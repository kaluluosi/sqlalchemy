<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    处理大集合
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="关系配置" href="relationships.html" />
        <link rel="next" title="集合订制和API详细信息" href="collection_api.html" />
        <link rel="prev" title="配置 Relationship Joins" href="join_conditions.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM映射类配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系配置</a></span><ul>
<li><span class="link-container"><a class="reference external" href="basic_relationships.html">关系模式基础知识</a></span></li>
<li><span class="link-container"><a class="reference external" href="self_referential.html">邻接列表关系</a></span></li>
<li><span class="link-container"><a class="reference external" href="join_conditions.html">配置 Relationship Joins</a></span></li>
<li class="selected"><span class="link-container"><strong>处理大集合</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#write-only-relationship">只写关系</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#write-only">创建和持久化新的write_only集合</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id31">把新项目添加到现有集合中</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id34">删除记录</a></span></li>
<li><span class="link-container"><a class="reference external" href="#querying-items">Querying Items</a></span></li>
<li><span class="link-container"><a class="reference external" href="#bulk-insert-of-new-items">Bulk INSERT of New Items</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#many-to-many-collections">Many to Many Collections</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#write-only-collections-api-documentation">Write Only Collections - API Documentation</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyCollection.add"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.add()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyCollection.add_all"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.add_all()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyCollection.delete"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.delete()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyCollection.insert"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.insert()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyCollection.remove"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.remove()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyCollection.select"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.select()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyCollection.update"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.update()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.WriteOnlyMapped"><code class="docutils literal notranslate"><span class="pre">WriteOnlyMapped</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dynamic-relationship">动态关系加载器</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#dynamic-relationship-loaders-api">Dynamic Relationship Loaders - API</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.AppenderQuery"><code class="docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.AppenderQuery.add"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.add()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.AppenderQuery.add_all"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.add_all()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.AppenderQuery.append"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.append()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.AppenderQuery.count"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.count()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.AppenderQuery.extend"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.extend()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.AppenderQuery.remove"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.remove()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.DynamicMapped"><code class="docutils literal notranslate"><span class="pre">DynamicMapped</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#raiseload">设置RaiseLoad</a></span></li>
<li><span class="link-container"><a class="reference external" href="#children-raise">在上述代码中，如果之前没有填充children，则访问属性将引发异常。这包括读取访问，但对于集合来说也影响了写访问，因为集合不能在不加载它们的情况下进行变更。这样做的原因是确保应用程序在某个上下文中不会发出任何意外的懒惰加载。使用raise策略</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id40">使用被动删除</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="collection_api.html">集合订制和API详细信息</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationship_persistence.html">特殊关系持久化模式</a></span></li>
<li><span class="link-container"><a class="reference external" href="backref.html">使用传统的“backref”关系参数</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationship_api.html">关系 API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM查询指南</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">使用Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">事件和内部实现</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM Examples</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="join_conditions.html" title="previous chapter">配置 Relationship Joins</a></li>
                <li><b>Next:</b>
                <a href="collection_api.html" title="next chapter">集合订制和API详细信息</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="relationships.html" title="关系配置">关系配置</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#largecollections">处理大集合</a><ul>
<li><a class="reference internal" href="#write-only-relationship">只写关系</a><ul>
<li><a class="reference internal" href="#write-only">创建和持久化新的write_only集合</a></li>
<li><a class="reference internal" href="#id31">把新项目添加到现有集合中</a></li>
<li><a class="reference internal" href="#id34">删除记录</a></li>
<li><a class="reference internal" href="#querying-items">Querying Items</a></li>
<li><a class="reference internal" href="#bulk-insert-of-new-items">Bulk INSERT of New Items</a><ul>
<li><a class="reference internal" href="#many-to-many-collections">Many to Many Collections</a></li>
</ul>
</li>
<li><a class="reference internal" href="#write-only-collections-api-documentation">Write Only Collections - API Documentation</a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.add"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.add()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.add_all"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.add_all()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.delete"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.delete()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.insert"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.insert()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.remove"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.remove()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.select"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.select()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.update"><code class="docutils literal notranslate"><span class="pre">WriteOnlyCollection.update()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyMapped"><code class="docutils literal notranslate"><span class="pre">WriteOnlyMapped</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#dynamic-relationship">动态关系加载器</a><ul>
<li><a class="reference internal" href="#dynamic-relationship-loaders-api">Dynamic Relationship Loaders - API</a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery"><code class="docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.add"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.add()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.add_all"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.add_all()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.append"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.append()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.count"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.count()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.extend"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.extend()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.remove"><code class="docutils literal notranslate"><span class="pre">AppenderQuery.remove()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.orm.DynamicMapped"><code class="docutils literal notranslate"><span class="pre">DynamicMapped</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#raiseload">设置RaiseLoad</a></li>
<li><a class="reference internal" href="#children-raise">在上述代码中，如果之前没有填充children，则访问属性将引发异常。这包括读取访问，但对于集合来说也影响了写访问，因为集合不能在不加载它们的情况下进行变更。这样做的原因是确保应用程序在某个上下文中不会发出任何意外的懒惰加载。使用raise策略</a></li>
<li><a class="reference internal" href="#id40">使用被动删除</a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-large_collections" >
        
<section id="largecollections">
<span id="id1"></span><h1>处理大集合<a class="headerlink" href="#largecollections" title="Permalink to this heading">¶</a></h1>
<p>默认情况下，:func:<a href="#id2"><span class="problematic" id="id3">`</span></a>_orm.relationship`的行为是完全加载在内存中的集合内容，基于一个配置的
:ref:<a href="#id4"><span class="problematic" id="id5">`</span></a>loader策略 &lt;orm_queryguide_relationship_loaders&gt;`来控制这些内容的何时和如何从数据库加载。
相关集合可能不仅在访问它们时或主动加载数据时被加载到内存中，而且在集合本身发生变化时也需要
加载数据, 或者在从工作单元通当中删除拥有对象的情况下都需要加载数据。</p>
<p>当关联集合可能非常大时，可能根本不可能在任何情况下都将这样的集合加载到内存中，因为这个
操作可能会大量消耗时间、网络和内存资源。</p>
<p>本章节包括旨在允许：func: <cite>_orm.relationship</cite> 与大集合一同使用保持足够性能的API特点。</p>
<section id="write-only-relationship">
<span id="id6"></span><h2>只写关系<a class="headerlink" href="#write-only-relationship" title="Permalink to this heading">¶</a></h2>
<p><a href="#id7"><span class="problematic" id="id8">**</span></a>只写**加载策略是配置 <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code> 不加载它的内容到内存中的主要手段。现代化的
类型注解声明形式的Declarative形式如下所例：
：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">WriteOnlyMapped</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">pass</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;account&quot;</span>
<span class="gp">... </span>    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">identifier</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">account_transactions</span><span class="p">:</span> <span class="n">WriteOnlyMapped</span><span class="p">[</span><span class="s2">&quot;AccountTransaction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">passive_deletes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;AccountTransaction.timestamp&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Account(identifier=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">!r}</span><span class="s2">)&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">AccountTransaction</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;account_transaction&quot;</span>
<span class="gp">... </span>    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">account_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;account.id&quot;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span>    <span class="n">description</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">amount</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="p">(</span>
<span class="gp">... </span>            <span class="sa">f</span><span class="s2">&quot;AccountTransaction(amount=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
<span class="gp">... </span>            <span class="sa">f</span><span class="s2">&quot;timestamp=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">!r}</span><span class="s2">)&quot;</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;eager_defaults&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>在上面的代码里面，<code class="docutils literal notranslate"><span class="pre">account_transactions``关系不使用普通的:class:`.Mapped`注释配置，而是使用</span>
<span class="pre">:class:`.WriteOnlyMapped`类型的注释配置，在运行时将``lazy=&quot;``配置为&quot;write_only&quot;。</span></code>.WriteOnlyMapped``
注释是:class:<a href="#id9"><span class="problematic" id="id10">`</span></a>_orm.Mapped`注释的另一种形式，它表示在对象的实例上使用:class:<a href="#id11"><span class="problematic" id="id12">`</span></a>_orm.WriteOnlyCollection`集合类型。</p>
<p>上述:func:<a href="#id13"><span class="problematic" id="id14">`</span></a>_orm.relationship`配置还包括具体的一些元素，它们决定了在删除 “Account”对象以及从 “account_transactions”集合中删除”AccountTransaction”对象时要执行的操作:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">passive_deletes=True</span></code> - 允许工作单元在删除“Account”时不必加载集合；请参见:ref:<cite>passive_deletes</cite>。</p></li>
<li><p><a href="#id15"><span class="problematic" id="id16">``</span></a>ondelete=”cascade”<a href="#id17"><span class="problematic" id="id18">``</span></a>在 :class:<a href="#id19"><span class="problematic" id="id20">`</span></a>.ForeignKey`约束上配置。这也在:ref:<a href="#id21"><span class="problematic" id="id22">`</span></a>passive_deletes`详述。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cascade=&quot;all,</span> <span class="pre">delete-orphan&quot;</span></code> - 指示工作单元在从集合中删除“AccountTransaction”时删除它们。在:ref:<cite>unitofwork_cascades`文档中
参见 :ref:`cascade_delete_orphan</cite>。</p></li>
</ul>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>添加了 “Write only” 技术支持.</p>
</div>
<section id="write-only">
<h3>创建和持久化新的write_only集合<a class="headerlink" href="#write-only" title="Permalink to this heading">¶</a></h3>
<p>现在可以直接将write-only集合作为整体分配为 <span class="xref std std-term">transient</span> 或 <span class="xref std std-term">pending</span> 对象。
使用以上映射代码，在:class:<a href="#id23"><span class="problematic" id="id24">`</span></a>_orm.Session`中可以创建新 <a href="#id25"><span class="problematic" id="id26">``</span></a>Account``对象，
一系列 <a href="#id27"><span class="problematic" id="id28">``</span></a>AccountTransaction``对象。 可以使用任何Python可迭代对象作为
开始对象的来源，正如下面我们使用Python <a href="#id29"><span class="problematic" id="id30">``</span></a>list``那样:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">new_account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span>
<span class="go">...     identifier=&quot;account_01&quot;,</span>
<span class="go">...     account_transactions=[</span>
<span class="go">...         AccountTransaction(description=&quot;initial deposit&quot;, amount=Decimal(&quot;500.00&quot;)),</span>
<span class="go">...         AccountTransaction(description=&quot;transfer&quot;, amount=Decimal(&quot;1000.00&quot;)),</span>
<span class="go">...         AccountTransaction(description=&quot;withdrawal&quot;, amount=Decimal(&quot;-29.50&quot;)),</span>
<span class="go">...     ],</span>
<span class="go">... )</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="go">...     session.add(new_account)</span>
<span class="go">...     session.commit()</span>
<div class='show_sql'><span class="k">BEGIN</span><span class="w"> </span><span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;account_01&#39;</span><span class="p">,)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account_transaction</span><span class="w"> </span><span class="p">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;initial deposit&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account_transaction</span><span class="w"> </span><span class="p">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transfer&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account_transaction</span><span class="w"> </span><span class="p">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;withdrawal&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">29</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>
<span class="k">COMMIT</span>
</div></pre></div>
</div>
<p>一旦对象被写为数据库持久状态(即处于 <span class="xref std std-term">persistent</span> 或 <span class="xref std std-term">detached</span> 状态)，
集合就可以扩展了，旧的和新的条目以及个别条目的记录也都可以删除。但是，
集合可能**不能再被重新分配替换为整个集合**，因为这种修改操作需要前一个集合被完全加载到
内存中，才能将旧值和新值调和。</p>
</section>
<section id="id31">
<h3>把新项目添加到现有集合中<a class="headerlink" href="#id31" title="Permalink to this heading">¶</a></h3>
<p>对于 <span class="xref std std-term">persistent</span> 对象，只有通过使用 <span class="xref std std-term">unit of work</span> 进程才能进行 集合的修改，才可以对 write-only 集合添加新条目等操作；</p>
<p>使用 <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.add" title="sqlalchemy.orm.WriteOnlyCollection.add"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.add()</span></code></a>,
<a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.add_all" title="sqlalchemy.orm.WriteOnlyCollection.add_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.add_all()</span></code></a> and <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.remove" title="sqlalchemy.orm.WriteOnlyCollection.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.remove()</span></code></a>
方法:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">existing_account</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;account_01&quot;</span><span class="p">))</span>
<div class='show_sql'><span class="k">BEGIN</span><span class="w"> </span><span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">identifier</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">account</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="n">identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;account_01&#39;</span><span class="p">,)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">existing_account</span><span class="o">.</span><span class="n">account_transactions</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span>
<span class="go">...     [</span>
<span class="go">...         AccountTransaction(description=&quot;paycheck&quot;, amount=Decimal(&quot;2000.00&quot;)),</span>
<span class="go">...         AccountTransaction(description=&quot;rent&quot;, amount=Decimal(&quot;-800.00&quot;)),</span>
<span class="go">...     ]</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account_transaction</span><span class="w"> </span><span class="p">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;paycheck&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account_transaction</span><span class="w"> </span><span class="p">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;rent&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">800</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="k">COMMIT</span>
</div></pre></div>
</div>
<p>上述添加的条目被保存在:class:<cite>_orm.Session`中之后，就像存在于 :term:`transient`状态下的对象一样，
随后如果要删除对象后，则使用:meth:</cite>.WriteOnlyCollection.remove`方法，工作单元过程会默认该对象
已经是集合的一部分。以删除一个单独的AccountTransaction条目为例，因为我们的 :ref:<a href="#id32"><span class="problematic" id="id33">`</span></a>cascade &lt;unitofwork_cascades&gt;`设置需要，
被删除的行被修整。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">existing_transaction</span> <span class="o">=</span> <span class="n">account_transactions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">existing_account</span><span class="o">.</span><span class="n">account_transactions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">existing_transaction</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="go">{execsql}DELETE FROM account_transaction WHERE account_transaction.id = ?</span>
<span class="go">[...] (3,)</span>
<span class="go">COMMIT</span></pre></div>
</div>
<p>对于任何的ORM-mapped集合，可以通过删除对象将对象与集合分离。对于 one-to-many关系模式 ，这种情况下键值可以设置为 <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code>；对于 many-to-many 关系模式，特定的联合项将被删除。</p>
</section>
<section id="id34">
<h3>删除记录<a class="headerlink" href="#id34" title="Permalink to this heading">¶</a></h3>
<p>WriteOnlyCollection 对象 remove 的协议与常规 orm 集合相同：如果 project_transaction 已经存在于 session 中，传统的 orm 逻辑将项目从 Account.transactions集合中删除：</p>
<p>jack = session.query(Account).filter_by(name=’jack’).one()</p>
<p>proj = session.query(Project).filter_by(name=’proj3’).one()</p>
<p>jack.projects.remove(proj)</p>
<p>如果没有一个项目驻留在 session 中（如下文所述），则只需将其设置为可删除即可对其进行 remove，就像写操作一样：</p>
<p>proj = Project(name=’other project’)</p>
<p>jack.projects.remove(proj)</p>
</section>
<section id="querying-items">
<h3>Querying Items<a class="headerlink" href="#querying-items" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a> 没有在任何时间点存储对集合当前内容的引用，
也没有任何行为会直接发出 SELECT 查询以将其加载到内存中；
这种方法的默认设置是，集合可以包含很多千甚至百万行，因此不应作为其他操作的副作用
的内存中预加载。</p>
<p><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a> 包括SQL生成助手，例如:meth:<cite>_orm.WriteOnlyCollection.select</cite>，
该助手将预先配置带有当前父行的 WHERE / FROM条件的:class:<cite>.Select`构造，
然后可以进一步修改以选择所需的任何范围的行，也可使用 :ref:`server side cursors &lt;orm_queryguide_yield_per&gt;</cite>
用于需要以节省内存占用的方式迭代整个集合的进程。</p>
<p>下面是 SQLite 下生成的语句。请注意，它还包括 ORDER BY 条件，这由 <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code> 的参数 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.order_by</span></code> 指示，
如果未配置该参数，则将省略此条件:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">existing_account</span><span class="o">.</span><span class="n">account_transactions</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
<span class="n">account_transaction</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="k">timestamp</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">account_transaction</span>
<span class="k">WHERE</span><span class="w"> </span><span class="p">:</span><span class="n">param_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="n">account_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="k">timestamp</span>
</div></pre></div>
</div>
<p>我们可以使用 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> 构造和 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 进行查询 <cite>AccountTransaction</cite> 对象，
最简单的方法是使用会返回 ORM 对象的 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.scalars()</span></code> 方法。典型的做法是，
尽管不是必需的，但会进一步修改 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> 来限制返回的记录； 在下面的示例中，添加了其他 WHERE 条件来仅加载 “debit” 帐户交易记录，
以及“LIMIT 10” 来仅检索这前十个行：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">account_transactions</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">existing_account</span><span class="o">.</span><span class="n">account_transactions</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AccountTransaction</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">{execsql}</span>
<span class="go">BEGIN (implicit)</span>
<span class="go">SELECT account_transaction.id, account_transaction.account_id, account_transaction.description,</span>
<span class="go">account_transaction.amount, account_transaction.timestamp</span>
<span class="go">FROM account_transaction</span>
<span class="go">WHERE ? = account_transaction.account_id AND account_transaction.amount &lt; ?</span>
<span class="go">ORDER BY account_transaction.timestamp  LIMIT ? OFFSET ?</span>
<span class="go">[...] (1, 0, 10, 0)</span>
<span class="go">{stop}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">account_transactions</span><span class="p">)</span>
<span class="go">[AccountTransaction(amount=-29.50, timestamp=&#39;...&#39;), AccountTransaction(amount=-800.00, timestamp=&#39;...&#39;)]</span></pre></div>
</div>
</section>
<section id="bulk-insert-of-new-items">
<h3>Bulk INSERT of New Items<a class="headerlink" href="#bulk-insert-of-new-items" title="Permalink to this heading">¶</a></h3>
<p>WriteOnlyCollection 能够 generating DML constructs 像 <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 对象，
它可在 ORM 的上下文中产生 bulk insert 行为。详见 ORM bulk 插入章节的概述。
仅正常的 one to many 集合的情况下,方法:meth:<cite>.WriteOnlyCollection.insert</cite>
生成一个 <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造器，其用于主键的 VALUES 条件与父对象相应。
由于此 VALUES 条件仅针对关联表格，因此该语句将同时插入新行，并将成为新记录添加到相关集合中:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     existing_account.account_transactions.insert(),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;description&quot;: &quot;transaction 1&quot;, &quot;amount&quot;: Decimal(&quot;47.50&quot;)},</span>
<span class="go">...         {&quot;description&quot;: &quot;transaction 2&quot;, &quot;amount&quot;: Decimal(&quot;-501.25&quot;)},</span>
<span class="go">...         {&quot;description&quot;: &quot;transaction 3&quot;, &quot;amount&quot;: Decimal(&quot;1800.00&quot;)},</span>
<span class="go">...         {&quot;description&quot;: &quot;transaction 4&quot;, &quot;amount&quot;: Decimal(&quot;-300.00&quot;)},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">BEGIN</span><span class="w"> </span><span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account_transaction</span><span class="w"> </span><span class="p">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transaction 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transaction 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">501</span><span class="p">.</span><span class="mi">25</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transaction 3&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1800</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transaction 4&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">300</span><span class="p">.</span><span class="mi">0</span><span class="p">)]</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="go">COMMIT</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="queryguide/dml.html#orm-queryguide-bulk-insert"><span class="std std-ref">ORM 批量 INSERT 语句</span></a> - in the <span class="xref std std-ref">queryguide_toplevel</span></p>
<p><a class="reference internal" href="basic_relationships.html#relationship-patterns-o2m"><span class="std std-ref">一对多</span></a> - at <a class="reference internal" href="basic_relationships.html#relationship-patterns"><span class="std std-ref">关系模式基础知识</span></a></p>
</div>
<section id="many-to-many-collections">
<h4>Many to Many Collections<a class="headerlink" href="#many-to-many-collections" title="Permalink to this heading">¶</a></h4>
<p>一种 <strong>many to many 集合</strong> 的情况下，描述了两个类之间的关系涉及到一个第三个配置使用 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code> 参数的表格。
使用 <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a> 插入此类集合的新行时，可能首先单独对其进行批量插入，并使用 RETURNING 检索到这些记录，
然后将这些记录传递给 <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.add_all" title="sqlalchemy.orm.WriteOnlyCollection.add_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.add_all()</span></code></a> 方法，此时单元操作过程会将这些记录作为集合的一部分来持久化。</p>
<p>例如，假设一个类 <code class="docutils literal notranslate"><span class="pre">BankAudit</span></code>  指向许多 <code class="docutils literal notranslate"><span class="pre">AccountTransaction</span></code> 记录，这是一个多对多表格:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">audit_to_transaction</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<span class="go">...     &quot;audit_transaction&quot;,</span>
<span class="go">...     Base.metadata,</span>
<span class="go">...     Column(&quot;audit_id&quot;, ForeignKey(&quot;audit.id&quot;, ondelete=&quot;CASCADE&quot;), primary_key=True),</span>
<span class="go">...     Column(</span>
<span class="go">...         &quot;transaction_id&quot;,</span>
<span class="go">...         ForeignKey(&quot;account_transaction.id&quot;, ondelete=&quot;CASCADE&quot;),</span>
<span class="go">...         primary_key=True,</span>
<span class="go">...     ),</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">BankAudit</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="go">...     __tablename__ = &quot;audit&quot;</span>
<span class="go">...     id: Mapped[int] = mapped_column(primary_key=True)</span>
<span class="go">...     account_transactions: WriteOnlyMapped[&quot;AccountTransaction&quot;] = relationship(</span>
<span class="go">...         secondary=audit_to_transaction, passive_deletes=True</span>
<span class="go">...     )</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>我们可以通过批量插入添加更多的 <code class="docutils literal notranslate"><span class="pre">AccountTransaction</span></code> 对象，
通过调用 <code class="docutils literal notranslate"><span class="pre">existing_account.account_transactions.insert()</span></code>，添加方法返回一个 <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造器，其用于与父对象相应的 VALUES 条件。</p>
<p>通过 <code class="docutils literal notranslate"><span class="pre">session.execute()</span></code> 执行该方法，并传入带有预先绑定的参数序列的元素列表来批量插入（或插入已存在于表格中的现有 <code class="docutils literal notranslate"><span class="pre">AccountTransaction</span></code> 对象）
此处的 <code class="xref py py-const docutils literal notranslate"><span class="pre">RETURNING</span></code> 选项被添加到语法以使用 <code class="xref py py-func docutils literal notranslate"><span class="pre">sqlalchemy.orm.scalars()</span></code> 函数捕获 插入/返回的所有行：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">new_transactions</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">existing_account</span><span class="o">.</span><span class="n">account_transactions</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">AccountTransaction</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;odd trans 1&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50000.00&quot;</span><span class="p">)},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;odd trans 2&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;25000.00&quot;</span><span class="p">)},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;odd trans 3&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;45.00&quot;</span><span class="p">)},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">{execsql}BEGIN (implicit)</span>
<span class="go">INSERT INTO account_transaction (account_id, description, amount, timestamp) VALUES</span>
<span class="go">(?, ?, ?, CURRENT_TIMESTAMP), (?, ?, ?, CURRENT_TIMESTAMP), (?, ?, ?, CURRENT_TIMESTAMP)</span>
<span class="go">RETURNING id, account_id, description, amount, timestamp</span>
<span class="go">[...] (1, &#39;odd trans 1&#39;, 50000.0, 1, &#39;odd trans 2&#39;, 25000.0, 1, &#39;odd trans 3&#39;, 45.0)</span>
<span class="go">{stop}</span></pre></div>
</div>
<p>与许多针对于持久状态对象的 orm 集合的情况相同，orm 集合可以通过 <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.update" title="sqlalchemy.orm.WriteOnlyCollection.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.update()</span></code></a> 和 <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.delete" title="sqlalchemy.orm.WriteOnlyCollection.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.delete()</span></code></a> 对象快捷构造进行更新和修改。</p>
<p>WriteOnlyCollection支持 bulk update 和 delete 通过生成诸如 <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 和 <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> 构造器，其中包括 WHERE 条件，以便针对集合中的元素进行 update 和 delete 操作。</p>
<p>最后 <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a> 能够通过 <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.select" title="sqlalchemy.orm.WriteOnlyCollection.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WriteOnlyCollection.select()</span></code></a> 方法生成用于此查询的 SQL 部分，然后可以将其使用于外层 SELECT 语句中，以便能够针对一组较大的行进行现有的过滤操作，基于与选定的父项匹配的子项来选择行。
有关详细信息，请参阅 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 以及 :ref:<a href="#id35"><span class="problematic" id="id36">`</span></a>subquery &lt;sql_expression_subquery&gt;`指南。您可以在此查询中定义各种限制和过滤条件，以便只查询某些行:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">subq</span> <span class="o">=</span> <span class="n">bank_audit</span><span class="o">.</span><span class="n">account_transactions</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">with_only_columns</span><span class="p">(</span><span class="n">AccountTransaction</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     update(AccountTransaction)</span>
<span class="go">...     .values(description=AccountTransaction.description + &quot; (audited)&quot;)</span>
<span class="go">...     .where(AccountTransaction.id.in_(subq))</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">account_transaction</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="n">account_transaction</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">audit_transaction</span>
<span class="k">WHERE</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">audit_transaction</span><span class="p">.</span><span class="n">audit_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">account_transaction</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">audit_transaction</span><span class="p">.</span><span class="n">transaction_id</span><span class="p">)</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39; (audited)&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
</div></pre></div>
</div>
<p>要更新或删除其中一个组，最好使用一个类似于如下代码的子查询判断Related名字是 “foo” 的对象:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy.sql import exists, select</span>

<span class="go">audit_alias = select([audit.c.id]).where(audit.c.name == &quot;audit1&quot;).scalar_subquery()</span>

<span class="go">q = (</span>
<span class="go">    select([account_transactions.c.id])</span>
<span class="go">    .where(</span>
<span class="go">        exists()</span>
<span class="go">        .where(account_transactions_audit_transaction.c.audit_id == audit_alias)</span>
<span class="go">        .where(account_transactions.c.id == account_transactions_audit_transaction.c.transaction_id)</span>
<span class="go">    )</span>
<span class="go">    .subquery()</span>
<span class="go">)</span>

<span class="go">stmt = (</span>
<span class="go">    account_transactions.update()</span>
<span class="go">    .values(description=account_transactions.c.description + &quot; (audited)&quot;)</span>
<span class="go">    .where(account_transactions.c.id.in_(q))</span>
<span class="go">)</span></pre></div>
</div>
<p>BulkUPDATE 的多个例子详见 <span class="xref std std-ref">updating_multiple_rows</span>。同时在示例中， ORM 的查询操作对 write-only 集合做了操作，但是并不会执行额外的懒惰加载。</p>
</section>
</section>
<section id="write-only-collections-api-documentation">
<h3>Write Only Collections - API Documentation<a class="headerlink" href="#write-only-collections-api-documentation" title="Permalink to this heading">¶</a></h3>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><span class="sig-name descname">WriteOnlyCollection</span></a></p></td>
<td><p>Write-only collection which can synchronize changes into the
attribute event system.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyMapped"><span class="sig-name descname">WriteOnlyMapped</span></a></p></td>
<td><p>Represent the ORM mapped attribute type for a “write only” relationship.</p></td>
</tr>
</tbody>
</table>
<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyCollection">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">WriteOnlyCollection</span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyCollection" title="Permalink to this definition">¶</a></dt>
<dd><p>Write-only collection which can synchronize changes into the
attribute event system.</p>
<p>The <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a> is used in a mapping by
using the <code class="docutils literal notranslate"><span class="pre">&quot;write_only&quot;</span></code> lazy loading strategy with
<code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>.     For background on this configuration,
see <a class="reference internal" href="#write-only-relationship"><span class="std std-ref">只写关系</span></a>.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.</span></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#write-only-relationship"><span class="std std-ref">只写关系</span></a></p>
</div>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.add"><span class="sig-name descname">add()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.add_all"><span class="sig-name descname">add_all()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.delete"><span class="sig-name descname">delete()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.insert"><span class="sig-name descname">insert()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.remove"><span class="sig-name descname">remove()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.select"><span class="sig-name descname">select()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection.update"><span class="sig-name descname">update()</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyCollection</span></code></a> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.writeonly.AbstractCollectionWriter</span></code>)</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyCollection.add">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyCollection.</span></code></a><span class="sig-name descname"><span class="pre">add</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">item</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyCollection.add" title="Permalink to this definition">¶</a></dt>
<dd><p>Add an item to this <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a>.</p>
<p>The given item will be persisted to the database in terms of
the parent instance’s collection on the next flush.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyCollection.add_all">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyCollection.</span></code></a><span class="sig-name descname"><span class="pre">add_all</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Iterable</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyCollection.add_all" title="Permalink to this definition">¶</a></dt>
<dd><p>Add an iterable of items to this <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a>.</p>
<p>The given items will be persisted to the database in terms of
the parent instance’s collection on the next flush.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyCollection.delete">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyCollection.</span></code></a><span class="sig-name descname"><span class="pre">delete</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.dml.Delete"><span class="pre">Delete</span></a></span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyCollection.delete" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce a <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> which will refer to rows in terms
of this instance-local <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyCollection.insert">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyCollection.</span></code></a><span class="sig-name descname"><span class="pre">insert</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.dml.Insert"><span class="pre">Insert</span></a></span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyCollection.insert" title="Permalink to this definition">¶</a></dt>
<dd><p>For one-to-many collections, produce a <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> which
will insert new rows in terms of this this instance-local
<a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a>.</p>
<p>This construct is only supported for a <a class="reference internal" href="internals.html#sqlalchemy.orm.Relationship" title="sqlalchemy.orm.Relationship"><code class="xref py py-class docutils literal notranslate"><span class="pre">Relationship</span></code></a>
that does <strong>not</strong> include the <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code>
parameter.  For relationships that refer to a many-to-many table,
use ordinary bulk insert techniques to produce new objects, then
use <code class="xref py py-meth docutils literal notranslate"><span class="pre">AbstractCollectionWriter.add_all()</span></code> to associate them
with the collection.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyCollection.remove">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyCollection.</span></code></a><span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">item</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyCollection.remove" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove an item from this <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a>.</p>
<p>The given item will be removed from the parent instance’s collection on
the next flush.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyCollection.select">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyCollection.</span></code></a><span class="sig-name descname"><span class="pre">select</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><span class="pre">Select</span></a><span class="p"><span class="pre">[</span></span><a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Tuple" title="sqlalchemy.sql.expression.Tuple"><span class="pre">Tuple</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyCollection.select" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct that represents the
rows within this instance-local <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyCollection.update">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyCollection.</span></code></a><span class="sig-name descname"><span class="pre">update</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.dml.Update"><span class="pre">Update</span></a></span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyCollection.update" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce a <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> which will refer to rows in terms
of this instance-local <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a>.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.WriteOnlyMapped">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">WriteOnlyMapped</span></span><a class="headerlink" href="#sqlalchemy.orm.WriteOnlyMapped" title="Permalink to this definition">¶</a></dt>
<dd><p>Represent the ORM mapped attribute type for a “write only” relationship.</p>
<p>The <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyMapped" title="sqlalchemy.orm.WriteOnlyMapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyMapped</span></code></a> type annotation may be used in an
<a class="reference internal" href="declarative_tables.html#orm-declarative-mapped-column"><span class="std std-ref">Annotated Declarative Table</span></a> mapping
to indicate that the <code class="docutils literal notranslate"><span class="pre">lazy=&quot;write_only&quot;</span></code> loader strategy should be used
for a particular <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>.</p>
<p>E.g.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">class User(Base):</span>
<span class="go">    __tablename__ = &quot;user&quot;</span>
<span class="go">    id: Mapped[int] = mapped_column(primary_key=True)</span>
<span class="go">    addresses: WriteOnlyMapped[Address] = relationship(</span>
<span class="go">        cascade=&quot;all,delete-orphan&quot;</span>
<span class="go">    )</span></pre></div>
</div>
<p>See the section <a class="reference internal" href="#write-only-relationship"><span class="std std-ref">只写关系</span></a> for background.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.</span></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#write-only-relationship"><span class="std std-ref">只写关系</span></a> - complete background</p>
<p><a class="reference internal" href="#sqlalchemy.orm.DynamicMapped" title="sqlalchemy.orm.DynamicMapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">DynamicMapped</span></code></a> - includes legacy <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> support</p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyMapped" title="sqlalchemy.orm.WriteOnlyMapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.WriteOnlyMapped</span></code></a> (<code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.base._MappedAnnotationBase</span></code>)</p>
</div>
</dd></dl>

</section>
</section>
<section id="dynamic-relationship">
<span id="id37"></span><h2>动态关系加载器<a class="headerlink" href="#dynamic-relationship" title="Permalink to this heading">¶</a></h2>
<div class="admonition legacy">
<p class="admonition-title">Legacy Feature</p>
<p>“dynamic” lazy loader strategy是现在称为 “write_only” 策略的旧式形式。</p>
<p>“dynamic” 策略会配置 <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>，在实例上访问它时返回一个’orm.Query’对象，而不是集合。
<a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 然后可以进行进一步的修改，以便可以基于过滤条件来迭代数据库集合。返回的 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 对象是 <code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code> 的行为与基本的集合修改方法（如 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.append" title="sqlalchemy.orm.AppenderQuery.append"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderQuery.append()</span></code></a> 和 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.remove" title="sqlalchemy.orm.AppenderQuery.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderQuery.remove()</span></code></a> 等）组合在一起。</p>
<p>“dynamic” 加载程序还与 <a class="reference internal" href="extensions/asyncio.html"><span class="std std-ref">异步 I/O (asyncio)</span></a> 扩展不兼容，虽然可以使用一些限制，但必须根据案例进行小心的编程和测试。因此，在处理真正的大的集合管理时，应该优选 <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a>。</p>
</div>
<p>动态关系加载策略允许配置一个 <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>，当在实例上访问它时，它将返回 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 对象而不是集合。这个 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 可以进一步地修改以便数据库集合可以基于篮子条件进行迭代。返回的 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 对象是实例级别的 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a>，组合了 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 的加载和迭代行为，以及 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.append" title="sqlalchemy.orm.AppenderQuery.append"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderQuery.append()</span></code></a> 和 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.remove" title="sqlalchemy.orm.AppenderQuery.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderQuery.remove()</span></code></a> 等简单的集合修改方法。</p>
<p>“dynamic” 关系加载器可以使用 DynamicMapped 注释类进行配置:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy.orm import DynamicMapped</span>

<span class="go">class User(Base):</span>
<span class="go">    __tablename__ = &quot;user&quot;</span>

<span class="go">    id: Mapped[int] = mapped_column(primary_key=True)</span>
<span class="go">    posts: DynamicMapped[Post] = relationship()</span></pre></div>
</div>
<p>以上，一个单独的 “User.posts” 集合属性将返回的是一个 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a> 对象，这是 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 的子类，支持基本的修改集合操作，例如 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.append" title="sqlalchemy.orm.AppenderQuery.append"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderQuery.append()</span></code></a> 和 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.remove" title="sqlalchemy.orm.AppenderQuery.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderQuery.remove()</span></code></a>。</p>
<p>动态关系支持有限的写操作，可以通过 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.append" title="sqlalchemy.orm.AppenderQuery.append"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderQuery.append()</span></code></a> 和 <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.remove" title="sqlalchemy.orm.AppenderQuery.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderQuery.remove()</span></code></a> 方法进行操作。</p>
<p>由于动态关系的访问总是会向数据库查询，此原因导致对于基本联系人分组已经进行豁免了，因此修改底层集合的更改在数据记录刷新之前将不可见。但只要 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 上设置了自动flash，刷新操作就会自动执行每次集合查询返回之前。</p>
<section id="dynamic-relationship-loaders-api">
<h3>Dynamic Relationship Loaders - API<a class="headerlink" href="#dynamic-relationship-loaders-api" title="Permalink to this heading">¶</a></h3>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery"><span class="sig-name descname">AppenderQuery</span></a></p></td>
<td><p>A dynamic query that supports basic collection storage operations.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.DynamicMapped"><span class="sig-name descname">DynamicMapped</span></a></p></td>
<td><p>Represent the ORM mapped attribute type for a “dynamic” relationship.</p></td>
</tr>
</tbody>
</table>
<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.AppenderQuery">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">AppenderQuery</span></span><a class="headerlink" href="#sqlalchemy.orm.AppenderQuery" title="Permalink to this definition">¶</a></dt>
<dd><p>A dynamic query that supports basic collection storage operations.</p>
<p>Methods on <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a> include all methods of
<a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>, plus additional methods used for collection
persistence.</p>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.add"><span class="sig-name descname">add()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.add_all"><span class="sig-name descname">add_all()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.append"><span class="sig-name descname">append()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.count"><span class="sig-name descname">count()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.extend"><span class="sig-name descname">extend()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery.remove"><span class="sig-name descname">remove()</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.AppenderQuery</span></code></a> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.dynamic.AppenderMixin</span></code>, <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.Query</span></code></a>)</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.AppenderQuery.add">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.AppenderQuery.</span></code></a><span class="sig-name descname"><span class="pre">add</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">item</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.AppenderQuery.add" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderMixin.add()</span></code> <em>method of</em> <code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderMixin</span></code></p>
</div>
<p>Add an item to this <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a>.</p>
<p>The given item will be persisted to the database in terms of
the parent instance’s collection on the next flush.</p>
<p>This method is provided to assist in delivering forwards-compatibility
with the <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a> collection class.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.</span></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.AppenderQuery.add_all">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.AppenderQuery.</span></code></a><span class="sig-name descname"><span class="pre">add_all</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Iterable</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.AppenderQuery.add_all" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderMixin.add_all()</span></code> <em>method of</em> <code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderMixin</span></code></p>
</div>
<p>Add an iterable of items to this <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a>.</p>
<p>The given items will be persisted to the database in terms of
the parent instance’s collection on the next flush.</p>
<p>This method is provided to assist in delivering forwards-compatibility
with the <a class="reference internal" href="#sqlalchemy.orm.WriteOnlyCollection" title="sqlalchemy.orm.WriteOnlyCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyCollection</span></code></a> collection class.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.</span></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.AppenderQuery.append">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.AppenderQuery.</span></code></a><span class="sig-name descname"><span class="pre">append</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">item</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.AppenderQuery.append" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderMixin.append()</span></code> <em>method of</em> <code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderMixin</span></code></p>
</div>
<p>Append an item to this <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a>.</p>
<p>The given item will be persisted to the database in terms of
the parent instance’s collection on the next flush.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.AppenderQuery.count">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.AppenderQuery.</span></code></a><span class="sig-name descname"><span class="pre">count</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">int</span></span></span><a class="headerlink" href="#sqlalchemy.orm.AppenderQuery.count" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderMixin.count()</span></code> <em>method of</em> <code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderMixin</span></code></p>
</div>
<p>Return a count of rows this the SQL formed by this <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>
would return.</p>
<p>This generates the SQL for this Query as follows:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">SELECT count(1) AS count_1 FROM (</span>
<span class="go">    SELECT &lt;rest of query follows...&gt;</span>
<span class="go">) AS anon_1</span></pre></div>
</div>
<p>The above SQL returns a single row, which is the aggregate value
of the count function; the <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query.count" title="sqlalchemy.orm.Query.count"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.count()</span></code></a>
method then returns
that single integer value.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is important to note that the value returned by
count() is <strong>not the same as the number of ORM objects that this
Query would return from a method such as the .all() method</strong>.
The <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object,
when asked to return full entities,
will <strong>deduplicate entries based on primary key</strong>, meaning if the
same primary key value would appear in the results more than once,
only one object of that primary key would be present.  This does
not apply to a query that is against individual columns.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../faq/sessions.html#faq-query-deduplicating"><span class="std std-ref">我的查询返回的对象数量与查询.count()测试我告诉我的不同 - 为什么？</span></a></p>
</div>
</div>
<p>For fine grained control over specific columns to count, to skip the
usage of a subquery or otherwise control of the FROM clause, or to use
other aggregate functions, use <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-attr docutils literal notranslate"><span class="pre">expression.func</span></code></a>
expressions in conjunction with <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.query()</span></code>, i.e.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy import func</span>

<span class="go"># count User records, without</span>
<span class="go"># using a subquery.</span>
<span class="go">session.query(func.count(User.id))</span>

<span class="go"># return count of user &quot;id&quot; grouped</span>
<span class="go"># by &quot;name&quot;</span>
<span class="go">session.query(func.count(User.id)).\</span>
<span class="go">        group_by(User.name)</span>

<span class="go">from sqlalchemy import distinct</span>

<span class="go"># count distinct &quot;name&quot; values</span>
<span class="go">session.query(func.count(distinct(User.name)))</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../changelog/migration_20.html#migration-20-query-usage"><span class="std std-ref">ORM使用2.0迁移</span></a></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.AppenderQuery.extend">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.AppenderQuery.</span></code></a><span class="sig-name descname"><span class="pre">extend</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Iterable</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.AppenderQuery.extend" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderMixin.extend()</span></code> <em>method of</em> <code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderMixin</span></code></p>
</div>
<p>Add an iterable of items to this <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a>.</p>
<p>The given items will be persisted to the database in terms of
the parent instance’s collection on the next flush.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.AppenderQuery.remove">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.AppenderQuery"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.AppenderQuery.</span></code></a><span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">item</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.AppenderQuery.remove" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <code class="xref py py-meth docutils literal notranslate"><span class="pre">AppenderMixin.remove()</span></code> <em>method of</em> <code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderMixin</span></code></p>
</div>
<p>Remove an item from this <a class="reference internal" href="#sqlalchemy.orm.AppenderQuery" title="sqlalchemy.orm.AppenderQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">AppenderQuery</span></code></a>.</p>
<p>The given item will be removed from the parent instance’s collection on
the next flush.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.DynamicMapped">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">DynamicMapped</span></span><a class="headerlink" href="#sqlalchemy.orm.DynamicMapped" title="Permalink to this definition">¶</a></dt>
<dd><p>Represent the ORM mapped attribute type for a “dynamic” relationship.</p>
<p>The <a class="reference internal" href="#sqlalchemy.orm.DynamicMapped" title="sqlalchemy.orm.DynamicMapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">DynamicMapped</span></code></a> type annotation may be used in an
<a class="reference internal" href="declarative_tables.html#orm-declarative-mapped-column"><span class="std std-ref">Annotated Declarative Table</span></a> mapping
to indicate that the <code class="docutils literal notranslate"><span class="pre">lazy=&quot;dynamic&quot;</span></code> loader strategy should be used
for a particular <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>.</p>
<div class="admonition legacy">
<p class="admonition-title">Legacy Feature</p>
<p>The “dynamic” lazy loader strategy is the legacy form of what
is now the “write_only” strategy described in the section
<a class="reference internal" href="#write-only-relationship"><span class="std std-ref">只写关系</span></a>.</p>
</div>
<p>E.g.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">class User(Base):</span>
<span class="go">    __tablename__ = &quot;user&quot;</span>
<span class="go">    id: Mapped[int] = mapped_column(primary_key=True)</span>
<span class="go">    addresses: DynamicMapped[Address] = relationship(</span>
<span class="go">        cascade=&quot;all,delete-orphan&quot;</span>
<span class="go">    )</span></pre></div>
</div>
<p>See the section <a class="reference internal" href="#dynamic-relationship"><span class="std std-ref">动态关系加载器</span></a> for background.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.</span></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#dynamic-relationship"><span class="std std-ref">动态关系加载器</span></a> - complete background</p>
<p><a class="reference internal" href="#sqlalchemy.orm.WriteOnlyMapped" title="sqlalchemy.orm.WriteOnlyMapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">WriteOnlyMapped</span></code></a> - fully 2.0 style version</p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.DynamicMapped" title="sqlalchemy.orm.DynamicMapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.DynamicMapped</span></code></a> (<code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.base._MappedAnnotationBase</span></code>)</p>
</div>
</dd></dl>

</section>
</section>
<section id="raiseload">
<span id="collections-raiseload"></span><h2>设置RaiseLoad<a class="headerlink" href="#raiseload" title="Permalink to this heading">¶</a></h2>
<p>“raise”加载关系将在通常情况下作为一个懒惰加入发出属性时，抛出一个
<a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.InvalidRequestError" title="sqlalchemy.exc.InvalidRequestError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">InvalidRequestError</span></code></a> 异常:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">class MyClass(Base):</span>
<span class="go">    __tablename__ = &quot;some_table&quot;</span>

<span class="go">    # ...</span>

<span class="go">    children: Mapped[List[MyRelatedClass]] = relationship(lazy=&quot;raise&quot;)</span></pre></div>
</div>
</section>
<section id="children-raise">
<h2>在上述代码中，如果之前没有填充children，则访问属性将引发异常。这包括读取访问，但对于集合来说也影响了写访问，因为集合不能在不加载它们的情况下进行变更。这样做的原因是确保应用程序在某个上下文中不会发出任何意外的懒惰加载。使用raise策略<a class="headerlink" href="#children-raise" title="Permalink to this heading">¶</a></h2>
<p>为了避免阅读SQL日志以确定是否已经提前加载了所有必要的属性，”raise”策略将导致如果访问时未加载属性的话会立即抛出异常。 使用:func: <a href="#id38"><span class="problematic" id="id39">`</span></a>_orm.raiseload`加载选项的查询选项也可以基于raise策略。</p>
</section>
<section id="id40">
<h2>使用被动删除<a class="headerlink" href="#id40" title="Permalink to this heading">¶</a></h2>
<p>SQLAlchemy中集合管理的重要方面是，当引用集合的对象被删除时，SQLAlchemy需要考虑到位于该集合内部的对象。这些对象需要从父对象中解除关联，对于一个一对多的集合来说，这意味着外键列将设置为NULL，或者基于:ref:<a href="#id41"><span class="problematic" id="id42">`</span></a>cascade &lt;unitofwork_cascades&gt;`设置，可能希望为这些行发出一个DELETE语句。</p>
<p>:term:<a href="#id43"><span class="problematic" id="id44">`</span></a>工作单元`进程只考虑逐行操作对象，这意味着DELETE操作意味着集合中的所有行必须在刷新过程中完全加载到内存中。对于大型集合来说，这是不可行的，所以我们将寻求依赖于数据库自己的能力来自动更新或删除行，使用外键ON DELETE规则，指导工作单元在处理时不需要实际加载这些行。可以通过在:func: <a href="#id45"><span class="problematic" id="id46">`</span></a>_orm.relationship`构造上配置:paramref:<a href="#id47"><span class="problematic" id="id48">`</span></a>_orm.relationship.passive_deletes`来指示工作单元以这种方式工作;同时要正确配置正在使用的外键约束。</p>
<p>有关完整的”passive delete”配置的进一步细节，请参见:ref:<a href="#id49"><span class="problematic" id="id50">`</span></a>passive_deletes`节。</p>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="join_conditions.html" title="previous chapter">配置 Relationship Joins</a>
        Next:
        <a href="collection_api.html" title="next chapter">集合订制和API详细信息</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 9:20:02

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


