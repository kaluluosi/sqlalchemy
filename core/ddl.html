<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    自定义 DDL
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="模式定义语言 (Schema Definition Language)" href="schema.html" />
        <link rel="next" title="SQL 数据类型对象" href="types.html" />
        <link rel="prev" title="定义约束和索引" href="constraints.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy 核心">SQLAlchemy 核心</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="expression_api.html">SQL语句和表达式API</a></span></li>
<li><span class="link-container"><a class="reference external" href="schema.html">模式定义语言 (Schema Definition Language)</a></span><ul>
<li><span class="link-container"><a class="reference external" href="metadata.html">使用MetaData描述数据库</a></span></li>
<li><span class="link-container"><a class="reference external" href="reflection.html">从数据库反射对象</a></span></li>
<li><span class="link-container"><a class="reference external" href="defaults.html">列INSERT/UPDATE默认值</a></span></li>
<li><span class="link-container"><a class="reference external" href="constraints.html">定义约束和索引</a></span></li>
<li class="selected"><span class="link-container"><strong>自定义 DDL</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id7">用户自定义 DDL</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id8">控制 DDL 序列</a></span></li>
<li><span class="link-container"><a class="reference external" href="#ddlelement">使用内置 DDLElement 类</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id9">控制约束和索引的 DDL 生成</a></span></li>
<li><span class="link-container"><a class="reference external" href="#ddl-api">DDL 表达式构造 API</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="types.html">SQL 数据类型对象</a></span></li>
<li><span class="link-container"><a class="reference external" href="engines_connections.html">引擎与连接使用</a></span></li>
<li><span class="link-container"><a class="reference external" href="api_basics.html">Core API基础知识</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="constraints.html" title="previous chapter">定义约束和索引</a></li>
                <li><b>Next:</b>
                <a href="types.html" title="next chapter">SQL 数据类型对象</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy 核心">SQLAlchemy 核心</a></li>
                    <ul><li><a href="schema.html" title="模式定义语言 (Schema Definition Language)">模式定义语言 (Schema Definition Language)</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#ddl">自定义 DDL</a><ul>
<li><a class="reference internal" href="#id7">用户自定义 DDL</a></li>
<li><a class="reference internal" href="#id8">控制 DDL 序列</a></li>
<li><a class="reference internal" href="#ddlelement">使用内置 DDLElement 类</a></li>
<li><a class="reference internal" href="#id9">控制约束和索引的 DDL 生成</a></li>
<li><a class="reference internal" href="#ddl-api">DDL 表达式构造 API</a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar core-ddl" >
        
<section id="ddl">
<h1>自定义 DDL<a class="headerlink" href="#ddl" title="Permalink to this heading">¶</a></h1>
<dl>
<dt>在前面的章节中，我们讨论了许多模式构造，包括  <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 、</dt><dd><p><a class="reference internal" href="constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> 、
<a class="reference internal" href="constraints.html#sqlalchemy.schema.CheckConstraint" title="sqlalchemy.schema.CheckConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">CheckConstraint</span></code></a> ~sqlalchemy.schema.Sequence`。</p>
</dd>
<dt>在整个过程中，我们都依赖于 :class:<a href="#id1"><span class="problematic" id="id2">`</span></a>~sqlalchemy.schema.Table`和</dt><dd><blockquote>
<div><p><a class="reference internal" href="metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> <a href="#id3"><span class="problematic" id="id4">`</span></a>create()``和</p>
</div></blockquote>
<p>:func:<a href="#id5"><span class="problematic" id="id6">`</span></a>~sqlalchemy.schema.MetaData.create_all`方法来发出数据定义语言 (DDL)，以便创建所</p>
</dd>
</dl>
<p>有构造的视图。当发出时，会调用一个预定义的操作顺序，并创建用于创建每张表的DDL，包括所
有与之相关的约束和其他对象。对于需要特定于数据库的DDL的更复杂场景，SQLAlchemy提供了
两种技术，可以用于添加任何DDL，基于任何条件，要么随着表的标准生成，要么仅仅是DDL自
身。</p>
<section id="id7">
<h2>用户自定义 DDL<a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h2>
<p>最简单的自定义 DDL 语句是使用   <code class="xref py py-class docutils literal notranslate"><span class="pre">DDL</span></code> 。该构造类似于所有其他 DDL
元素，只不过它接受一个字符串，即要发出的文本：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="s2">&quot;after_create&quot;</span><span class="p">,</span>
    <span class="n">DDL</span><span class="p">(</span>
        <span class="s2">&quot;ALTER TABLE users ADD CONSTRAINT &quot;</span>
        <span class="s2">&quot;cst_user_name_length &quot;</span>
        <span class="s2">&quot; CHECK (length(user_name) &gt;= 8)&quot;</span>
    <span class="p">),</span>
<span class="p">)</span></pre></div>
</div>
<dl class="simple">
<dt>创建 DDL 库的更全面的方法是使用自定义编译 - 有关详细信息，请参见</dt><dd><p><span class="xref std std-ref">sqlalchemy.ext.compiler_toplevel</span> 。</p>
</dd>
</dl>
</section>
<section id="id8">
<h2>控制 DDL 序列<a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h2>
<p>前面介绍的   <code class="xref py py-class docutils literal notranslate"><span class="pre">DDL</span></code>  元素也可以根据数据库的检查而有条件地调用。需要使
用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">ExecutableDDLElement.execute_if()</span></code>  方法。例如，如果我们想创建触发器，但仅在
PostgreSQL 后端上，我们可以这样调用：</p>
<blockquote>
<div><blockquote>
<div><dl class="simple">
<dt>mytable = Table(</dt><dd><p>“mytable”,
metadata,
Column(“id”, Integer, primary_key=True),
Column(“data”, String(50)),</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>func = DDL(</dt><dd><p>“CREATE FUNCTION my_func() ”
“RETURNS TRIGGER AS $$ ”
“BEGIN ”
“NEW.data := ‘ins’; ”
“RETURN NEW; ”
“END; $$ LANGUAGE PLPGSQL”</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>trigger = DDL(</dt><dd><p>“CREATE TRIGGER dt_ins BEFORE INSERT ON mytable ”
“FOR EACH ROW EXECUTE PROCEDURE my_func();”</p>
</dd>
</dl>
<p>)</p>
<p>event.listen(mytable, “after_create”, func.execute_if(dialect=”postgresql”))</p>
<p>event.listen(mytable, “after_create”, trigger.execute_if(dialect=”postgresql”))</p>
</div></blockquote>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">execute_if.dialect()</span></code>  关键字也接受一组字符串方言名称：</p>
<blockquote>
<div><dl class="simple">
<dt>event.listen(</dt><dd><p>mytable, “after_create”, trigger.execute_if(dialect=(“postgresql”, “mysql”))</p>
</dd>
</dl>
<p>)
event.listen(</p>
<blockquote>
<div><p>mytable, “before_drop”, trigger.execute_if(dialect=(“postgresql”, “mysql”))</p>
</div></blockquote>
<p>)</p>
</div></blockquote>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">ExecutableDDLElement.execute_if()</span></code>  方法也可以针对将使用数据库连接的可调用函数，例如，</p>
</div></blockquote>
<p>在下面的示例中，我们使用此功能有条件地创建 CHECK 约束，首先在 PostgreSQL 目录中查找
它是否存在：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">should_create</span><span class="p">(</span><span class="n">ddl</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;select conname from pg_constraint where conname=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">ddl</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">name</span>
    <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">bool</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">should_drop</span><span class="p">(</span><span class="n">ddl</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">should_create</span><span class="p">(</span><span class="n">ddl</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
    <span class="n">users</span><span class="p">,</span>
    <span class="s2">&quot;after_create&quot;</span><span class="p">,</span>
    <span class="n">DDL</span><span class="p">(</span>
        <span class="s2">&quot;ALTER TABLE users ADD CONSTRAINT &quot;</span>
        <span class="s2">&quot;cst_user_name_length CHECK (length(user_name) &gt;= 8)&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">execute_if</span><span class="p">(</span><span class="n">callable_</span><span class="o">=</span><span class="n">should_create</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
    <span class="n">users</span><span class="p">,</span>
    <span class="s2">&quot;before_drop&quot;</span><span class="p">,</span>
    <span class="n">DDL</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE users DROP CONSTRAINT cst_user_name_length&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute_if</span><span class="p">(</span>
        <span class="n">callable_</span><span class="o">=</span><span class="n">should_drop</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">users</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<div class='show_sql'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">conname</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_constraint</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">conname</span><span class="o">=</span><span class="s1">&#39;cst_user_name_length&#39;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">cst_user_name_length</span><span class="w">  </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
</div><span class="n">users</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">conname</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_constraint</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">conname</span><span class="o">=</span><span class="s1">&#39;cst_user_name_length&#39;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">cst_user_name_length</span>
<span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span>
</div></pre></div>
</div>
</section>
<section id="ddlelement">
<h2>使用内置 DDLElement 类<a class="headerlink" href="#ddlelement" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">sqlalchemy.schema</span></code> 包包含 SQL 表达式构造，这些构造提供了 DDL 表达式，所有这些构造都扩展
自公共基类  <code class="xref py py-class docutils literal notranslate"><span class="pre">ExecutableDDLElement</span></code> 。例如，要生成``CREATE TABLE``语句，可以使用</p>
<blockquote>
<div><p><code class="xref py py-class docutils literal notranslate"><span class="pre">CreateTable</span></code>  构造：</p>
</div></blockquote>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">CreateTable</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">mytable</span><span class="p">))</span>
<div class='show_sql'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">mytable</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">col1</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">col2</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">col3</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">col4</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">col5</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">col6</span><span class="w"> </span><span class="nb">INTEGER</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>上面的  <code class="xref py py-class docutils literal notranslate"><span class="pre">CreateTable</span></code>  构造像其他任何表达式构造一样工作（例如``select()``
、<code class="docutils literal notranslate"><span class="pre">table.insert()</span></code>
等）。所有 SQLAlchemy 的 DDL 导向构造都是   <code class="xref py py-class docutils literal notranslate"><span class="pre">ExecutableDDLElement</span></code>  基类的子类；这
是所有对应 CREATE和 DROP 的对象的基础，不仅在 SQLAlchemy 中，而且在 Alembic 迁移中也是如此。
可用构造的完整参考在   <a class="reference internal" href="#schema-api-ddl"><span class="std std-ref">DDL 表达式构造 API</span></a>  中。</p>
<p>用户定义的 DDL 构造也可以作为  <code class="xref py py-class docutils literal notranslate"><span class="pre">ExecutableDDLElement</span></code>  的子类进行创建。参见   <span class="xref std std-ref">sqlalchemy.ext.compiler_toplevel</span>  中的几个示例。</p>
</section>
<section id="id9">
<h2>控制约束和索引的 DDL 生成<a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.</span></p>
</div>
<dl class="simple">
<dt>虽然先前提到的  <code class="xref py py-meth docutils literal notranslate"><span class="pre">ExecutableDDLElement.execute_if()</span></code>  方法对于需要有条件地调用的自定义</dt><dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">DDL</span></code>  类非常有用，但约束和索引通常与特定的   <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  相关联，即它们也应</p>
</dd>
</dl>
<p>该遵循”条件”规则，
例如包含特定于特定后端的功能，例如 PostgreSQL 或 SQL Server 的索引。对于这种用例，</p>
<blockquote>
<div><p><a class="reference internal" href="constraints.html#sqlalchemy.schema.Constraint.ddl_if" title="sqlalchemy.schema.Constraint.ddl_if"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Constraint.ddl_if()</span></code></a>   和  <a class="reference internal" href="constraints.html#sqlalchemy.schema.Index.ddl_if" title="sqlalchemy.schema.Index.ddl_if"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Index.ddl_if()</span></code></a>  方法可能会针对 :
<a class="reference internal" href="constraints.html#sqlalchemy.schema.CheckConstraint" title="sqlalchemy.schema.CheckConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">CheckConstraint</span></code></a> 、
<a class="reference internal" href="constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a>  和   <a class="reference internal" href="constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a>  等构造，接受与
<code class="xref py py-meth docutils literal notranslate"><span class="pre">ExecutableDDLElement.execute_if()</span></code>   方法相同的参数，以控制它们是否会根据其父
<a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  对象发出DDL。这些方法可以在创建   <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  的定义时内联使用</p>
</div></blockquote>
<p>（或类似地，在 ORM 声明性映射的 <code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> 集合中使用）, 如下所示：</p>
<blockquote>
<div><p>from sqlalchemy import CheckConstraint, Index
from sqlalchemy import MetaData, Table, Column
from sqlalchemy import Integer, String</p>
<p>meta = MetaData()</p>
<dl class="simple">
<dt>my_table = Table(</dt><dd><p>“my_table”,
meta,
Column(“id”, Integer, primary_key=True),
Column(“num”, Integer),
Column(“data”, String),
Index(“my_pg_index”, “data”).ddl_if(dialect=”postgresql”),
CheckConstraint(“num &gt; 5”).ddl_if(dialect=”postgresql”),</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<dl class="simple">
<dt>在上面的示例中，  <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  构造引用了一个  <a class="reference internal" href="constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a>  和一个</dt><dd><p><a class="reference internal" href="constraints.html#sqlalchemy.schema.CheckConstraint" title="sqlalchemy.schema.CheckConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">CheckConstraint</span></code></a>  构造，两者都表示使用了``.ddl_if(dialect=”postgresql”)``，这</p>
</dd>
</dl>
<p>表示这些元素仅会针对 PostgreSQL 方言包含在 CREATE TABLE 序列中。例如，如果我们针对 SQLite 方言运行
<code class="docutils literal notranslate"><span class="pre">meta.create_all()</span></code>，则两个构造都不包含在内：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sqlite_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite+pysqlite://&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">meta</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">sqlite_engine</span><span class="p">)</span>
<div class='show_sql'><span class="k">BEGIN</span><span class="w"> </span><span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="n">PRAGMA</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">table_info</span><span class="p">(</span><span class="ss">&quot;my_table&quot;</span><span class="p">)</span>
<span class="p">[</span><span class="n">raw</span><span class="w"> </span><span class="k">sql</span><span class="p">]</span><span class="w"> </span><span class="p">()</span>
<span class="n">PRAGMA</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">table_info</span><span class="p">(</span><span class="ss">&quot;my_table&quot;</span><span class="p">)</span>
<span class="p">[</span><span class="n">raw</span><span class="w"> </span><span class="k">sql</span><span class="p">]</span><span class="w"> </span><span class="p">()</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">my_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">num</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">data</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>但是，如果我们将相同的命令针对 PostgreSQL 数据库运行，则将看到 CHECK 约束的内联 DDL 构造，
以及单独的 CREATE 语句针对索引发出：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">  &gt;&gt;&gt; from sqlalchemy import create_engine</span>
<span class="go">  &gt;&gt;&gt; postgresql_engine = create_engine(</span>
<span class="go">  ...     &quot;postgresql+psycopg2://scott:tiger@localhost/test&quot;, echo=True</span>
<span class="go">  ... )</span>
<span class="go">  &gt;&gt;&gt; meta.create_all(postgresql_engine)</span>
<span class="go">  {execsql}BEGIN (implicit)</span>
<span class="go">  select relname from pg_class c join pg_namespace n on n.oid=c.relnamespace where pg_catalog.pg_table_is_visible(c.oid) and relname=%(name)s</span>
<span class="go">  [generated in 0.00009s] {&#39;name&#39;: &#39;my_table&#39;}</span>

<span class="go">  CREATE TABLE my_table (</span>
<span class="go">      id SERIAL NOT NULL,</span>
<span class="go">      num INTEGER,</span>
<span class="go">      data VARCHAR,</span>
<span class="go">      PRIMARY KEY (id),</span>
<span class="go">      CHECK (num &gt; 5)</span>
<span class="go">  )</span>
<span class="go">  [no key 0.00007s] {}</span>
<span class="go">  CREATE INDEX my_pg_index ON my_table (data)</span>
<span class="go">  [no key 0.00013s] {}</span>
<span class="go">  COMMIT</span>

<span class="go">:meth:`.Constraint.ddl_if`   和  :meth:`.Index.ddl_if`  方法创建一个事件挂钩，该挂钩可以不仅在</span></pre></div>
</div>
<p>DDL 执行时间上进行参考，就像  <code class="xref py py-meth docutils literal notranslate"><span class="pre">ExecutableDDLElement.execute_if()</span></code>  的行为一样，而
且还可以在   <code class="xref py py-class docutils literal notranslate"><span class="pre">CreateTable</span></code>  对象的 SQL 编译阶段中进行查看，该对象负责渲染
<code class="docutils literal notranslate"><span class="pre">CHECK</span> <span class="pre">(num</span> <span class="pre">&gt;</span> <span class="pre">5)</span></code> DDL 在 CREATE TABLE 语句中内联。因此，  <code class="xref py py-meth docutils literal notranslate"><span class="pre">ddl_if.callable_()</span></code>
参数接收到的事件挂钩具有更丰富的参数集，其中包括传递了``dialect`` 关键字参数，以及类</p>
<blockquote>
<div><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">DDLCompiler()</span></code>   的实例通过“编译器”关键字参数进行内联呈现。当在  <code class="xref py py-meth docutils literal notranslate"><span class="pre">DDLCompiler()</span></code></p>
</div></blockquote>
<p>序列内触发事件时，<code class="docutils literal notranslate"><span class="pre">bind</span></code> 参数**不**存在，因此希望检查数据库版本信息的现代事件挂钩最好使
用给定的   <a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a>  对象，例如测试 PostgreSQL 版本：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">only_pg_14</span><span class="p">(</span><span class="n">ddl_element</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;postgresql&quot;</span> <span class="ow">and</span> <span class="n">dialect</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,)</span>


<span class="n">my_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;my_table&quot;</span><span class="p">,</span>
    <span class="n">meta</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;my_pg_index&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ddl_if</span><span class="p">(</span><span class="n">callable_</span><span class="o">=</span><span class="n">only_pg_14</span><span class="p">),</span>
<span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="constraints.html#sqlalchemy.schema.Constraint.ddl_if" title="sqlalchemy.schema.Constraint.ddl_if"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Constraint.ddl_if()</span></code></a></p>
<p><a class="reference internal" href="constraints.html#sqlalchemy.schema.Index.ddl_if" title="sqlalchemy.schema.Index.ddl_if"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Index.ddl_if()</span></code></a></p>
</div>
</section>
<section id="ddl-api">
<span id="schema-api-ddl"></span><h2>DDL 表达式构造 API<a class="headerlink" href="#ddl-api" title="Permalink to this heading">¶</a></h2>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="constraints.html" title="previous chapter">定义约束和索引</a>
        Next:
        <a href="types.html" title="next chapter">SQL 数据类型对象</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 18:43:44

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


