<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    事件注册
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="核心API基础知识" href="api_basics.html" />
        <link rel="next" title="运行时检查API" href="inspection.html" />
        <link rel="prev" title="核心API基础知识" href="api_basics.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy核心模块">SQLAlchemy核心模块</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="expression_api.html">SQL语句和表达式API</a></span></li>
<li><span class="link-container"><a class="reference external" href="schema.html">Schema定义语言</a></span></li>
<li><span class="link-container"><a class="reference external" href="types.html">SQL数据库类型对象</a></span></li>
<li><span class="link-container"><a class="reference external" href="engines_connections.html">引擎和连接使用</a></span></li>
<li><span class="link-container"><a class="reference external" href="api_basics.html">核心API基础知识</a></span><ul>
<li class="selected"><span class="link-container"><strong>事件注册</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span></li>
<li><span class="link-container"><a class="reference external" href="#event-named-argument-styles">命名参数风格</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id9">目标</a></span></li>
<li><span class="link-container"><a class="reference external" href="#event-modifiers">修饰符</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id15">事件参考</a></span></li>
<li><span class="link-container"><a class="reference external" href="#api">API</a></span></li>
<li><span class="link-container"><a class="reference external" href="inspection.html">运行时检查API</a></span></li>
<li><span class="link-container"><a class="reference external" href="exceptions.html">核心异常</a></span></li>
<li><span class="link-container"><a class="reference external" href="internals.html">核心内部</a></span></li>
</ul>
</li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="api_basics.html" title="previous chapter">核心API基础知识</a></li>
                <li><b>Next:</b>
                <a href="inspection.html" title="next chapter">运行时检查API</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy核心模块">SQLAlchemy核心模块</a></li>
                    <ul><li><a href="api_basics.html" title="核心API基础知识">核心API基础知识</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#id1">事件注册</a></li>
<li><a class="reference internal" href="#event-named-argument-styles">命名参数风格</a></li>
<li><a class="reference internal" href="#id9">目标</a></li>
<li><a class="reference internal" href="#event-modifiers">修饰符</a></li>
<li><a class="reference internal" href="#id15">事件参考</a></li>
<li><a class="reference internal" href="#api">API</a><ul>
<li><a class="reference internal" href="#sqlalchemy.event.listen"><code class="docutils literal notranslate"><span class="pre">listen()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.event.listens_for"><code class="docutils literal notranslate"><span class="pre">listens_for()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.event.remove"><code class="docutils literal notranslate"><span class="pre">remove()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.event.contains"><code class="docutils literal notranslate"><span class="pre">contains()</span></code></a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar core-event" >
        
<p id="event-toplevel">事件
===</p>
<p>SQLAlchemy自带一个事件API，发布了各种钩子，包括对SQLAlchemy核心和ORM内部的钩子。</p>
<section id="id1">
<h1>事件注册<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h1>
<p>订阅事件是通过一个API点完成的：：func：` .listen`函数或者alternatively的：func：` .listens_for`。这些函数接受目标，一个标识符，用于标识要拦截的事件，和一个用户定义的监听函数。这两个函数的附加位置和关键字参数可以由特定类型的事件支持，这些事件可以指定给定事件函数的替代接口，或者根据给定目标提供关于二级事件目标的说明。</p>
<p>事件的名称和相应的监听函数的参数签名源自一个绑定到标记类的规范化方法，该标记类在文档中描述。例如, <code class="xref py py-meth docutils literal notranslate"><span class="pre">PoolEvents.connect`的文档表明事件名称为`()</span></code>”connect”<a href="#id2"><span class="problematic" id="id3">``</span></a>,并且用户定义的监听函数应该接收两个位置参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.event</span> <span class="kn">import</span> <span class="n">listen</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="kn">import</span> <span class="n">Pool</span>


<span class="k">def</span> <span class="nf">my_on_connect</span><span class="p">(</span><span class="n">dbapi_con</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&quot;New DBAPI connection:&quot;</span><span class="p">,</span> <span class="n">dbapi_con</span><span class="p">)</span>


<span class="n">listen</span><span class="p">(</span><span class="n">Pool</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="n">my_on_connect</span><span class="p">)</span></pre></div>
</div>
<p>使用:func: <a href="#id4"><span class="problematic" id="id5">`</span></a>.listens_for`装饰器进行监听,如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.event</span> <span class="kn">import</span> <span class="n">listens_for</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="kn">import</span> <span class="n">Pool</span>


<span class="nd">@listens_for</span><span class="p">(</span><span class="n">Pool</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_on_connect</span><span class="p">(</span><span class="n">dbapi_con</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&quot;New DBAPI connection:&quot;</span><span class="p">,</span> <span class="n">dbapi_con</span><span class="p">)</span></pre></div>
</div>
</section>
<section id="event-named-argument-styles">
<span id="id6"></span><h1>命名参数风格<a class="headerlink" href="#event-named-argument-styles" title="Permalink to this heading">¶</a></h1>
<p>有一些参数风格的变化可以被监听函数所接受。
以:meth:<cite>_events.PoolEvents.connect`为例，此函数
记录为接收“dbapi_connection”和“connection_record”参数.
我们可以选择通过名称接收这些参数，建立一个监听器函数
接受``**keyword``参数，通过传递``named=True``来实现
:func:</cite>.listen` 或:func:<cite>.listens_for</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.event</span> <span class="kn">import</span> <span class="n">listens_for</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="kn">import</span> <span class="n">Pool</span>


<span class="nd">@listens_for</span><span class="p">(</span><span class="n">Pool</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_on_connect</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&quot;New DBAPI connection:&quot;</span><span class="p">,</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;dbapi_connection&quot;</span><span class="p">])</span></pre></div>
</div>
<p>使用命名参数传递时，参数规范中列出的名称将用作字典中的键。</p>
<p>命名风格将所有参数按名称传递，而不考虑函数签名，因此也可以列出特定参数，以任何顺序，只要名称匹配即可:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.event</span> <span class="kn">import</span> <span class="n">listens_for</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="kn">import</span> <span class="n">Pool</span>


<span class="nd">@listens_for</span><span class="p">(</span><span class="n">Pool</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_on_connect</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&quot;New DBAPI connection:&quot;</span><span class="p">,</span> <span class="n">dbapi_connection</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&quot;Connection record:&quot;</span><span class="p">,</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;connection_record&quot;</span><span class="p">])</span></pre></div>
</div>
<p>上述代码中，“<a href="#id7"><span class="problematic" id="id8">**</span></a>kw”的存在告诉:func:<cite>.listens_for</cite>，应该通过名称将参数传递给函数，而不是按顺序传递。</p>
</section>
<section id="id9">
<h1>目标<a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">func<span class="colon">:</span></dt>
<dd class="field-odd"><p><cite>.listen</cite> 函数针对目标非常灵活。它</p>
</dd>
</dl>
<p>通常接受类，这些类的实例和相关的
类或对象，可以从中推导出适当的目标。
例如，上面提到的“connect”事件接受
中的:class:<a href="#id10"><span class="problematic" id="id11">`</span></a>_engine.Engine`类和对象，以及:class:<a href="#id12"><span class="problematic" id="id13">`</span></a>_pool.Pool`类和对象</p>
<blockquote>
<div><p>from sqlalchemy.event import listen
from sqlalchemy.pool import Pool, QueuePool
from sqlalchemy import create_engine
from sqlalchemy.engine import Engine
import psycopg2</p>
<dl class="simple">
<dt>def connect():</dt><dd><p>return psycopg2.connect(user=”ed”, host=”127.0.0.1”, dbname=”test”)</p>
</dd>
</dl>
<p>my_pool = QueuePool(connect)
my_engine = create_engine(“postgresql+psycopg2://ed&#64;localhost/test”)</p>
<p># associate listener with all instances of Pool
listen(Pool, “connect”, my_on_connect)</p>
<p># associate listener with all instances of Pool
# via the Engine class
listen(Engine, “connect”, my_on_connect)</p>
<p># associate listener with my_pool
listen(my_pool, “connect”, my_on_connect)</p>
<p># associate listener with my_engine.pool
listen(my_engine, “connect”, my_on_connect)</p>
</div></blockquote>
</section>
<section id="event-modifiers">
<span id="id14"></span><h1>修饰符<a class="headerlink" href="#event-modifiers" title="Permalink to this heading">¶</a></h1>
<p>一些监听器允许向:func:<cite>.listen`传递修饰符。
这些修饰符有时提供了替代调用签名的方法
侦听器。就像ORM事件一样，一些事件监听器可以有一个
返回值来修改后续处理。默认情况下，没有
听众需要返回值，但通过传递``retval=True`</cite>
可以支持这个值:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate_phone</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">oldvalue</span><span class="p">,</span> <span class="n">initiator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strip non-numeric characters from a phone number&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\D&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="c1"># setup listener on UserContact.phone attribute, instructing</span>
<span class="c1"># it to use the return value</span>
<span class="n">listen</span><span class="p">(</span><span class="n">UserContact</span><span class="o">.</span><span class="n">phone</span><span class="p">,</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="n">validate_phone</span><span class="p">,</span> <span class="n">retval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
</section>
<section id="id15">
<h1>事件参考<a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h1>
<p>SQLAlchemy Core和SQLAlchemy ORM都具有各种事件钩子:</p>
<ul class="simple">
<li><p><strong>核心事件</strong> - 这些在中描述</p></li>
</ul>
<p>  :ref:<a href="#id16"><span class="problematic" id="id17">`</span></a>core_event_toplevel`并包括特定于的事件钩子
  连接池生命周期，SQL语句执行，
  事务生命周期和模式创建和拆除。</p>
<ul class="simple">
<li><p><strong>ORM事件</strong> - 这些在中描述</p></li>
</ul>
<p>  <a class="reference internal" href="../orm/events.html"><span class="std std-ref">ORM 事件</span></a> 并包括特定于的事件钩子
  类和属性插装，对象初始化
  钩子， 属性更改钩子，会话状态，流，以及
  提交挂钩，映射器初始化，对象/结果填充，
  以及每个实例的持久性钩子。</p>
</section>
<section id="api">
<h1>API<a class="headerlink" href="#api" title="Permalink to this heading">¶</a></h1>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.event.contains"><span class="sig-name descname">contains</span></a>(target, identifier, fn)</p></td>
<td><p>Return True if the given target/ident/fn is set up to listen.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.event.listen"><span class="sig-name descname">listen</span></a>(target, identifier, fn, *args, **kw)</p></td>
<td><p>Register a listener function for the given target.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.event.listens_for"><span class="sig-name descname">listens_for</span></a>(target, identifier, *args, **kw)</p></td>
<td><p>Decorate a function as a listener for the given target + identifier.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.event.remove"><span class="sig-name descname">remove</span></a>(target, identifier, fn)</p></td>
<td><p>Remove an event listener.</p></td>
</tr>
</tbody>
</table>
<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.event.listen">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.event.</span></span><span class="sig-name descname"><span class="pre">listen</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">target</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">identifier</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fn</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kw</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.event.listen" title="Permalink to this definition">¶</a></dt>
<dd><p>Register a listener function for the given target.</p>
<p>The <a class="reference internal" href="#sqlalchemy.event.listen" title="sqlalchemy.event.listen"><code class="xref py py-func docutils literal notranslate"><span class="pre">listen()</span></code></a> function is part of the primary interface for the
SQLAlchemy event system, documented at <span class="xref std std-ref">event_toplevel</span>.</p>
<p>e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">UniqueConstraint</span>

<span class="k">def</span> <span class="nf">unique_constraint_name</span><span class="p">(</span><span class="n">const</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="n">const</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;uq_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
    <span class="p">)</span>
<span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">,</span>
        <span class="s2">&quot;after_parent_attach&quot;</span><span class="p">,</span>
        <span class="n">unique_constraint_name</span><span class="p">)</span></pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.event.listen.params.insert"></span><strong>insert</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.event.listen.params.insert">¶</a> (<em>bool</em>) – The default behavior for event handlers is to append
the decorated user defined function to an internal list of registered
event listeners upon discovery. If a user registers a function with
<code class="docutils literal notranslate"><span class="pre">insert=True</span></code>, SQLAlchemy will insert (prepend) the function to the
internal list upon discovery. This feature is not typically used or
recommended by the SQLAlchemy maintainers, but is provided to ensure
certain user defined functions can run before others, such as when
<a class="reference internal" href="../dialects/mysql.html#mysql-sql-mode"><span class="std std-ref">Changing the sql_mode in MySQL</span></a>.</p></li>
<li><p><span class="target" id="sqlalchemy.event.listen.params.named"></span><strong>named</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.event.listen.params.named">¶</a> (<em>bool</em>) – When using named argument passing, the names listed in
the function argument specification will be used as keys in the
dictionary.
See <a class="reference internal" href="#event-named-argument-styles"><span class="std std-ref">命名参数风格</span></a>.</p></li>
<li><p><span class="target" id="sqlalchemy.event.listen.params.once"></span><strong>once</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.event.listen.params.once">¶</a> (<em>bool</em>) – Private/Internal API usage. Deprecated.  This parameter
would provide that an event function would run only once per given
target. It does not however imply automatic de-registration of the
listener function; associating an arbitrarily high number of listeners
without explicitly removing them will cause memory to grow unbounded even
if <code class="docutils literal notranslate"><span class="pre">once=True</span></code> is specified.</p></li>
<li><p><span class="target" id="sqlalchemy.event.listen.params.propagate"></span><strong>propagate</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.event.listen.params.propagate">¶</a> (<em>bool</em>) – The <code class="docutils literal notranslate"><span class="pre">propagate</span></code> kwarg is available when working
with ORM instrumentation and mapping events.
See <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.MapperEvents" title="sqlalchemy.orm.MapperEvents"><code class="xref py py-class docutils literal notranslate"><span class="pre">MapperEvents</span></code></a> and
<a class="reference internal" href="../orm/events.html#sqlalchemy.orm.MapperEvents.before_mapper_configured" title="sqlalchemy.orm.MapperEvents.before_mapper_configured"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MapperEvents.before_mapper_configured()</span></code></a> for examples.</p></li>
<li><p><span class="target" id="sqlalchemy.event.listen.params.retval"></span><strong>retval</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.event.listen.params.retval">¶</a> (<em>bool</em>) – <p>This flag applies only to specific event listeners,
each of which includes documentation explaining when it should be used.
By default, no listener ever requires a return value.
However, some listeners do support special behaviors for return values,
and include in their documentation that the <code class="docutils literal notranslate"><span class="pre">retval=True</span></code> flag is
necessary for a return value to be processed.</p>
<p>Event listener suites that make use of <a class="reference internal" href="#sqlalchemy.event.listen.params.retval" title="sqlalchemy.event.listen"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">listen.retval</span></code></a>
include <a class="reference internal" href="events.html#sqlalchemy.events.ConnectionEvents" title="sqlalchemy.events.ConnectionEvents"><code class="xref py py-class docutils literal notranslate"><span class="pre">ConnectionEvents</span></code></a> and
<a class="reference internal" href="../orm/events.html#sqlalchemy.orm.AttributeEvents" title="sqlalchemy.orm.AttributeEvents"><code class="xref py py-class docutils literal notranslate"><span class="pre">AttributeEvents</span></code></a>.</p>
</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference internal" href="#sqlalchemy.event.listen" title="sqlalchemy.event.listen"><code class="xref py py-func docutils literal notranslate"><span class="pre">listen()</span></code></a> function cannot be called at the same time
that the target event is being run.   This has implications
for thread safety, and also means an event cannot be added
from inside the listener function for itself.  The list of
events to be run are present inside of a mutable collection
that can’t be changed during iteration.</p>
<p>Event registration and removal is not intended to be a “high
velocity” operation; it is a configurational operation.  For
systems that need to quickly associate and deassociate with
events at high scale, use a mutable structure that is handled
from inside of a single listener.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.event.listens_for" title="sqlalchemy.event.listens_for"><code class="xref py py-func docutils literal notranslate"><span class="pre">listens_for()</span></code></a></p>
<p><a class="reference internal" href="#sqlalchemy.event.remove" title="sqlalchemy.event.remove"><code class="xref py py-func docutils literal notranslate"><span class="pre">remove()</span></code></a></p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.event.listens_for">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.event.</span></span><span class="sig-name descname"><span class="pre">listens_for</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">target</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">identifier</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kw</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.event.listens_for" title="Permalink to this definition">¶</a></dt>
<dd><p>Decorate a function as a listener for the given target + identifier.</p>
<p>The <a class="reference internal" href="#sqlalchemy.event.listens_for" title="sqlalchemy.event.listens_for"><code class="xref py py-func docutils literal notranslate"><span class="pre">listens_for()</span></code></a> decorator is part of the primary interface for the
SQLAlchemy event system, documented at <span class="xref std std-ref">event_toplevel</span>.</p>
<p>This function generally shares the same kwargs as <code class="xref py py-func docutils literal notranslate"><span class="pre">listens()</span></code>.</p>
<p>e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">UniqueConstraint</span>

<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">UniqueConstraint</span><span class="p">,</span> <span class="s2">&quot;after_parent_attach&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unique_constraint_name</span><span class="p">(</span><span class="n">const</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="n">const</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;uq_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">list</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
    <span class="p">)</span></pre></div>
</div>
<p>A given function can also be invoked for only the first invocation
of the event using the <code class="docutils literal notranslate"><span class="pre">once</span></code> argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Mapper</span><span class="p">,</span> <span class="s2">&quot;before_configure&quot;</span><span class="p">,</span> <span class="n">once</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">on_config</span><span class="p">():</span>
    <span class="n">do_config</span><span class="p">()</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">once</span></code> argument does not imply automatic de-registration
of the listener function after it has been invoked a first time; a
listener entry will remain associated with the target object.
Associating an arbitrarily high number of listeners without explicitly
removing them will cause memory to grow unbounded even if <code class="docutils literal notranslate"><span class="pre">once=True</span></code>
is specified.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.event.listen" title="sqlalchemy.event.listen"><code class="xref py py-func docutils literal notranslate"><span class="pre">listen()</span></code></a> - general description of event listening</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.event.remove">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.event.</span></span><span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">target</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">identifier</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fn</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.event.remove" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove an event listener.</p>
<p>The arguments here should match exactly those which were sent to
<a class="reference internal" href="#sqlalchemy.event.listen" title="sqlalchemy.event.listen"><code class="xref py py-func docutils literal notranslate"><span class="pre">listen()</span></code></a>; all the event registration which proceeded as a result
of this call will be reverted by calling <a class="reference internal" href="#sqlalchemy.event.remove" title="sqlalchemy.event.remove"><code class="xref py py-func docutils literal notranslate"><span class="pre">remove()</span></code></a> with the same
arguments.</p>
<p>e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># if a function was registered like this...</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">SomeMappedClass</span><span class="p">,</span> <span class="s2">&quot;before_insert&quot;</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_listener_function</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># ... it&#39;s removed like this</span>
<span class="n">event</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">SomeMappedClass</span><span class="p">,</span> <span class="s2">&quot;before_insert&quot;</span><span class="p">,</span> <span class="n">my_listener_function</span><span class="p">)</span></pre></div>
</div>
<p>Above, the listener function associated with <code class="docutils literal notranslate"><span class="pre">SomeMappedClass</span></code> was also
propagated to subclasses of <code class="docutils literal notranslate"><span class="pre">SomeMappedClass</span></code>; the <a class="reference internal" href="#sqlalchemy.event.remove" title="sqlalchemy.event.remove"><code class="xref py py-func docutils literal notranslate"><span class="pre">remove()</span></code></a>
function will revert all of these operations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference internal" href="#sqlalchemy.event.remove" title="sqlalchemy.event.remove"><code class="xref py py-func docutils literal notranslate"><span class="pre">remove()</span></code></a> function cannot be called at the same time
that the target event is being run.   This has implications
for thread safety, and also means an event cannot be removed
from inside the listener function for itself.  The list of
events to be run are present inside of a mutable collection
that can’t be changed during iteration.</p>
<p>Event registration and removal is not intended to be a “high
velocity” operation; it is a configurational operation.  For
systems that need to quickly associate and deassociate with
events at high scale, use a mutable structure that is handled
from inside of a single listener.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.event.listen" title="sqlalchemy.event.listen"><code class="xref py py-func docutils literal notranslate"><span class="pre">listen()</span></code></a></p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.event.contains">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.event.</span></span><span class="sig-name descname"><span class="pre">contains</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">target</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">identifier</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fn</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bool</span></span></span><a class="headerlink" href="#sqlalchemy.event.contains" title="Permalink to this definition">¶</a></dt>
<dd><p>Return True if the given target/ident/fn is set up to listen.</p>
</dd></dl>

</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="api_basics.html" title="previous chapter">核心API基础知识</a>
        Next:
        <a href="inspection.html" title="next chapter">运行时检查API</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 9:30:58

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


