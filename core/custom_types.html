<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    自定义类型
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="SQL 数据类型对象" href="types.html" />
        <link rel="next" title="数据库类型 API" href="type_api.html" />
        <link rel="prev" title="类型层次结构" href="type_basics.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy 核心">SQLAlchemy 核心</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="expression_api.html">SQL语句和表达式API</a></span></li>
<li><span class="link-container"><a class="reference external" href="schema.html">模式定义语言 (Schema Definition Language)</a></span></li>
<li><span class="link-container"><a class="reference external" href="types.html">SQL 数据类型对象</a></span><ul>
<li><span class="link-container"><a class="reference external" href="type_basics.html">类型层次结构</a></span></li>
<li class="selected"><span class="link-container"><strong>自定义类型</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id2">覆盖类型编译</a></span></li>
<li><span class="link-container"><a class="reference external" href="#types-typedecorator">增强现有类型</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.cache_ok"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.cache_ok</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.Comparator"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.Comparator.operate"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator.operate()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.Comparator.reverse_operate"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator.reverse_operate()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.__init__"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.__init__()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.bind_expression"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.bind_expression()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.bind_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.bind_processor()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.coerce_to_is_types"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.coerce_to_is_types</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.column_expression"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.column_expression()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.comparator_factory"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.comparator_factory</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.compare_values"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.compare_values()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.copy"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.copy()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.get_dbapi_type"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.get_dbapi_type()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.literal_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.literal_processor()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.load_dialect_impl()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.process_bind_param"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.process_literal_param"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_literal_param()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.process_result_value"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.result_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.result_processor()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.sort_key_function"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.sort_key_function</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.type_engine"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.type_engine()</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#typedecorator">TypeDecorator配方</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#unicode">强制编码字符串为Unicode</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id4">保留数字</a></span></li>
<li><span class="link-container"><a class="reference external" href="#utc">存储时区感知时间戳为时区感知的UTC</a></span></li>
<li><span class="link-container"><a class="reference external" href="#guid">跨数据库的GUID类型</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#python-uuid-uuid-orm">链接Python ``uuid.UUID``到ORM映射自定义类型</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#marshal-json-strings">Marshal JSON Strings</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id11">添加可变性</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id12">比较运算</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlbind-result">应用SQL级别的Bind/Result处理</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id15">创建新类型</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.UserDefinedType.cache_ok"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.cache_ok</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.UserDefinedType.coerce_compared_value"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.coerce_compared_value()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.UserDefinedType.ensure_kwarg"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.ensure_kwarg</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#custom-and-decorated-types-reflection">处理自定义类型和反射</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="type_api.html">数据库类型 API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="engines_connections.html">引擎与连接使用</a></span></li>
<li><span class="link-container"><a class="reference external" href="api_basics.html">Core API基础知识</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="type_basics.html" title="previous chapter">类型层次结构</a></li>
                <li><b>Next:</b>
                <a href="type_api.html" title="next chapter">数据库类型 API</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy 核心">SQLAlchemy 核心</a></li>
                    <ul><li><a href="types.html" title="SQL 数据类型对象">SQL 数据类型对象</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#types-custom">自定义类型</a><ul>
<li><a class="reference internal" href="#id2">覆盖类型编译</a></li>
<li><a class="reference internal" href="#types-typedecorator">增强现有类型</a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.cache_ok"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.cache_ok</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator.operate()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.reverse_operate"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator.reverse_operate()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.__init__"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.__init__()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.bind_expression"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.bind_expression()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.bind_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.bind_processor()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_to_is_types"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.coerce_to_is_types</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.column_expression"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.column_expression()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.comparator_factory"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.comparator_factory</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.compare_values"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.compare_values()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.copy"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.copy()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.get_dbapi_type"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.get_dbapi_type()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.literal_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.literal_processor()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.load_dialect_impl()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_literal_param"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_literal_param()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.result_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.result_processor()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.sort_key_function"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.sort_key_function</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.type_engine"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.type_engine()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#typedecorator">TypeDecorator配方</a><ul>
<li><a class="reference internal" href="#unicode">强制编码字符串为Unicode</a></li>
<li><a class="reference internal" href="#id4">保留数字</a></li>
<li><a class="reference internal" href="#utc">存储时区感知时间戳为时区感知的UTC</a></li>
<li><a class="reference internal" href="#guid">跨数据库的GUID类型</a><ul>
<li><a class="reference internal" href="#python-uuid-uuid-orm">链接Python ``uuid.UUID``到ORM映射自定义类型</a></li>
</ul>
</li>
<li><a class="reference internal" href="#marshal-json-strings">Marshal JSON Strings</a><ul>
<li><a class="reference internal" href="#id11">添加可变性</a></li>
<li><a class="reference internal" href="#id12">比较运算</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sqlbind-result">应用SQL级别的Bind/Result处理</a></li>
<li><a class="reference internal" href="#id15">创建新类型</a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.UserDefinedType.cache_ok"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.cache_ok</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.UserDefinedType.coerce_compared_value"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.coerce_compared_value()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.UserDefinedType.ensure_kwarg"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.ensure_kwarg</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#custom-and-decorated-types-reflection">处理自定义类型和反射</a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar core-custom_types" >
        
<section id="types-custom">
<span id="id1"></span><h1>自定义类型<a class="headerlink" href="#types-custom" title="Permalink to this heading">¶</a></h1>
<p>现有类型的行为有多种方法可以重新定义，同时也有办法提供新的类型。</p>
<section id="id2">
<h2>覆盖类型编译<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<p>经常需要强制类型的“字符串”版本，即在CREATE TABLE语句或其他SQL函数(如CAST)中呈现的版本改变。例如，应用程序可能想要强制对所有平台(除了一种以外)渲染二进制，其中需要渲染BLOB。对于大多数用例，建议使用现有的通用类型，例如  <a class="reference internal" href="type_basics.html#sqlalchemy.types.LargeBinary" title="sqlalchemy.types.LargeBinary"><code class="xref py py-class docutils literal notranslate"><span class="pre">LargeBinary</span></code></a> 。但是，为了更精确地控制类型，可以将针对每个dialect的编译指令与任何类型相关联:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="kn">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">BINARY</span>


<span class="nd">@compiles</span><span class="p">(</span><span class="n">BINARY</span><span class="p">,</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_binary_sqlite</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;BLOB&quot;</span></pre></div>
</div>
<p>上面的代码允许使用  <a class="reference internal" href="type_basics.html#sqlalchemy.types.BINARY" title="sqlalchemy.types.BINARY"><code class="xref py py-class docutils literal notranslate"><span class="pre">BINARY</span></code></a> ，该类型将在除SQLite外的所有后端中产生字符串”BINARY”，在SQLite的情况下，它将生成字符串”BLOB”。</p>
<p>查看 <span class="xref std std-ref">类型编译扩展</span> 关于更多例子的细节。</p>
</section>
<section id="types-typedecorator">
<span id="id3"></span><h2>增强现有类型<a class="headerlink" href="#types-typedecorator" title="Permalink to this heading">¶</a></h2>
<p>：class:<cite>.TypeDecorator`允许创建自定义类型，为现有类型添加绑定参数和结果处理行为。当需要在Python中进行额外的  :term:`marshalling</cite>  时，就会使用它，以及从数据库中。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> 的bind和结果处理是**附加**于托管的类型的处理，这个处理是根据DBAPI基础上来的。虽然可以通过直接子类化替换给定类型的处理，但实际上从不需要以这种方式，SQLAlchemy不再支持这种公共用例。</p>
</div>
<aside class="topic">
<p class="topic-title">ORM提示</p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> .validates` 装饰器。这种技术可能更适用于当业务情况需要规范化数据时，而不是与数据类型一样通用。</p>
</aside>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><span class="sig-name descname">TypeDecorator</span></a></p></td>
<td><p>Allows the creation of types which add additional functionality
to an existing type.</p></td>
</tr>
</tbody>
</table>
<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.types.</span></span><span class="sig-name descname"><span class="pre">TypeDecorator</span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows the creation of types which add additional functionality
to an existing type.</p>
<p>This method is preferred to direct subclassing of SQLAlchemy’s
built-in types as it ensures that all required functionality of
the underlying type is kept in place.</p>
<p>Typical usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy.types</span> <span class="k">as</span> <span class="nn">types</span>

<span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Prefixes Unicode values with &quot;PREFIX:&quot; on the way in and</span>
<span class="sd">    strips it off on the way out.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PREFIX:&quot;</span> <span class="o">+</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MyType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">length</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The class-level <code class="docutils literal notranslate"><span class="pre">impl</span></code> attribute is required, and can reference any
<a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> class.  Alternatively, the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl" title="sqlalchemy.types.TypeDecorator.load_dialect_impl"><code class="xref py py-meth docutils literal notranslate"><span class="pre">load_dialect_impl()</span></code></a>
method can be used to provide different type classes based on the dialect
given; in this case, the <code class="docutils literal notranslate"><span class="pre">impl</span></code> variable can reference
<code class="docutils literal notranslate"><span class="pre">TypeEngine</span></code> as a placeholder.</p>
<p>The <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.cache_ok" title="sqlalchemy.types.TypeDecorator.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TypeDecorator.cache_ok</span></code></a> class-level flag indicates if this
custom <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> is safe to be used as part of a cache key.
This flag defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code> which will initially generate a warning
when the SQL compiler attempts to generate a cache key for a statement
that uses this type.  If the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> is not guaranteed
to produce the same bind/result behavior and SQL generation
every time, this flag should be set to <code class="docutils literal notranslate"><span class="pre">False</span></code>; otherwise if the
class produces the same behavior each time, it may be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.
See <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.cache_ok" title="sqlalchemy.types.TypeDecorator.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TypeDecorator.cache_ok</span></code></a> for further notes on how this works.</p>
<p>Types that receive a Python type that isn’t similar to the ultimate type
used may want to define the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a>
method. This is used to give the expression system a hint when coercing
Python objects into bind parameters within expressions. Consider this
expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">somecol</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span></pre></div>
</div>
<p>Above, if “somecol” is an <code class="docutils literal notranslate"><span class="pre">Integer</span></code> variant, it makes sense that
we’re doing date arithmetic, where above is usually interpreted
by databases as adding a number of days to the given date.
The expression system does the right thing by not attempting to
coerce the “date()” value into an integer-oriented bind parameter.</p>
<p>However, in the case of <code class="docutils literal notranslate"><span class="pre">TypeDecorator</span></code>, we are usually changing an
incoming Python type to something new - <code class="docutils literal notranslate"><span class="pre">TypeDecorator</span></code> by default will
“coerce” the non-typed side to be the same type as itself. Such as below,
we define an “epoch” type that stores a date value as an integer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyEpochType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span>

    <span class="n">epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Our expression of <code class="docutils literal notranslate"><span class="pre">somecol</span> <span class="pre">+</span> <span class="pre">date</span></code> with the above type will coerce the
“date” on the right side to also be treated as <code class="docutils literal notranslate"><span class="pre">MyEpochType</span></code>.</p>
<p>This behavior can be overridden via the
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a> method, which returns a type
that should be used for the value of the expression. Below we set it such
that an integer value will be treated as an <code class="docutils literal notranslate"><span class="pre">Integer</span></code>, and any other
value is assumed to be a date and will be treated as a <code class="docutils literal notranslate"><span class="pre">MyEpochType</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">coerce_compared_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Integer</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note that the <strong>behavior of coerce_compared_value is not inherited
by default from that of the base type</strong>.
If the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> is augmenting a
type that requires special logic for certain types of operators,
this method <strong>must</strong> be overridden.  A key example is when decorating
the <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSONB</span></code></a> types;
the default rules of <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.coerce_compared_value" title="sqlalchemy.types.TypeEngine.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.coerce_compared_value()</span></code></a> should
be used in order to deal with operators like index operations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">TypeDecorator</span>

<span class="k">class</span> <span class="nc">MyJsonType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">JSON</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">coerce_compared_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">coerce_compared_value</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Without the above step, index operations such as <code class="docutils literal notranslate"><span class="pre">mycol['foo']</span></code>
will cause the index value <code class="docutils literal notranslate"><span class="pre">'foo'</span></code> to be JSON encoded.</p>
<p>Similarly, when working with the <a class="reference internal" href="type_basics.html#sqlalchemy.types.ARRAY" title="sqlalchemy.types.ARRAY"><code class="xref py py-class docutils literal notranslate"><span class="pre">ARRAY</span></code></a> datatype, the
type coercion for index operations (e.g. <code class="docutils literal notranslate"><span class="pre">mycol[5]</span></code>) is also
handled by <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a>, where
again a simple override is sufficient unless special rules are needed
for particular operators:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ARRAY</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">TypeDecorator</span>

<span class="k">class</span> <span class="nc">MyArrayType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">ARRAY</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">coerce_compared_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">coerce_compared_value</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</div>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.cache_ok"><span class="sig-name descname">cache_ok</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate"><span class="sig-name descname">operate()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.reverse_operate"><span class="sig-name descname">reverse_operate()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.__init__"><span class="sig-name descname">__init__()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.bind_expression"><span class="sig-name descname">bind_expression()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.bind_processor"><span class="sig-name descname">bind_processor()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value"><span class="sig-name descname">coerce_compared_value()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_to_is_types"><span class="sig-name descname">coerce_to_is_types</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.column_expression"><span class="sig-name descname">column_expression()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.comparator_factory"><span class="sig-name descname">comparator_factory</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.compare_values"><span class="sig-name descname">compare_values()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.copy"><span class="sig-name descname">copy()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.get_dbapi_type"><span class="sig-name descname">get_dbapi_type()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.literal_processor"><span class="sig-name descname">literal_processor()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl"><span class="sig-name descname">load_dialect_impl()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param"><span class="sig-name descname">process_bind_param()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_literal_param"><span class="sig-name descname">process_literal_param()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value"><span class="sig-name descname">process_result_value()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.result_processor"><span class="sig-name descname">result_processor()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.sort_key_function"><span class="sig-name descname">sort_key_function</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.type_engine"><span class="sig-name descname">type_engine()</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator</span></code></a> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.sql.expression.SchemaEventTarget</span></code>, <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.ExternalType</span></code></a>, <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeEngine</span></code></a>)</p>
</div>
<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.cache_ok">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">cache_ok</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">bool</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></em><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">None</span></em><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.cache_ok" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType.cache_ok" title="sqlalchemy.types.ExternalType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExternalType.cache_ok</span></code></a> <em>attribute of</em> <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a></p>
</div>
<p>Indicate if statements using this <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a> are “safe to
cache”.</p>
<p>The default value <code class="docutils literal notranslate"><span class="pre">None</span></code> will emit a warning and then not allow caching
of a statement which includes this type.   Set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to disable
statements using this type from being cached at all without a warning.
When set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the object’s class and selected elements from its
state will be used as part of the cache key.  For example, using a
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_only</span> <span class="o">=</span> <span class="kc">True</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The cache key for the above type would be equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">MyType</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">(&lt;class &#39;__main__.MyType&#39;&gt;, (&#39;choices&#39;, (&#39;a&#39;, &#39;b&#39;, &#39;c&#39;)))</span></pre></div>
</div>
<p>The caching scheme will extract attributes from the type that correspond
to the names of parameters in the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method.  Above, the
“choices” attribute becomes part of the cache key but “internal_only”
does not, because there is no parameter named “internal_only”.</p>
<p>The requirements for cacheable elements is that they are hashable
and also that they indicate the same SQL rendered for expressions using
this type every time for a given cache value.</p>
<p>To accommodate for datatypes that refer to unhashable structures such
as dictionaries, sets and lists, these objects can be made “cacheable”
by assigning hashable structures to the attributes whose names
correspond with the names of the arguments.  For example, a datatype
which accepts a dictionary of lookup values may publish this as a sorted
series of tuples.   Given a previously un-cacheable type as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LookupType</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;a custom type that accepts a dictionary as a parameter.</span>

<span class="sd">    this is the non-cacheable version, as &quot;self.lookup&quot; is not</span>
<span class="sd">    hashable.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(255)&quot;</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># ...  works with &quot;self.lookup&quot; ...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where “lookup” is a dictionary.  The type will not be able to generate
a cache key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span> <span class="o">=</span> <span class="n">LookupType</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">&lt;stdin&gt;:1: SAWarning: UserDefinedType LookupType({&#39;a&#39;: 10, &#39;b&#39;: 20}) will not</span>
<span class="go">produce a cache key because the ``cache_ok`` flag is not set to True.</span>
<span class="go">Set this flag to True if this type object&#39;s state is safe to use</span>
<span class="go">in a cache key, or False to disable this warning.</span>
<span class="go">symbol(&#39;no_cache&#39;)</span></pre></div>
</div>
<p>If we <strong>did</strong> set up such a cache key, it wouldn’t be usable. We would
get a tuple structure that contains a dictionary inside of it, which
cannot itself be used as a key in a “cache dictionary” such as SQLAlchemy’s
statement cache, since Python dictionaries aren’t hashable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># set cache_ok = True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span><span class="o">.</span><span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># this is the cache key it would generate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span>
<span class="go">(&lt;class &#39;__main__.LookupType&#39;&gt;, (&#39;lookup&#39;, {&#39;a&#39;: 10, &#39;b&#39;: 20}))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># however this key is not hashable, will fail when used with</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># SQLAlchemy statement cache</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">some_cache</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s2">&quot;some sql value&quot;</span><span class="p">}</span>
<span class="go">Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1,</span>
<span class="go">in &lt;module&gt; TypeError: unhashable type: &#39;dict&#39;</span></pre></div>
</div>
<p>The type may be made cacheable by assigning a sorted tuple of tuples
to the “.lookup” attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LookupType</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;a custom type that accepts a dictionary as a parameter.</span>

<span class="sd">    The dictionary is stored both as itself in a private variable,</span>
<span class="sd">    and published in a public variable as a sorted tuple of tuples,</span>
<span class="sd">    which is hashable and will also return the same value for any</span>
<span class="sd">    two equivalent dictionaries.  Note it assumes the keys and</span>
<span class="sd">    values of the dictionary are themselves hashable.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span> <span class="o">=</span> <span class="n">lookup</span>

        <span class="c1"># assume keys/values of &quot;lookup&quot; are hashable; otherwise</span>
        <span class="c1"># they would also need to be converted in some way here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">lookup</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sorted</span><span class="p">(</span><span class="n">lookup</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(255)&quot;</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># ...  works with &quot;self._lookup&quot; ...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where above, the cache key for <code class="docutils literal notranslate"><span class="pre">LookupType({&quot;a&quot;:</span> <span class="pre">10,</span> <span class="pre">&quot;b&quot;:</span> <span class="pre">20})</span></code> will be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">LookupType</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">(&lt;class &#39;__main__.LookupType&#39;&gt;, (&#39;lookup&#39;, ((&#39;a&#39;, 10), (&#39;b&#39;, 20))))</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.14: </span>- added the <code class="docutils literal notranslate"><span class="pre">cache_ok</span></code> flag to allow
some configurability of caching for <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> classes.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.28: </span>- added the <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a> mixin which
generalizes the <code class="docutils literal notranslate"><span class="pre">cache_ok</span></code> flag to both the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>
and <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> classes.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="connections.html#sql-caching"><span class="std std-ref">SQL 编译缓存</span></a></p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.Comparator">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Comparator</span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.Comparator" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.Comparator" title="sqlalchemy.types.TypeEngine.Comparator"><code class="xref py py-class docutils literal notranslate"><span class="pre">Comparator</span></code></a> that is specific to
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>User-defined <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> classes should not typically
need to modify this.</p>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator" title="sqlalchemy.types.TypeDecorator.Comparator"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.Comparator</span></code></a> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.Comparator</span></code>)</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.Comparator.operate">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.Comparator.</span></code></a><span class="sig-name descname"><span class="pre">operate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">OperatorType</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">other</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_CT</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.Comparator.operate" title="Permalink to this definition">¶</a></dt>
<dd><p>Operate on an argument.</p>
<p>This is the lowest level of operation, raises
<code class="xref py py-class docutils literal notranslate"><span class="pre">NotImplementedError</span></code> by default.</p>
<p>Overriding this on a subclass can allow common
behavior to be applied to all operations.
For example, overriding <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnOperators" title="sqlalchemy.sql.expression.ColumnOperators"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnOperators</span></code></a>
to apply <code class="docutils literal notranslate"><span class="pre">func.lower()</span></code> to the left and right
side:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyComparator</span><span class="p">(</span><span class="n">ColumnOperators</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.Comparator.operate.params.op"></span><strong>op</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate.params.op">¶</a> – Operator callable.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.Comparator.operate.params.*other"></span><strong>*other</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate.params.*other">¶</a> – the ‘other’ side of the operation. Will
be a single scalar for most operations.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.Comparator.operate.params.**kwargs"></span><strong>**kwargs</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate.params.**kwargs">¶</a> – modifiers.  These may be passed by special
operators such as <code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.contains()</span></code>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.Comparator.reverse_operate">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.Comparator.</span></code></a><span class="sig-name descname"><span class="pre">reverse_operate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">OperatorType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">other</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_CT</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.Comparator.reverse_operate" title="Permalink to this definition">¶</a></dt>
<dd><p>Reverse operate on an argument.</p>
<p>Usage is the same as <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate" title="sqlalchemy.types.TypeDecorator.Comparator.operate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">operate()</span></code></a>.</p>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.__init__">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Construct a <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>Arguments sent here are passed to the constructor
of the class assigned to the <code class="docutils literal notranslate"><span class="pre">impl</span></code> class level attribute,
assuming the <code class="docutils literal notranslate"><span class="pre">impl</span></code> is a callable, and the resulting
object is assigned to the <code class="docutils literal notranslate"><span class="pre">self.impl</span></code> instance attribute
(thus overriding the class attribute of the same name).</p>
<p>If the class level <code class="docutils literal notranslate"><span class="pre">impl</span></code> is not a callable (the unusual case),
it will be assigned to the same instance attribute ‘as-is’,
ignoring those arguments passed to the constructor.</p>
<p>Subclasses can override this to customize the generation
of <code class="docutils literal notranslate"><span class="pre">self.impl</span></code> entirely.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.bind_expression">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">bind_expression</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bindparam</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.BindParameter" title="sqlalchemy.sql.expression.BindParameter"><span class="pre">BindParameter</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.bind_expression" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a bind value (i.e. a <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.BindParameter" title="sqlalchemy.sql.expression.BindParameter"><code class="xref py py-class docutils literal notranslate"><span class="pre">BindParameter</span></code></a> instance),
return a SQL expression which will typically wrap the given parameter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method is called during the <strong>SQL compilation</strong> phase of a
statement, when rendering a SQL string. It is <strong>not</strong> necessarily
called against specific values, and should not be confused with the
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="sqlalchemy.types.TypeDecorator.process_bind_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a> method, which is
the more typical method that processes the actual value passed to a
particular parameter at statement execution time.</p>
</div>
<p>Subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> can override this method
to provide custom bind expression behavior for the type.  This
implementation will <strong>replace</strong> that of the underlying implementation
type.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.bind_processor">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">bind_processor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_BindProcessorType</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.bind_processor" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide a bound value processing function for the
given <a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a>.</p>
<p>This is the method that fulfills the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a>
contract for bound value conversion which normally occurs via
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.bind_processor" title="sqlalchemy.types.TypeEngine.bind_processor"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.bind_processor()</span></code></a> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>User-defined subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should
<strong>not</strong> implement this method, and should instead implement
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="sqlalchemy.types.TypeDecorator.process_bind_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a> so that the “inner”
processing provided by the implementing type is maintained.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="target" id="sqlalchemy.types.TypeDecorator.bind_processor.params.dialect"></span><strong>dialect</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.bind_processor.params.dialect">¶</a> – Dialect instance in use.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.coerce_compared_value">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">coerce_compared_value</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">OperatorType</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Any</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Suggest a type for a ‘coerced’ Python value in an expression.</p>
<p>By default, returns self.   This method is called by
the expression system when an object using this type is
on the left or right side of an expression against a plain Python
object which does not yet have a SQLAlchemy type assigned:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expr</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">somecolumn</span> <span class="o">+</span> <span class="mi">35</span></pre></div>
</div>
<p>Where above, if <code class="docutils literal notranslate"><span class="pre">somecolumn</span></code> uses this type, this method will
be called with the value <code class="docutils literal notranslate"><span class="pre">operator.add</span></code>
and <code class="docutils literal notranslate"><span class="pre">35</span></code>.  The return value is whatever SQLAlchemy type should
be used for <code class="docutils literal notranslate"><span class="pre">35</span></code> for this particular operation.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.coerce_to_is_types">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">coerce_to_is_types</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference internal" href="defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><span class="pre">Sequence</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></em><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">(&lt;class</span> <span class="pre">'NoneType'&gt;,)</span></em><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.coerce_to_is_types" title="Permalink to this definition">¶</a></dt>
<dd><p>Specify those Python types which should be coerced at the expression
level to “IS &lt;constant&gt;” when compared using <code class="docutils literal notranslate"><span class="pre">==</span></code> (and same for
<code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NOT</span></code> in conjunction with <code class="docutils literal notranslate"><span class="pre">!=</span></code>).</p>
<p>For most SQLAlchemy types, this includes <code class="docutils literal notranslate"><span class="pre">NoneType</span></code>, as well as
<code class="docutils literal notranslate"><span class="pre">bool</span></code>.</p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> modifies this list to only include <code class="docutils literal notranslate"><span class="pre">NoneType</span></code>,
as typedecorator implementations that deal with boolean types are common.</p>
<p>Custom <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> classes can override this attribute to
return an empty tuple, in which case no values will be coerced to
constants.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.column_expression">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">column_expression</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.column_expression" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a SELECT column expression, return a wrapping SQL expression.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method is called during the <strong>SQL compilation</strong> phase of a
statement, when rendering a SQL string. It is <strong>not</strong> called
against specific values, and should not be confused with the
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value" title="sqlalchemy.types.TypeDecorator.process_result_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a> method, which is
the more typical method that processes the actual value returned
in a result row subsequent to statement execution time.</p>
</div>
<p>Subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> can override this method
to provide custom column expression behavior for the type.  This
implementation will <strong>replace</strong> that of the underlying implementation
type.</p>
<p>See the description of <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.column_expression" title="sqlalchemy.types.TypeEngine.column_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.column_expression()</span></code></a>
for a complete description of the method’s use.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.comparator_factory">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">comparator_factory</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">_ComparatorFactory</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></em><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.comparator_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.Comparator" title="sqlalchemy.types.TypeEngine.Comparator"><code class="xref py py-class docutils literal notranslate"><span class="pre">Comparator</span></code></a> class which will apply
to operations performed by owning <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnElement</span></code></a>
objects.</p>
<p>The <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.comparator_factory" title="sqlalchemy.types.TypeDecorator.comparator_factory"><code class="xref py py-attr docutils literal notranslate"><span class="pre">comparator_factory</span></code></a> attribute is a hook consulted by
the core expression system when column and SQL expression operations
are performed.   When a <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.Comparator" title="sqlalchemy.types.TypeEngine.Comparator"><code class="xref py py-class docutils literal notranslate"><span class="pre">Comparator</span></code></a> class is
associated with this attribute, it allows custom re-definition of
all existing operators, as well as definition of new operators.
Existing operators include those provided by Python operator overloading
such as <code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.__add__()</span></code> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.__eq__()</span></code>,
those provided as standard
attributes of <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnOperators" title="sqlalchemy.sql.operators.ColumnOperators"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnOperators</span></code></a> such as
<code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.like()</span></code>
and <code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.in_()</span></code>.</p>
<p>Rudimentary usage of this hook is allowed through simple subclassing
of existing types, or alternatively by using <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.
See the documentation section <span class="xref std std-ref">types_operators</span> for examples.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.compare_values">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">compare_values</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">x</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">y</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bool</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.compare_values" title="Permalink to this definition">¶</a></dt>
<dd><p>Given two values, compare them for equality.</p>
<p>By default this calls upon <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.compare_values" title="sqlalchemy.types.TypeEngine.compare_values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.compare_values()</span></code></a>
of the underlying “impl”, which in turn usually
uses the Python equals operator <code class="docutils literal notranslate"><span class="pre">==</span></code>.</p>
<p>This function is used by the ORM to compare
an original-loaded value with an intercepted
“changed” value, to determine if a net change
has occurred.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.copy">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">copy</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kw</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Self</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.copy" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce a copy of this <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> instance.</p>
<p>This is a shallow copy and is provided to fulfill part of
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> contract.  It usually does not
need to be overridden unless the user-defined <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>
has local state that should be deep-copied.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.get_dbapi_type">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">get_dbapi_type</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dbapi</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">module</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Any</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.get_dbapi_type" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the DBAPI type object represented by this
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>By default this calls upon <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.get_dbapi_type" title="sqlalchemy.types.TypeEngine.get_dbapi_type"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.get_dbapi_type()</span></code></a> of the
underlying “impl”.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.literal_processor">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">literal_processor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_LiteralProcessorType</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.literal_processor" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide a literal processing function for the given
<a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a>.</p>
<p>This is the method that fulfills the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a>
contract for literal value conversion which normally occurs via
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.literal_processor" title="sqlalchemy.types.TypeEngine.literal_processor"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.literal_processor()</span></code></a> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>User-defined subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should
<strong>not</strong> implement this method, and should instead implement
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_literal_param" title="sqlalchemy.types.TypeDecorator.process_literal_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_literal_param()</span></code></a> so that the
“inner” processing provided by the implementing type is maintained.</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.load_dialect_impl">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">load_dialect_impl</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><span class="pre">TypeEngine</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> object corresponding to a dialect.</p>
<p>This is an end-user override hook that can be used to provide
differing types depending on the given dialect.  It is used
by the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> implementation of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.type_engine" title="sqlalchemy.types.TypeDecorator.type_engine"><code class="xref py py-meth docutils literal notranslate"><span class="pre">type_engine()</span></code></a>
to help determine what type should ultimately be returned
for a given <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>By default returns <code class="docutils literal notranslate"><span class="pre">self.impl</span></code>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.process_bind_param">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">process_bind_param</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Any</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="Permalink to this definition">¶</a></dt>
<dd><p>Receive a bound parameter value to be converted.</p>
<p>Custom subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should override
this method to provide custom behaviors for incoming data values.
This method is called at <strong>statement execution time</strong> and is passed
the literal Python data value which is to be associated with a bound
parameter in the statement.</p>
<p>The operation could be anything desired to perform custom
behavior, such as transforming or serializing data.
This could also be used as a hook for validating logic.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.process_bind_param.params.value"></span><strong>value</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param.params.value">¶</a> – Data to operate upon, of any type expected by
this method in the subclass.  Can be <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.process_bind_param.params.dialect"></span><strong>dialect</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param.params.dialect">¶</a> – the <a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a> in use.</p></li>
</ul>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#types-typedecorator"><span class="std std-ref">增强现有类型</span></a></p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value" title="sqlalchemy.types.TypeDecorator.process_result_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.process_literal_param">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">process_literal_param</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">str</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.process_literal_param" title="Permalink to this definition">¶</a></dt>
<dd><p>Receive a literal parameter value to be rendered inline within
a statement.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method is called during the <strong>SQL compilation</strong> phase of a
statement, when rendering a SQL string. Unlike other SQL
compilation methods, it is passed a specific Python value to be
rendered as a string. However it should not be confused with the
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="sqlalchemy.types.TypeDecorator.process_bind_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a> method, which is
the more typical method that processes the actual value passed to a
particular parameter at statement execution time.</p>
</div>
<p>Custom subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should override
this method to provide custom behaviors for incoming data values
that are in the special case of being rendered as literals.</p>
<p>The returned string will be rendered into the output string.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.process_result_value">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">process_result_value</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_T</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.process_result_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Receive a result-row column value to be converted.</p>
<p>Custom subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should override
this method to provide custom behaviors for data values
being received in result rows coming from the database.
This method is called at <strong>result fetching time</strong> and is passed
the literal Python data value that’s extracted from a database result
row.</p>
<p>The operation could be anything desired to perform custom
behavior, such as transforming or deserializing data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.process_result_value.params.value"></span><strong>value</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value.params.value">¶</a> – Data to operate upon, of any type expected by
this method in the subclass.  Can be <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.process_result_value.params.dialect"></span><strong>dialect</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value.params.dialect">¶</a> – the <a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a> in use.</p></li>
</ul>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#types-typedecorator"><span class="std std-ref">增强现有类型</span></a></p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="sqlalchemy.types.TypeDecorator.process_bind_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.result_processor">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">result_processor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">coltype</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_ResultProcessorType</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.result_processor" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide a result value processing function for the given
<a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a>.</p>
<p>This is the method that fulfills the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a>
contract for bound value conversion which normally occurs via
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.result_processor" title="sqlalchemy.types.TypeEngine.result_processor"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.result_processor()</span></code></a> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>User-defined subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should
<strong>not</strong> implement this method, and should instead implement
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value" title="sqlalchemy.types.TypeDecorator.process_result_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a> so that the
“inner” processing provided by the implementing type is maintained.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.result_processor.params.dialect"></span><strong>dialect</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.result_processor.params.dialect">¶</a> – Dialect instance in use.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.result_processor.params.coltype"></span><strong>coltype</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.result_processor.params.coltype">¶</a> – A SQLAlchemy data type</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.sort_key_function">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">sort_key_function</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></em><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.sort_key_function" title="Permalink to this definition">¶</a></dt>
<dd><p>A sorting function that can be passed as the key to sorted.</p>
<p>The default value of <code class="docutils literal notranslate"><span class="pre">None</span></code> indicates that the values stored by
this type are self-sorting.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.3.8.</span></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.type_engine">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">type_engine</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><span class="pre">TypeEngine</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.type_engine" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a dialect-specific <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> instance
for this <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>In most cases this returns a dialect-adapted form of
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> type represented by <code class="docutils literal notranslate"><span class="pre">self.impl</span></code>.
Makes usage of <code class="xref py py-meth docutils literal notranslate"><span class="pre">dialect_impl()</span></code>.
Behavior can be customized here by overriding
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl" title="sqlalchemy.types.TypeDecorator.load_dialect_impl"><code class="xref py py-meth docutils literal notranslate"><span class="pre">load_dialect_impl()</span></code></a>.</p>
</dd></dl>

</dd></dl>

</section>
<section id="typedecorator">
<h2>TypeDecorator配方<a class="headerlink" href="#typedecorator" title="Permalink to this heading">¶</a></h2>
<p>以下是一些关键的 <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> 配方。</p>
<section id="unicode">
<span id="coerce-to-unicode"></span><h3>强制编码字符串为Unicode<a class="headerlink" href="#unicode" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><p><a class="reference internal" href="type_basics.html#sqlalchemy.types.Unicode" title="sqlalchemy.types.Unicode"><code class="xref py py-class docutils literal notranslate"><span class="pre">Unicode</span></code></a> ` unicode``对象，这意味着在Python2中，如果使用Python的字符串对象，那么将抛出异常。它所执行的编码/解码函数只是为了适应所使用的DBAPI所需要的格式，是主要的私有实现细节。</p>
</div></blockquote>
<p>这可以通过使用 <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> 来实现，需要时进行必要的强制类型转换:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">TypeDecorator</span><span class="p">,</span> <span class="n">Unicode</span>


<span class="k">class</span> <span class="nc">CoerceUTF8</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;将Python的bytestring的安全强制转换为Unicode，然后转发到数据库中。&quot;&quot;&quot;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">Unicode</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</section>
<section id="id4">
<h3>保留数字<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>某些数据库连接器（例如SQL Server）如果传递带有太多小数位的Decimal，则会报错。这里有一个将Decimal四舍五入的配方:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">TypeDecorator</span><span class="p">,</span> <span class="n">Numeric</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>


<span class="k">class</span> <span class="nc">SafeNumeric</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;增加了分量的数字。&quot;&quot;&quot;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">Numeric</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">TypeDecorator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantize_int</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantize</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantize_int</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantize_int</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quantize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></pre><div class="code-annotations-key"></div></div>
</div>
</section>
<section id="utc">
<h3>存储时区感知时间戳为时区感知的UTC<a class="headerlink" href="#utc" title="Permalink to this heading">¶</a></h3>
<p>Relational数据库中的时间戳应始终以与时区无关的方式存储。对于大多数数据库，这意味着需要先将时间戳设置为UTC时区，然后存储它的时区为无时区（即，没有任何时区与之相关），UTC被假定为“隐式”时区。另外，也有特定于数据库的类型，如PostgreSQL的“TIMESTAMP WITH TIMEZONE”，通常是首选的，因为它们具有更丰富的功能。如果不能使用时间智能数据库类型，或者不喜欢该项功能，那么可以使用  <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> ` datetime.timezone.utc``时区被用于归一化和反归一化:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>


<span class="k">class</span> <span class="nc">TZDateTime</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">DateTime</span>
    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;tzinfo is required&quot;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></pre><div class="code-annotations-key"></div></div>
</div>
</section>
<section id="guid">
<span id="custom-guid-type"></span><h3>跨数据库的GUID类型<a class="headerlink" href="#guid" title="Permalink to this heading">¶</a></h3>
<p>接收并返回Python uuid()对象。在使用PostgreSQL的情况下使用PG UUID类型，在其他后端使用CHAR(32)，将它们以字符串形式存储为十六进制。如果需要，可以修改为将二进制存储在CHAR(16)中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">TypeDecorator</span><span class="p">,</span> <span class="n">CHAR</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">UUID</span>
<span class="kn">import</span> <span class="nn">uuid</span>


<span class="k">class</span> <span class="nc">GUID</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;与平台无关的GUID类型。</span>

<span class="sd">    在PostgreSQL中使用UUID类型，否则使用CHAR(32)，</span>
<span class="sd">    将字符串化的十六进制值存储。</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">CHAR</span>
    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">load_dialect_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dialect</span><span class="o">.</span><span class="n">type_descriptor</span><span class="p">(</span><span class="n">UUID</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dialect</span><span class="o">.</span><span class="n">type_descriptor</span><span class="p">(</span><span class="n">CHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.32x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">int</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># hexstring</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.32x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">int</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<section id="python-uuid-uuid-orm">
<h4>链接Python <a href="#id5"><span class="problematic" id="id6">``</span></a>uuid.UUID``到ORM映射自定义类型<a class="headerlink" href="#python-uuid-uuid-orm" title="Permalink to this heading">¶</a></h4>
<p>在使用  <a class="reference internal" href="../orm/declarative_tables.html#orm-declarative-mapped-column"><span class="std std-ref">装饰式ORM</span></a>
映射时，上面定义的自定义``GUID``类型可能会与
Python <a href="#id7"><span class="problematic" id="id8">``</span></a>uuid.UUID``数据类型相关联，并将其自动用于
的资源将在ORM映射到的列相关联该对象，则可以将其添加到</p>
<blockquote>
<div><p><a href="#id9"><span class="problematic" id="id10">:type:`_orm.DeclarativeBase`</span></a>  类上通常定义的  :ref:` 类型注释映射 &lt;orm_declarative_mapped_column_type_map&gt;` ：</p>
<blockquote>
<div><p>import uuid
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><dl class="simple">
<dt>type_annotation_map = {</dt><dd><p>uuid.UUID: GUID,</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<p>使用以上配置，扩展自``Base``的ORM映射类可以引用Python <code class="docutils literal notranslate"><span class="pre">uuid.UUID</span></code>。自动使用``GUID``：</p>
<blockquote>
<div><dl>
<dt>class MyModel(Base):</dt><dd><p>__tablename__ = “my_table”</p>
<p>id: Mapped[uuid.UUID] = mapped_column(primary_key=True)</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/declarative_tables.html#orm-declarative-mapped-column-type-map"><span class="std std-ref">自定义类型映射</span></a></p>
</div>
</section>
</section>
<section id="marshal-json-strings">
<h3>Marshal JSON Strings<a class="headerlink" href="#marshal-json-strings" title="Permalink to this heading">¶</a></h3>
<p>此类型使用“simplejson”将Python数据结构编组为/从JSON中。可修改为使用Python的内置json编码器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">TypeDecorator</span><span class="p">,</span> <span class="n">VARCHAR</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="k">class</span> <span class="nc">JSONEncodedDict</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;将不可变结构表示为json编码string。用法：JSONEncodedDict(255)&quot;&quot;&quot;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">VARCHAR</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<section id="id11">
<h4>添加可变性<a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h4>
<p>ORM默认情况下不会检测这种类型的任何“可变性”，也就是说，不会检测任何值的就地更改并使其刷新。如果没有进一步的步骤，您需要替换每个父对象上的现有值以检测更改::  obj.json_value[“key”] = “value”  # ORM不会检测  obj.json_value = {“key”: “value”}  # ORM会检测</p>
<p>上面的限制最好使用``sqlalchemy.ext.mutable``扩展实现可变性。 对于以字典为导向的JSON结构，我们可以将其应用为：</p>
<blockquote>
<div><p>json_type = MutableDict.as_mutable(JSONEncodedDict)</p>
<dl>
<dt>class MyClass(Base):</dt><dd><p>#  …</p>
<p>json_data = Column(json_type)</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/extensions/mutable.html"><span class="std std-ref">变化追踪</span></a></p>
</div>
</section>
<section id="id12">
<h4>比较运算<a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><blockquote>
<div><p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> ` JSONEncodedDict``的类型，我们需要在使用此运算符之前使用 <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.cast" title="sqlalchemy.sql.expression.cast"><code class="xref py py-func docutils literal notranslate"><span class="pre">cast()</span></code></a> 或</p>
</div></blockquote>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">type_coerce()</span></code> 来将列转换为文本形式。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">type_coerce</span><span class="p">,</span> <span class="n">String</span>

  <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">my_table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">type_coerce</span><span class="p">(</span><span class="n">my_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">json_data</span><span class="p">,</span> <span class="n">String</span><span class="p">)</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">oo%&quot;</span><span class="p">))</span>

<span class="p">:</span><span class="n">class</span><span class="p">:</span><span class="err">`</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="err">`</span> <span class="o">.</span><span class="n">TypeDecorator</span><span class="o">.</span><span class="n">coerce_compared_value</span><span class="err">`</span>  <span class="n">方法来定义新运算符</span><span class="p">::</span>

  <span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">operators</span>
  <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>


  <span class="k">class</span> <span class="nc">JSONEncodedDict</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
      <span class="n">impl</span> <span class="o">=</span> <span class="n">VARCHAR</span>

      <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

      <span class="k">def</span> <span class="nf">coerce_compared_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="n">operators</span><span class="o">.</span><span class="n">like_op</span><span class="p">,</span> <span class="n">operators</span><span class="o">.</span><span class="n">not_like_op</span><span class="p">):</span>
              <span class="k">return</span> <span class="n">String</span><span class="p">()</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="k">return</span> <span class="bp">self</span>

      <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
              <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

          <span class="k">return</span> <span class="n">value</span>

      <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
              <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">value</span></pre><div class="code-annotations-key"></div></div>
</div>
</div></blockquote>
<p>以上只是处理“LIKE”操作符的方法之一。其他应用程序可能希望为JSON对象引发``NotImplementedError``的操作符（如“LIKE”），而不是自动将其强制类型为文本。</p>
</section>
</section>
</section>
<section id="sqlbind-result">
<span id="types-sql-value-processing"></span><h2>应用SQL级别的Bind/Result处理<a class="headerlink" href="#sqlbind-result" title="Permalink to this heading">¶</a></h2>
<p>如在 <a class="reference internal" href="#types-typedecorator"><span class="std std-ref">增强现有类型</span></a> 一节中所述，当将参数发送到语句时和从数据库加载结果行时，SQLAlchemy允许调用Python函数以应用转换。还可以定义SQL级别的转换。这样做的原因是在关系数据库中包含了一系列特定于应用程序和持久性格式之间转换的功能而只存在于数据库服务器中。</p>
<p>任何: class: ‘TypeEngine’，: class :。’UserDefinedType’或 : class:<cite>.TypeDecorator`子类均可包括  :meth:</cite>.TypeEngine.bind_expression`   和 / 或  :meth:` .TypeEngine.column_expression`   的实现，如果定义为返回非“None”值，则应返回: class:<cite>_expression.ColumnElement ` 为将注入到SQL语句中，包围绑定参数或列表达式的表达式格式。例如，要构建一个“Geometry”类型，该类型将对所有传出值应用PostGIS函数“ST_GeomFromText”，并对所有传入数据应用函数“ST_AsText”，我们可以创建一个  :class:</cite>.UserDefinedType` ~.sqlalchemy.sql.expression.func` 结合使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">UserDefinedType</span>


<span class="k">class</span> <span class="nc">Geometry</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;GEOMETRY&quot;</span>

    <span class="k">def</span> <span class="nf">bind_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bindvalue</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">ST_GeomFromText</span><span class="p">(</span><span class="n">bindvalue</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">column_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>我们可以将“Geometry”类型应用于:schema:Table元数据中，并在:func :<a href="#id13"><span class="problematic" id="id14">`</span></a>_expression.select`中使用它:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geometry</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;geom_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;geom_data&quot;</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">print</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">geom_data</span> <span class="o">==</span> <span class="s2">&quot;LINESTRING(189412 252431,189631 259122)&quot;</span>
    <span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>生成的SQL将嵌入两个函数。 ST_AsText应用于columns条款，以便将ST_GeomFromText在将返回值传递到结果集之前运行：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_id</span><span class="p">,</span><span class="w"> </span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_data</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">geom_data_1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">geometry</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_GeomFromText</span><span class="p">(:</span><span class="n">geom_data_2</span><span class="p">)</span></pre></div>
</div>
<p>通过  <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.Operators.op" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.op()</span></code></a>   中使用自定义SQL进行比较操作,参数  :paramref:` .Operators.op.is_comparison`  标志应设置为“True”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyInt</span><span class="p">(</span><span class="n">Integer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">comparator_factory</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">Comparator</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">is_frobnozzled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;--is_frobnozzled-&gt;&quot;</span><span class="p">,</span> <span class="n">is_comparison</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">other</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.Operators.op" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.op()</span></code></a></p>
<p><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.comparator_factory" title="sqlalchemy.types.TypeEngine.comparator_factory"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TypeEngine.comparator_factory</span></code></a></p>
</div>
</section>
<section id="id15">
<h2>创建新类型<a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h2>
<blockquote>
<div><p><a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> .TypeDecorator` 。</p>
</div></blockquote>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><span class="sig-name descname">UserDefinedType</span></a></p></td>
<td><p>Base for user defined types.</p></td>
</tr>
</tbody>
</table>
<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.types.UserDefinedType">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.types.</span></span><span class="sig-name descname"><span class="pre">UserDefinedType</span></span><a class="headerlink" href="#sqlalchemy.types.UserDefinedType" title="Permalink to this definition">¶</a></dt>
<dd><p>Base for user defined types.</p>
<p>This should be the base of new types.  Note that
for most cases, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> is probably
more appropriate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy.types</span> <span class="k">as</span> <span class="nn">types</span>

<span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">UserDefinedType</span><span class="p">):</span>
    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MYTYPE(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">process</span>

    <span class="k">def</span> <span class="nf">result_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">coltype</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">process</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Once the type is made, it’s immediately usable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">MyType</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="p">)</span></pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_col_spec()</span></code> method will in most cases receive a keyword
argument <code class="docutils literal notranslate"><span class="pre">type_expression</span></code> which refers to the owning expression
of the type as being compiled, such as a <a class="reference internal" href="metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> or
<a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.cast" title="sqlalchemy.sql.expression.cast"><code class="xref py py-func docutils literal notranslate"><span class="pre">cast()</span></code></a> construct.  This keyword is only sent if the method
accepts keyword arguments (e.g. <code class="docutils literal notranslate"><span class="pre">**kw</span></code>) in its argument signature;
introspection is used to check for this in order to support legacy
forms of this function.</p>
<p>The <a class="reference internal" href="#sqlalchemy.types.UserDefinedType.cache_ok" title="sqlalchemy.types.UserDefinedType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">UserDefinedType.cache_ok</span></code></a> class-level flag indicates if this
custom <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> is safe to be used as part of a cache key.
This flag defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code> which will initially generate a warning
when the SQL compiler attempts to generate a cache key for a statement
that uses this type.  If the <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> is not guaranteed
to produce the same bind/result behavior and SQL generation
every time, this flag should be set to <code class="docutils literal notranslate"><span class="pre">False</span></code>; otherwise if the
class produces the same behavior each time, it may be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.
See <a class="reference internal" href="#sqlalchemy.types.UserDefinedType.cache_ok" title="sqlalchemy.types.UserDefinedType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">UserDefinedType.cache_ok</span></code></a> for further notes on how this works.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.28: </span>Generalized the <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType.cache_ok" title="sqlalchemy.types.ExternalType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExternalType.cache_ok</span></code></a>
flag so that it is available for both <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> as well
as <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a>.</p>
</div>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.types.UserDefinedType.cache_ok"><span class="sig-name descname">cache_ok</span></a>, <a class="reference internal" href="#sqlalchemy.types.UserDefinedType.coerce_compared_value"><span class="sig-name descname">coerce_compared_value()</span></a>, <a class="reference internal" href="#sqlalchemy.types.UserDefinedType.ensure_kwarg"><span class="sig-name descname">ensure_kwarg</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.UserDefinedType</span></code></a> (<a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.ExternalType</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeEngineMixin</span></code>, <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeEngine</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.util.langhelpers.EnsureKWArg</span></code>)</p>
</div>
<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.UserDefinedType.cache_ok">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.UserDefinedType.</span></code></a><span class="sig-name descname"><span class="pre">cache_ok</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">bool</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></em><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">None</span></em><a class="headerlink" href="#sqlalchemy.types.UserDefinedType.cache_ok" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType.cache_ok" title="sqlalchemy.types.ExternalType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExternalType.cache_ok</span></code></a> <em>attribute of</em> <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a></p>
</div>
<p>Indicate if statements using this <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a> are “safe to
cache”.</p>
<p>The default value <code class="docutils literal notranslate"><span class="pre">None</span></code> will emit a warning and then not allow caching
of a statement which includes this type.   Set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to disable
statements using this type from being cached at all without a warning.
When set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the object’s class and selected elements from its
state will be used as part of the cache key.  For example, using a
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_only</span> <span class="o">=</span> <span class="kc">True</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The cache key for the above type would be equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">MyType</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">(&lt;class &#39;__main__.MyType&#39;&gt;, (&#39;choices&#39;, (&#39;a&#39;, &#39;b&#39;, &#39;c&#39;)))</span></pre></div>
</div>
<p>The caching scheme will extract attributes from the type that correspond
to the names of parameters in the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method.  Above, the
“choices” attribute becomes part of the cache key but “internal_only”
does not, because there is no parameter named “internal_only”.</p>
<p>The requirements for cacheable elements is that they are hashable
and also that they indicate the same SQL rendered for expressions using
this type every time for a given cache value.</p>
<p>To accommodate for datatypes that refer to unhashable structures such
as dictionaries, sets and lists, these objects can be made “cacheable”
by assigning hashable structures to the attributes whose names
correspond with the names of the arguments.  For example, a datatype
which accepts a dictionary of lookup values may publish this as a sorted
series of tuples.   Given a previously un-cacheable type as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LookupType</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;a custom type that accepts a dictionary as a parameter.</span>

<span class="sd">    this is the non-cacheable version, as &quot;self.lookup&quot; is not</span>
<span class="sd">    hashable.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(255)&quot;</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># ...  works with &quot;self.lookup&quot; ...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where “lookup” is a dictionary.  The type will not be able to generate
a cache key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span> <span class="o">=</span> <span class="n">LookupType</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">&lt;stdin&gt;:1: SAWarning: UserDefinedType LookupType({&#39;a&#39;: 10, &#39;b&#39;: 20}) will not</span>
<span class="go">produce a cache key because the ``cache_ok`` flag is not set to True.</span>
<span class="go">Set this flag to True if this type object&#39;s state is safe to use</span>
<span class="go">in a cache key, or False to disable this warning.</span>
<span class="go">symbol(&#39;no_cache&#39;)</span></pre></div>
</div>
<p>If we <strong>did</strong> set up such a cache key, it wouldn’t be usable. We would
get a tuple structure that contains a dictionary inside of it, which
cannot itself be used as a key in a “cache dictionary” such as SQLAlchemy’s
statement cache, since Python dictionaries aren’t hashable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># set cache_ok = True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span><span class="o">.</span><span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># this is the cache key it would generate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span>
<span class="go">(&lt;class &#39;__main__.LookupType&#39;&gt;, (&#39;lookup&#39;, {&#39;a&#39;: 10, &#39;b&#39;: 20}))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># however this key is not hashable, will fail when used with</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># SQLAlchemy statement cache</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">some_cache</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s2">&quot;some sql value&quot;</span><span class="p">}</span>
<span class="go">Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1,</span>
<span class="go">in &lt;module&gt; TypeError: unhashable type: &#39;dict&#39;</span></pre></div>
</div>
<p>The type may be made cacheable by assigning a sorted tuple of tuples
to the “.lookup” attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LookupType</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;a custom type that accepts a dictionary as a parameter.</span>

<span class="sd">    The dictionary is stored both as itself in a private variable,</span>
<span class="sd">    and published in a public variable as a sorted tuple of tuples,</span>
<span class="sd">    which is hashable and will also return the same value for any</span>
<span class="sd">    two equivalent dictionaries.  Note it assumes the keys and</span>
<span class="sd">    values of the dictionary are themselves hashable.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span> <span class="o">=</span> <span class="n">lookup</span>

        <span class="c1"># assume keys/values of &quot;lookup&quot; are hashable; otherwise</span>
        <span class="c1"># they would also need to be converted in some way here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">lookup</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sorted</span><span class="p">(</span><span class="n">lookup</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(255)&quot;</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># ...  works with &quot;self._lookup&quot; ...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where above, the cache key for <code class="docutils literal notranslate"><span class="pre">LookupType({&quot;a&quot;:</span> <span class="pre">10,</span> <span class="pre">&quot;b&quot;:</span> <span class="pre">20})</span></code> will be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">LookupType</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">(&lt;class &#39;__main__.LookupType&#39;&gt;, (&#39;lookup&#39;, ((&#39;a&#39;, 10), (&#39;b&#39;, 20))))</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.14: </span>- added the <code class="docutils literal notranslate"><span class="pre">cache_ok</span></code> flag to allow
some configurability of caching for <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> classes.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.28: </span>- added the <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a> mixin which
generalizes the <code class="docutils literal notranslate"><span class="pre">cache_ok</span></code> flag to both the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>
and <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> classes.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="connections.html#sql-caching"><span class="std std-ref">SQL 编译缓存</span></a></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.UserDefinedType.coerce_compared_value">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.UserDefinedType.</span></code></a><span class="sig-name descname"><span class="pre">coerce_compared_value</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">OperatorType</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><span class="pre">TypeEngine</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.UserDefinedType.coerce_compared_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Suggest a type for a ‘coerced’ Python value in an expression.</p>
<p>Default behavior for <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> is the
same as that of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>; by default it returns
<code class="docutils literal notranslate"><span class="pre">self</span></code>, assuming the compared value should be coerced into
the same type as this one.  See
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a> for more detail.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.UserDefinedType.ensure_kwarg">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.UserDefinedType.</span></code></a><span class="sig-name descname"><span class="pre">ensure_kwarg</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">str</span></em><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'get_col_spec'</span></em><a class="headerlink" href="#sqlalchemy.types.UserDefinedType.ensure_kwarg" title="Permalink to this definition">¶</a></dt>
<dd><p>a regular expression that indicates method names for which the method
should accept <code class="docutils literal notranslate"><span class="pre">**kw</span></code> arguments.</p>
<p>The class will scan for methods matching the name template and decorate
them if necessary to ensure <code class="docutils literal notranslate"><span class="pre">**kw</span></code> parameters are accepted.</p>
</dd></dl>

</dd></dl>

</section>
<section id="custom-and-decorated-types-reflection">
<span id="id16"></span><h2>处理自定义类型和反射<a class="headerlink" href="#custom-and-decorated-types-reflection" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt>请注意，具有附加Python行为的数据库类型，包括基于</dt><dd><p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> 和其他用户定义的数据类型的类型，</p>
</dd>
</dl>
<p>在数据库模式中没有任何表现形式。当使用数据库时
在描述 <span class="xref std std-ref">metadata_reflection</span> 处的功能时，SQLAlchemy使用一个固定的映射，
其将由数据库服务器报告的数据类型信息与SQLAlchemy数据类型对象相关联。
例如，如果我们在PostgreSQL模式中查看特定数据库列的定义，我们可能会收回字符串“VARCHAR”。
SQLAlchemy的PostgreSQL方言具有硬编码映射，将字符串名称“VARCHAR”与SQLAlchemy  <a class="reference internal" href="type_basics.html#sqlalchemy.types.VARCHAR" title="sqlalchemy.types.VARCHAR"><code class="xref py py-class docutils literal notranslate"><span class="pre">VARCHAR</span></code></a> ”这样的语句时，  :class:` _schema.Column` .VARCHAR`。</p>
<p>这的含义是，如果表对象使用无法直接对应于数据库本机类型名称的类型对象，那么如果我们使用反映创建一个新的  <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  _schema.MetaData` 集合中的此数据库表，不能包含此数据类型。例如：：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
<span class="go">...     Table,</span>
<span class="go">...     Column,</span>
<span class="go">...     MetaData,</span>
<span class="go">...     create_engine,</span>
<span class="go">...     PickleType,</span>
<span class="go">...     Integer,</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<span class="go">...     &quot;my_table&quot;, metadata, Column(&quot;id&quot;, Integer), Column(&quot;data&quot;, PickleType)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<div class='show_sql'><span class="n">INFO</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">Engine</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">my_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">data</span><span class="w"> </span><span class="nb">BLOB</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>上面，我们使用了  <a class="reference internal" href="type_basics.html#sqlalchemy.types.PickleType" title="sqlalchemy.types.PickleType"><code class="xref py py-class docutils literal notranslate"><span class="pre">PickleType</span></code></a> ，它是一个  :class:` .TypeDecorator` ，它基于  <a class="reference internal" href="type_basics.html#sqlalchemy.types.LargeBinary" title="sqlalchemy.types.LargeBinary"><code class="xref py py-class docutils literal notranslate"><span class="pre">LargeBinary</span></code></a> .PickleType` 。</p>
<p>如果我们查看“my_table.c.data.type”的类型，因为这是由我们直接创建的Python对象，它是：class:<cite>.PickleType</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">type</span>
<span class="go">PickleType()</span></pre></div>
</div>
<p>但是，如果我们使用反射创建另一个  <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> .PickleType` 的使用不会反映在我们创建的SQLite数据库中。相反，我们得到了  <a class="reference internal" href="type_basics.html#sqlalchemy.types.BLOB" title="sqlalchemy.types.BLOB"><code class="xref py py-class docutils literal notranslate"><span class="pre">BLOB</span></code></a> ：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">metadata_two</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_reflected_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="n">metadata_two</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<div class='show_sql'><span class="n">INFO</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">Engine</span><span class="w"> </span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">table_info</span><span class="p">(</span><span class="ss">&quot;my_table&quot;</span><span class="p">)</span>
<span class="n">INFO</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">Engine</span><span class="w"> </span><span class="p">()</span>
<span class="n">DEBUG</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">Engine</span><span class="w"> </span><span class="n">Col</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;cid&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;notnull&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dflt_value&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pk&#39;</span><span class="p">)</span>
</div></pre></div>
</div>
<p>通常，当一个应用程序使用自定义类型定义了显式的   <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  元数据时，就不需要使用表反射，因为所需的   :class:` _schema.Table`  元数据已经存在。然而，对于应用程序或它们的组合需要使用既包括自定义的 Python 层次结构数据类型，又设置其   <a class="reference internal" href="metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  对象为从数据库反射的   :class:` _schema.Table`  对象，仍需要展示自定义数据类型的额外 Python 行为的情况，需要采取额外措施。</p>
<p>最直接的方法是覆盖特定的列，如   <span class="xref std std-ref">reflection_overriding_columns</span>  中所述。在这种技术中，我们使用反射与显式   :class:` _schema.Column`  对象相结合，对于那些我们想要使用自定义或装饰数据类型的列，我们使用他们来覆盖反射的对象：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">metadata_three</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_reflected_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;my_table&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">metadata_three</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">PickleType</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span></pre></div>
</div>
<p>上述的 <cite>my_reflected_table</cite> 对象是反射的，会从 SQLite 数据库中加载 “id” 列的定义。但是对于 “data” 列，我们已经用包含我们想要的 Python 数据类型   <a class="reference internal" href="type_basics.html#sqlalchemy.types.PickleType" title="sqlalchemy.types.PickleType"><code class="xref py py-class docutils literal notranslate"><span class="pre">PickleType</span></code></a>  的   :class:` _schema.Column`  显式定义来覆盖了反射的对象。反射过程将保持此   <a class="reference internal" href="metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  对象不变：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_reflected_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">type</span>
<span class="go">PickleType()</span></pre></div>
</div>
<p>从数据库本地类型对象转换为自定义数据类型的更复杂的方法是使用  <a class="reference internal" href="events.html#sqlalchemy.events.DDLEvents.column_reflect" title="sqlalchemy.events.DDLEvents.column_reflect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DDLEvents.column_reflect()</span></code></a>  事件处理程序。如果我们知道我们希望所有的   :class:` .BLOB`  数据类型实际上都是   <a class="reference internal" href="type_basics.html#sqlalchemy.types.PickleType" title="sqlalchemy.types.PickleType"><code class="xref py py-class docutils literal notranslate"><span class="pre">PickleType</span></code></a> ，我们可以设置一条规则:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">BLOB</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">PickleType</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Table</span><span class="p">,</span> <span class="s2">&quot;column_reflect&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_setup_pickletype</span><span class="p">(</span><span class="n">inspector</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column_info</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">column_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">BLOB</span><span class="p">):</span>
        <span class="n">column_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PickleType</span><span class="p">()</span></pre></div>
</div>
<p>在反射任何包含   <a class="reference internal" href="type_basics.html#sqlalchemy.types.BLOB" title="sqlalchemy.types.BLOB"><code class="xref py py-class docutils literal notranslate"><span class="pre">BLOB</span></code></a>  数据类型列的   :class:` _schema.Table`  时，如果在应用程序中调用了上述代码 <em>之前</em> （同时注意在应用程序中仅调用 <strong>一次</strong>，因为这是一个全局规则），所得到的数据类型将在   <a class="reference internal" href="metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  对象中以   :class:` .PickleType`  存储。</p>
<p>在实践中，上述基于事件的方法可能有附加规则，以便仅影响那些数据类型很重要的列，例如表名和可能的列名的查找表，或其他启发式规则，以便准确确定哪些列应该使用 Python 数据类型来建立。</p>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="type_basics.html" title="previous chapter">类型层次结构</a>
        Next:
        <a href="type_api.html" title="next chapter">数据库类型 API</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 18:58:41

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


