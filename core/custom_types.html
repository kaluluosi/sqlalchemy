<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    自定义类型
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="SQL数据库类型对象" href="types.html" />
        <link rel="next" title="基础类型 API" href="type_api.html" />
        <link rel="prev" title="类型层次结构" href="type_basics.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy核心模块">SQLAlchemy核心模块</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="expression_api.html">SQL语句和表达式API</a></span></li>
<li><span class="link-container"><a class="reference external" href="schema.html">Schema定义语言</a></span></li>
<li><span class="link-container"><a class="reference external" href="types.html">SQL数据库类型对象</a></span><ul>
<li><span class="link-container"><a class="reference external" href="type_basics.html">类型层次结构</a></span></li>
<li class="selected"><span class="link-container"><strong>自定义类型</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id2">覆盖类型编译</a></span></li>
<li><span class="link-container"><a class="reference external" href="#types-typedecorator">增强现有类型</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.cache_ok"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.cache_ok</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.Comparator"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.Comparator.operate"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator.operate()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.Comparator.reverse_operate"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator.reverse_operate()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.__init__"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.__init__()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.bind_expression"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.bind_expression()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.bind_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.bind_processor()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.coerce_to_is_types"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.coerce_to_is_types</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.column_expression"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.column_expression()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.comparator_factory"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.comparator_factory</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.compare_values"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.compare_values()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.copy"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.copy()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.get_dbapi_type"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.get_dbapi_type()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.literal_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.literal_processor()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.load_dialect_impl()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.process_bind_param"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.process_literal_param"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_literal_param()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.process_result_value"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.result_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.result_processor()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.sort_key_function"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.sort_key_function</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.TypeDecorator.type_engine"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.type_engine()</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#typedecorator-recipes">TypeDecorator Recipes</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#unicode">将编码的字符串转换为 Unicode</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id20">四舍五入数值型</a></span></li>
<li><span class="link-container"><a class="reference external" href="#utc">以UTC时区不带时区的形式存储时区感知时间戳</a></span></li>
<li><span class="link-container"><a class="reference external" href="#guid">后端不受限制的 GUID 类型</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#python-uuid-uuid-orm">将 Python uuid.UUID 链接到自定义类型以进行 ORM 映射</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#json">采用 JSON 字符串</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id27">添加可变性</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id28">处理比较操作</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sql">应用 SQL 级别的绑定/结果处理</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id39">创建新类型</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.UserDefinedType.cache_ok"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.cache_ok</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.UserDefinedType.coerce_compared_value"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.coerce_compared_value()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.types.UserDefinedType.ensure_kwarg"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.ensure_kwarg</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#custom-and-decorated-types-reflection">使用自定义类型和反射操作</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="type_api.html">基础类型 API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="engines_connections.html">引擎和连接使用</a></span></li>
<li><span class="link-container"><a class="reference external" href="api_basics.html">核心API基础知识</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="type_basics.html" title="previous chapter">类型层次结构</a></li>
                <li><b>Next:</b>
                <a href="type_api.html" title="next chapter">基础类型 API</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy核心模块">SQLAlchemy核心模块</a></li>
                    <ul><li><a href="types.html" title="SQL数据库类型对象">SQL数据库类型对象</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#types-custom">自定义类型</a><ul>
<li><a class="reference internal" href="#id2">覆盖类型编译</a></li>
<li><a class="reference internal" href="#types-typedecorator">增强现有类型</a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.cache_ok"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.cache_ok</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator.operate()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.reverse_operate"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.Comparator.reverse_operate()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.__init__"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.__init__()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.bind_expression"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.bind_expression()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.bind_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.bind_processor()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_to_is_types"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.coerce_to_is_types</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.column_expression"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.column_expression()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.comparator_factory"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.comparator_factory</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.compare_values"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.compare_values()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.copy"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.copy()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.get_dbapi_type"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.get_dbapi_type()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.literal_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.literal_processor()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.load_dialect_impl()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_literal_param"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_literal_param()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.result_processor"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.result_processor()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.sort_key_function"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.sort_key_function</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.type_engine"><code class="docutils literal notranslate"><span class="pre">TypeDecorator.type_engine()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#typedecorator-recipes">TypeDecorator Recipes</a><ul>
<li><a class="reference internal" href="#unicode">将编码的字符串转换为 Unicode</a></li>
<li><a class="reference internal" href="#id20">四舍五入数值型</a></li>
<li><a class="reference internal" href="#utc">以UTC时区不带时区的形式存储时区感知时间戳</a></li>
<li><a class="reference internal" href="#guid">后端不受限制的 GUID 类型</a><ul>
<li><a class="reference internal" href="#python-uuid-uuid-orm">将 Python uuid.UUID 链接到自定义类型以进行 ORM 映射</a></li>
</ul>
</li>
<li><a class="reference internal" href="#json">采用 JSON 字符串</a><ul>
<li><a class="reference internal" href="#id27">添加可变性</a></li>
<li><a class="reference internal" href="#id28">处理比较操作</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sql">应用 SQL 级别的绑定/结果处理</a></li>
<li><a class="reference internal" href="#id39">创建新类型</a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.types.UserDefinedType.cache_ok"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.cache_ok</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.UserDefinedType.coerce_compared_value"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.coerce_compared_value()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.types.UserDefinedType.ensure_kwarg"><code class="docutils literal notranslate"><span class="pre">UserDefinedType.ensure_kwarg</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#custom-and-decorated-types-reflection">使用自定义类型和反射操作</a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar core-custom_types" >
        
<section id="types-custom">
<span id="id1"></span><h1>自定义类型<a class="headerlink" href="#types-custom" title="Permalink to this heading">¶</a></h1>
<p>有多种方法可重新定义现有类型的行为，以及提供新的类型。</p>
<section id="id2">
<h2>覆盖类型编译<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<p>频繁需求是强制一个类型的“字符串”版本，也就是在CREATE TABLE语句或其他SQL函数（如CAST）中呈现的版本被更改。例如，应用程序可能希望强制在除一个外的所有平台上都采用“BINARY”来呈现，而在其中一个应用程序中则希望呈现“BLOB”。对于大多数用例，最好使用现有的通用类型（在本例中为：class:<cite>~sqlalchemy.types.LargeBinary</cite>），但要更准确地控制类型，可以将每方言都有一个编译指令与任何类型相关联：</p>
<blockquote>
<div><p>from sqlalchemy.ext.compiler import compiles
from sqlalchemy.types import BINARY</p>
<p>&#64;compiles(BINARY, “sqlite”)
def compile_binary_sqlite(<a href="#id45"><span class="problematic" id="id46">type_</span></a>, compiler, <a href="#id3"><span class="problematic" id="id4">**</span></a>kw):</p>
<blockquote>
<div><p>return “BLOB”</p>
</div></blockquote>
</div></blockquote>
<p>上述代码允许使用:class:<cite>~sqlalchemy.types.BINARY</cite>，它将生成字符串’BINARY’（在所有后端除SQLite外），在此情况下它将生成“BLOB”。</p>
<p>有关其他示例，请参阅:ref:<cite>type_compilation_extension</cite> 部分，.:ref:<cite>sqlalchemy.ext.compiler_toplevel</cite> 下面的子部分。</p>
</section>
<section id="types-typedecorator">
<span id="id5"></span><h2>增强现有类型<a class="headerlink" href="#types-typedecorator" title="Permalink to this heading">¶</a></h2>
<p>:class:<a href="#id6"><span class="problematic" id="id7">`</span></a>~sqlalchemy.types.TypeDecorator`允许创建自定义类型，它将添加绑定参数和结果处理行为到现有的类型对象中。当需要对数据进行额外的Python-to-db marshal（也就是从和向应用程序编排数据库）时使用它。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code>。每个DBAPI都是特定bot DBAPI进行处理的。虽然可以通过直接子类化来替换给定类型的此处理，但在实践中不需要，SQLAlchemy 公开了现在不支持此类公共使用情况。</p>
</div>
<aside class="topic">
<p class="topic-title">ORM 提示</p>
<p>:class:<a href="#id8"><span class="problematic" id="id9">`</span></a>~sqlalchemy.types.TypeDecorator`可用于提供一种一致的方式，用于将某种类型的值转换为传递到和从数据库传出。使用ORM时，使用与ORM无关的技术可以用于转换用户数据，这是使用 :func:<a href="#id10"><span class="problematic" id="id11">`</span></a>~sqlalchemy.orm.validates`装饰器。当需要将通过ORM模型传入的数据规范化为特定于业务的某种方式时，此技术可能更合适，并且不如数据类型通用。</p>
</aside>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><span class="sig-name descname">TypeDecorator</span></a></p></td>
<td><p>Allows the creation of types which add additional functionality
to an existing type.</p></td>
</tr>
</tbody>
</table>
<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.types.</span></span><span class="sig-name descname"><span class="pre">TypeDecorator</span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows the creation of types which add additional functionality
to an existing type.</p>
<p>This method is preferred to direct subclassing of SQLAlchemy’s
built-in types as it ensures that all required functionality of
the underlying type is kept in place.</p>
<p>Typical usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy.types</span> <span class="k">as</span> <span class="nn">types</span>

<span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Prefixes Unicode values with &quot;PREFIX:&quot; on the way in and</span>
<span class="sd">    strips it off on the way out.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PREFIX:&quot;</span> <span class="o">+</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MyType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">length</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The class-level <code class="docutils literal notranslate"><span class="pre">impl</span></code> attribute is required, and can reference any
<a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> class.  Alternatively, the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl" title="sqlalchemy.types.TypeDecorator.load_dialect_impl"><code class="xref py py-meth docutils literal notranslate"><span class="pre">load_dialect_impl()</span></code></a>
method can be used to provide different type classes based on the dialect
given; in this case, the <code class="docutils literal notranslate"><span class="pre">impl</span></code> variable can reference
<code class="docutils literal notranslate"><span class="pre">TypeEngine</span></code> as a placeholder.</p>
<p>The <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.cache_ok" title="sqlalchemy.types.TypeDecorator.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TypeDecorator.cache_ok</span></code></a> class-level flag indicates if this
custom <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> is safe to be used as part of a cache key.
This flag defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code> which will initially generate a warning
when the SQL compiler attempts to generate a cache key for a statement
that uses this type.  If the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> is not guaranteed
to produce the same bind/result behavior and SQL generation
every time, this flag should be set to <code class="docutils literal notranslate"><span class="pre">False</span></code>; otherwise if the
class produces the same behavior each time, it may be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.
See <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.cache_ok" title="sqlalchemy.types.TypeDecorator.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TypeDecorator.cache_ok</span></code></a> for further notes on how this works.</p>
<p>Types that receive a Python type that isn’t similar to the ultimate type
used may want to define the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a>
method. This is used to give the expression system a hint when coercing
Python objects into bind parameters within expressions. Consider this
expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">somecol</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span></pre></div>
</div>
<p>Above, if “somecol” is an <code class="docutils literal notranslate"><span class="pre">Integer</span></code> variant, it makes sense that
we’re doing date arithmetic, where above is usually interpreted
by databases as adding a number of days to the given date.
The expression system does the right thing by not attempting to
coerce the “date()” value into an integer-oriented bind parameter.</p>
<p>However, in the case of <code class="docutils literal notranslate"><span class="pre">TypeDecorator</span></code>, we are usually changing an
incoming Python type to something new - <code class="docutils literal notranslate"><span class="pre">TypeDecorator</span></code> by default will
“coerce” the non-typed side to be the same type as itself. Such as below,
we define an “epoch” type that stores a date value as an integer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyEpochType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span>

    <span class="n">epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Our expression of <code class="docutils literal notranslate"><span class="pre">somecol</span> <span class="pre">+</span> <span class="pre">date</span></code> with the above type will coerce the
“date” on the right side to also be treated as <code class="docutils literal notranslate"><span class="pre">MyEpochType</span></code>.</p>
<p>This behavior can be overridden via the
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a> method, which returns a type
that should be used for the value of the expression. Below we set it such
that an integer value will be treated as an <code class="docutils literal notranslate"><span class="pre">Integer</span></code>, and any other
value is assumed to be a date and will be treated as a <code class="docutils literal notranslate"><span class="pre">MyEpochType</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">coerce_compared_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Integer</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note that the <strong>behavior of coerce_compared_value is not inherited
by default from that of the base type</strong>.
If the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> is augmenting a
type that requires special logic for certain types of operators,
this method <strong>must</strong> be overridden.  A key example is when decorating
the <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSON" title="sqlalchemy.dialects.postgresql.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSONB</span></code></a> types;
the default rules of <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.coerce_compared_value" title="sqlalchemy.types.TypeEngine.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.coerce_compared_value()</span></code></a> should
be used in order to deal with operators like index operations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">TypeDecorator</span>

<span class="k">class</span> <span class="nc">MyJsonType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">JSON</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">coerce_compared_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">coerce_compared_value</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Without the above step, index operations such as <code class="docutils literal notranslate"><span class="pre">mycol['foo']</span></code>
will cause the index value <code class="docutils literal notranslate"><span class="pre">'foo'</span></code> to be JSON encoded.</p>
<p>Similarly, when working with the <a class="reference internal" href="type_basics.html#sqlalchemy.types.ARRAY" title="sqlalchemy.types.ARRAY"><code class="xref py py-class docutils literal notranslate"><span class="pre">ARRAY</span></code></a> datatype, the
type coercion for index operations (e.g. <code class="docutils literal notranslate"><span class="pre">mycol[5]</span></code>) is also
handled by <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a>, where
again a simple override is sufficient unless special rules are needed
for particular operators:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ARRAY</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">TypeDecorator</span>

<span class="k">class</span> <span class="nc">MyArrayType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">ARRAY</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">coerce_compared_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">coerce_compared_value</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</div>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.cache_ok"><span class="sig-name descname">cache_ok</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate"><span class="sig-name descname">operate()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.reverse_operate"><span class="sig-name descname">reverse_operate()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.__init__"><span class="sig-name descname">__init__()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.bind_expression"><span class="sig-name descname">bind_expression()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.bind_processor"><span class="sig-name descname">bind_processor()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value"><span class="sig-name descname">coerce_compared_value()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_to_is_types"><span class="sig-name descname">coerce_to_is_types</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.column_expression"><span class="sig-name descname">column_expression()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.comparator_factory"><span class="sig-name descname">comparator_factory</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.compare_values"><span class="sig-name descname">compare_values()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.copy"><span class="sig-name descname">copy()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.get_dbapi_type"><span class="sig-name descname">get_dbapi_type()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.literal_processor"><span class="sig-name descname">literal_processor()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl"><span class="sig-name descname">load_dialect_impl()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param"><span class="sig-name descname">process_bind_param()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_literal_param"><span class="sig-name descname">process_literal_param()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value"><span class="sig-name descname">process_result_value()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.result_processor"><span class="sig-name descname">result_processor()</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.sort_key_function"><span class="sig-name descname">sort_key_function</span></a>, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.type_engine"><span class="sig-name descname">type_engine()</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator</span></code></a> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.sql.expression.SchemaEventTarget</span></code>, <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.ExternalType</span></code></a>, <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeEngine</span></code></a>)</p>
</div>
<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.cache_ok">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">cache_ok</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">bool</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></em><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">None</span></em><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.cache_ok" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType.cache_ok" title="sqlalchemy.types.ExternalType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExternalType.cache_ok</span></code></a> <em>attribute of</em> <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a></p>
</div>
<p>Indicate if statements using this <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a> are “safe to
cache”.</p>
<p>The default value <code class="docutils literal notranslate"><span class="pre">None</span></code> will emit a warning and then not allow caching
of a statement which includes this type.   Set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to disable
statements using this type from being cached at all without a warning.
When set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the object’s class and selected elements from its
state will be used as part of the cache key.  For example, using a
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_only</span> <span class="o">=</span> <span class="kc">True</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The cache key for the above type would be equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">MyType</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">(&lt;class &#39;__main__.MyType&#39;&gt;, (&#39;choices&#39;, (&#39;a&#39;, &#39;b&#39;, &#39;c&#39;)))</span></pre></div>
</div>
<p>The caching scheme will extract attributes from the type that correspond
to the names of parameters in the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method.  Above, the
“choices” attribute becomes part of the cache key but “internal_only”
does not, because there is no parameter named “internal_only”.</p>
<p>The requirements for cacheable elements is that they are hashable
and also that they indicate the same SQL rendered for expressions using
this type every time for a given cache value.</p>
<p>To accommodate for datatypes that refer to unhashable structures such
as dictionaries, sets and lists, these objects can be made “cacheable”
by assigning hashable structures to the attributes whose names
correspond with the names of the arguments.  For example, a datatype
which accepts a dictionary of lookup values may publish this as a sorted
series of tuples.   Given a previously un-cacheable type as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LookupType</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;a custom type that accepts a dictionary as a parameter.</span>

<span class="sd">    this is the non-cacheable version, as &quot;self.lookup&quot; is not</span>
<span class="sd">    hashable.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(255)&quot;</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># ...  works with &quot;self.lookup&quot; ...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where “lookup” is a dictionary.  The type will not be able to generate
a cache key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span> <span class="o">=</span> <span class="n">LookupType</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">&lt;stdin&gt;:1: SAWarning: UserDefinedType LookupType({&#39;a&#39;: 10, &#39;b&#39;: 20}) will not</span>
<span class="go">produce a cache key because the ``cache_ok`` flag is not set to True.</span>
<span class="go">Set this flag to True if this type object&#39;s state is safe to use</span>
<span class="go">in a cache key, or False to disable this warning.</span>
<span class="go">symbol(&#39;no_cache&#39;)</span></pre></div>
</div>
<p>If we <strong>did</strong> set up such a cache key, it wouldn’t be usable. We would
get a tuple structure that contains a dictionary inside of it, which
cannot itself be used as a key in a “cache dictionary” such as SQLAlchemy’s
statement cache, since Python dictionaries aren’t hashable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># set cache_ok = True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span><span class="o">.</span><span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># this is the cache key it would generate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span>
<span class="go">(&lt;class &#39;__main__.LookupType&#39;&gt;, (&#39;lookup&#39;, {&#39;a&#39;: 10, &#39;b&#39;: 20}))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># however this key is not hashable, will fail when used with</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># SQLAlchemy statement cache</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">some_cache</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s2">&quot;some sql value&quot;</span><span class="p">}</span>
<span class="go">Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1,</span>
<span class="go">in &lt;module&gt; TypeError: unhashable type: &#39;dict&#39;</span></pre></div>
</div>
<p>The type may be made cacheable by assigning a sorted tuple of tuples
to the “.lookup” attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LookupType</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;a custom type that accepts a dictionary as a parameter.</span>

<span class="sd">    The dictionary is stored both as itself in a private variable,</span>
<span class="sd">    and published in a public variable as a sorted tuple of tuples,</span>
<span class="sd">    which is hashable and will also return the same value for any</span>
<span class="sd">    two equivalent dictionaries.  Note it assumes the keys and</span>
<span class="sd">    values of the dictionary are themselves hashable.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span> <span class="o">=</span> <span class="n">lookup</span>

        <span class="c1"># assume keys/values of &quot;lookup&quot; are hashable; otherwise</span>
        <span class="c1"># they would also need to be converted in some way here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">lookup</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sorted</span><span class="p">(</span><span class="n">lookup</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(255)&quot;</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># ...  works with &quot;self._lookup&quot; ...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where above, the cache key for <code class="docutils literal notranslate"><span class="pre">LookupType({&quot;a&quot;:</span> <span class="pre">10,</span> <span class="pre">&quot;b&quot;:</span> <span class="pre">20})</span></code> will be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">LookupType</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">(&lt;class &#39;__main__.LookupType&#39;&gt;, (&#39;lookup&#39;, ((&#39;a&#39;, 10), (&#39;b&#39;, 20))))</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.14: </span>- added the <code class="docutils literal notranslate"><span class="pre">cache_ok</span></code> flag to allow
some configurability of caching for <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> classes.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.28: </span>- added the <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a> mixin which
generalizes the <code class="docutils literal notranslate"><span class="pre">cache_ok</span></code> flag to both the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>
and <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> classes.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="connections.html#sql-caching"><span class="std std-ref">SQL编译缓存</span></a></p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.Comparator">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Comparator</span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.Comparator" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.Comparator" title="sqlalchemy.types.TypeEngine.Comparator"><code class="xref py py-class docutils literal notranslate"><span class="pre">Comparator</span></code></a> that is specific to
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>User-defined <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> classes should not typically
need to modify this.</p>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator" title="sqlalchemy.types.TypeDecorator.Comparator"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.Comparator</span></code></a> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.Comparator</span></code>)</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.Comparator.operate">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.Comparator.</span></code></a><span class="sig-name descname"><span class="pre">operate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">OperatorType</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">other</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_CT</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.Comparator.operate" title="Permalink to this definition">¶</a></dt>
<dd><p>Operate on an argument.</p>
<p>This is the lowest level of operation, raises
<code class="xref py py-class docutils literal notranslate"><span class="pre">NotImplementedError</span></code> by default.</p>
<p>Overriding this on a subclass can allow common
behavior to be applied to all operations.
For example, overriding <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnOperators" title="sqlalchemy.sql.expression.ColumnOperators"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnOperators</span></code></a>
to apply <code class="docutils literal notranslate"><span class="pre">func.lower()</span></code> to the left and right
side:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyComparator</span><span class="p">(</span><span class="n">ColumnOperators</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.Comparator.operate.params.op"></span><strong>op</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate.params.op">¶</a> – Operator callable.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.Comparator.operate.params.*other"></span><strong>*other</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate.params.*other">¶</a> – the ‘other’ side of the operation. Will
be a single scalar for most operations.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.Comparator.operate.params.**kwargs"></span><strong>**kwargs</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate.params.**kwargs">¶</a> – modifiers.  These may be passed by special
operators such as <code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.contains()</span></code>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.Comparator.reverse_operate">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.Comparator.</span></code></a><span class="sig-name descname"><span class="pre">reverse_operate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">OperatorType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">other</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_CT</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.Comparator.reverse_operate" title="Permalink to this definition">¶</a></dt>
<dd><p>Reverse operate on an argument.</p>
<p>Usage is the same as <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.Comparator.operate" title="sqlalchemy.types.TypeDecorator.Comparator.operate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">operate()</span></code></a>.</p>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.__init__">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Construct a <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>Arguments sent here are passed to the constructor
of the class assigned to the <code class="docutils literal notranslate"><span class="pre">impl</span></code> class level attribute,
assuming the <code class="docutils literal notranslate"><span class="pre">impl</span></code> is a callable, and the resulting
object is assigned to the <code class="docutils literal notranslate"><span class="pre">self.impl</span></code> instance attribute
(thus overriding the class attribute of the same name).</p>
<p>If the class level <code class="docutils literal notranslate"><span class="pre">impl</span></code> is not a callable (the unusual case),
it will be assigned to the same instance attribute ‘as-is’,
ignoring those arguments passed to the constructor.</p>
<p>Subclasses can override this to customize the generation
of <code class="docutils literal notranslate"><span class="pre">self.impl</span></code> entirely.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.bind_expression">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">bind_expression</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bindparam</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.BindParameter" title="sqlalchemy.sql.expression.BindParameter"><span class="pre">BindParameter</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.bind_expression" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a bind value (i.e. a <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.BindParameter" title="sqlalchemy.sql.expression.BindParameter"><code class="xref py py-class docutils literal notranslate"><span class="pre">BindParameter</span></code></a> instance),
return a SQL expression which will typically wrap the given parameter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method is called during the <strong>SQL compilation</strong> phase of a
statement, when rendering a SQL string. It is <strong>not</strong> necessarily
called against specific values, and should not be confused with the
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="sqlalchemy.types.TypeDecorator.process_bind_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a> method, which is
the more typical method that processes the actual value passed to a
particular parameter at statement execution time.</p>
</div>
<p>Subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> can override this method
to provide custom bind expression behavior for the type.  This
implementation will <strong>replace</strong> that of the underlying implementation
type.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.bind_processor">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">bind_processor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_BindProcessorType</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.bind_processor" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide a bound value processing function for the
given <a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a>.</p>
<p>This is the method that fulfills the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a>
contract for bound value conversion which normally occurs via
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.bind_processor" title="sqlalchemy.types.TypeEngine.bind_processor"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.bind_processor()</span></code></a> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>User-defined subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should
<strong>not</strong> implement this method, and should instead implement
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="sqlalchemy.types.TypeDecorator.process_bind_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a> so that the “inner”
processing provided by the implementing type is maintained.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="target" id="sqlalchemy.types.TypeDecorator.bind_processor.params.dialect"></span><strong>dialect</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.bind_processor.params.dialect">¶</a> – Dialect instance in use.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.coerce_compared_value">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">coerce_compared_value</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">OperatorType</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Any</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Suggest a type for a ‘coerced’ Python value in an expression.</p>
<p>By default, returns self.   This method is called by
the expression system when an object using this type is
on the left or right side of an expression against a plain Python
object which does not yet have a SQLAlchemy type assigned:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expr</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">somecolumn</span> <span class="o">+</span> <span class="mi">35</span></pre></div>
</div>
<p>Where above, if <code class="docutils literal notranslate"><span class="pre">somecolumn</span></code> uses this type, this method will
be called with the value <code class="docutils literal notranslate"><span class="pre">operator.add</span></code>
and <code class="docutils literal notranslate"><span class="pre">35</span></code>.  The return value is whatever SQLAlchemy type should
be used for <code class="docutils literal notranslate"><span class="pre">35</span></code> for this particular operation.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.coerce_to_is_types">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">coerce_to_is_types</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference internal" href="defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><span class="pre">Sequence</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></em><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">(&lt;class</span> <span class="pre">'NoneType'&gt;,)</span></em><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.coerce_to_is_types" title="Permalink to this definition">¶</a></dt>
<dd><p>Specify those Python types which should be coerced at the expression
level to “IS &lt;constant&gt;” when compared using <code class="docutils literal notranslate"><span class="pre">==</span></code> (and same for
<code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NOT</span></code> in conjunction with <code class="docutils literal notranslate"><span class="pre">!=</span></code>).</p>
<p>For most SQLAlchemy types, this includes <code class="docutils literal notranslate"><span class="pre">NoneType</span></code>, as well as
<code class="docutils literal notranslate"><span class="pre">bool</span></code>.</p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> modifies this list to only include <code class="docutils literal notranslate"><span class="pre">NoneType</span></code>,
as typedecorator implementations that deal with boolean types are common.</p>
<p>Custom <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> classes can override this attribute to
return an empty tuple, in which case no values will be coerced to
constants.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.column_expression">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">column_expression</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><span class="pre">ColumnElement</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.column_expression" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a SELECT column expression, return a wrapping SQL expression.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method is called during the <strong>SQL compilation</strong> phase of a
statement, when rendering a SQL string. It is <strong>not</strong> called
against specific values, and should not be confused with the
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value" title="sqlalchemy.types.TypeDecorator.process_result_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a> method, which is
the more typical method that processes the actual value returned
in a result row subsequent to statement execution time.</p>
</div>
<p>Subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> can override this method
to provide custom column expression behavior for the type.  This
implementation will <strong>replace</strong> that of the underlying implementation
type.</p>
<p>See the description of <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.column_expression" title="sqlalchemy.types.TypeEngine.column_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.column_expression()</span></code></a>
for a complete description of the method’s use.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.comparator_factory">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">comparator_factory</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">_ComparatorFactory</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></em><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.comparator_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.Comparator" title="sqlalchemy.types.TypeEngine.Comparator"><code class="xref py py-class docutils literal notranslate"><span class="pre">Comparator</span></code></a> class which will apply
to operations performed by owning <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnElement</span></code></a>
objects.</p>
<p>The <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.comparator_factory" title="sqlalchemy.types.TypeDecorator.comparator_factory"><code class="xref py py-attr docutils literal notranslate"><span class="pre">comparator_factory</span></code></a> attribute is a hook consulted by
the core expression system when column and SQL expression operations
are performed.   When a <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.Comparator" title="sqlalchemy.types.TypeEngine.Comparator"><code class="xref py py-class docutils literal notranslate"><span class="pre">Comparator</span></code></a> class is
associated with this attribute, it allows custom re-definition of
all existing operators, as well as definition of new operators.
Existing operators include those provided by Python operator overloading
such as <code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.__add__()</span></code> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.__eq__()</span></code>,
those provided as standard
attributes of <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnOperators" title="sqlalchemy.sql.operators.ColumnOperators"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnOperators</span></code></a> such as
<code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.like()</span></code>
and <code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.in_()</span></code>.</p>
<p>Rudimentary usage of this hook is allowed through simple subclassing
of existing types, or alternatively by using <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.
See the documentation section <span class="xref std std-ref">types_operators</span> for examples.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.compare_values">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">compare_values</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">x</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">y</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bool</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.compare_values" title="Permalink to this definition">¶</a></dt>
<dd><p>Given two values, compare them for equality.</p>
<p>By default this calls upon <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.compare_values" title="sqlalchemy.types.TypeEngine.compare_values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.compare_values()</span></code></a>
of the underlying “impl”, which in turn usually
uses the Python equals operator <code class="docutils literal notranslate"><span class="pre">==</span></code>.</p>
<p>This function is used by the ORM to compare
an original-loaded value with an intercepted
“changed” value, to determine if a net change
has occurred.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.copy">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">copy</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kw</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Self</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.copy" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce a copy of this <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> instance.</p>
<p>This is a shallow copy and is provided to fulfill part of
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> contract.  It usually does not
need to be overridden unless the user-defined <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>
has local state that should be deep-copied.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.get_dbapi_type">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">get_dbapi_type</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dbapi</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">module</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Any</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.get_dbapi_type" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the DBAPI type object represented by this
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>By default this calls upon <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.get_dbapi_type" title="sqlalchemy.types.TypeEngine.get_dbapi_type"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.get_dbapi_type()</span></code></a> of the
underlying “impl”.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.literal_processor">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">literal_processor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_LiteralProcessorType</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.literal_processor" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide a literal processing function for the given
<a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a>.</p>
<p>This is the method that fulfills the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a>
contract for literal value conversion which normally occurs via
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.literal_processor" title="sqlalchemy.types.TypeEngine.literal_processor"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.literal_processor()</span></code></a> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>User-defined subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should
<strong>not</strong> implement this method, and should instead implement
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_literal_param" title="sqlalchemy.types.TypeDecorator.process_literal_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_literal_param()</span></code></a> so that the
“inner” processing provided by the implementing type is maintained.</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.load_dialect_impl">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">load_dialect_impl</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><span class="pre">TypeEngine</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> object corresponding to a dialect.</p>
<p>This is an end-user override hook that can be used to provide
differing types depending on the given dialect.  It is used
by the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> implementation of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator.type_engine" title="sqlalchemy.types.TypeDecorator.type_engine"><code class="xref py py-meth docutils literal notranslate"><span class="pre">type_engine()</span></code></a>
to help determine what type should ultimately be returned
for a given <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>By default returns <code class="docutils literal notranslate"><span class="pre">self.impl</span></code>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.process_bind_param">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">process_bind_param</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Any</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="Permalink to this definition">¶</a></dt>
<dd><p>Receive a bound parameter value to be converted.</p>
<p>Custom subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should override
this method to provide custom behaviors for incoming data values.
This method is called at <strong>statement execution time</strong> and is passed
the literal Python data value which is to be associated with a bound
parameter in the statement.</p>
<p>The operation could be anything desired to perform custom
behavior, such as transforming or serializing data.
This could also be used as a hook for validating logic.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.process_bind_param.params.value"></span><strong>value</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param.params.value">¶</a> – Data to operate upon, of any type expected by
this method in the subclass.  Can be <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.process_bind_param.params.dialect"></span><strong>dialect</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param.params.dialect">¶</a> – the <a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a> in use.</p></li>
</ul>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#types-typedecorator"><span class="std std-ref">增强现有类型</span></a></p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value" title="sqlalchemy.types.TypeDecorator.process_result_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.process_literal_param">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">process_literal_param</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_T</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">str</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.process_literal_param" title="Permalink to this definition">¶</a></dt>
<dd><p>Receive a literal parameter value to be rendered inline within
a statement.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method is called during the <strong>SQL compilation</strong> phase of a
statement, when rendering a SQL string. Unlike other SQL
compilation methods, it is passed a specific Python value to be
rendered as a string. However it should not be confused with the
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="sqlalchemy.types.TypeDecorator.process_bind_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a> method, which is
the more typical method that processes the actual value passed to a
particular parameter at statement execution time.</p>
</div>
<p>Custom subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should override
this method to provide custom behaviors for incoming data values
that are in the special case of being rendered as literals.</p>
<p>The returned string will be rendered into the output string.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.process_result_value">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">process_result_value</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_T</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.process_result_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Receive a result-row column value to be converted.</p>
<p>Custom subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should override
this method to provide custom behaviors for data values
being received in result rows coming from the database.
This method is called at <strong>result fetching time</strong> and is passed
the literal Python data value that’s extracted from a database result
row.</p>
<p>The operation could be anything desired to perform custom
behavior, such as transforming or deserializing data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.process_result_value.params.value"></span><strong>value</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value.params.value">¶</a> – Data to operate upon, of any type expected by
this method in the subclass.  Can be <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.process_result_value.params.dialect"></span><strong>dialect</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value.params.dialect">¶</a> – the <a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a> in use.</p></li>
</ul>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#types-typedecorator"><span class="std std-ref">增强现有类型</span></a></p>
<p><a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_bind_param" title="sqlalchemy.types.TypeDecorator.process_bind_param"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_bind_param()</span></code></a></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.result_processor">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">result_processor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">coltype</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_ResultProcessorType</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.result_processor" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide a result value processing function for the given
<a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code></a>.</p>
<p>This is the method that fulfills the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a>
contract for bound value conversion which normally occurs via
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.result_processor" title="sqlalchemy.types.TypeEngine.result_processor"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.result_processor()</span></code></a> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>User-defined subclasses of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should
<strong>not</strong> implement this method, and should instead implement
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.process_result_value" title="sqlalchemy.types.TypeDecorator.process_result_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.process_result_value()</span></code></a> so that the
“inner” processing provided by the implementing type is maintained.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.result_processor.params.dialect"></span><strong>dialect</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.result_processor.params.dialect">¶</a> – Dialect instance in use.</p></li>
<li><p><span class="target" id="sqlalchemy.types.TypeDecorator.result_processor.params.coltype"></span><strong>coltype</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.types.TypeDecorator.result_processor.params.coltype">¶</a> – A SQLAlchemy data type</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.sort_key_function">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">sort_key_function</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></em><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.sort_key_function" title="Permalink to this definition">¶</a></dt>
<dd><p>A sorting function that can be passed as the key to sorted.</p>
<p>The default value of <code class="docutils literal notranslate"><span class="pre">None</span></code> indicates that the values stored by
this type are self-sorting.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.3.8.</span></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.TypeDecorator.type_engine">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.TypeDecorator"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeDecorator.</span></code></a><span class="sig-name descname"><span class="pre">type_engine</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.engine.Dialect" title="sqlalchemy.engine.Dialect"><span class="pre">Dialect</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><span class="pre">TypeEngine</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.TypeDecorator.type_engine" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a dialect-specific <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> instance
for this <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>.</p>
<p>In most cases this returns a dialect-adapted form of
the <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> type represented by <code class="docutils literal notranslate"><span class="pre">self.impl</span></code>.
Makes usage of <code class="xref py py-meth docutils literal notranslate"><span class="pre">dialect_impl()</span></code>.
Behavior can be customized here by overriding
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.load_dialect_impl" title="sqlalchemy.types.TypeDecorator.load_dialect_impl"><code class="xref py py-meth docutils literal notranslate"><span class="pre">load_dialect_impl()</span></code></a>.</p>
</dd></dl>

</dd></dl>

</section>
<section id="typedecorator-recipes">
<h2>TypeDecorator Recipes<a class="headerlink" href="#typedecorator-recipes" title="Permalink to this heading">¶</a></h2>
<p>一些关键的:class:<a href="#id12"><span class="problematic" id="id13">`</span></a>~sqlalchemy.types.TypeDecorator`示例如下。</p>
<section id="unicode">
<span id="coerce-to-unicode"></span><h3>将编码的字符串转换为 Unicode<a class="headerlink" href="#unicode" title="Permalink to this heading">¶</a></h3>
<p>有关:class:<a href="#id14"><span class="problematic" id="id15">`</span></a>~sqlalchemy.Unicode`类型的常见一个问题是，它只处理Python中的``unicode``对象。Python 2使用时，表示为``u’some string’<a href="#id16"><span class="problematic" id="id17">``</span></a>的值（如果不是3）是传递给绑定参数必须的对象格式。它执行的编码/解码函数仅适合DBAPI使用，是一个私有实现细节。</p>
<p>如果需要一个类型，可以安全地接收Python字节串，即包含非ASCII字符并且不是Python 2中的“u’” 对象的字符串，则可以使用:class:<a href="#id18"><span class="problematic" id="id19">`</span></a>~sqlalchemy.types.TypeDecorator`进行需要的强制转换：</p>
<blockquote>
<div><p>from sqlalchemy.types import TypeDecorator, Unicode</p>
<dl>
<dt>class CoerceUTF8(TypeDecorator):</dt><dd><p>“””Safely coerce Python bytestrings to Unicode
before passing off to the database.”””</p>
<p>impl = Unicode</p>
<dl>
<dt>def process_bind_param(self, value, dialect):</dt><dd><dl class="simple">
<dt>if isinstance(value, str):</dt><dd><p>value = value.decode(“utf-8”)</p>
</dd>
</dl>
<p>return value</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</section>
<section id="id20">
<h3>四舍五入数值型<a class="headerlink" href="#id20" title="Permalink to this heading">¶</a></h3>
<p>某些数据库连接器（如SQL Server）会在传递太多小数位数的Decimal时出现问题。下面是一个按原样舍入它们的配方：</p>
<blockquote>
<div><p>from sqlalchemy.types import TypeDecorator, Numeric
from decimal import Decimal</p>
<dl>
<dt>class SafeNumeric(TypeDecorator):</dt><dd><p>“””Adds quantization to Numeric.”””</p>
<p>impl = Numeric</p>
<dl>
<dt>def __init__(self, <a href="#id21"><span class="problematic" id="id22">*</span></a>arg, <a href="#id23"><span class="problematic" id="id24">**</span></a>kw):</dt><dd><p>TypeDecorator.__init__(self, <em>arg, **kw)
self.quantize_int = -self.impl.scale
self.quantize = Decimal(10) *</em> self.quantize_int</p>
</dd>
<dt>def process_bind_param(self, value, dialect):</dt><dd><dl class="simple">
<dt>if isinstance(value, Decimal) and value.as_tuple()[2] &lt; self.quantize_int:</dt><dd><p>value = value.quantize(self.quantize)</p>
</dd>
</dl>
<p>return value</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</section>
<section id="utc">
<h3>以UTC时区不带时区的形式存储时区感知时间戳<a class="headerlink" href="#utc" title="Permalink to this heading">¶</a></h3>
<p>时间戳始终应以时区无关的方式存储在数据库中。对于大多数数据库，这意味着在存储之前应该首先将时间戳设置在UTC时区中，并且存储在没有与之关联的时区-naive（也就是，没有与之关联的任何时区；假定UTC是“隐式”时区）中。另外，数据库特定的类型，如PostgreSQL的“TIMESTAMP WITH TIMEZONE”通常更受欢迎，因为它们具有更丰富的功能；但是，在不存在或不喜欢时区智能数据库类型时，:class:<a href="#id25"><span class="problematic" id="id26">`</span></a>~sqlalchemy.types.TypeDecorator`可以用于创建将时区感知时间戳转换为时区感知和反之的数据类型。在下面的示例 中，使用Python默认的``datetime.timezone.utc``时区来规范化和取消规范化：</p>
<blockquote>
<div><p>import datetime</p>
<dl>
<dt>class TZDateTime(TypeDecorator):</dt><dd><p>impl = DateTime
cache_ok = True</p>
<dl>
<dt>def process_bind_param(self, value, dialect):</dt><dd><dl>
<dt>if value is not None:</dt><dd><dl class="simple">
<dt>if not value.tzinfo:</dt><dd><p>raise TypeError(“tzinfo is required”)</p>
</dd>
</dl>
<p>value = value.astimezone(datetime.timezone.utc).replace(tzinfo=None)</p>
</dd>
</dl>
<p>return value</p>
</dd>
<dt>def process_result_value(self, value, dialect):</dt><dd><dl class="simple">
<dt>if value is not None:</dt><dd><p>value = value.replace(tzinfo=datetime.timezone.utc)</p>
</dd>
</dl>
<p>return value</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</section>
<section id="guid">
<span id="custom-guid-type"></span><h3>后端不受限制的 GUID 类型<a class="headerlink" href="#guid" title="Permalink to this heading">¶</a></h3>
<p>接收和返回Python uuid()对象。在使用PostgreSQL时，使用PG UUID类型，其他后端上使用 CHAR(32)，以十六进制字符串格式存储它们。如果需要，可以更改为将二进制存储在CHAR(16)中。</p>
<blockquote>
<div><p>from sqlalchemy.types import TypeDecorator, CHAR
from sqlalchemy.dialects.postgresql import UUID
import uuid</p>
<dl>
<dt>class GUID(TypeDecorator):</dt><dd><p>“””Platform-independent GUID type.</p>
<p>Uses PostgreSQL’s UUID type, otherwise uses
CHAR(32), storing as stringified hex values.</p>
<p>“””</p>
<p>impl = CHAR
cache_ok = True</p>
<dl>
<dt>def load_dialect_impl(self, dialect):</dt><dd><dl class="simple">
<dt>if dialect.name == “postgresql”:</dt><dd><p>return dialect.type_descriptor(UUID())</p>
</dd>
<dt>else:</dt><dd><p>return dialect.type_descriptor(CHAR(32))</p>
</dd>
</dl>
</dd>
<dt>def process_bind_param(self, value, dialect):</dt><dd><dl class="simple">
<dt>if value is None:</dt><dd><p>return value</p>
</dd>
<dt>elif dialect.name == “postgresql”:</dt><dd><p>return str(value)</p>
</dd>
<dt>else:</dt><dd><dl class="simple">
<dt>if not isinstance(value, uuid.UUID):</dt><dd><p>return “%.32x” % uuid.UUID(value).int</p>
</dd>
<dt>else:</dt><dd><p># hexstring
return “%.32x” % value.int</p>
</dd>
</dl>
</dd>
</dl>
</dd>
<dt>def process_result_value(self, value, dialect):</dt><dd><dl>
<dt>if value is None:</dt><dd><p>return value</p>
</dd>
<dt>else:</dt><dd><dl class="simple">
<dt>if not isinstance(value, uuid.UUID):</dt><dd><p>value = uuid.UUID(value)</p>
</dd>
</dl>
<p>return value</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<section id="python-uuid-uuid-orm">
<h4>将 Python uuid.UUID 链接到自定义类型以进行 ORM 映射<a class="headerlink" href="#python-uuid-uuid-orm" title="Permalink to this heading">¶</a></h4>
<p>使用 <a class="reference internal" href="../orm/declarative_tables.html#orm-declarative-mapped-column"><span class="std std-ref">Annotated Declarative Table</span></a>
映射声明ORM映射时，以上自定义“GUID”类型可以通过将其添加到
<code class="xref py py-class docutils literal notranslate"><span class="pre">_orm.DeclarativeBase`类上通常定义的</span> <span class="pre">:ref:`type</span> <span class="pre">annotation</span> <span class="pre">map</span></code> 来与Python`uuid.UUID`数据类型相关联：</p>
<blockquote>
<div><p>import uuid
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><dl class="simple">
<dt>type_annotation_map = {</dt><dd><p>uuid.UUID: GUID,</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<p>使用上述配置，扩展自“Base”的ORM映射类可以引用自动化地
使用``GUID``：</p>
<blockquote>
<div><dl>
<dt>class MyModel(Base):</dt><dd><p>__tablename__ = “my_table”</p>
<p>id: Mapped[uuid.UUID] = mapped_column(primary_key=True)</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/declarative_tables.html#orm-declarative-mapped-column-type-map"><span class="std std-ref">自定义类型映射</span></a></p>
</div>
</section>
</section>
<section id="json">
<h3>采用 JSON 字符串<a class="headerlink" href="#json" title="Permalink to this heading">¶</a></h3>
<p>此类型使用 <code class="docutils literal notranslate"><span class="pre">simplejson</span></code> 将Python数据结构编组到JSON。可以修改为使用Python内置的json编码器：</p>
<blockquote>
<div><p>from sqlalchemy.types import TypeDecorator, VARCHAR
import json</p>
<dl>
<dt>class JSONEncodedDict(TypeDecorator):</dt><dd><p>“””Represents an immutable structure as a json-encoded string.</p>
<p>Usage:</p>
<blockquote>
<div><p>JSONEncodedDict(255)</p>
</div></blockquote>
<p>“””</p>
<p>impl = VARCHAR</p>
<p>cache_ok = True</p>
<dl>
<dt>def process_bind_param(self, value, dialect):</dt><dd><dl class="simple">
<dt>if value is not None:</dt><dd><p>value = json.dumps(value)</p>
</dd>
</dl>
<p>return value</p>
</dd>
<dt>def process_result_value(self, value, dialect):</dt><dd><dl class="simple">
<dt>if value is not None:</dt><dd><p>value = json.loads(value)</p>
</dd>
</dl>
<p>return value</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<section id="id27">
<h4>添加可变性<a class="headerlink" href="#id27" title="Permalink to this heading">¶</a></h4>
<p>ORM默认不会检测此类型的“可变性” - 意思是，对值的原地更改将不会
检测到并不会被刷新。否则，您需要替换每个父对象上的现有价值以检测更改：：</p>
<blockquote>
<div><p>obj.json_value[“key”] = “value”  # 在ORM中将 <em>不</em> 检测到</p>
<p>obj.json_value = {“key”: “value”}  # 在ORM中将 <em>检测</em> 到</p>
</div></blockquote>
<p>如果父站上需要这种要求，则上述限制可能是正确的，因为许多
应用可能不需要一旦创建了值，就需要将其改变。 对于具有此要求的那些应用程序
最好使用``sqlalchemy.ext.mutable``扩展来支持可变性。
对于基于字典的JSON结构，我们可以使用此方法：</p>
<blockquote>
<div><p>json_type = MutableDict.as_mutable(JSONEncodedDict)</p>
<dl>
<dt>class MyClass(Base):</dt><dd><p>#  …</p>
<p>json_data = Column(json_type)</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/extensions/mutable.html"><span class="std std-ref">变异跟踪</span></a></p>
</div>
</section>
<section id="id28">
<h4>处理比较操作<a class="headerlink" href="#id28" title="Permalink to this heading">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator`的默认行为是将表达式的“右侧”强制转换为相同的类型。对于像JSON这样的类型，这意味着任何操作符使用必须在JSON的条件下有意义。</span>&#160; <span class="pre">对于一些情况，用户可能希望类型在某些情况下表现得像JSON，在其他情况下则表现得像纯文本。例如，如果希望处理JSON类型的LIKE操作符。</span> <span class="pre">为处理像</span> <span class="pre">``JSONEncodedDict</span></code> <a href="#id29"><span class="problematic" id="id30">``</span></a>类型这样的类型，我们需要在尝试使用此运算符之前使用 CAST 或 type_coerce来将列转换为文本形式：</p>
<blockquote>
<div><p>from sqlalchemy import type_coerce, String</p>
<p>stmt = select(my_table).where(type_coerce(my_table.c.json_data, String).like(“%foo%”))</p>
</div></blockquote>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnElement</span></code> 表达式构造中。：meth:<cite>.TypeEngine.Comparator`类提供抽象比较对象以提供基本行为模板，许多类型提供自己的子实现。可以直接将用户定义的 :class:</cite>.TypeEngine.Comparator` 实现构建到简单的类型子类中，以覆盖或定义新操作。下面，我们创建一个``Geometry``类型，它将应用PostGIS函数 <a href="#id31"><span class="problematic" id="id32">``</span></a>ST_GeomFromText``到所有外向值，以及函数``ST_AsText``到所有传入数据：</p>
<blockquote>
<div><p>from sqlalchemy import func
from sqlalchemy.types import UserDefinedType</p>
<dl class="simple">
<dt>class Geometry(UserDefinedType):</dt><dd><dl class="simple">
<dt>def get_col_spec(self):</dt><dd><p>return “GEOMETRY”</p>
</dd>
<dt>def bind_expression(self, bindvalue):</dt><dd><p>return func.ST_GeomFromText(bindvalue, type_=self)</p>
</dd>
<dt>def column_expression(self, col):</dt><dd><p>return func.ST_AsText(col, type_=self)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>我们可以将 <code class="docutils literal notranslate"><span class="pre">Geometry</span></code> 类型应用于 <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> metadata 中，并在使用 <a class="reference internal" href="selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> 构造中使用它：</p>
<blockquote>
<div><dl class="simple">
<dt>geometry = Table(</dt><dd><p>“geometry”,
metadata,
Column(“geom_id”, Integer, primary_key=True),
Column(“geom_data”, Geometry),</p>
</dd>
</dl>
<p>)</p>
<dl>
<dt>print(</dt><dd><dl class="simple">
<dt>select(geometry).where(</dt><dd><p>geometry.c.geom_data == “LINESTRING(189412 252431,189631 259122)”</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>SQL语句将嵌入这两个函数，如适当。 <a href="#id33"><span class="problematic" id="id34">``</span></a>ST_AsText``应用于列子句中，以便传入一个结果集之前将返回值运行通过该函数，而``ST_GeomFromText``应用于绑定参数，以便将传递值转换为：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_id</span><span class="p">,</span><span class="w"> </span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_data</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">geom_data_1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">geometry</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_GeomFromText</span><span class="p">(:</span><span class="n">geom_data_2</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.column_expression" title="sqlalchemy.types.TypeEngine.column_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.column_expression()</span></code></a> 方法与编译器的内部机制进行交互，以便SQL表达式不干扰包装表达式的标签化。因此，如果以表达式标签渲染 <a class="reference internal" href="selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> ，则将字符串标签移至包装表达式的外部：</p>
<blockquote>
<div><p>print(select(geometry.c.geom_data.label(“my_data”)))</p>
</div></blockquote>
<p>输出：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_data</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">my_data</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">geometry</span></pre></div>
</div>
<p>另一个示例是我们装饰 <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.BYTEA" title="sqlalchemy.dialects.postgresql.BYTEA"><code class="xref py py-class docutils literal notranslate"><span class="pre">BYTEA</span></code></a> 以提供``PGPString``，这将自动透明地使用PostgreSQL <a href="#id35"><span class="problematic" id="id36">``</span></a>pgcrypto``扩展来加密/解密值：</p>
<blockquote>
<div><dl class="simple">
<dt>from sqlalchemy import (</dt><dd><p>create_engine,
String,
select,
func,
MetaData,
Table,
Column,
type_coerce,
TypeDecorator,</p>
</dd>
</dl>
<p>)</p>
<p>from sqlalchemy.dialects.postgresql import BYTEA</p>
<dl>
<dt>class PGPString(TypeDecorator):</dt><dd><p>impl = BYTEA</p>
<p>cache_ok = True</p>
<dl>
<dt>def __init__(self, passphrase):</dt><dd><p>super(PGPString, self).__init__()</p>
<p>self.passphrase = passphrase</p>
</dd>
<dt>def bind_expression(self, bindvalue):</dt><dd><p># convert the bind’s type from PGPString to
# String, so that it’s passed to psycopg2 as is without
# a dbapi.Binary wrapper
bindvalue = type_coerce(bindvalue, String)
return func.pgp_sym_encrypt(bindvalue, self.passphrase)</p>
</dd>
<dt>def column_expression(self, col):</dt><dd><p>return func.pgp_sym_decrypt(col, self.passphrase)</p>
</dd>
</dl>
</dd>
</dl>
<p>metadata_obj = MetaData()
message = Table(</p>
<blockquote>
<div><p>“message”,
metadata_obj,
Column(“username”, String(50)),
Column(“message”, PGPString(“this is my passphrase”)),</p>
</div></blockquote>
<p>)</p>
<p>engine = create_engine(“postgresql+psycopg2://scott:tiger&#64;localhost/test”, echo=True)
with engine.begin() as conn:</p>
<blockquote>
<div><p>metadata_obj.create_all(conn)</p>
<p>conn.execute(message.insert(), username=”some user”, message=”this is my message”)</p>
<dl class="simple">
<dt>print(</dt><dd><p>conn.scalar(select(message.c.message).where(message.c.username == “some user”))</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
</div></blockquote>
<p>使用插入、选择语句和 <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.BYTEA" title="sqlalchemy.dialects.postgresql.BYTEA"><code class="xref py py-class docutils literal notranslate"><span class="pre">BYTEA</span></code></a> 一起阅读“PGPString”类型时，将应用“pgp_sym_encrypt”和“pgp_sym_decrypt”函数：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">username</span><span class="p">)</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">pgp_sym_encrypt</span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">pgp_sym_encrypt_1</span><span class="p">)</span><span class="n">s</span><span class="p">))</span>
<span class="c1">-- {&#39;username&#39;: &#39;some user&#39;, &#39;message&#39;: &#39;this is my message&#39;,</span>
<span class="c1">--  &#39;pgp_sym_encrypt_1&#39;: &#39;this is my passphrase&#39;}</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">pgp_sym_decrypt</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">pgp_sym_decrypt_1</span><span class="p">)</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">message_1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">message</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">username_1</span><span class="p">)</span><span class="n">s</span>
<span class="c1">-- {&#39;pgp_sym_decrypt_1&#39;: &#39;this is my passphrase&#39;, &#39;username_1&#39;: &#39;some user&#39;}</span></pre></div>
</div>
</section>
</section>
</section>
<section id="sql">
<span id="types-sql-value-processing"></span><h2>应用 SQL 级别的绑定/结果处理<a class="headerlink" href="#sql" title="Permalink to this heading">¶</a></h2>
<p>如上所述， SQL 可用Python函数在参数发送到语句时以及从数据库加载结果行时进行调用。还可以在SQL级别定义转换。原因是仅当关系数据库包含特定系列的函数时，这些函数可能在应用程序和持久性格式之间的数据之间强制作用。例如，使用数据库定义的加密/解密函数，以及处理地理数据的存储过程。</p>
<p>任何 <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a>、<a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> 或 <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> 子类都可以包含 <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.bind_expression" title="sqlalchemy.types.TypeEngine.bind_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.bind_expression()</span></code></a> 和/或 <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.column_expression" title="sqlalchemy.types.TypeEngine.column_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.column_expression()</span></code></a> 的实现。如果定义为返回一个非- <code class="docutils literal notranslate"><span class="pre">None</span></code> 的值，则应返回一个 <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnElement</span></code></a> 表达式以注入到SQL语句中，无论是周围绑定参数还是列表达式都是如此。例如，为构建一个“几何”类型，将在向去除所有传出值应用PostGIS函数“ST_GeomFromText”和函数“ST_AsText”时，我们可以创建自己的:class:<cite>~sqlalchemy.types.UserDefinedType`子类，该子类提供这些方法和功能`~sqlalchemy.sql.expression.func</cite>：</p>
<blockquote>
<div><p>from sqlalchemy import func
from sqlalchemy.types import UserDefinedType</p>
<dl class="simple">
<dt>class Geometry(UserDefinedType):</dt><dd><dl class="simple">
<dt>def get_col_spec(self):</dt><dd><p>return “GEOMETRY”</p>
</dd>
<dt>def bind_expression(self, bindvalue):</dt><dd><p>return func.ST_GeomFromText(bindvalue, type_=self)</p>
</dd>
<dt>def column_expression(self, col):</dt><dd><p>return func.ST_AsText(col, type_=self)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>我们可以将“Geometry”类型应用于 <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> metadata ，并在 <a class="reference internal" href="selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> 中使用它：</p>
<blockquote>
<div><dl class="simple">
<dt>geometry = Table(</dt><dd><p>“geometry”,
metadata,
Column(“geom_id”, Integer, primary_key=True),
Column(“geom_data”, Geometry),</p>
</dd>
</dl>
<p>)</p>
<dl>
<dt>print(</dt><dd><dl class="simple">
<dt>select(geometry).where(</dt><dd><p>geometry.c.geom_data == “LINESTRING(189412 252431,189631 259122)”</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>结果SQL将嵌入两个函数。 根据情况，<a href="#id37"><span class="problematic" id="id38">``</span></a>ST_AsText``适用于列子句，以便将传入一个结果集之前将返回值运行通过该函数，而``ST_GeomFromText``应用于绑定参数，以便将传递的值转换为：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_id</span><span class="p">,</span><span class="w"> </span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_data</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">geom_data_1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">geometry</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_GeomFromText</span><span class="p">(:</span><span class="n">geom_data_2</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.column_expression" title="sqlalchemy.types.TypeEngine.column_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.column_expression()</span></code></a> 方法与编译器的内部机制进行交互，以便SQL表达式不干扰包装表达式的标签化。因此，如果以表达式标签渲染 <a class="reference internal" href="selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> ，则将字符串标签移至包装表达式的外部：</p>
<blockquote>
<div><p>print(select(geometry.c.geom_data.label(“my_data”)))</p>
</div></blockquote>
<p>输出：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">geometry</span><span class="p">.</span><span class="n">geom_data</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">my_data</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">geometry</span></pre></div>
</div>
<p>另一个示例是我们在 ：class:<cite>.BYTEA</cite> 内添加实现 PostgreSQL 阶乘运算符的功能。我们使用 <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.UnaryExpression" title="sqlalchemy.sql.expression.UnaryExpression"><code class="xref py py-class docutils literal notranslate"><span class="pre">UnaryExpression</span></code></a> 构造与 <code class="xref py py-class docutils literal notranslate"><span class="pre">_.custom_op</span></code> 的组合来生成阶乘表达式：</p>
<blockquote>
<div><p>from sqlalchemy import Integer
from sqlalchemy.sql.expression import UnaryExpression
from sqlalchemy.sql import operators</p>
<dl>
<dt>class MyInteger(Integer):</dt><dd><dl>
<dt>class comparator_factory(Integer.Comparator):</dt><dd><dl>
<dt>def factorial(self):</dt><dd><dl class="simple">
<dt>return UnaryExpression(</dt><dd><p>self.expr, modifier=operators.custom_op(“!”), type_=MyInteger</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>使用上述类型：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="k">sql</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="k">column</span>
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">print</span><span class="p">(</span><span class="k">column</span><span class="p">(</span><span class="ss">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MyInteger</span><span class="p">).</span><span class="n">factorial</span><span class="p">())</span>
<span class="err">{</span><span class="n">printsql</span><span class="err">}</span><span class="n">x</span><span class="w"> </span><span class="o">!</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.Operators.op" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.op()</span></code></a></p>
<p><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine.comparator_factory" title="sqlalchemy.types.TypeEngine.comparator_factory"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TypeEngine.comparator_factory</span></code></a></p>
</div>
</section>
<section id="id39">
<h2>创建新类型<a class="headerlink" href="#id39" title="Permalink to this heading">¶</a></h2>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code>。</p>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><span class="sig-name descname">UserDefinedType</span></a></p></td>
<td><p>Base for user defined types.</p></td>
</tr>
</tbody>
</table>
<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.types.UserDefinedType">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.types.</span></span><span class="sig-name descname"><span class="pre">UserDefinedType</span></span><a class="headerlink" href="#sqlalchemy.types.UserDefinedType" title="Permalink to this definition">¶</a></dt>
<dd><p>Base for user defined types.</p>
<p>This should be the base of new types.  Note that
for most cases, <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> is probably
more appropriate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy.types</span> <span class="k">as</span> <span class="nn">types</span>

<span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">UserDefinedType</span><span class="p">):</span>
    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MYTYPE(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">process</span>

    <span class="k">def</span> <span class="nf">result_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">coltype</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">process</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Once the type is made, it’s immediately usable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">MyType</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="p">)</span></pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_col_spec()</span></code> method will in most cases receive a keyword
argument <code class="docutils literal notranslate"><span class="pre">type_expression</span></code> which refers to the owning expression
of the type as being compiled, such as a <a class="reference internal" href="metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> or
<a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.cast" title="sqlalchemy.sql.expression.cast"><code class="xref py py-func docutils literal notranslate"><span class="pre">cast()</span></code></a> construct.  This keyword is only sent if the method
accepts keyword arguments (e.g. <code class="docutils literal notranslate"><span class="pre">**kw</span></code>) in its argument signature;
introspection is used to check for this in order to support legacy
forms of this function.</p>
<p>The <a class="reference internal" href="#sqlalchemy.types.UserDefinedType.cache_ok" title="sqlalchemy.types.UserDefinedType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">UserDefinedType.cache_ok</span></code></a> class-level flag indicates if this
custom <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> is safe to be used as part of a cache key.
This flag defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code> which will initially generate a warning
when the SQL compiler attempts to generate a cache key for a statement
that uses this type.  If the <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> is not guaranteed
to produce the same bind/result behavior and SQL generation
every time, this flag should be set to <code class="docutils literal notranslate"><span class="pre">False</span></code>; otherwise if the
class produces the same behavior each time, it may be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.
See <a class="reference internal" href="#sqlalchemy.types.UserDefinedType.cache_ok" title="sqlalchemy.types.UserDefinedType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">UserDefinedType.cache_ok</span></code></a> for further notes on how this works.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.28: </span>Generalized the <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType.cache_ok" title="sqlalchemy.types.ExternalType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExternalType.cache_ok</span></code></a>
flag so that it is available for both <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> as well
as <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a>.</p>
</div>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.types.UserDefinedType.cache_ok"><span class="sig-name descname">cache_ok</span></a>, <a class="reference internal" href="#sqlalchemy.types.UserDefinedType.coerce_compared_value"><span class="sig-name descname">coerce_compared_value()</span></a>, <a class="reference internal" href="#sqlalchemy.types.UserDefinedType.ensure_kwarg"><span class="sig-name descname">ensure_kwarg</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.UserDefinedType</span></code></a> (<a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.ExternalType</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeEngineMixin</span></code>, <a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.types.TypeEngine</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.util.langhelpers.EnsureKWArg</span></code>)</p>
</div>
<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.UserDefinedType.cache_ok">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.UserDefinedType.</span></code></a><span class="sig-name descname"><span class="pre">cache_ok</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">bool</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></em><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">None</span></em><a class="headerlink" href="#sqlalchemy.types.UserDefinedType.cache_ok" title="Permalink to this definition">¶</a></dt>
<dd><div class="inherited-member docutils container">
<p><em>inherited from the</em> <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType.cache_ok" title="sqlalchemy.types.ExternalType.cache_ok"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExternalType.cache_ok</span></code></a> <em>attribute of</em> <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a></p>
</div>
<p>Indicate if statements using this <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a> are “safe to
cache”.</p>
<p>The default value <code class="docutils literal notranslate"><span class="pre">None</span></code> will emit a warning and then not allow caching
of a statement which includes this type.   Set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to disable
statements using this type from being cached at all without a warning.
When set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the object’s class and selected elements from its
state will be used as part of the cache key.  For example, using a
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_only</span> <span class="o">=</span> <span class="kc">True</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The cache key for the above type would be equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">MyType</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">(&lt;class &#39;__main__.MyType&#39;&gt;, (&#39;choices&#39;, (&#39;a&#39;, &#39;b&#39;, &#39;c&#39;)))</span></pre></div>
</div>
<p>The caching scheme will extract attributes from the type that correspond
to the names of parameters in the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method.  Above, the
“choices” attribute becomes part of the cache key but “internal_only”
does not, because there is no parameter named “internal_only”.</p>
<p>The requirements for cacheable elements is that they are hashable
and also that they indicate the same SQL rendered for expressions using
this type every time for a given cache value.</p>
<p>To accommodate for datatypes that refer to unhashable structures such
as dictionaries, sets and lists, these objects can be made “cacheable”
by assigning hashable structures to the attributes whose names
correspond with the names of the arguments.  For example, a datatype
which accepts a dictionary of lookup values may publish this as a sorted
series of tuples.   Given a previously un-cacheable type as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LookupType</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;a custom type that accepts a dictionary as a parameter.</span>

<span class="sd">    this is the non-cacheable version, as &quot;self.lookup&quot; is not</span>
<span class="sd">    hashable.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(255)&quot;</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># ...  works with &quot;self.lookup&quot; ...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where “lookup” is a dictionary.  The type will not be able to generate
a cache key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span> <span class="o">=</span> <span class="n">LookupType</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">&lt;stdin&gt;:1: SAWarning: UserDefinedType LookupType({&#39;a&#39;: 10, &#39;b&#39;: 20}) will not</span>
<span class="go">produce a cache key because the ``cache_ok`` flag is not set to True.</span>
<span class="go">Set this flag to True if this type object&#39;s state is safe to use</span>
<span class="go">in a cache key, or False to disable this warning.</span>
<span class="go">symbol(&#39;no_cache&#39;)</span></pre></div>
</div>
<p>If we <strong>did</strong> set up such a cache key, it wouldn’t be usable. We would
get a tuple structure that contains a dictionary inside of it, which
cannot itself be used as a key in a “cache dictionary” such as SQLAlchemy’s
statement cache, since Python dictionaries aren’t hashable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># set cache_ok = True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">type_</span><span class="o">.</span><span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># this is the cache key it would generate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span>
<span class="go">(&lt;class &#39;__main__.LookupType&#39;&gt;, (&#39;lookup&#39;, {&#39;a&#39;: 10, &#39;b&#39;: 20}))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># however this key is not hashable, will fail when used with</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># SQLAlchemy statement cache</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">some_cache</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s2">&quot;some sql value&quot;</span><span class="p">}</span>
<span class="go">Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1,</span>
<span class="go">in &lt;module&gt; TypeError: unhashable type: &#39;dict&#39;</span></pre></div>
</div>
<p>The type may be made cacheable by assigning a sorted tuple of tuples
to the “.lookup” attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LookupType</span><span class="p">(</span><span class="n">UserDefinedType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;a custom type that accepts a dictionary as a parameter.</span>

<span class="sd">    The dictionary is stored both as itself in a private variable,</span>
<span class="sd">    and published in a public variable as a sorted tuple of tuples,</span>
<span class="sd">    which is hashable and will also return the same value for any</span>
<span class="sd">    two equivalent dictionaries.  Note it assumes the keys and</span>
<span class="sd">    values of the dictionary are themselves hashable.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span> <span class="o">=</span> <span class="n">lookup</span>

        <span class="c1"># assume keys/values of &quot;lookup&quot; are hashable; otherwise</span>
        <span class="c1"># they would also need to be converted in some way here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">lookup</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sorted</span><span class="p">(</span><span class="n">lookup</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(255)&quot;</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># ...  works with &quot;self._lookup&quot; ...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where above, the cache key for <code class="docutils literal notranslate"><span class="pre">LookupType({&quot;a&quot;:</span> <span class="pre">10,</span> <span class="pre">&quot;b&quot;:</span> <span class="pre">20})</span></code> will be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">LookupType</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span><span class="o">.</span><span class="n">_static_cache_key</span>
<span class="go">(&lt;class &#39;__main__.LookupType&#39;&gt;, (&#39;lookup&#39;, ((&#39;a&#39;, 10), (&#39;b&#39;, 20))))</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.14: </span>- added the <code class="docutils literal notranslate"><span class="pre">cache_ok</span></code> flag to allow
some configurability of caching for <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> classes.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.28: </span>- added the <a class="reference internal" href="type_api.html#sqlalchemy.types.ExternalType" title="sqlalchemy.types.ExternalType"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalType</span></code></a> mixin which
generalizes the <code class="docutils literal notranslate"><span class="pre">cache_ok</span></code> flag to both the <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>
and <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> classes.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="connections.html#sql-caching"><span class="std std-ref">SQL编译缓存</span></a></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.types.UserDefinedType.coerce_compared_value">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.UserDefinedType.</span></code></a><span class="sig-name descname"><span class="pre">coerce_compared_value</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">OperatorType</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><span class="pre">TypeEngine</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.types.UserDefinedType.coerce_compared_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Suggest a type for a ‘coerced’ Python value in an expression.</p>
<p>Default behavior for <a class="reference internal" href="#sqlalchemy.types.UserDefinedType" title="sqlalchemy.types.UserDefinedType"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedType</span></code></a> is the
same as that of <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a>; by default it returns
<code class="docutils literal notranslate"><span class="pre">self</span></code>, assuming the compared value should be coerced into
the same type as this one.  See
<a class="reference internal" href="#sqlalchemy.types.TypeDecorator.coerce_compared_value" title="sqlalchemy.types.TypeDecorator.coerce_compared_value"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeDecorator.coerce_compared_value()</span></code></a> for more detail.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.types.UserDefinedType.ensure_kwarg">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.types.UserDefinedType"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.types.UserDefinedType.</span></code></a><span class="sig-name descname"><span class="pre">ensure_kwarg</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">str</span></em><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'get_col_spec'</span></em><a class="headerlink" href="#sqlalchemy.types.UserDefinedType.ensure_kwarg" title="Permalink to this definition">¶</a></dt>
<dd><p>a regular expression that indicates method names for which the method
should accept <code class="docutils literal notranslate"><span class="pre">**kw</span></code> arguments.</p>
<p>The class will scan for methods matching the name template and decorate
them if necessary to ensure <code class="docutils literal notranslate"><span class="pre">**kw</span></code> parameters are accepted.</p>
</dd></dl>

</dd></dl>

</section>
<section id="custom-and-decorated-types-reflection">
<span id="id40"></span><h2>使用自定义类型和反射操作<a class="headerlink" href="#custom-and-decorated-types-reflection" title="Permalink to this heading">¶</a></h2>
<p>重要的是要注意，具有附加Python行为的数据库类型（包括基于:class:<cite>.TypeDecorator`的类型以及其他数据类型的用户定义子类）在数据库架构内没有任何表示。使用数据库时元数据 introspection 功能，如在 :ref:`metadata_reflection</cite> 中描述的，使用了将数据库服务器报告的数据类型信息与SQLAlchemy数据类型对象相关联的修补映射。例如，如果我们在PostgreSQL模式中查看特定数据库列的定义，我们可能会得到字符串“VARCHAR”。SQLAlchemy的 PostgreSQL方言有一个硬编码映射，将字符串名“VARCHAR”链接到SQLAlchemy的 <a class="reference internal" href="type_basics.html#sqlalchemy.types.VARCHAR" title="sqlalchemy.types.VARCHAR"><code class="xref py py-class docutils literal notranslate"><span class="pre">VARCHAR</span></code></a> 类，并且这就是为什么当我们发出像 <a href="#id41"><span class="problematic" id="id42">``</span></a>Table(‘my_table’, m, autoload_with=engine)` ` 这样的语句时，<a class="reference internal" href="metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象在其中将具有 <a class="reference internal" href="type_basics.html#sqlalchemy.types.VARCHAR" title="sqlalchemy.types.VARCHAR"><code class="xref py py-class docutils literal notranslate"><span class="pre">VARCHAR</span></code></a> 的实例。</p>
<p>这意味着，如果 <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象使用类型对象，这些类型对象不直接对应于数据库本机类型名称，如果我们使用反射在其他地方依靠新的 <a class="reference internal" href="metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 集合创建新的 <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象，则它将不会具有此数据类型。例如：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
<span class="go">...     Table,</span>
<span class="go">...     Column,</span>
<span class="go">...     MetaData,</span>
<span class="go">...     create_engine,</span>
<span class="go">...     PickleType,</span>
<span class="go">...     Integer,</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<span class="go">...     &quot;my_table&quot;, metadata, Column(&quot;id&quot;, Integer), Column(&quot;data&quot;, PickleType)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<div class='show_sql'><span class="n">INFO</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">Engine</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">my_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">data</span><span class="w"> </span><span class="nb">BLOB</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>以上，我们使用了 <a class="reference internal" href="type_basics.html#sqlalchemy.types.PickleType" title="sqlalchemy.types.PickleType"><code class="xref py py-class docutils literal notranslate"><span class="pre">PickleType</span></code></a>，它是一个 work on top of the <a class="reference internal" href="type_basics.html#sqlalchemy.types.LargeBinary" title="sqlalchemy.types.LargeBinary"><code class="xref py py-class docutils literal notranslate"><span class="pre">LargeBinary</span></code></a> datatype 的 <a class="reference internal" href="#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> ，在SQLite是指数据库类型 <code class="docutils literal notranslate"><span class="pre">BLOB</span></code>。在CREATE TABLE中，我们看到使用了“BLOB”数据类型。SQLite数据库不知道我们所使用的 <a class="reference internal" href="type_basics.html#sqlalchemy.types.PickleType" title="sqlalchemy.types.PickleType"><code class="xref py py-class docutils literal notranslate"><span class="pre">PickleType</span></code></a>。</p>
<p>如果我们查看 <cite>my_table.c.data.type</cite> 的数据类型，因为这是我们直接创建的Python对象，它是 <a class="reference internal" href="type_basics.html#sqlalchemy.types.PickleType" title="sqlalchemy.types.PickleType"><code class="xref py py-class docutils literal notranslate"><span class="pre">PickleType</span></code></a> ：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">type</span>
<span class="go">PickleType()</span></pre></div>
</div>
<p>但是，如果使用反射创建另一个 <a class="reference internal" href="metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 实例，则使用 <a class="reference internal" href="type_basics.html#sqlalchemy.types.PickleType" title="sqlalchemy.types.PickleType"><code class="xref py py-class docutils literal notranslate"><span class="pre">PickleType</span></code></a> 不会表示在我们创建的SQLite数据库中；我们得到 <a class="reference internal" href="type_basics.html#sqlalchemy.types.BLOB" title="sqlalchemy.types.BLOB"><code class="xref py py-class docutils literal notranslate"><span class="pre">BLOB</span></code></a> ：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">metadata_two</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_reflected_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="n">metadata_two</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<div class='show_sql'><span class="n">INFO</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">Engine</span><span class="w"> </span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">table_info</span><span class="p">(</span><span class="ss">&quot;my_table&quot;</span><span class="p">)</span>
<span class="n">INFO</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">Engine</span><span class="w"> </span><span class="p">()</span>
<span class="n">DEBUG</span><span class="w"> </span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">engine</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">Engine</span><span class="w"> </span><span class="n">Col</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;cid&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;notnull&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dflt_value&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pk&#39;</span><span class="p">)</span><span class="err">通常，当应用程序使用自定义类型定义显式的</span><span class="o">`</span><span class="n">_schema</span><span class="p">.</span><span class="k">Table</span><span class="o">`</span><span class="err">元数据时，不需要使用表反射，因为必要的</span><span class="o">`</span><span class="n">_schema</span><span class="p">.</span><span class="k">Table</span><span class="o">`</span><span class="err">元数据已经存在。</span><span class="w"> </span><span class="err">然而，对于应用程序或它们的组合需要使用既包括自定义的</span><span class="n">Python级别数据类型</span><span class="err">，又设置其</span><span class="o">`</span><span class="n">_schema</span><span class="p">.</span><span class="k">Column</span><span class="o">`</span><span class="err">对象为从数据库反射而来的</span><span class="o">`</span><span class="n">_schema</span><span class="p">.</span><span class="k">Table</span><span class="o">`</span><span class="err">对象，仍需要表现出额外的</span><span class="n">Python行为</span><span class="err">，必须采取其他步骤。</span>
</div></pre></div>
</div>
<p>其中最简单的方法是，如:ref:<a href="#id43"><span class="problematic" id="id44">`</span></a>reflection_overriding_columns`中所述，覆盖特定列。 通过这种技术，我们简单地使用反射以及针对我们要使用自定义或装饰数据类型的那些列的显式`_schema.Column`对象:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">metadata_three</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_reflected_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;my_table&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">metadata_three</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">PickleType</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span></pre></div>
</div>
<p>上面的“my_reflected_table”对象是反射的，将从SQLite数据库加载“id”列的定义。 但是对于“data”列，我们已使用显式`_schema.Column`定义覆盖了反射对象，该定义包括我们想要的Python数据类型:class:<cite>.PickleType</cite>。 反射过程将保留这个`_schema.Column`对象:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_reflected_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">type</span>
<span class="go">PickleType()</span></pre></div>
</div>
<p>将数据库本地类型对象转换为自定义数据类型的一种更复杂的方法是使用`._DDLEvents.column_reflect`事件处理程序。 例如，如果我们知道所有`_schema.BLOB`数据类型实际上都要作为`_schema.PickleType`，则可以在全局范围内设置一条规则:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">BLOB</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">PickleType</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Table</span><span class="p">,</span> <span class="s2">&quot;column_reflect&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_setup_pickletype</span><span class="p">(</span><span class="n">inspector</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column_info</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">column_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">BLOB</span><span class="p">):</span>
        <span class="n">column_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PickleType</span><span class="p">()</span></pre></div>
</div>
<p>当上面的代码在任何表反射发生之前调用时（还要注意它应该在应用程序中**仅调用一次**，因为它是全局规则），仅反射包含`_schema.BLOB`数据类型的任何`_schema.Table`时，将将生成的数据类型存储在`_schema.Column`对象中作为`_schema.PickleType`。</p>
<p>在实践中，上述基于事件的方法可能需要其他规则，才能仅影响那些数据类型很重要的列，例如表名和可能的列名的查找表或其他启发式规则，以准确确定应使用哪些列一个Python数据类型。</p>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="type_basics.html" title="previous chapter">类型层次结构</a>
        Next:
        <a href="type_api.html" title="next chapter">基础类型 API</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 9:30:57

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


