<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    使用声明式进行Mapper配置
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="通过声明性方式映射类" href="declarative_mapping.html" />
        <link rel="next" title="使用 Mixin 构建映射层次结构" href="declarative_mixins.html" />
        <link rel="prev" title="使用Declarative配置Table" href="declarative_tables.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM映射类配置</a></span><ul>
<li><span class="link-container"><a class="reference external" href="mapping_styles.html">ORM映射类概述</a></span></li>
<li><span class="link-container"><a class="reference external" href="declarative_mapping.html">通过声明性方式映射类</a></span><ul>
<li><span class="link-container"><a class="reference external" href="declarative_styles.html">声明式映射风格</a></span></li>
<li><span class="link-container"><a class="reference external" href="declarative_tables.html">使用Declarative配置Table</a></span></li>
<li class="selected"><span class="link-container"><strong>使用声明式进行Mapper配置</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-properties">使用声明式定义映射属性</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-mapper-options">用声明方式进行Mapper配置选项</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id3">动态构造映射器参数</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#id4">其它声明式映射指令</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#declare-last"><code class="docutils literal notranslate"><span class="pre">__declare_last__()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#declare-first"><code class="docutils literal notranslate"><span class="pre">__declare_first__()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#metadata"><code class="docutils literal notranslate"><span class="pre">metadata</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#abstract"><code class="docutils literal notranslate"><span class="pre">__abstract__</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#table-cls"><code class="docutils literal notranslate"><span class="pre">__table_cls__</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="declarative_mixins.html">使用 Mixin 构建映射层次结构</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="dataclasses.html">与dataclasses和attrs集成</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapped_sql_expr.html">将SQL表达式映射为属性</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapped_attributes.html">更改属性行为</a></span></li>
<li><span class="link-container"><a class="reference external" href="composites.html">复合列类型</a></span></li>
<li><span class="link-container"><a class="reference external" href="inheritance.html">映射类继承层次结构</a></span></li>
<li><span class="link-container"><a class="reference external" href="nonstandard_mappings.html">非传统映射</a></span></li>
<li><span class="link-container"><a class="reference external" href="versioning.html">配置版本计数器</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapping_api.html">类映射API</a></span></li>
<li><span class="link-container"><a class="reference external" href="scalar_mapping.html">映射SQL表达式</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM 查询指南</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">用 Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">事件和内部机制</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM 示例</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="declarative_tables.html" title="previous chapter">使用Declarative配置Table</a></li>
                <li><b>Next:</b>
                <a href="declarative_mixins.html" title="next chapter">使用 Mixin 构建映射层次结构</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="mapper_config.html" title="ORM映射类配置">ORM映射类配置</a></li>
                    <ul><li><a href="declarative_mapping.html" title="通过声明性方式映射类">通过声明性方式映射类</a></li>
                </ul>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#mapper">使用声明式进行Mapper配置</a><ul>
<li><a class="reference internal" href="#orm-declarative-properties">使用声明式定义映射属性</a></li>
<li><a class="reference internal" href="#orm-declarative-mapper-options">用声明方式进行Mapper配置选项</a><ul>
<li><a class="reference internal" href="#id3">动态构造映射器参数</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4">其它声明式映射指令</a><ul>
<li><a class="reference internal" href="#declare-last"><code class="docutils literal notranslate"><span class="pre">__declare_last__()</span></code></a></li>
<li><a class="reference internal" href="#declare-first"><code class="docutils literal notranslate"><span class="pre">__declare_first__()</span></code></a></li>
<li><a class="reference internal" href="#metadata"><code class="docutils literal notranslate"><span class="pre">metadata</span></code></a></li>
<li><a class="reference internal" href="#abstract"><code class="docutils literal notranslate"><span class="pre">__abstract__</span></code></a></li>
<li><a class="reference internal" href="#table-cls"><code class="docutils literal notranslate"><span class="pre">__table_cls__</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-declarative_config" >
        
<section id="mapper">
<span id="orm-declarative-mapper-config-toplevel"></span><h1>使用声明式进行Mapper配置<a class="headerlink" href="#mapper" title="Permalink to this heading">¶</a></h1>
<p>本文档中的   <a class="reference internal" href="mapping_styles.html#orm-mapper-configuration-overview"><span class="std std-ref">映射类的基本组件</span></a>  部分讨论了   <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>  构造的一般配置元素，该结构定义了特定用户定义的类如何映射到数据库表或其他 SQL 结构。接下来的章节描述了声明式系统如何构建   <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>  的具体细节。</p>
<section id="orm-declarative-properties">
<span id="id1"></span><h2>使用声明式定义映射属性<a class="headerlink" href="#orm-declarative-properties" title="Permalink to this heading">¶</a></h2>
<p>在   <a class="reference internal" href="declarative_tables.html"><span class="std std-ref">使用Declarative配置Table</span></a>  中给出的示例说明了映射到基于表的列的映射，使用了   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>  构造方法。除基于表的列之外，还有几种ORM映射构造方法可以配置，最常见的是   <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>  构造方法。其它类型的属性包括使用   <code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code>  构造方法定义的 SQL 表达式和使用   <a class="reference internal" href="composites.html#sqlalchemy.orm.composite" title="sqlalchemy.orm.composite"><code class="xref py py-func docutils literal notranslate"><span class="pre">composite()</span></code></a>  构造方法的多列映射。</p>
<p>在   <a class="reference internal" href="mapping_styles.html#orm-mapping-properties"><span class="std std-ref">属性字典</span></a>  中，   <a class="reference internal" href="mapping_styles.html#orm-imperative-mapping"><span class="std std-ref">命令式映射</span></a>  使用   <a class="reference internal" href="mapping_styles.html#orm-mapping-properties"><span class="std std-ref">properties</span></a>  字典来定义所有映射类属性。在声明式映射中，这些属性都在类定义中内联指定，在声明式表映射的情况下，这些属性都与将用于生成   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  对象的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  对象内联。</p>
<p>在完成“用户”和“地址”的示例映射工作之后，我们可以说明一个声明式表映射，其中包括不仅有   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>  对象，还包括关系和 SQL 表达式：</p>
<blockquote>
<div><p>from typing import List
from typing import Optional</p>
<p>from sqlalchemy import Column
from sqlalchemy import ForeignKey
from sqlalchemy import String
from sqlalchemy import Text
from sqlalchemy.orm import column_property
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class User(Base):</dt><dd><p>__tablename__ = “user”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)
name: Mapped[str]
firstname: Mapped[str] = mapped_column(String(50))
lastname: Mapped[str] = mapped_column(String(50))
fullname: Mapped[str] = column_property(firstname + “ “ + lastname)</p>
<p>addresses: Mapped[List[“Address”]] = relationship(back_populates=”user”)</p>
</dd>
<dt>class Address(Base):</dt><dd><p>__tablename__ = “address”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)
user_id: Mapped[int] = mapped_column(ForeignKey(“user.id”))
email_address: Mapped[str]
address_statistics: Mapped[Optional[str]] = mapped_column(Text, deferred=True)</p>
<p>user: Mapped[“User”] = relationship(back_populates=”addresses”)</p>
</dd>
</dl>
</div></blockquote>
<p>上述声明式表映射包含两个表，每个表都有指向另一个表的   <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code> ，以及一个由   <code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code>  映射的简单 SQL 表达式和一个额外的   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code> ，该 _orm_class=”literal” 加载应根据  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred</span></code>  关键字定义的“延迟”方式进行。关于这些特定概念的更多文档信息可以在文档   <a class="reference internal" href="basic_relationships.html#relationship-patterns"><span class="std std-ref">基本关系模式</span></a> 、  <a class="reference internal" href="mapped_sql_expr.html#mapper-column-property-sql-expressions"><span class="std std-ref">使用column_property</span></a>  和   <a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">使用列延迟选择要加载的列</span></a>  中找到。</p>
<p>使用声明式映射也可以使用“混合表”样式来指定属性；直接属于表的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  对象会移动到   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  定义中，但包括组成的 SQL 表达式在内的所有其他内容仍将内联到类定义中。需要引用   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  的构造方法会将其用   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  对象表示。为了使用混合式表格样式说明上述映射：</p>
<blockquote>
<div><p># 使用声明式映射属性并带有命令式表格 i.e. __table__</p>
<p>from sqlalchemy import Column, ForeignKey, Integer, String, Table, Text
from sqlalchemy.orm import column_property
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import deferred
from sqlalchemy.orm import relationship</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class User(Base):</dt><dd><dl class="simple">
<dt>__table__ = Table(</dt><dd><p>“user”,
Base.metadata,
Column(“id”, Integer, primary_key=True),
Column(“name”, String),
Column(“firstname”, String(50)),
Column(“lastname”, String(50)),</p>
</dd>
</dl>
<p>)</p>
<p>fullname = column_property(__table__.c.firstname + “ “ + __table__.c.lastname)</p>
<p>addresses = relationship(“Address”, back_populates=”user”)</p>
</dd>
<dt>class Address(Base):</dt><dd><dl class="simple">
<dt>__table__ = Table(</dt><dd><p>“address”,
Base.metadata,
Column(“id”, Integer, primary_key=True),
Column(“user_id”, ForeignKey(“user.id”)),
Column(“email_address”, String),
Column(“address_statistics”, Text),</p>
</dd>
</dl>
<p>)</p>
<p>address_statistics = deferred(__table__.c.address_statistics)</p>
<p>user = relationship(“User”, back_populates=”addresses”)</p>
</dd>
</dl>
</div></blockquote>
<p>上述示例中需要注意的事项：</p>
<ul class="simple">
<li><p>address   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  包含一个名为 <code class="docutils literal notranslate"><span class="pre">address_statistics</span></code> 的列，我们将此列重新映射到相同的属性名称下，以便其受   <a class="reference internal" href="queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a>  构造方法的控制。</p></li>
<li><p>对于声明性表和混合表映射，当我们定义   <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a>  构造方法时，我们总是使用表格名称而不是映射类名称作为目标表格。</p></li>
<li><p>当我们定义   <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>  构造方法时，由于这些构造方法在将一个映射类与另一个映射类链接在一起时，必定有一个类会比另一个类先定义，因此我们可以使用该类的字符串名称来引用远程类。此功能还扩展到   <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>  上指定的其它参数，如“primary join”和“order by”参数。请参阅   <a class="reference internal" href="basic_relationships.html#orm-declarative-relationship-eval"><span class="std std-ref">推迟计算关系参数</span></a>  部分获取有关详细信息。</p></li>
</ul>
</section>
<section id="orm-declarative-mapper-options">
<span id="id2"></span><h2>用声明方式进行Mapper配置选项<a class="headerlink" href="#orm-declarative-mapper-options" title="Permalink to this heading">¶</a></h2>
<p>使用所有映射形式时，该类的映射是通过成为   <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>  对象的一部分的参数进行配置的。接受这些参数的函数是   <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>  函数，这些参数从   <code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code>  可以看到的前线映射函数中传递给它。声明性映射的形式中，映射程序参数使用 <code class="docutils literal notranslate"><span class="pre">__mapper_args__</span></code> 声明式类变量指定，该变量是作为关键字参数传递给   <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>  函数的字典。一些示例：</p>
<p><strong>映射具体的主键列</strong></p>
<p>下面的示例说明了针对  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.primary_key</span></code>  参数的声明式级别设置，该参数独立于基于 schema 级别的主键约束将特定列作为 ORM 应将其视为主键的一部分：</p>
<blockquote>
<div><dl>
<dt>class GroupUsers(Base):</dt><dd><p>__tablename__ = “group_users”</p>
<p>user_id = mapped_column(String(40))
group_id = mapped_column(String(40))</p>
<p>__mapper_args__ = {“primary_key”: [user_id, group_id]}</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="declarative_tables.html#mapper-primary-key"><span class="std std-ref">映射到一组明确设置的主键列</span></a>  - 有关显式列映射为主键列的 ORM 映射的后台信息</p>
</div>
<p><strong>版本 ID 列</strong></p>
<p>下面的示例说明了  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.version_id_col</span></code>  和  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.version_id_generator</span></code>  参数的声明式级别设置，它们配置了 ORM 维护的版本计数器，该计数器在  <span class="xref std std-term">unit of work</span>  刷新过程中进行更新和检查：</p>
<blockquote>
<div><p>from datetime import datetime</p>
<dl>
<dt>class Widget(Base):</dt><dd><p>__tablename__ = “widgets”</p>
<p>id = mapped_column(Integer, primary_key=True)
timestamp = mapped_column(DateTime, nullable=False)</p>
<dl class="simple">
<dt>__mapper_args__ = {</dt><dd><p>“version_id_col”: timestamp,
“version_id_generator”: lambda v: datetime.now(),</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="versioning.html#mapper-version-counter"><span class="std std-ref">配置版本计数器</span></a>  - ORM 版本计数器功能的背景信息</p>
</div>
<p><strong>单表继承</strong></p>
<p>下面的示例说明了针对  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.polymorphic_on</span></code>  和  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.polymorphic_identity</span></code>  参数的声明式级别设置，这些参数用于配置单表继承映射：</p>
<blockquote>
<div><dl>
<dt>class Person(Base):</dt><dd><p>__tablename__ = “person”</p>
<p>person_id = mapped_column(Integer, primary_key=True)
type = mapped_column(String, nullable=False)</p>
<dl class="simple">
<dt>__mapper_args__ = dict(</dt><dd><p>polymorphic_on=type,
polymorphic_identity=”person”,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>class Employee(Person):</dt><dd><dl class="simple">
<dt>__mapper_args__ = dict(</dt><dd><p>polymorphic_identity=”employee”,</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="xref std std-ref">single_inheritance</span>  - ORM 单表继承映射功能背景</p>
</div>
<section id="id3">
<h3>动态构造映射器参数<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>可以通过使用   <code class="xref py py-func docutils literal notranslate"><span class="pre">declared_attr()</span></code>  构造方法从类绑定的描述符方法生成 <code class="docutils literal notranslate"><span class="pre">__mapper_args__</span></code> 字典，而不是从固定字典中生成，这对于从表配置或映射类的其他方面编程派生出的 Mapper 参数是有用的。动态 <code class="docutils literal notranslate"><span class="pre">__mapper_args__</span></code> 属性通常在使用声明式 Mixin 或抽象基类时非常有用。</p>
<p>例如，要从具有特殊  <code class="xref py py-attr docutils literal notranslate"><span class="pre">Column.info</span></code>  值的列中省略映射的任何列，mixin 可以使用扫描这些列并将它们传递给  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.exclude_properties</span></code>  集合的 <code class="docutils literal notranslate"><span class="pre">__mapper_args__</span></code> 方法从 <code class="docutils literal notranslate"><span class="pre">cls.__table__</span></code> 属性中获取这些列的名称 “键” 建议:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">declared_attr</span>


<span class="k">class</span> <span class="nc">ExcludeColsWFlag</span><span class="p">:</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">__mapper_args__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;exclude_properties&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">column</span><span class="o">.</span><span class="n">key</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">c</span>
                <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="n">ExcludeColsWFlag</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">not_needed</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;exclude&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>以上，<code class="docutils literal notranslate"><span class="pre">ExcludeColsWFlag</span></code> mixin 提供了一个每个类的 <code class="docutils literal notranslate"><span class="pre">__mapper_args__</span></code> 钩子，该钩子将扫描传递给  <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.info" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.info</span></code></a>  参数的“exclude”:True 的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  对象，然后将其“键”名称加入  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.exclude_properties</span></code>  集合中，从而防止生成的   <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>  将这些列考虑为任何 SQL 操作。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="xref std std-ref">orm_mixins_toplevel</span></p>
</div>
</section>
</section>
<section id="id4">
<h2>其它声明式映射指令<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h2>
<section id="declare-last">
<h3><code class="docutils literal notranslate"><span class="pre">__declare_last__()</span></code><a class="headerlink" href="#declare-last" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">__declare_last__()</span></code> 钩子允许定义一个类级别函数，该函数由  <a class="reference internal" href="events.html#sqlalchemy.orm.MapperEvents.after_configured" title="sqlalchemy.orm.MapperEvents.after_configured"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MapperEvents.after_configured()</span></code></a>  事件自动调用，该事件在映射被认为已完成并且 ‘configure’ 步骤已完成时发生：</p>
<blockquote>
<div><dl>
<dt>class MyClass(Base):</dt><dd><p>&#64;classmethod
def __declare_last__(cls):</p>
<blockquote>
<div><p>“”” “””
# 使用映射</p>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
</section>
<section id="declare-first">
<h3><code class="docutils literal notranslate"><span class="pre">__declare_first__()</span></code><a class="headerlink" href="#declare-first" title="Permalink to this heading">¶</a></h3>
<p>与 <code class="docutils literal notranslate"><span class="pre">__declare_last__()</span></code> 相似，但是使用  <a class="reference internal" href="events.html#sqlalchemy.orm.MapperEvents.before_configured" title="sqlalchemy.orm.MapperEvents.before_configured"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MapperEvents.before_configured()</span></code></a>  事件在 Mapper 配置开始时调用：</p>
<blockquote>
<div><dl>
<dt>class MyClass(Base):</dt><dd><p>&#64;classmethod
def __declare_first__(cls):</p>
<blockquote>
<div><p>“”” “””
# 在映射配置之前做一些事情</p>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
</section>
<section id="metadata">
<span id="declarative-metadata"></span><h3><code class="docutils literal notranslate"><span class="pre">metadata</span></code><a class="headerlink" href="#metadata" title="Permalink to this heading">¶</a></h3>
<p>通常用于分配新   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>  集合是与   <code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code>  对象相关联的  <code class="xref py py-attr docutils literal notranslate"><span class="pre">registry.metadata</span></code>  属性。当使用由   <code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code>  超类生成的声明性基类时，以及使用诸如   <code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code>  和  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.generate_base()</span></code>  的遗留函数时，该   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>  也通常存在于基类中作为名为“metadata”的属性，因此也存在于通过继承映射类。声明式将使用此属性（如果存在）来确定目标   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>  集合，否则将使用直接关联   <code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code>  的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 。</p>
<p>此属性也可以被分配，以便基于每个映射层次结构对单个基础和/或   <code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code>  使用的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>  集合。这在使用 Declarative Mixin 或抽象基类的元数据 - 每抽象基类一次 的模式中生效，例如，下一节   <a class="reference internal" href="#declarative-abstract"><span class="std std-ref">__abstract__</span></a>  就是这样的示例。也可以使用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped()</span></code>  作为下列示例说明：</p>
<blockquote>
<div><p>reg = registry()</p>
<dl class="simple">
<dt>class BaseOne:</dt><dd><p>metadata = MetaData()</p>
</dd>
<dt>class BaseTwo:</dt><dd><p>metadata = MetaData()</p>
</dd>
</dl>
<p>&#64;reg.mapped
class ClassOne:</p>
<blockquote>
<div><p>__tablename__ = “t1”  # 将使用 reg.metadata</p>
<p>id = mapped_column(Integer, primary_key=True)</p>
</div></blockquote>
<p>&#64;reg.mapped
class ClassTwo(BaseOne):</p>
<blockquote>
<div><p>__tablename__ = “t1”  # 将使用 BaseOne.metadata</p>
<p>id = mapped_column(Integer, primary_key=True)</p>
</div></blockquote>
<p>&#64;reg.mapped
class ClassThree(BaseTwo):</p>
<blockquote>
<div><p>__tablename__ = “t1”  # 将使用 BaseTwo.metadata</p>
<p>id = mapped_column(Integer, primary_key=True)</p>
</div></blockquote>
</div></blockquote>
<p>以上，从 <code class="docutils literal notranslate"><span class="pre">DefaultBase</span></code> 继承的类将使用一个   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>  作为表的数据中心，在从 <code class="docutils literal notranslate"><span class="pre">OtherBase</span></code> 继承的类中使用一个不同的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 。然后可以创建这些表格，比如在不同的数据库中：</p>
<blockquote>
<div><p>DefaultBase.metadata.create_all(some_engine)
OtherBase.metadata.create_all(some_other_engine)</p>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#declarative-abstract"><span class="std std-ref">__abstract__</span></a></p>
</div>
</section>
<section id="abstract">
<span id="declarative-abstract"></span><h3><code class="docutils literal notranslate"><span class="pre">__abstract__</span></code><a class="headerlink" href="#abstract" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">__abstract__</span></code> 导致声明式跳过为类完全生成表或 Mapper。类可以像 Mixin 一样添加到层次结构中，以允许子类只扩展来自特殊类的内容：</p>
<blockquote>
<div><dl>
<dt>class SomeAbstractBase(Base):</dt><dd><p>__abstract__ = True</p>
<dl class="simple">
<dt>def some_helpful_method(self):</dt><dd><p>“”” “””</p>
</dd>
</dl>
<p>&#64;declared_attr
def __mapper_args__(cls):</p>
<blockquote>
<div><p>return {“helpful mapper arguments”: True}</p>
</div></blockquote>
</dd>
<dt>class MyMappedClass(SomeAbstractBase):</dt><dd><p>pass</p>
</dd>
</dl>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">__abstract__</span></code> 的一个可能的用途是为不同的基类使用不同的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> ：</p>
<blockquote>
<div><dl class="simple">
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class DefaultBase(Base):</dt><dd><p>__abstract__ = True
metadata = MetaData()</p>
</dd>
<dt>class OtherBase(Base):</dt><dd><p>__abstract__ = True
metadata = MetaData()</p>
</dd>
</dl>
</div></blockquote>
<p>以上，在从 <code class="docutils literal notranslate"><span class="pre">DefaultBase</span></code> 继承的类中，将使用一个   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>  作为表的注册中心，在从 <code class="docutils literal notranslate"><span class="pre">OtherBase</span></code> 继承的类中将使用一个不同的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 。然后，可以创建这些表格，例如在不同的数据库中：</p>
<blockquote>
<div><p>DefaultBase.metadata.create_all(some_engine)
OtherBase.metadata.create_all(some_other_engine)</p>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="xref std std-ref">orm_inheritance_abstract_poly</span>  - 一种适用于继承层次结构的替代“抽象”映射类。</p>
</div>
</section>
<section id="table-cls">
<span id="declarative-table-cls"></span><h3><code class="docutils literal notranslate"><span class="pre">__table_cls__</span></code><a class="headerlink" href="#table-cls" title="Permalink to this heading">¶</a></h3>
<p>允许自定义用于生成   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  的可调用 / 类。这是一个非常开放的钩子，可以允许特殊自定义到一个   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  中，在此处生成：</p>
<blockquote>
<div><dl>
<dt>class MyMixin:</dt><dd><p>&#64;classmethod
def __table_cls__(cls, name, metadata_obj, <a href="#id5"><span class="problematic" id="id6">*</span></a>arg, <a href="#id7"><span class="problematic" id="id8">**</span></a>kw):</p>
<blockquote>
<div><p>return Table(f”my_{name}”, metadata_obj, <a href="#id9"><span class="problematic" id="id10">*</span></a>arg, <a href="#id11"><span class="problematic" id="id12">**</span></a>kw)</p>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<p>上述 mixin 将导致生成的所有   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  包括以 <code class="docutils literal notranslate"><span class="pre">&quot;my_&quot;</span></code> 为前缀，后面是通常使用 <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> 属性指定的名称。</p>
<p><code class="docutils literal notranslate"><span class="pre">__table_cls__</span></code> 还支持返回 <code class="docutils literal notranslate"><span class="pre">None</span></code> 的情况，这会导致类被视为子类而不是单个表。在某些自定义方案中，这可能很有用，例如，如果没有主键存在，则将定义为单继承：</p>
<blockquote>
<div><dl>
<dt>class AutoTable:</dt><dd><p>&#64;declared_attr
def __tablename__(cls):</p>
<blockquote>
<div><p>return cls.__name__</p>
</div></blockquote>
<p>&#64;classmethod
def __table_cls__(cls, <a href="#id13"><span class="problematic" id="id14">*</span></a>arg, <a href="#id15"><span class="problematic" id="id16">**</span></a>kw):</p>
<blockquote>
<div><dl class="simple">
<dt>for obj in arg[1:]:</dt><dd><dl class="simple">
<dt>if (isinstance(obj, Column) and obj.primary_key) or isinstance(</dt><dd><p>obj, PrimaryKeyConstraint</p>
</dd>
<dt>):</dt><dd><p>return Table(<a href="#id17"><span class="problematic" id="id18">*</span></a>arg, <a href="#id19"><span class="problematic" id="id20">**</span></a>kw)</p>
</dd>
</dl>
</dd>
</dl>
<p>return None</p>
</div></blockquote>
</dd>
<dt>class Person(AutoTable, Base):</dt><dd><p>id = mapped_column(Integer, primary_key=True)</p>
</dd>
<dt>class Employee(Person):</dt><dd><p>employee_name = mapped_column(String)</p>
</dd>
</dl>
</div></blockquote>
<p>上述 <code class="docutils literal notranslate"><span class="pre">Employee</span></code> 类将被映射为单表继承映射的子类 <code class="docutils literal notranslate"><span class="pre">Person</span></code>；<code class="docutils literal notranslate"><span class="pre">employee_name</span></code> 列将添加为 <code class="docutils literal notranslate"><span class="pre">Person</span></code> 表的成员。</p>
</section>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="declarative_tables.html" title="previous chapter">使用Declarative配置Table</a>
        Next:
        <a href="declarative_mixins.html" title="next chapter">使用 Mixin 构建映射层次结构</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 18:43:55

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


