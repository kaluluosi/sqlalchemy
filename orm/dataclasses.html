<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    与dataclasses和attrs集成
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="ORM映射类配置" href="mapper_config.html" />
        <link rel="next" title="将 SQL 表达式作为映射属性" href="mapped_sql_expr.html" />
        <link rel="prev" title="使用 Mixins 构成映射层次" href="declarative_mixins.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM映射类配置</a></span><ul>
<li><span class="link-container"><a class="reference external" href="mapping_styles.html">ORM映射类概述</a></span></li>
<li><span class="link-container"><a class="reference external" href="declarative_mapping.html">使用Declarative映射类</a></span></li>
<li class="selected"><span class="link-container"><strong>与dataclasses和attrs集成</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-native-dataclasses">声明性数据类映射</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id20">类级特性配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id31">关键字配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id42">属性配置</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id55">列默认值</a></span></li>
<li><span class="link-container"><a class="reference external" href="#annotated">与Annotated集成</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#mixin">使用mixin和抽象超类</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id72">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-native-dataclasses-non-mapped-fields">使用非映射数据类字段</a></span></li>
<li><span class="link-container"><a class="reference external" href="#pydantic">与Pydantic等备用数据类提供者的集成</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm">将ORM映射应用于现有的数据类（传统数据类使用）</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#declarative-with-imperative-table">使用Declarative With Imperative Table映射预存在的数据类</a></span></li>
<li><span class="link-container"><a class="reference external" href="#declarative-style">使用Declarative-style字段映射预存在的数据类</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="mapped_sql_expr.html">将 SQL 表达式作为映射属性</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapped_attributes.html">更改属性行为</a></span></li>
<li><span class="link-container"><a class="reference external" href="composites.html">组合列类型</a></span></li>
<li><span class="link-container"><a class="reference external" href="inheritance.html">映射类继承层次结构</a></span></li>
<li><span class="link-container"><a class="reference external" href="nonstandard_mappings.html">非传统映射</a></span></li>
<li><span class="link-container"><a class="reference external" href="versioning.html">配置版本计数器</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapping_api.html">类映射API</a></span></li>
<li><span class="link-container"><a class="reference external" href="scalar_mapping.html">SQL表达式映射</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM查询指南</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">使用Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">事件和内部实现</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM Examples</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="declarative_mixins.html" title="previous chapter">使用 Mixins 构成映射层次</a></li>
                <li><b>Next:</b>
                <a href="mapped_sql_expr.html" title="next chapter">将 SQL 表达式作为映射属性</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="mapper_config.html" title="ORM映射类配置">ORM映射类配置</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#dataclassesattrs">与dataclasses和attrs集成</a><ul>
<li><a class="reference internal" href="#orm-declarative-native-dataclasses">声明性数据类映射</a><ul>
<li><a class="reference internal" href="#id20">类级特性配置</a></li>
<li><a class="reference internal" href="#id31">关键字配置</a></li>
<li><a class="reference internal" href="#id42">属性配置</a><ul>
<li><a class="reference internal" href="#id55">列默认值</a></li>
<li><a class="reference internal" href="#annotated">与Annotated集成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mixin">使用mixin和抽象超类</a></li>
<li><a class="reference internal" href="#id72">关系配置</a></li>
<li><a class="reference internal" href="#orm-declarative-native-dataclasses-non-mapped-fields">使用非映射数据类字段</a></li>
<li><a class="reference internal" href="#pydantic">与Pydantic等备用数据类提供者的集成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm">将ORM映射应用于现有的数据类（传统数据类使用）</a><ul>
<li><a class="reference internal" href="#declarative-with-imperative-table">使用Declarative With Imperative Table映射预存在的数据类</a></li>
<li><a class="reference internal" href="#declarative-style">使用Declarative-style字段映射预存在的数据类</a></li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-dataclasses" >
        
<section id="dataclassesattrs">
<span id="orm-dataclasses-toplevel"></span><h1>与dataclasses和attrs集成<a class="headerlink" href="#dataclassesattrs" title="Permalink to this heading">¶</a></h1>
<p>从SQLAlchemy 2.0版本开始，可以通过向映射类添加单个mixin或装饰器来将:ref:<a href="#id1"><span class="problematic" id="id2">`</span></a>带注释的声明性表&lt;orm_declarative_mapped_column&gt;`映射转换为Python <a href="#id118"><span class="problematic" id="id119">dataclass_</span></a> ，从而实现“原生数据类”集成。</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>集成ORM声明类的数据类创建</p>
</div>
<p>还有一些可用的模式，可以用于映射现有的数据类，以及映射由attrs_第三方集成库进行装饰的类。</p>
<section id="orm-declarative-native-dataclasses">
<span id="id3"></span><h2>声明性数据类映射<a class="headerlink" href="#orm-declarative-native-dataclasses" title="Permalink to this heading">¶</a></h2>
<p>SQLAlchemy :ref:<a href="#id4"><span class="problematic" id="id5">`</span></a>带注释的声明性表&lt;orm_declarative_mapped_column&gt;`映射可以使用一个额外的mixin类或装饰器指令进行增强，增强后，映射过程完成后会将映射的类**就地**转换为Python <a href="#id120"><span class="problematic" id="id121">dataclass_</span></a> ，然后才应用ORM-specific :term:<a href="#id6"><span class="problematic" id="id7">`</span></a>instrumentation`到class上。最显著的行为补充是生成一个具有对位置和关键字参数的细粒度控制的``__init__()``方法，具有或没有默认值，以及生成如``__repr__()``或``__eq__()``之类的方法。</p>
<p>从:pep:<cite>484</cite> typing的角度来看，该类被认为具有Dataclass-specific的行为，尤其是通过利用:pep:<cite>681</cite>，Dataclass变换，允许使用typing工具将该类视为明确使用``&#64;dataclasses.dataclass``装饰器装饰的类。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>从**2023年4月4日**起，typing工具对:pep:<a href="#id8"><span class="problematic" id="id9">`</span></a>681`的支持受到限制，并且目前已知Pyright_以及Mypy_作为**版本1.2**已支持。请注意，Mypy 1.1.1引入了:pep:<a href="#id10"><span class="problematic" id="id11">`</span></a>681`支持，但未正确适应Python描述符，这将导致在使用SQLAlhcemy的ORM映射方案时出现错误。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://peps.python.org/pep-0681/#the-dataclass-transform-decorator">https://peps.python.org/pep-0681/#the-dataclass-transform-decorator</a> - 有关像SQLAlchemy这样的库如何启用:pep:<a href="#id12"><span class="problematic" id="id13">`</span></a>681`支持的背景说明</p>
</div>
</div>
<p>可以通过向任何Declarative类添加Dataclass conversion，具体方法为向:class:<cite>_orm.MappedAsDataclass</cite> mixin添加:class:<a href="#id14"><span class="problematic" id="id15">`</span></a>_orm.DeclarativeBase`类继承级别，或对于装饰器映射，使用``_orm.registry.mapped_as_dataclass``装饰器。</p>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code> mixin可以应用于Declarative <a href="#id16"><span class="problematic" id="id17">``</span></a>Base``类或任何超类，如下例所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">,</span> <span class="n">DeclarativeBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;子类将转换为dataclasses&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>或者可直接应用于从Declarative base扩展的类:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User class will be converted to a dataclass&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>在使用装饰器形式时，只支持:meth:<a href="#id18"><span class="problematic" id="id19">`</span></a>_orm.registry.mapped_as_dataclass`装饰器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>


<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<section id="id20">
<h3>类级特性配置<a class="headerlink" href="#id20" title="Permalink to this heading">¶</a></h3>
<p>dataclasses特性的支持是部分的。 <a href="#id21"><span class="problematic" id="id22">:一个:`被支持`的是``init``</span></a>，<code class="docutils literal notranslate"><span class="pre">repr</span></code>，<code class="docutils literal notranslate"><span class="pre">eq</span></code>，<a href="#id23"><span class="problematic" id="id24">``</span></a>order``和``unsafe_hash``特性，<a href="#id25"><span class="problematic" id="id26">``</span></a>match_args``和``kw_only``支持Python 3.10+。 :一个:<a href="#id27"><span class="problematic" id="id28">`</span></a>无法支持`的是``frozen``和``slots``特性。</p>
<p>当使用:meth:<a href="#id29"><span class="problematic" id="id30">`</span></a>_orm.MappedAsDataclass`的mixin class形式进行Declarative类配置时，类配置参数作为类级别参数传递:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">,</span> <span class="n">Base</span><span class="p">,</span> <span class="n">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unsafe_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User class将转换为dataclass&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>在使用装饰器形式时，类配置参数直接传递给装饰器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>


<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span><span class="p">(</span><span class="n">unsafe_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User class将转换为dataclass&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
</section>
<section id="id31">
<h3>关键字配置<a class="headerlink" href="#id31" title="Permalink to this heading">¶</a></h3>
<p>支持dataclasses特性是部分的。 <a href="#id32"><span class="problematic" id="id33">:一个:`被支持`的是``init``</span></a>，<code class="docutils literal notranslate"><span class="pre">repr</span></code>，<code class="docutils literal notranslate"><span class="pre">eq</span></code>，<a href="#id34"><span class="problematic" id="id35">``</span></a>order``和``unsafe_hash``特性，<a href="#id36"><span class="problematic" id="id37">``</span></a>match_args``和``kw_only``支持Python 3.10+。 :一个:<a href="#id38"><span class="problematic" id="id39">`</span></a>无法支持`的是``frozen``和``slots``特性。</p>
<p>当使用Declarative with Imperative Table形式的mixin class :class:<a href="#id40"><span class="problematic" id="id41">`</span></a>_orm.MappedAsDataclass`进行Declarative类配置时，类配置参数作为类级别参数传递:</p>
<p>当使用装饰器形式时，类配置参数直接传递给装饰器:</p>
</section>
<section id="id42">
<h3>属性配置<a class="headerlink" href="#id42" title="Permalink to this heading">¶</a></h3>
<p>SQLAlchemy的本机dataclasses与正常dataclasses不同之处在于映射的属性使用:class:<a href="#id43"><span class="problematic" id="id44">`</span></a>_orm.Mapped`泛型注释容器进行描述。映射遵循与:ref:<a href="#id45"><span class="problematic" id="id46">`</span></a>orm_declarative_table`文档记录的相同的格式，并支持:func:<a href="#id47"><span class="problematic" id="id48">`</span></a>_orm.mapped_column`和:class:<a href="#id49"><span class="problematic" id="id50">`</span></a>_orm.Mapped`的所有功能。</p>
<p>此外，ORM属性配置构造，包括:func:<cite>_orm.mapped_column</cite>，<code class="xref py py-func docutils literal notranslate"><span class="pre">composite`支持**每个属性字段选项**，包括``init`()</span></code>，<code class="docutils literal notranslate"><span class="pre">default</span></code>，<code class="docutils literal notranslate"><span class="pre">default_factory``和``repr</span></code>。这些参数的名称固定为:pep:<cite>681</cite>。功能相当于dataclasses：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">init</span></code>，如:paramref:<cite>_orm.mapped_column.init</cite>，
<code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.init</span></code>，如果为false，则表示该字段不应作为``__init__()``方法的一部分</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code>，如:paramref:<cite>_orm.mapped_column.default</cite>，
<code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.default</span></code>
表示该字段的默认值，可以作为关键字参数在``__init__()``方法中提供。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_factory</span></code>，如:paramref:<cite>_orm.mapped_column.default_factory</cite>，
<code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.default_factory</span></code>，表示可调函数
如果没有明确传递给``__init__()``方法，则将调用该函数来生成新的默认值。</p></li>
<li><p><a href="#id51"><span class="problematic" id="id52">``</span></a>repr``默认为True，表示该字段应包含在生成的``__repr__()``方法中</p></li>
</ul>
<p>与dataclasses的另一个关键区别是，属性的默认值必须使用ORM构造的``default``参数来配置，例如``mapped_column(default=None)``。使用类似于dataclass语法的语法，它接受简单的Python值作为默认值而不使用``&#64;dataclases.field()``，不被支持。</p>
<p>使用:func:<a href="#id53"><span class="problematic" id="id54">`</span></a>_orm.mapped_column`的示例，如下映射将生成一个``__init__()``方法，仅接受``name``和``fullname``字段，其中``name``是必需的，可以作为位置传递，而``fullname``是可选的。 我们希望由数据库生成``id``字段不是构造函数的一部分:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>


<span class="c1"># &#39;fullname&#39;是可选的关键字参数</span>
<span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<section id="id55">
<h4>列默认值<a class="headerlink" href="#id55" title="Permalink to this heading">¶</a></h4>
<p>为了适应``default``参数的名称重叠与当前:sparamref:<cite>_schema.Column.default`的重叠参数 :class:`_schema.Column</cite> 构造，<code class="xref py py-func docutils literal notranslate"><span class="pre">utc_timestamp()`()</span></code>,的datetime列的:paramref:<a href="#id56"><span class="problematic" id="id57">`</span></a>_schema.Column.default`但构造函数中的该参数是可选的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">insert_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">utc_timestamp</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>使用上述映射时，当未传递``created_at``参数的新``User``对象的``INSERT``过程执行如下步骤：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="go">...     session.add(User())</span>
<span class="go">...     session.commit()</span>
<div class='show_sql'><span class="k">BEGIN</span><span class="w"> </span><span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">created_at</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">utc_timestamp</span><span class="p">())</span>
<span class="p">[</span><span class="k">generated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00010</span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="p">()</span>
<span class="k">COMMIT</span>
</div></pre></div>
</div>
</section>
<section id="annotated">
<h4>与Annotated集成<a class="headerlink" href="#annotated" title="Permalink to this heading">¶</a></h4>
<p>在:ref:<cite>orm_declarative_mapped_column_pep593`中引入的方法说明了如何使用:pep:`593`中的``Annotated``对象将整个:func:`_orm.mapped_column`构造打包以进行重复使用。该特征支持使用dataclasses特性。但是，其中的某些方面需要解决措施，因为typing工具可能无法正确解释对属性的:pep:`681`特殊配置。例如，鉴于以下方法，该方法在运行时将完全正常，但typing工具将认为``User()``构造函数是无效的，因为它们看不到present`</cite> init = False``参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="c1"># typing工具会忽略init=False</span>
<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span>


<span class="c1"># typing错误：参数“id”缺失</span>
<span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>然而，<code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column`构造中，以使typing工具正确解释属性。例如，下面的方法将正常工作，但typing工具将不会将``User()``构造函数视为有效，因为它们看不到`()</span></code> init = False``参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="c1"># init=False和其他pep-681参数必须内联</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span></pre><div class="code-annotations-key"></div></div>
</div>
</section>
</section>
<section id="mixin">
<span id="orm-declarative-dc-mixins"></span><h3>使用mixin和抽象超类<a class="headerlink" href="#mixin" title="Permalink to this heading">¶</a></h3>
<p>在:class:<a href="#id58"><span class="problematic" id="id59">`</span></a>_orm.MappedAsDataclass`映射类中使用任何mixin或基类，这些类包括:class:<a href="#id60"><span class="problematic" id="id61">`</span></a>_orm.Mapped`属性，它们自己必须是:class:<a href="#id62"><span class="problematic" id="id63">`</span></a>_orm.MappedAsDataclass`层次结构的一部分，例如，在使用mixin的示例中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mixin</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">):</span>
    <span class="n">create_user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">update_user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">MappedAsDataclass</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">Mixin</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sys_user&quot;</span>

    <span class="n">uid</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="n">uuid4</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>:pep:<a href="#id64"><span class="problematic" id="id65">`</span></a>681`支持作为属于数据类的一部分的非数据类mixin的类型工具将不起作用。</p>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 2.0.8: </span>在:class:<a href="#id66"><span class="problematic" id="id67">`</span></a>_orm.MappedAsDataclass`或:meth:<a href="#id68"><span class="problematic" id="id69">`</span></a>_orm.registry.mapped_as_dataclass`层次结构中使用mixin和抽象基类，它们本身不是数据类，并非都支持:pep:<a href="#id70"><span class="problematic" id="id71">`</span></a>681`作为属于数据类的一部分的字段。会出现这种情况的警告，后续将成为错误。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../errors.html#error-dcmx"><span class="std std-ref">将 &lt;cls&gt; 转换为数据类时出错，其中一个或多个属性来自于不是数据类的超类 &lt;cls&gt;。</span></a> - 背景说明</p>
</div>
</div>
</section>
<section id="id72">
<h3>关系配置<a class="headerlink" href="#id72" title="Permalink to this heading">¶</a></h3>
<p>如在配置记录的:ref:<cite>relationship_patterns`中记录的，在:class:`_orm.Mapped`注释中与:func:`_orm.relationship`结合使用的方式相同。当将基于集合的:func:`_orm.relationship`作为可选关键字参数指定时，必须传递:paramref:`_orm.relationship.default_factory`参数，并且它必须引用要使用的集合类。One-to-one和scalar对象引用可以利用:paramref:`_orm.relationship.default</cite>，如果默认值为``None``时可以将其用于构造函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;parent&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">children</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Child&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">list</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;parent&quot;</span>
    <span class="p">)</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">Child</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;child&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;parent.id&quot;</span><span class="p">))</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述映射将在新的``Parent()``对象构造时为``Parent.children``生成一个空列表，类似地，在新的``Child()``对象构造时为``Child.parent``生成``None``值而无需传递``parent``。</p>
<p>当:class:<a href="#id73"><span class="problematic" id="id74">`</span></a>_orm.relationship`单独声明时，它需要直接在:paramref:<a href="#id75"><span class="problematic" id="id76">`</span></a>_orm.Mapper.properties`字典中指定，该字典本身指定在``__mapper_args__``字典中，以便将其传递给:class:<a href="#id77"><span class="problematic" id="id78">`</span></a>_orm.Mapper`的构造函数。这个方法的替代方法在下面的示例中。</p>
</section>
<section id="orm-declarative-native-dataclasses-non-mapped-fields">
<span id="id79"></span><h3>使用非映射数据类字段<a class="headerlink" href="#orm-declarative-native-dataclasses-non-mapped-fields" title="Permalink to this heading">¶</a></h3>
<p>当使用Declarative数据类时，也可以使用非映射字段，这些字段将成为数据类构造过程的一部分，但不会映射。通过使用正常的Dataclass语法，可以定义不使用:class:<cite>.Mapped`的字段。不使用:class:</cite>.Mapped`的任何字段都将被映射过程忽略。在以下示例中，字段``ctrl_one``和``ctrl_two``将成为对象的实例级状态，但不会被ORM持久化：</p>
<blockquote>
<div><p>from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import registry</p>
<p>reg = registry()</p>
<p>&#64;reg.mapped_as_dataclass
class Data:</p>
<blockquote>
<div><p>__tablename__ = “data”</p>
<p>id: Mapped[int] = mapped_column(init=False, primary_key=True)
status: Mapped[str]</p>
<p>ctrl_one: Optional[str] = None
ctrl_two: Optional[str] = None</p>
</div></blockquote>
</div></blockquote>
<p>上述Data的实例可以创建如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;s1&quot;</span><span class="p">,</span> <span class="n">ctrl_one</span><span class="o">=</span><span class="s2">&quot;ctrl1&quot;</span><span class="p">,</span> <span class="n">ctrl_two</span><span class="o">=</span><span class="s2">&quot;ctrl2&quot;</span><span class="p">)</span></pre></div>
</div>
<p>一个更现实的例子可能是结合:initvar来使用``__post_init__()``特性来接收仅初始化的字段，这些字段可以用于组合持久化数据。在下面的示例中，<code class="docutils literal notranslate"><span class="pre">User``类使用``id</span></code>、<code class="docutils literal notranslate"><span class="pre">name``和``password_hash``作为映射特性，但使用初始化-only``password``和``repeat_password``字段来表示用户创建过程（注意：要运行此示例，请将函数``your_crypt_function_here()``替换为第三方加密函数，例如``bcrypt``或``argon2-cffi</span></code>）：</p>
<blockquote>
<div><p>from dataclasses import InitVar
from typing import Optional</p>
<p>from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import registry</p>
<p>reg = registry()</p>
<p>&#64;reg.mapped_as_dataclass
class User:</p>
<blockquote>
<div><p>__tablename__ = “user_account”</p>
<p>id: Mapped[int] = mapped_column(init=False, primary_key=True)
name: Mapped[str]</p>
<p>password: InitVar[str]
repeat_password: InitVar[str]</p>
<p>password_hash: Mapped[str] = mapped_column(init=False, nullable=False)</p>
<dl>
<dt>def __post_init__(self, password: str, repeat_password: str):</dt><dd><dl class="simple">
<dt>if password != repeat_password:</dt><dd><p>raise ValueError(“passwords do not match”)</p>
</dd>
</dl>
<p>self.password_hash = your_crypt_function_here(password)</p>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<p>上述对象使用``password``和``repeat_password``参数创建，这些参数最先被消耗，以便在flush中从自动增量或其他默认值生成器中获取其值。允许在构造函数中明确指定它们，将为它们赋予``None``默认值。</p>
<p>从:class:<a href="#id80"><span class="problematic" id="id81">`</span></a>_orm.MappedAsDataclass`或直接应用了:meth:<a href="#id82"><span class="problematic" id="id83">`</span></a>_orm.registry.mapped_as_dataclass`的mixin中包括非数据类mixin的字段将被忽略，而无需显式地指定``__allow_unmapped__``类属性。在以前的2.0 beta版本中，即使只是为了使旧的ORM typed mappings继续正常工作，这个属性也需要被显式定义。</p>
</section>
<section id="pydantic">
<span id="dataclasses-pydantic"></span><h3>与Pydantic等备用数据类提供者的集成<a class="headerlink" href="#pydantic" title="Permalink to this heading">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Pydantic版本1.x的数据类层与SQLAlchemy的类instrumentation并不完全兼容，而且许多功能（例如相关的collections）可能无法正确工作。</p>
<p>对于Pydantic的兼容性，请考虑构建在SQLAlchemy ORM之上的Pydantic的`SQLModel &lt;<a class="reference external" href="https://sqlmodel.tiangolo.com">https://sqlmodel.tiangolo.com</a>&gt;`_ ORM，其中包含特定的实现细节，<a href="#id84"><span class="problematic" id="id85">**</span></a>明确解决**这些不兼容性。</p>
</div>
<p>SQLAlchemy的:class:<cite>_orm.MappedAsDataclass</cite> class和:meth:<a href="#id86"><span class="problematic" id="id87">`</span></a>_orm.registry.mapped_as_dataclass`方法直接调用Python标准库``dataclasses.dataclass``类装饰器，在对类进行声明性映射处理之后。可以使用``dataclass_callable``参数将此函数调用换成备用的数据类提供者，例如Pydantic，作为类关键字参数传递给:class:<a href="#id88"><span class="problematic" id="id89">`</span></a>_orm.MappedAsDataclass`以及:meth:<a href="#id90"><span class="problematic" id="id91">`</span></a>_orm.registry.mapped_as_dataclass`方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span>
    <span class="n">MappedAsDataclass</span><span class="p">,</span>
    <span class="n">DeclarativeBase</span><span class="p">,</span>
    <span class="n">dataclass_callable</span><span class="o">=</span><span class="n">pydantic</span><span class="o">.</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述``User``类将被应用为数据类，并使用Pydantic的``pydantic.dataclasses.dataclasses``可调用。该过程既适用于映射类，也适用于扩展从:class:<a href="#id92"><span class="problematic" id="id93">`</span></a>_orm.MappedAsDataclass`或直接应用:meth:<a href="#id94"><span class="problematic" id="id95">`</span></a>_orm.registry.mapped_as_dataclass`的mixin。</p>
</section>
</section>
<section id="orm">
<span id="orm-declarative-dataclasses"></span><h2>将ORM映射应用于现有的数据类（传统数据类使用）<a class="headerlink" href="#orm" title="Permalink to this heading">¶</a></h2>
<div class="admonition legacy">
<p class="admonition-title">Legacy Feature</p>
<p>这些方法的描述已被新的功能:ref:<a href="#id96"><span class="problematic" id="id97">`</span></a>orm_declarative_native_dataclasses`所取代。这个在1.4中首次添加了Dataclass的支持，这通.过在此部分中描述这个旧方法。</p>
</div>
<p>要将映射应用于数据类，无法直接使用SQLAlchemy的“inline”声明性指令;将ORM指令分配给类时，使用以下三种技术之一：</p>
<ul class="simple">
<li><p>使用“Declarative with Imperative Table”，使用:class:<cite>_schema.Table`对象定义要映射的表/列，并将其分配给类的``__table__``属性;关系在``__mapper_args__``字典内定义。使用:meth:`_orm.registry.mapped`装饰器映射类。以下是下方的示例:ref:`orm_declarative_dataclasses_imperative_table</cite>。</p></li>
<li><p>使用完整的“Declarative”，将Declarative-interpreted指令，例如:class:<cite>_schema.Column</cite>，<code class="xref py py-func docutils literal notranslate"><span class="pre">relationship`添加到`()</span></code>.metadata``字典的``dataclasses.field()``构造中，其中它们由声明性过程消耗。重复使用:meth:<cite>_orm.registry.mapped`装饰器，另请参见下面显示的示例:ref:`orm_declarative_dataclasses_declarative_table</cite>。</p></li>
<li><p>可以使用:meth:<a href="#id98"><span class="problematic" id="id99">`</span></a>_orm.registry.map_imperatively`方法将Imperative映射应用于现有的数据类，以完全相同的方式生成映射如:ref:<a href="#id100"><span class="problematic" id="id101">`</span></a>orm_imperative_mapping`中所述。这将在下面的示例:ref:<a href="#id102"><span class="problematic" id="id103">`</span></a>orm_imperative_dataclasses`中说明。</p></li>
</ul>
<p>将ORM映射应用于数据类的一般过程与普通类的过程相同，但还包括SQLAlchemy将检测到在数据类中作为声明过程一部分的类级属性，并在运行时将其替换为通常的SQLAlchemy ORM映射属性。由dataclasses生成的``__init__``方法保持不变，其他所有由dataclasses生成的方法也保持不变，例如``__eq__()``和``__repr__()``等。</p>
<section id="declarative-with-imperative-table">
<span id="orm-declarative-dataclasses-imperative-table"></span><h3>使用Declarative With Imperative Table映射预存在的数据类<a class="headerlink" href="#declarative-with-imperative-table" title="Permalink to this heading">¶</a></h3>
<p>使用:ref:<cite>orm_imperative_table_configuration`的示例将描述如何使用``&#64;dataclass`</cite>。显式构造完整的:class:<cite>_schema.Table`对象并将其分配给``__table__``属性。使用正常的dataclass语法定义实例字段。其他:class:</cite>.MapperProperty`定义，例如:func:<cite>.relationship</cite>，都放置在:class:<a href="#id104"><span class="problematic" id="id105">`</span></a>__mapper_args__ &lt;orm_declarative_mapper_options&gt;`类级字典中，对应于:paramref:<a href="#id106"><span class="problematic" id="id107">`</span></a>_orm.Mapper.properties`参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span><span class="p">,</span> <span class="n">relationship</span>

<span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@mapper_registry</span><span class="o">.</span><span class="n">mapped</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">mapper_registry</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nickname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">list</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># type: ignore</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;addresses&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="nd">@mapper_registry</span><span class="o">.</span><span class="n">mapped</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">:</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;address&quot;</span><span class="p">,</span>
        <span class="n">mapper_registry</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;email_address&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述示例中，<code class="docutils literal notranslate"><span class="pre">User.id</span></code>、<code class="docutils literal notranslate"><span class="pre">Address.id``和``Address.user_id``属性被定义为``field(init=False)</span></code>。这意味着这些参数不会添加到``__init__()``方法中，但是Session仍将能够在获取值后在flush期间将它们设置。将它们显式指定为构造函数参数，它们将被赋予``None``默认值。</p>
<p>对于:func:<a href="#id108"><span class="problematic" id="id109">`</span></a>_orm.relationship`通过单独声明，需要直接在:paramref:<a href="#id110"><span class="problematic" id="id111">`</span></a>_orm.Mapper.properties`字典中指定，这个字典本身在``__mapper_args__``字典内置，以便将它传递给:class:<a href="#id112"><span class="problematic" id="id113">`</span></a>_orm.Mapper`的构造函数。此方法的另一种方法在下面的示例中。</p>
</section>
<section id="declarative-style">
<span id="orm-declarative-dataclasses-declarative-table"></span><h3>使用Declarative-style字段映射预存在的数据类<a class="headerlink" href="#declarative-style" title="Permalink to this heading">¶</a></h3>
<div class="admonition legacy">
<p class="admonition-title">Legacy Feature</p>
<p>完全声明式方法需要将:class:<a href="#id114"><span class="problematic" id="id115">`</span></a>_schema.Column`对象声明为类属性。这将与使用dataclass级别的属性的冲突。结合使用时，可以利用``metadata``属性。在``dataclass.field``对象中，可以提供SQLAlchemy特定的映射信息。Declarative支持在类指定属性``__sa_dataclass_metadata_key__``时的这些参数的提取。这还提供了一种更简洁的方法来指示:func:<a href="#id116"><span class="problematic" id="id117">`</span></a>_orm.relationship`关联:</p>
<p>from __future__ import annotations</p>
<p>from dataclasses import dataclass, field
from typing import List</p>
<p>from sqlalchemy import Column, ForeignKey, Integer, String
from sqlalchemy.orm import registry, relationship</p>
<p>mapper_registry = registry()</p>
<p>&#64;mapper_registry.mapped
&#64;dataclass
class User:</p>
<blockquote>
<div><p>__tablename__ = “user”</p>
<p>__sa_dataclass_metadata_key__ = “sa”
id: int = field(init=False, metadata={“sa”: Column(Integer, primary_key=True)})
name: str = field(default=None, metadata={“sa”: Column(String(50))})
fullname: str = field(default=None, metadata={“sa”: Column(String(50))})
nickname: str = field(default=None, metadata={“sa”: Column(String(12))})</p>
</div></blockquote>
</div>
<p>addresses: List[Address] = field默认值为列表，元素类型为Address，其中metadata参数用来设置属性的元数据信息，这里设置了一个sa键，值为关系数据的配置信息，即关联Address表。</p>
<p>由此可见metadata参数的类似于声明方式给与了dataclasses通过注释生成ORM对象的灵活性，使其能够通过注释继承和自定义ORM属性和关系的实现。</p>
<p>对于Address类也有类似的注释实现，id、user_id和email_address分别对应自增主键、用户id和email地址信息。</p>
<p>在本文档的另一个章节orm_declarative_dataclasses_mixin中，详细介绍了如何将声明性的混合类用于已有的dataclass中，其中介绍了基于声明式的orm混合类的要求，并给出了基于dataclass的实现方式。实现的主要步骤是使用Lambda函数在metadata中表示ORM construct（例如Column、relationship等）。</p>
<p>最后本文档通过使用属性包装函数_declared_attr_修饰lambda函数来实现定义属性函数的目标，并给出了一个将dataclass映射为ORM类的例子。在此例子中，实体类User和Address类使用了两个已有的ORM类UserMixin和AddressMixin，并通过数据类混合方式继承他们的功能。值得一提的是，这里的ORM类是通过Python的数据类实现的，实现了类似SQLAlchemy的声明式混合，使得我们的ORM层的语法看起来比纯Python代码简洁并且易于阅读及维护。</p>
<p>在orm_imperative_dataclasses章节中，介绍了如何利用一种叫做_map_imperatively_的技术将已有的dataclass映射为ORM类。同时还给出了数据类的另一个实现方式：使用attrs模块的示例代码，并介绍了如何进行Python类型注解。</p>
<p>最后，本文档还详细的讲述了在Python的ORM领域中两种主流的类型检查工具mypy和pyright在可读性和错误提示方面的优越性以及对这些注释的支持程度。</p>
</section>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="declarative_mixins.html" title="previous chapter">使用 Mixins 构成映射层次</a>
        Next:
        <a href="mapped_sql_expr.html" title="next chapter">将 SQL 表达式作为映射属性</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 10:07:09

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


