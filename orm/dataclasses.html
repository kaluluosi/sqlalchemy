<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    与dataclasses和attrs集成
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="ORM映射类配置" href="mapper_config.html" />
        <link rel="next" title="将SQL表达式映射为属性" href="mapped_sql_expr.html" />
        <link rel="prev" title="使用 Mixin 构建映射层次结构" href="declarative_mixins.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM映射类配置</a></span><ul>
<li><span class="link-container"><a class="reference external" href="mapping_styles.html">ORM映射类概述</a></span></li>
<li><span class="link-container"><a class="reference external" href="declarative_mapping.html">通过声明性方式映射类</a></span></li>
<li class="selected"><span class="link-container"><strong>与dataclasses和attrs集成</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-native-dataclasses">声明数据类映射</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id2">类级特征配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id3">属性配置</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id6">列默认值</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id7">与注释</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-dc-mixins">使用基类</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id9">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="#pydantic">与Pydantic等替代数据类提供程序集成</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm">将ORM映射应用于现有数据类（旧数据类用法）</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-declarative-dataclasses-imperative-table">使用“自声明式表”​​映射现有数据类</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#mixins-dataclasses">使用声明性 mixins 与预先存在的 dataclasses</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dataclasses">使用命令式映射映射预先存在的 dataclasses</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm-attrs">将 ORM 映射应用于现有的 attrs 类</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id13">使用声明性“命令式表”</a></span></li>
<li><span class="link-container"><a class="reference external" href="#attrs">使用命令式映射映射 attrs</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="mapped_sql_expr.html">将SQL表达式映射为属性</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapped_attributes.html">更改属性行为</a></span></li>
<li><span class="link-container"><a class="reference external" href="composites.html">复合列类型</a></span></li>
<li><span class="link-container"><a class="reference external" href="inheritance.html">映射类继承层次结构</a></span></li>
<li><span class="link-container"><a class="reference external" href="nonstandard_mappings.html">非传统映射</a></span></li>
<li><span class="link-container"><a class="reference external" href="versioning.html">配置版本计数器</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapping_api.html">类映射API</a></span></li>
<li><span class="link-container"><a class="reference external" href="scalar_mapping.html">映射SQL表达式</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM 查询指南</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">用 Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">事件和内部机制</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM 示例</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="declarative_mixins.html" title="previous chapter">使用 Mixin 构建映射层次结构</a></li>
                <li><b>Next:</b>
                <a href="mapped_sql_expr.html" title="next chapter">将SQL表达式映射为属性</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="mapper_config.html" title="ORM映射类配置">ORM映射类配置</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#dataclassesattrs">与dataclasses和attrs集成</a><ul>
<li><a class="reference internal" href="#orm-declarative-native-dataclasses">声明数据类映射</a><ul>
<li><a class="reference internal" href="#id2">类级特征配置</a></li>
<li><a class="reference internal" href="#id3">属性配置</a><ul>
<li><a class="reference internal" href="#id6">列默认值</a></li>
<li><a class="reference internal" href="#id7">与注释</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-declarative-dc-mixins">使用基类</a></li>
<li><a class="reference internal" href="#id9">关系配置</a></li>
<li><a class="reference internal" href="#pydantic">与Pydantic等替代数据类提供程序集成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm">将ORM映射应用于现有数据类（旧数据类用法）</a><ul>
<li><a class="reference internal" href="#orm-declarative-dataclasses-imperative-table">使用“自声明式表”​​映射现有数据类</a><ul>
<li><a class="reference internal" href="#mixins-dataclasses">使用声明性 mixins 与预先存在的 dataclasses</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataclasses">使用命令式映射映射预先存在的 dataclasses</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-attrs">将 ORM 映射应用于现有的 attrs 类</a><ul>
<li><a class="reference internal" href="#id13">使用声明性“命令式表”</a></li>
<li><a class="reference internal" href="#attrs">使用命令式映射映射 attrs</a></li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-dataclasses" >
        
<section id="dataclassesattrs">
<span id="orm-dataclasses-toplevel"></span><h1>与dataclasses和attrs集成<a class="headerlink" href="#dataclassesattrs" title="Permalink to this heading">¶</a></h1>
<p>SQLAlchemy自2.0版本开始提供”原生dataclass”集成，使用单个混合类型或装饰器将   <a class="reference internal" href="declarative_tables.html#orm-declarative-mapped-column"><span class="std std-ref">带注释的声明表</span></a>  映射转换为Python dataclass_就可将映射类转换为数据类。</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>使用ORM Declarative类进行集成数据类的创建</p>
</div>
<p>还有其他的模式可以使用，例如映射现有的dataclasses，或映射由attrs_第三方集成库创建的类。</p>
<section id="orm-declarative-native-dataclasses">
<span id="id1"></span><h2>声明数据类映射<a class="headerlink" href="#orm-declarative-native-dataclasses" title="Permalink to this heading">¶</a></h2>
<p>SQLAlchemy   <a class="reference internal" href="declarative_tables.html#orm-declarative-mapped-column"><span class="std std-ref">Annotated Declarative Table</span></a>  映射可以通过添加另一个混合类型类或装饰器指令来增强，这会在映射完成后增加一个步骤，将映射类**原地**转换为Python <a class="reference external" href="https://docs.python.org/zh-cn/3/library/dataclasses.html">dataclass</a>, 然后应用特定于ORM的 :term:` instrumentation` 以完成映射过程。这当中最显著的行为变化就是生成一个具有细粒度控制的 <cite>__init __（）</cite> 方法, 可以在没有默认值的情况下接受有位置和关键字参数，同时生成像 <cite>__repr __（）</cite> 和 <cite>__eq __（）</cite> 这样的方法。</p>
<p>从  <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a>  类型的角度讲，数据类特定的行为被识别为包含数据类转换的工具，特别是通过  :pep:` 681`  “Dataclass Transforms” 来利用，这可以使类型工具将该类视为已显式使用 <cite>&#64;dataclasses.dataclass</cite> 装饰器装饰。</p>
<p>将数据转换类添加到任何声明式类中，可以将   <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  混合类型添加到   :class:` _orm.DeclarativeBase`  类层次结构中或通过使用   <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped_as_dataclass()</span></code>  类装饰器的装饰器映射。</p>
<p>可将   <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  混合类型应用于声明式 “Base” 类或任何超类，例如下面的示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">,</span> <span class="n">DeclarativeBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;该子类将被转换为dataclasses&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>或者可以直接应用于从声明式base派生的类：</p>
<blockquote>
<div><p>from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import MappedAsDataclass</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class User(MappedAsDataclass, Base):</dt><dd><p>“””User类将被转换为数据类”””</p>
<p>__tablename__ = “user_account”</p>
<p>id: Mapped[int] = mapped_column(init=False, primary_key=True)
name: Mapped[str]</p>
</dd>
</dl>
</div></blockquote>
<p>使用装饰器形式时，仅支持  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped_as_dataclass()</span></code>  装饰器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>


<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<section id="id2">
<h3>类级特征配置<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<p>支持数据类特性部分。目前**支持**的有“init”、“repr”、“eq”、“order”和“unsafe_hash”特性，Python 3.10+上支持“match_args”和“kw_only”。目前**不支持**的有“frozen”和“slots”特性。</p>
<p>在使用   <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  的混合类形式时，类配置参数作为类级参数传递:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">,</span> <span class="n">Base</span><span class="p">,</span> <span class="n">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unsafe_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User类将被转换为DataClass&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>使用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped_as_dataclass()</span></code>  装饰器形式时，类配置参数直接传递给装饰器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>


<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span><span class="p">(</span><span class="n">unsafe_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User类将被转换为DataClass&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>有关数据类类选项的背景，请参见数据类_文档中的 <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#dataclasses.dataclass">&#64;dataclasses.dataclass</a>。</p>
</section>
<section id="id3">
<h3>属性配置<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>SQLAlchemy原生数据类与普通数据类的区别在于所有要映射的属性都是使用   <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>  通用注释容器描述的。映射遵循与   :ref:` orm_declarative_table`  中记录的相同形式，支持   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>  和   :class:` _orm.Mapped`  的所有功能。</p>
<p>此外，ORM属性配置构造，包括   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code> 、  :func:` _orm.relationship`  和   <a class="reference internal" href="composites.html#sqlalchemy.orm.composite" title="sqlalchemy.orm.composite"><code class="xref py py-func docutils literal notranslate"><span class="pre">composite()</span></code></a>  支持 <strong>每个属性字段选项</strong>，包括 ` <cite>init`</cite>、<code class="docutils literal notranslate"><span class="pre">default</span></code>、<code class="docutils literal notranslate"><span class="pre">default_factory</span></code> 和 <code class="docutils literal notranslate"><span class="pre">repr</span></code>。这些参数的名称被固定为  <span class="target" id="index-1"></span><a class="pep reference external" href="https://peps.python.org/pep-0681/"><strong>PEP 681</strong></a>  中指定的名称。功能与数据类等效：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">init</span></code>，与  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">orm.mapped_column</span></code> ，  :paramref:` _orm.relationship.init &lt;sqlalchemy.orm.relationship&gt;`  相同，如果为 False，则表示该字段不应作为``__init __()`` 方法的一部分。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code>，如  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">orm.mapped_column</span></code> ，  :paramref:` _orm.relationship.default &lt;sqlalchemy.orm.relationship&gt;` ，指示字段的默认值，该值在``__init__（）``方法中按关键字参数给出。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_factory</span></code>，如  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">orm.mapped_column</span></code> ，  :paramref:` _orm.relationship.default_factory &lt;sqlalchemy.orm.relationship&gt;` ，表示可调用函数，该函数会在未将参数传递明确传递给``__init__（）``方法的情况下生成新的默认值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">repr``默认为True，表示该字段应作为生成的``__repr</span> <span class="pre">__()</span></code> 方法的一部分。</p></li>
</ul>
<p>与数据类的另一个主要区别是，将属性的默认值 <a href="#id4"><span class="problematic" id="id5">**</span></a>必须**使用ORM构造中的``default``参数进行配置，例如``mapped_column（default = None）``。不支持类似数据类的语法，该语法接受简单的Python值作为默认值，而不使用 <cite>&#64;dataclases.field（）`</cite>。</p>
<p>通过使用   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code> ，下面的映射将生成一个` <cite>__init__()`</cite> 方法，该方法仅接受参数``name`` 和``fullname``，其中``name``是必需的，可以按位置传递，<code class="docutils literal notranslate"><span class="pre">fullname``是可选的。我们预计由数据库生成的</span> <span class="pre">``id</span></code> 字段根本不在构造函数中:</p>
<blockquote>
<div><p>from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import registry</p>
<p>reg = registry()</p>
<p>&#64;reg.mapped_as_dataclass
class User:</p>
<blockquote>
<div><p>__tablename__ = “user_account”</p>
<p>id: Mapped[int] = mapped_column(init=False, primary_key=True)
name: Mapped[str]
fullname: Mapped[str] = mapped_column(default=None)</p>
</div></blockquote>
<p># ‘fullname’是可选的关键字参数
u1 = User(“name”)</p>
</div></blockquote>
<section id="id6">
<h4>列默认值<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<p>为了适应 <code class="docutils literal notranslate"><span class="pre">default</span></code> 参数与现有  <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.default</span></code></a>  参数的重叠，   :func:` _orm.mapped_column`  构造将这两个名称区分开来，通过添加一个新参数  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.insert_default</span></code>  直接将其填充到   :class:` _schema.Column`  的  <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.default</span></code></a>  参数中，而不考虑在  :paramref:` _orm.mapped_column.default`  上设置了什么，后者始终用于数据类配置。例如，要将默认值设置为 <code class="docutils literal notranslate"><span class="pre">func.utc_timestamp()</span></code> SQL 函数的 datetime 列，但在构造函数中该参数是可选的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">insert_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">utc_timestamp</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述映射将根据默认值生成新的``User``对象的 <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> 语句，而在 <code class="docutils literal notranslate"><span class="pre">created_at</span></code> 参数未显式传递的情况下，会执行如下操作：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="go">...     session.add(User())</span>
<span class="go">...     session.commit()</span>
<div class='show_sql'><span class="w"> </span><span class="k">BEGIN</span><span class="err">（隐式）</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="err">（</span><span class="n">created_at</span><span class="err">）</span><span class="k">VALUES</span><span class="err">（</span><span class="n">utc_timestamp</span><span class="err">（））</span>
<span class="p">[</span><span class="k">generated</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00010</span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="p">()</span>
<span class="k">COMMIT</span>
</div></pre></div>
</div>
</section>
<section id="id7">
<h4>与注释<a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h4>
<p>在   <a class="reference internal" href="declarative_tables.html#orm-declarative-mapped-column-pep593"><span class="std std-ref">将整个列声明映射到Python类型</span></a>  中介绍的方法说明如何使用  :pep:` 593`  中的“注释”对象来打包整个   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>  构造以供重用。此功能与数据类特性一起使用。 但是，该特性的一个方面需要处理以下情况：当使用类型工具时，额外的内部更改是，  :pep:` 681`  特定参数 <cite>init</cite>、<cite>default</cite>、<cite>repr</cite> 和 <cite>default_factory</cite> 必须在右侧中打包到显式的   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>  构造中，以便类型工具可以正确解释属性。例如，下面的方式将完美地在运行时工作，但是当未在其中看到` <cite>init=False`</cite> 参数时，类型工具将认为 <code class="docutils literal notranslate"><span class="pre">User()</span></code> 构造是无效的：</p>
<blockquote>
<div><p>from typing import Annotated</p>
<p>from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import registry</p>
<p># typing工具将忽略init = False
intpk = Annotated[int， mapped_column(init=False， primary_key=True)]</p>
<p>reg = registry()</p>
<p>&#64;reg.mapped_as_dataclass
class User:</p>
<blockquote>
<div><p>__tablename__ = “user_account”
id: Mapped[intpk]</p>
</div></blockquote>
<p># typing错误：缺少参数“id”
u1 = User()</p>
</div></blockquote>
<p>相反，需要在右边也使用   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code> ，并使用此函数显式设置  :paramref:` _orm.mapped_column.init`  的值；其他参数可以保留在 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 构造内:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="err">，</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="c1"># init=False和其他pep-681参数必须是inline的</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span></pre><div class="code-annotations-key"></div></div>
</div>
</section>
</section>
<section id="orm-declarative-dc-mixins">
<span id="id8"></span><h3>使用基类<a class="headerlink" href="#orm-declarative-dc-mixins" title="Permalink to this heading">¶</a></h3>
<p>任何包含   <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>  属性的混合类型或基类在   :class:` _orm.MappedAsDataclass`  映射类中使用时，它们本身必须是   <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  层次结构的一部分，比如在下面使用混合类型的示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mixin</span><span class="p">(</span><span class="n">MappedAsDataclass</span><span class="p">):</span>
    <span class="n">create_user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">update_user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">MappedAsDataclass</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">Mixin</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sys_user&quot;</span>

    <span class="n">uid</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="n">uuid4</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>支持  <span class="target" id="index-2"></span><a class="pep reference external" href="https://peps.python.org/pep-0681/"><strong>PEP 681</strong></a>  的 Python 类型检查器否则不认为数据类产生的类属性与数据类相同。</p>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 2.0.8: </span>在   <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  或
 <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped_as_dataclass()</span></code>  层次结构内使用混合类型和抽象基类，如果它们本身不是数据类，则不支持这些字段作为属于数据类的  :pep:` 681`  .针对此情况发出警告，该警告后来将变成错误。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../errors.html#error-dcmx"><span class="std std-ref">将 &lt;cls&gt; 转换为数据类时发生 Python 数据类错误</span></a>  - 关于理由</p>
</div>
</div>
</section>
<section id="id9">
<h3>关系配置<a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><p><a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>  注释结合   :func:` _orm.relationship`  与   <a class="reference internal" href="basic_relationships.html#relationship-patterns"><span class="std std-ref">基本关系模式</span></a>  中描述的使用方法相同。在将集合类作为可选关键字参数指定的情况下，必须传递  :paramref:` _orm.relationship.default_factory`  参数，并且它必须引用要使用的集合类。如果默认值将是 <code class="docutils literal notranslate"><span class="pre">None</span></code>，则可以使用  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.default</span></code>  来定义对多和标量对象引用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;parent&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">children</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Child&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">list</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;parent&quot;</span>
    <span class="p">)</span>


<span class="nd">@reg</span><span class="o">.</span><span class="n">mapped_as_dataclass</span>
<span class="k">class</span> <span class="nc">Child</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;child&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;parent.id&quot;</span><span class="p">))</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</div></blockquote>
<p>上述映射将为 <code class="docutils literal notranslate"><span class="pre">Parent.children</span></code> 栏位生成一个空列表，当构造一个不传递``children`` 的新 <code class="docutils literal notranslate"><span class="pre">Parent()</span> <span class="pre">``对象时，而类似的，对于</span> <span class="pre">``Child()</span></code> 对象，当构造一个未传递 <code class="docutils literal notranslate"><span class="pre">parent</span></code> 的新对象时，会生成 <code class="docutils literal notranslate"><span class="pre">None</span></code> 值的 <code class="docutils literal notranslate"><span class="pre">Child.parent</span></code>。</p>
<p>注意,  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.default_factory</span></code>  可以从   :func:` _orm.relationship`  派生的给定集合类自动推导出来，但这会破坏与Data class的兼容性，因为  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.default_factory</span></code>  或  :paramref:` _orm.relationship.default`  的存在决定了将其呈现为 <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> 方法时，该参数是必需还是可选。</p>
<p>使用   <span class="xref std std-ref">与 _的非映射数据类字段</span>  时，将使用未映射的字段作为实例级状态的一部分，但不会被ORM保存。任何不使用   :class:` .Mapped`  的字段将被映射过程忽略。在下面的示例中，字段“ctrl_one”和“ctrl_two”将是对象的实例级状态，但不会被ORM保存：</p>
<blockquote>
<div><p>from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import registry</p>
<p>reg = registry()</p>
<p>&#64;reg.mapped_as_dataclass
class Data:</p>
<blockquote>
<div><p>__tablename__ = “data”</p>
<p>id: Mapped[int] = mapped_column(init=False, primary_key=True)
status: Mapped[str]</p>
<p>ctrl_one: Optional[str] = None
ctrl_two: Optional[str] = None</p>
</div></blockquote>
</div></blockquote>
<p>可以像这样创建Data的实例：</p>
<blockquote>
<div><p>d1 = Data(status=”s1”, ctrl_one=”ctrl1”, ctrl_two=”ctrl2”)</p>
</div></blockquote>
<p>更真实的例子可能是将Dataclasses的 <code class="docutils literal notranslate"><span class="pre">InitVar</span></code> 特性与 <code class="docutils literal notranslate"><span class="pre">__post_init</span> <span class="pre">__（）</span></code> 特性一起使用，以接收可用于构成持续数据的仅初始化字段。在下面的示例中，声明了使用 <code class="docutils literal notranslate"><span class="pre">id</span></code>， <code class="docutils literal notranslate"><span class="pre">name</span></code> 和 <code class="docutils literal notranslate"><span class="pre">password_hash</span></code> 作为映射属性的 <code class="docutils literal notranslate"><span class="pre">User</span></code> 类，但是使用仅初始化 <code class="docutils literal notranslate"><span class="pre">password``和</span> <span class="pre">``repeat_password``字段来表示用户创建过程（注意：要运行此示例，将</span> <span class="pre">``your_crypt_function_here（）</span></code> 函数替换为类似于`bcrypt &lt;<a class="reference external" href="https://pypi.org/project/bcrypt/">https://pypi.org/project/bcrypt/</a>&gt;`_或 <a href="#id10"><span class="problematic" id="id11">`</span></a>argon2-cffi &lt;<a class="reference external" href="https://pypi.org/project/argon2-cffi/">https://pypi.org/project/argon2-cffi/</a>&gt;`_的第三方加密函数）:</p>
<blockquote>
<div><p>from dataclasses import InitVar
from typing import Optional</p>
<p>from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import registry</p>
<p>reg = registry()</p>
<p>&#64;reg.mapped_as_dataclass
class User:</p>
<blockquote>
<div><p>__tablename__ = “user_account”</p>
<p>id: Mapped[int] = mapped_column(init=False, primary_key=True)
name: Mapped[str]</p>
<p>password: InitVar[str]
repeat_password: InitVar[str]</p>
<p>password_hash: Mapped[str] = mapped_column(init=False, nullable=False)</p>
<dl>
<dt>def __post_init__(self, password: str, repeat_password: str):</dt><dd><dl class="simple">
<dt>if password != repeat_password:</dt><dd><p>raise ValueError(“passwords do not match”)</p>
</dd>
</dl>
<p>self.password_hash = your_crypt_function_here(password)</p>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<p>上述对象使用参数 <code class="docutils literal notranslate"><span class="pre">password</span></code> 和 <code class="docutils literal notranslate"><span class="pre">repeat_password</span></code> 创建，这些参数会被提前使用，以便可以从模拟器中返回它们的值并从中生成 <code class="docutils literal notranslate"><span class="pre">password_hash</span></code> 参数：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;some_user&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span> <span class="n">repeat_password</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">password_hash</span>
<span class="go">&#39;$6$9ppc... (example crypted string....)&#39;</span></pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0.0rc1: </span>当使用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped_as_dataclass()</span></code>  或
<code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  时，不使用   :class:` .Mapped`  注释的字段可以被包含在内，这将被视为结果数据类的一部分，但不会被映射，无需也没有始终需要注释合法性的额外 <cite>__allow_unmapped__</cite> 类属性。以前的2.0 beta版本将要求显式存在该属性，即使该属性的目的仅是允许旧版ORM类型映射继续运行。</p>
</div>
</section>
<section id="pydantic">
<span id="dataclasses-pydantic"></span><h3>与Pydantic等替代数据类提供程序集成<a class="headerlink" href="#pydantic" title="Permalink to this heading">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Pydantic 1.x版本的数据类层不完全兼容于SQLAlchemy的类仪器化，许多特性，如相关集合可能不正确地工作。</p>
<p>为了与Pydantic兼容，请考虑使用基于SQLAlchemy ORM构建的使用Pydantic的 <a class="reference external" href="https://sqlmodel.tiangolo.com">SQLModel</a> ORM，其中包括特定实现细节，这些细节 <strong>显式解决了</strong> 这些不兼容性。</p>
</div>
<p>SQLAlchemy的   <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  类 和  :meth:` _orm.registry.mapped_as_dataclass`  方法直接调用 Python标准库的 <cite>dataclasses.dataclass &lt;https://docs.python.org/3/library/dataclasses.html#dataclasses.dataclass&gt;`_类装饰器，在将类声明过程应用于类之后。可以使用 ``dataclass_callable`</cite> 参数直接为其他数据类提供程序换掉此函数调用，例如Pydantic，作为类关键字参数及作为  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped_as_dataclass()</span></code>  方法的参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">MappedAsDataclass</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span>
    <span class="n">MappedAsDataclass</span><span class="p">,</span>
    <span class="n">DeclarativeBase</span><span class="p">,</span>
    <span class="n">dataclass_callable</span><span class="o">=</span><span class="n">pydantic</span><span class="o">.</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述 <code class="docutils literal notranslate"><span class="pre">User</span></code> 类将被处理成一个dataclass，使用Pydantic的 <code class="docutils literal notranslate"><span class="pre">pydantic.dataclasses.dataclasses</span></code> 调用。这个过程适用于映射类以及直接扩展   <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  或直接应用到  :meth:` _orm.registry.mapped_as_dataclass`  的混合类。</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.4: </span>添加了   <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedAsDataclass</span></code>  和  :meth:` _orm.registry.mapped_as_dataclass`  的 <code class="docutils literal notranslate"><span class="pre">dataclass_callable</span></code> 类和方法参数，并调整了一些数据类的内部以适应更严格的数据类函数，例如 Pydantic 数据类函数。</p>
</div>
</section>
</section>
<section id="orm">
<span id="orm-declarative-dataclasses"></span><h2>将ORM映射应用于现有数据类（旧数据类用法）<a class="headerlink" href="#orm" title="Permalink to this heading">¶</a></h2>
<div class="admonition legacy">
<p class="admonition-title">Legacy Feature</p>
<p>这些方法不再适用于2.0系列的新特性   <a class="reference internal" href="#orm-declarative-native-dataclasses"><span class="std std-ref">声明数据类映射</span></a> 。这种新方法基于首次添加到版本1.4中的数据类支持，其在本节中介绍。</p>
</div>
<p>要将映射应用于数据类，不能直接使用 SQLAlchemy 的 “inline” 声明式指令;需要通过以下三种技术之一分配 ORM 指令：</p>
<ul class="simple">
<li><p>使用“自声明式表”；表格/列与映射被定义为分配给类的``__ table__`` 属性的   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  对象；关系是在 ` <cite>__mapper_args__`</cite> 字典内定义的.使用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped()</span></code>  装饰器将类映射.下面的示例显示了：   :ref:` orm_declarative_dataclasses_imperative_table` .</p></li>
<li><p>使用完全的“声明式”类型，如   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 、  :func:` _orm.relationship`  被添加到 <code class="docutils literal notranslate"><span class="pre">dataclasses.field()</span></code> 构造函数的 <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> 字典中，在声明式过程中进行消耗。再次使用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped()</span></code>  装饰器将映射类.请参考下面的示例解释：  :ref:` orm_declarative_dataclasses_declarative_table` .</p></li>
<li><p>非声明式映射可以使用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.map_imperatively()</span></code>  来应用到现有的数据类中，以完全相同的方式生成映射如   :ref:` orm_imperative_mapping`  中所述。这是   <a class="reference internal" href="#orm-imperative-dataclasses"><span class="std std-ref">使用命令式映射映射预先存在的 dataclasses</span></a>  中所示的。</p></li>
</ul>
<p>SQLAlchemy将映射应用于数据类的一般过程与普通类相同，但还包括SQLAlchemy检测到作为数据类声明过程的一部分的类级属性，并在运行时用通常的SQLAlchemy ORM映射属性替换它们，如dataclasses生成的 <code class="docutils literal notranslate"><span class="pre">__init</span> <span class="pre">__</span></code> 方法和 <code class="docutils literal notranslate"><span class="pre">__eq__()</span></code>, <code class="docutils literal notranslate"><span class="pre">__repr__()</span></code> 等方法将保持不变。</p>
<section id="orm-declarative-dataclasses-imperative-table">
<span id="id12"></span><h3>使用“自声明式表”​​映射现有数据类<a class="headerlink" href="#orm-declarative-dataclasses-imperative-table" title="Permalink to this heading">¶</a></h3>
<p>使用到   <a class="reference internal" href="declarative_tables.html#orm-imperative-table-configuration"><span class="std std-ref">具有 Imperative Table 的 Declarative （俗称混合 Declarative）</span></a>  的方式举例使用 ` <cite>&#64;dataclass`</cite>.显式地构造完整的  <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  对象，并将其分配给 ` <cite>__table__`</cite> 属性。使用以下数据类语法定义实例字段。其他   <a class="reference internal" href="internals.html#sqlalchemy.orm.MapperProperty" title="sqlalchemy.orm.MapperProperty"><code class="xref py py-class docutils literal notranslate"><span class="pre">MapperProperty</span></code></a>  的定义，例如   :func:` .relationship` ，将被放置在 <code class="docutils literal notranslate"><span class="pre">properties</span></code> 键下的   <a class="reference internal" href="declarative_config.html#orm-declarative-mapper-options"><span class="std std-ref">__mapper_args__</span></a>  类级字典中，对应于  :paramref:` _orm.Mapper.properties`  参数的方式:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span><span class="p">,</span> <span class="n">relationship</span>

<span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@mapper_registry</span><span class="o">.</span><span class="n">mapped</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">mapper_registry</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nickname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">list</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># type: ignore</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;addresses&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="nd">@mapper_registry</span><span class="o">.</span><span class="n">mapped</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">:</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;address&quot;</span><span class="p">,</span>
        <span class="n">mapper_registry</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;email_address&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>在上面的示例中，<code class="docutils literal notranslate"><span class="pre">User.id</span></code>、<code class="docutils literal notranslate"><span class="pre">Address.id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Address.user_id</span></code> 属性定义为 <code class="docutils literal notranslate"><span class="pre">field(init</span> <span class="pre">=</span> <span class="pre">False)</span></code>。这意味着这些参数不会被添加到 <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> 方法中，但是   <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  在进行 flush（从自动增量或其他默认值生成器中获取其值）时仍然可以将其设置。要允许它们明确在构造函数中指定，请改为将它们设置为默认值 ` <cite>None`</cite>。</p>
<p>对于   <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>  单独声明一个关系必须直接在  :paramref:` _orm.Mapper.properties`  字典中指定，该字典本身在 <code class="docutils literal notranslate"><span class="pre">__mapper_args__</span></code> 字典内指定，以便将其传递到   <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>  的构造函数。与此方法的替代方法相比，下面的方法更简洁，其中使用 ` <cite>metadata`</cite> 属性上的 SQLAlchemy 特定映射信息来指示   <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>  关联是使用以下方式：</p>
<blockquote>
<div><p>from __future__ import annotations</p>
<p>from dataclasses import dataclass, field
from typing import List</p>
<p>from sqlalchemy import Column, ForeignKey, Integer, String
from sqlalchemy.orm import registry, relationship</p>
<p>mapper_registry = registry()</p>
<p>&#64;mapper_registry.mapped
&#64;dataclass
class User:</p>
<blockquote>
<div><p>__tablename__ = “user”</p>
<p>__sa_dataclass_metadata_key__ = “sa”
id: int = field(init=False, metadata={“sa”: Column(Integer, primary_key=True)})
name: str = field(default=None, metadata={“sa”: Column(String(50))})
fullname: str = field(default=None, metadata={“sa”: Column(String(50))})
nickname: str = field(default=None, metadata={“sa”: Column(String(12))})</p>
</div></blockquote>
</div></blockquote>
<dl>
<dt>addresses: List[Address] = field(</dt><dd><blockquote>
<div><blockquote>
<div><p>default_factory=list, metadata={“sa”: relationship(“Address”)}</p>
</div></blockquote>
<p>)</p>
</div></blockquote>
<p>&#64;mapper_registry.mapped
&#64;dataclass
class Address:</p>
<blockquote>
<div><p>__tablename__ = “address”
__sa_dataclass_metadata_key__ = “sa”
id: int = field(init=False, metadata={“sa”: Column(Integer, primary_key=True)})
user_id: int = field(init=False, metadata={“sa”: Column(ForeignKey(“user.id”))})
email_address: str = field(default=None, metadata={“sa”: Column(String(50))})</p>
</div></blockquote>
</dd>
</dl>
<section id="mixins-dataclasses">
<span id="orm-declarative-dataclasses-mixin"></span><h4>使用声明性 mixins 与预先存在的 dataclasses<a class="headerlink" href="#mixins-dataclasses" title="Permalink to this heading">¶</a></h4>
<p>在   <span class="xref std std-ref">orm_mixins_toplevel</span>  章节中，我们介绍了声明性 Mixin 类。
声明性 mixins 的一种要求是某些难以复制的结构必须以可调用对象的方式给出，
使用   <code class="xref py py-class docutils literal notranslate"><span class="pre">declared_attr</span></code>  装饰器，例如   :ref:` orm_declarative_mixins_relationships`  中的示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RefTargetMixin</span><span class="p">:</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">target_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;target_id&quot;</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;target.id&quot;</span><span class="p">))</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">target</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Target&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>可以使用 lambda 表示 SQLAlchemy 构造函数，在 dataclasses 中的 <code class="docutils literal notranslate"><span class="pre">field()</span></code> 中支持使用
此形式。使用   <code class="xref py py-func docutils literal notranslate"><span class="pre">declared_attr()</span></code>  包含 lambda 是可选的。
如果我们要创建一个类似上面 <code class="docutils literal notranslate"><span class="pre">User</span></code> 类的类，其中 ORM 字段来自于一个自身就是 dataclass 的
mixin 的情况，形式将是：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">UserMixin</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">__sa_dataclass_metadata_key__</span> <span class="o">=</span> <span class="s2">&quot;sa&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sa&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)})</span>

    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">list</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sa&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)}</span>
    <span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AddressMixin</span><span class="p">:</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>
    <span class="n">__sa_dataclass_metadata_key__</span> <span class="o">=</span> <span class="s2">&quot;sa&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sa&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)})</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sa&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">))}</span>
    <span class="p">)</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sa&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))})</span>


<span class="nd">@mapper_registry</span><span class="o">.</span><span class="n">mapped</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">UserMixin</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="nd">@mapper_registry</span><span class="o">.</span><span class="n">mapped</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">AddressMixin</span><span class="p">):</span>
    <span class="k">pass</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.2: </span>Added support for “declared attr” style mixin attributes,
namely   <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>  constructs as well as   :class:` _schema.Column`
objects with foreign key declarations, to be used within “Dataclasses
with Declarative Table” style mappings.</p>
</div>
</section>
</section>
<section id="dataclasses">
<span id="orm-imperative-dataclasses"></span><h3>使用命令式映射映射预先存在的 dataclasses<a class="headerlink" href="#dataclasses" title="Permalink to this heading">¶</a></h3>
<dl class="simple">
<dt>正如之前所述，在使用 <code class="docutils literal notranslate"><span class="pre">&#64;dataclass</span></code> 装饰器将类设置为 dataclass 后，我们可以使用</dt><dd><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped()</span></code>   装饰器将 ORM 映射应用于该类。我们还可以使用
<code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.map_imperatively()</span></code>   方法将该类作为命令式映射来使用，</p>
</dd>
</dl>
<p>以便我们可以将所有   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  和   :class:` _orm.Mapper`  配置以命令式的方式传递给函数，
而不是在类本身上定义它们作为类变量:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nickname</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">list</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span>


<span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">address</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;address&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;email_address&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span>
    <span class="n">User</span><span class="p">,</span>
    <span class="n">user</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;addresses&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</section>
</section>
<section id="orm-attrs">
<span id="orm-declarative-attrs-imperative-table"></span><h2>将 ORM 映射应用于现有的 attrs 类<a class="headerlink" href="#orm-attrs" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="https://pypi.org/project/attrs/">attrs</a> 库是一个流行的第三方库，提供类似于 dataclasses 的功能，还提供了许多在普通 dataclass 中
无法找到的其他特性。</p>
<p>使用 <a class="reference external" href="https://pypi.org/project/attrs/">attrs</a> 扩充的类使用 <code class="docutils literal notranslate"><span class="pre">&#64;define</span></code> 装饰器。这个装饰器启动一个过程，扫描类寻找定义
类行为的属性，然后使用这些属性来生成方法、文档和注释。</p>
<p>SQLAlchemy ORM 支持使用声明性命令式数据类或命令式映射将 <a class="reference external" href="https://pypi.org/project/attrs/">attrs</a> 类映射。这两种样式的通用形式
完全等同于用于 dataclasses 的   <span class="xref std std-ref">orm_declarative_dataclasses_declarative_table</span>  和</p>
<blockquote>
<div><p><a class="reference internal" href="#orm-declarative-dataclasses-imperative-table"><span class="std std-ref">使用“自声明式表”​​映射现有数据类</span></a>  映射形式，其中 dataclass 或 attrs 中使用的内联属性指令未更改，</p>
</div></blockquote>
<p>并且在运行时应用了 SQLAlchemy 的面向表的工具。</p>
<p><a class="reference external" href="https://pypi.org/project/attrs/">attrs</a> 的默认 <code class="docutils literal notranslate"><span class="pre">&#64;define</span></code> 装饰器将带注释的类替换为一个基于 __slots__ 的新类，这是不受支持的。
使用旧样式注释 <code class="docutils literal notranslate"><span class="pre">&#64;attr.s</span></code> 或使用 <code class="docutils literal notranslate"><span class="pre">define(slots=False)</span></code>，此类将不被替换。此外，attrs 在装饰器运行后会删除其本身的类绑定属性，
以便 SQLAlchemy 的映射过程接管这些属性。<code class="docutils literal notranslate"><span class="pre">&#64;attr.s</span></code> 装饰器和 <code class="docutils literal notranslate"><span class="pre">&#64;define(slots=False)</span></code> 装饰器都与 SQLAlchemy 兼容。</p>
<section id="id13">
<h3>使用声明性“命令式表”<a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h3>
<p>在“声明性表命令式”样式中，使用声明性类内联声明   <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>  对象。类首先应用 ` <cite>&#64;define`</cite> 装饰器，
然后应用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped()</span></code>  装饰器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">attrs</span> <span class="kn">import</span> <span class="n">define</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@mapper_registry</span><span class="o">.</span><span class="n">mapped</span>
<span class="nd">@define</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">mapper_registry</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;FullName&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;fullname&quot;</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">nickname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]]</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># type: ignore</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;addresses&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="nd">@mapper_registry</span><span class="o">.</span><span class="n">mapped</span>
<span class="nd">@define</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">:</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;address&quot;</span><span class="p">,</span>
        <span class="n">mapper_registry</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;email_address&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>激活 attrs 的 <code class="docutils literal notranslate"><span class="pre">slots=True</span></code> 选项（在映射类上启用 <code class="docutils literal notranslate"><span class="pre">__slots__</span></code> ）
无法在没有完全实现替代属性工具（参见   <a class="reference internal" href="examples.html#examples-instrumentation"><span class="std std-ref">属性检查</span></a> ）的情况下与 SQLAlchemy 映射一起使用，
映射类通常依赖于对 <code class="docutils literal notranslate"><span class="pre">__dict__</span></code> 的直接访问以进行状态存储。出现此选项时行为是未定义的。</p>
</div>
</section>
<section id="attrs">
<h3>使用命令式映射映射 attrs<a class="headerlink" href="#attrs" title="Permalink to this heading">¶</a></h3>
<p>与 dataclasses 一样，我们也可以使用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.map_imperatively()</span></code>  将现有的 attrs 类定义为 ORM 映射：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">attrs</span> <span class="kn">import</span> <span class="n">define</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>


<span class="nd">@define</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">str</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">str</span>
    <span class="n">nickname</span><span class="p">:</span> <span class="n">str</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span>


<span class="nd">@define</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">int</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="n">int</span>
    <span class="n">email_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>


<span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">address</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;address&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;email_address&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span>
    <span class="n">User</span><span class="p">,</span>
    <span class="n">user</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;addresses&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述形式等价于之前使用“声明性命令式表”的示例。</p>
</section>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="declarative_mixins.html" title="previous chapter">使用 Mixin 构建映射层次结构</a>
        Next:
        <a href="mapped_sql_expr.html" title="next chapter">将SQL表达式映射为属性</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 18:58:54

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


