<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    事务和连接管理
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="使用Session" href="session.html" />
        <link rel="next" title="附加的持久化技术" href="persistence_techniques.html" />
        <link rel="prev" title="级联" href="cascades.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM映射类配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM查询指南</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">使用Session</a></span><ul>
<li><span class="link-container"><a class="reference external" href="session_basics.html">会话基础知识</a></span></li>
<li><span class="link-container"><a class="reference external" href="session_state_management.html">状态管理</a></span></li>
<li><span class="link-container"><a class="reference external" href="cascades.html">级联</a></span></li>
<li class="selected"><span class="link-container"><strong>事务和连接管理</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#unitofwork-transaction">管理事务</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#savepoint">使用保存点（SAVEPOINT）</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-session-vs-engine">会话级别与引擎级别的事务控制</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id4">逐步提交</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id5">开启事务</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id6">嵌套事务</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#session-explicit-begin">显式开启事务</a></span></li>
<li><span class="link-container"><a class="reference external" href="#session-twophase">启用两段提交</a></span></li>
<li><span class="link-container"><a class="reference external" href="#dbapi-autocommit">设置事务隔离级别 / DBAPI AUTOCOMMIT</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#session-sessionmaker">为 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 或 <code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 全局设置隔离级别</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id9">为多个绑定配置隔离级别</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id10">为单个事务设置隔离级别</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#id11">用事件跟踪事务状态</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#session-external-transaction">将会话加入外部事务中（例如用于测试套件）</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="persistence_techniques.html">附加的持久化技术</a></span></li>
<li><span class="link-container"><a class="reference external" href="contextual.html">上下文/线程本地会话</a></span></li>
<li><span class="link-container"><a class="reference external" href="session_events.html">使用事件跟踪查询、对象和会话更改</a></span></li>
<li><span class="link-container"><a class="reference external" href="session_api.html">会话API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="extending.html">事件和内部实现</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM Examples</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="cascades.html" title="previous chapter">级联</a></li>
                <li><b>Next:</b>
                <a href="persistence_techniques.html" title="next chapter">附加的持久化技术</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="session.html" title="使用Session">使用Session</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#id1">事务和连接管理</a><ul>
<li><a class="reference internal" href="#unitofwork-transaction">管理事务</a><ul>
<li><a class="reference internal" href="#savepoint">使用保存点（SAVEPOINT）</a></li>
<li><a class="reference internal" href="#orm-session-vs-engine">会话级别与引擎级别的事务控制</a><ul>
<li><a class="reference internal" href="#id4">逐步提交</a></li>
<li><a class="reference internal" href="#id5">开启事务</a></li>
<li><a class="reference internal" href="#id6">嵌套事务</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-explicit-begin">显式开启事务</a></li>
<li><a class="reference internal" href="#session-twophase">启用两段提交</a></li>
<li><a class="reference internal" href="#dbapi-autocommit">设置事务隔离级别 / DBAPI AUTOCOMMIT</a><ul>
<li><a class="reference internal" href="#session-sessionmaker">为 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 或 <code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 全局设置隔离级别</a></li>
<li><a class="reference internal" href="#id9">为多个绑定配置隔离级别</a></li>
<li><a class="reference internal" href="#id10">为单个事务设置隔离级别</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">用事件跟踪事务状态</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-external-transaction">将会话加入外部事务中（例如用于测试套件）</a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-session_transaction" >
        
<section id="id1">
<h1>事务和连接管理<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h1>
<section id="unitofwork-transaction">
<span id="id2"></span><h2>管理事务<a class="headerlink" href="#unitofwork-transaction" title="Permalink to this heading">¶</a></h2>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.4: </span>会话事务管理已经更新以更清晰和更易于使用。 特别是现在拥有“自动开始”操作，这意味着可以控制事务开始的时间，而无需使用传统的“自动提交”模式。</p>
</div>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 在一个时间内跟踪单个“虚拟”事务的状态，使用一个称为 <code class="xref py py-class docutils literal notranslate"><span class="pre">SessionTransaction</span></code> 的对象。 然后，此对象利用了给定 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 绑定的底层 <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code> 或者 Engines，以使用需要的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 对象启动真实的连接级别事务。</p>
<p>这个“虚拟”事务会在需要时自动创建，或者可以使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin()</span></code> 方法启动。 尽可能地，Python上下文管理器的使用在创建 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 对象的级别以及维护: class:<cite>_orm.SessionTransaction</cite> 的范围级别上都得到了支持。</p>
<p>在以下示例中，假设我们从一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 开始：</p>
<blockquote>
<div><p>from sqlalchemy.orm import Session</p>
<p>session = Session(engine)</p>
</div></blockquote>
<p>现在，我们可以使用上下文管理器在标有事务的情况下运行操作：</p>
<blockquote>
<div><dl class="simple">
<dt>with session.begin():</dt><dd><p>session.add(some_object())
session.add(some_other_object())</p>
</dd>
</dl>
<p># 在结束时提交事务，或者如果发生异常回滚</p>
</div></blockquote>
<p>在上下文结束时，假设未引发任何异常，任何未决的对象将被刷新到数据库中，并且数据库事务将被提交。 如果上面的块中引发了异常，则会回滚事务。 在两种情况下，在退出上面的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 后，其后续将准备好用于接续的交易。</p>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin()</span></code> 方法是可选的，同时 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 也可以以一种逐步提交的方法进行使用，在需要时会自动开始这些操作；这些操作只需要提交或者进行回滚即可:</p>
<blockquote>
<div><p>session = Session(engine)</p>
<p>session.add(some_object())
session.add(some_other_object())</p>
<p>session.commit()  # 提交</p>
<p># 将自动再次开始
result = session.execute(“&lt;some select statement&gt;”)
session.add_all([more_objects, …])
session.commit()  # 提交</p>
<p>session.add(still_another_object)
session.flush()  # 刷新 still_another_object
session.rollback()  # 回滚 still_another_object</p>
</div></blockquote>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 本身具有一个 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.close()</span></code> 方法。 如果 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 是在尚未提交或回滚的事务中开始的，此方法将取消该事务（即回滚），并且会使包含在 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 对象状态中的所有对象都被 expunge。 如果 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 在一个不保证进行 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code> 或 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.rollback()</span></code> 的方式下使用（即不在上下文管理器或类似机制中），则可以使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">close</span></code> 方法确保释放所有资源：</p>
<blockquote>
<div><p># 删除所有对象并无条件的释放所有事务（包括回滚），将所有数据库连接返回到其 Engines 中
session.close()</p>
</div></blockquote>
<p>最后，会话构造 / 关闭过程本身也可以通过上下文管理器运行。 这是确保 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 对象的使用范围在一个固定块内的最佳方式。 首先通过 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 构造函数进行说明：</p>
<blockquote>
<div><dl>
<dt>with Session(engine) as session:</dt><dd><p>session.add(some_object())
session.add(some_other_object())</p>
<p>session.commit()  # 提交</p>
<p>session.add(still_another_object)
session.flush()  # 刷新 still_another_object</p>
<p>session.commit()  # 提交</p>
<p>result = session.execute(“&lt;some SELECT statement&gt;”)</p>
</dd>
</dl>
<p># .execute() 调用的事务状态已经消除</p>
</div></blockquote>
<p>同样，<code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 也可以以同样的方式使用：</p>
<blockquote>
<div><p>Session = sessionmaker(engine)</p>
<dl>
<dt>with Session() as session:</dt><dd><dl class="simple">
<dt>with session.begin():</dt><dd><p>session.add(some_object)</p>
</dd>
</dl>
<p># 提交</p>
</dd>
</dl>
<p># 关闭 Session</p>
</div></blockquote>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 本身包括 <code class="xref py py-meth docutils literal notranslate"><span class="pre">sessionmaker.begin()</span></code> 方法，允许两个操作同时执行：</p>
<blockquote>
<div><dl class="simple">
<dt>with Session.begin() as session:</dt><dd><p>session.add(some_object)</p>
</dd>
</dl>
</div></blockquote>
<section id="savepoint">
<span id="session-begin-nested"></span><h3>使用保存点（SAVEPOINT）<a class="headerlink" href="#savepoint" title="Permalink to this heading">¶</a></h3>
<p>如果支持底层引擎的 SAVEPOINT 事务，则可以使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin_nested()</span></code> 方法突出显示此类事务:</p>
<blockquote>
<div><p>Session = sessionmaker()</p>
<dl>
<dt>with Session.begin() as session:</dt><dd><p>session.add(u1)
session.add(u2)</p>
<p>nested = session.begin_nested()  # 建立保存点
session.add(u3)
nested.rollback()  # 回滚 u3，保留 u1 和 u2</p>
</dd>
</dl>
<p># 提交 u1 和 u2</p>
</div></blockquote>
<p>每次调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin_nested()</span></code> 时，一个新的“BEGIN SAVEPOINT”命令会在当前数据库事务的范围内发出（如果尚未开始，则会启动一个），并且将返回一个类型为 <code class="xref py py-class docutils literal notranslate"><span class="pre">SessionTransaction</span></code> 的对象，它表示对此 SAVEPOINT 的句柄。 当调用此对象的 <code class="docutils literal notranslate"><span class="pre">.commit()</span></code> 方法时，将向数据库发送 “RELEASE SAVEPOINT”，如果调用 <code class="docutils literal notranslate"><span class="pre">.rollback()</span></code> 方法，将发送 “ROLLBACK TO SAVEPOINT”。 父数据库事务仍然处于进行中。</p>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin_nested()</span></code> 通常用作上下文管理器，特别是当可以捕获特定于每个实例的错误时，需要与这些错误对应的回滚，而无需回滚整个事务，例如下面的示例：</p>
<blockquote>
<div><dl class="simple">
<dt>for record in records:</dt><dd><dl class="simple">
<dt>try:</dt><dd><dl class="simple">
<dt>with session.begin_nested():</dt><dd><p>session.merge(record)</p>
</dd>
</dl>
</dd>
<dt>except:</dt><dd><p>print(f”Skipped record {record}”)</p>
</dd>
</dl>
</dd>
</dl>
<p>session.commit()</p>
</div></blockquote>
<p>当由 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin_nested()</span></code> 发起的 SAVEPOINT 被回滚时，会过期在 SAVEPOINT 范围内被修改的内存中的对象状态，而未在 SAVEPOINT 开始时被更改的其他对象状态保持不变。 这是为了使后续操作可以继续使用
不影响的数据，而无需从数据库中刷新数据。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.begin_nested()</span></code> - 核心 SAVEPOINT API</p>
</div>
</section>
<section id="orm-session-vs-engine">
<span id="id3"></span><h3>会话级别与引擎级别的事务控制<a class="headerlink" href="#orm-session-vs-engine" title="Permalink to this heading">¶</a></h3>
<p>核心的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 和 ORM 的 <code class="xref py py-class docutils literal notranslate"><span class="pre">_session.Session</span></code> 具有等效的事务语义，在 <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code> 和 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 级别以及 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 和 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 级别。 以下几节详细讨论了这些方案，这是基于以下方案：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ORM                                           Core
-----------------------------------------     -----------------------------------
sessionmaker                                  Engine
Session                                       Connection
sessionmaker.begin()                          Engine.begin()
some_session.commit()                         some_connection.commit()
with some_sessionmaker() as session:          with some_engine.connect() as conn:
with some_sessionmaker.begin() as session:    with some_engine.begin() as conn:
with some_session.begin_nested() as sp:       with some_connection.begin_nested() as sp:</pre></div>
</div>
<section id="id4">
<h4>逐步提交<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 和 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 均具有 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.commit()</span></code> 和 <code class="xref py py-meth docutils literal notranslate"><span class="pre">0样式的操作使用这些方法将在所有情况下影响**最外层**事务。</span> <span class="pre">对于</span> <span class="pre">:class:`_orm.Session()</span></code>，假定 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.autobegin</span></code> 保持默认值 <code class="docutils literal notranslate"><span class="pre">True</span></code>。</p>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@host/dbname&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
        <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data one&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data two&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data three&quot;</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data one&quot;</span><span class="p">),</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data two&quot;</span><span class="p">),</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data three&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
</section>
<section id="id5">
<h4>开启事务<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 和 <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code> 均具有 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Engine.begin()</span></code> 方法，它将获得足以执行 SQL 语句的新对象（<code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 和 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code>，分别）然后返回极维持 begin / commit / rollback 上下文管理器的句柄。</p>
<p>Engine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@host/dbname&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
        <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data one&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data two&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data three&quot;</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">)</span>
<span class="c1"># 自动提交并关闭</span></pre></div>
</div>
<p>Session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Session</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data one&quot;</span><span class="p">),</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data two&quot;</span><span class="p">),</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data three&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="c1"># 自动提交并关闭</span></pre></div>
</div>
</section>
<section id="id6">
<h4>嵌套事务<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<p>当使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin_nested()</span></code> 或 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.begin_nested()</span></code> 方法时，返回的事务对象必须用于提交或回滚 SAVEPOINT。调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code> 或 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.commit()</span></code> 方法将始终提交**最外层**事务；这是从 1.x 系列中反转的 SQLAlchemy 2.0 特定行为。</p>
<p>Engine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@host/dbname&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">savepoint</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
        <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data one&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data two&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;some data three&quot;</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">savepoint</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># 或回滚</span>

<span class="c1"># 自动提交</span></pre></div>
</div>
<p>Session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Session</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">savepoint</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data one&quot;</span><span class="p">),</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data two&quot;</span><span class="p">),</span>
            <span class="n">SomeClass</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data three&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">savepoint</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># 或回滚</span>
<span class="c1"># 自动提交</span></pre></div>
</div>
</section>
</section>
<section id="session-explicit-begin">
<span id="id7"></span><h3>显式开启事务<a class="headerlink" href="#session-explicit-begin" title="Permalink to this heading">¶</a></h3>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 具有“autobegin”行为，这意味着只要操作开始，它就会确保存在 <code class="xref py py-class docutils literal notranslate"><span class="pre">SessionTransaction</span></code> 以跟踪正在进行的操作。 当调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code> 时，此事务将完成。</p>
<p>通常，特别是在框架集成中，控制“开始”操作发生的时间很有用。 为此，<code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 使用“autobegin”策略，这样 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin()</span></code> 方法就可以在尚未开始事务的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 上直接调用：</p>
<blockquote>
<div><p>Session = sessionmaker(bind=engine)
session = Session()
session.begin()
try:</p>
<blockquote>
<div><p>item1 = session.get(Item, 1)
item2 = session.get(Item, 2)
item1.foo = “bar”
item2.bar = “foo”
session.commit()</p>
</div></blockquote>
<dl class="simple">
<dt>except:</dt><dd><p>session.rollback()
raise</p>
</dd>
</dl>
</div></blockquote>
<p>上面的模式更常规地使用上下文管理器：</p>
<blockquote>
<div><p>Session = sessionmaker(bind=engine)
session = Session()
with session.begin():</p>
<blockquote>
<div><p>item1 = session.get(Item, 1)
item2 = session.get(Item, 2)
item1.foo = “bar”
item2.bar = “foo”</p>
</div></blockquote>
</div></blockquote>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin()</span></code> 方法和会话的“autobegin”进程使用相同的步骤开始事务。 这包括调用 <a class="reference internal" href="events.html#sqlalchemy.orm.SessionEvents.after_transaction_create" title="sqlalchemy.orm.SessionEvents.after_transaction_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.after_transaction_create()</span></code></a> 事件，通常此钩子用于将其自己的事务处理集成到 ORM <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 中。</p>
</section>
<section id="session-twophase">
<span id="id8"></span><h3>启用两段提交<a class="headerlink" href="#session-twophase" title="Permalink to this heading">¶</a></h3>
<p>对于支持两段操作（目前为止是 MySQL 和 PostgreSQL）的后端，可以指示会话使用两段提交语义。 这将协调在数据库中对事务的提交，以便在所有数据库中提交或回滚事务。 您还可以通过 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.prepare()</span></code> 以准备与由 SQLAlchemy 不管理的事务进行交互。 要使用两段提交，请在会话中设置标志 <code class="docutils literal notranslate"><span class="pre">twophase=True</span></code>：</p>
<blockquote>
<div><p>engine1 = create_engine(“postgresql+psycopg2://db1”)
engine2 = create_engine(“postgresql+psycopg2://db2”)</p>
<p>Session = sessionmaker(twophase=True)</p>
<p># 将用户操作绑定到 engine 1，将帐户操作绑定到 engine 2
Session.configure(binds={User: engine1, Account: engine2})</p>
<p>session = Session()</p>
<p># …. 与账户和用户一起操作</p>
<p># 提交。 会话将对所有数据库执行 flush 和 prepare 步骤，然后提交两个事务
session.commit()</p>
</div></blockquote>
</section>
<section id="dbapi-autocommit">
<span id="session-transaction-isolation"></span><h3>设置事务隔离级别 / DBAPI AUTOCOMMIT<a class="headerlink" href="#dbapi-autocommit" title="Permalink to this heading">¶</a></h3>
<p>大多数 DBAPI 都支持可配置的事务 :term:` 隔离` 级别。 通常为四个级别“READ UNCOMMITTED”、“READ COMMITTED”、“REPEATABLE READ”和“SERIALIZABLE”。 这些通常在 DBAPI 连接开始新事务之前应用。请注意，大多数 DBAPI 都会自动开始此事务并发出“BEGIN”。</p>
<p>支持隔离级别的 DBAPI 通常还支持真正的“autocommit”，这意味着 DBAPI 连接本身将处于非事务自动提交模式。 这通常意味着不会出现自动向数据库发出“BEGIN”的典型 DBAPI 行为，但它也可能包括其他指令。在使用此模式时，<strong>DBAPI 不会在任何情况下使用事务</strong>。 SQLAlchemy 方法如 <code class="docutils literal notranslate"><span class="pre">.begin()</span></code>, <code class="docutils literal notranslate"><span class="pre">.commit()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">.rollback()</span></code> 自动通过。</p>
<p>SQLAlchemy 的方言支持按 <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code> 或 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 的基础设置可选的隔离模式，这些选项可以在 <code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code> 级别以及 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execution_options()</span></code> 级别使用。</p>
<p>当使用 ORM <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 时，它充当 engines 和 connections 的 <em>接口</em>，但不直接公开事务隔离级别。 因此，要影响事务隔离级别，我们需要在 <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code> 或 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 上进行操作。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/connections.html#dbapi-autocommit"><span class="std std-ref">设置交易隔离级别，包括DBAPI Autocommit</span></a> - 确保查看 SQLAlchemy <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 对象级别的隔离级别如何工作。</p>
</div>
<section id="session-sessionmaker">
<span id="session-transaction-isolation-enginewide"></span><h4>为 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 或 <code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 全局设置隔离级别<a class="headerlink" href="#session-sessionmaker" title="Permalink to this heading">¶</a></h4>
<p>为了使 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 或 <code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 全局设置特定的隔离级别，第一种技术是可以在所有情况下针对特定的隔离级别建立 <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code>，然后将其用作 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 和 / 或 <code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 的连接资源：</p>
<blockquote>
<div><p>from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker</p>
<dl class="simple">
<dt>eng = create_engine(</dt><dd><p>“postgresql+psycopg2://scott:tiger&#64;localhost/test”,
isolation_level=”REPEATABLE READ”,</p>
</dd>
</dl>
<p>)</p>
<p>Session = sessionmaker(eng)</p>
</div></blockquote>
<p>另一个选项，如果有两个引擎具有不同的隔离级别，则是使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Engine.execution_options()</span></code> 方法，该方法将生成原始 <code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code> 的浅拷贝，它与父引擎共享相同的连接池。当将操作分为“事务性”和“自动提交”操作时，这通常更可取：</p>
<blockquote>
<div><p>from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker</p>
<p>eng = create_engine(“postgresql+psycopg2://scott:tiger&#64;localhost/test”)</p>
<p>autocommit_engine = eng.execution_options(isolation_level=”AUTOCOMMIT”)</p>
<p>transactional_session = sessionmaker(eng)
autocommit_session = sessionmaker(autocommit_engine)</p>
</div></blockquote>
<p>上面，“eng”和``autocommit_engine`` 具有相同的 dialect 和连接池。但是，当从 <code class="docutils literal notranslate"><span class="pre">autocommit_engine</span></code> 获取连接时，“AUTOCOMMIT”模式将被设置为连接将被放置在非事务式自动提交模式下。这通常意味着不再发生自动发出“BEGIN”的典型 DBAPI 行为，但是它可能包括其他指令。此时，<strong>“自动提交”模式下的 Session 仍具有事务语义</strong>，其中包括 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code> 和 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.rollback()</span></code> 仍将认为它们在“提交”和“回滚”对象，然后事务将悄悄消失。因此，<strong>通常建议在只读模式下使用隔离级别为 AUTOCOMMIT 的会话</strong>，如下例所示：</p>
<blockquote>
<div><dl class="simple">
<dt>with autocommit_session() as session:</dt><dd><p>some_objects = session.execute(“&lt;statement&gt;”)
some_other_objects = session.execute(“&lt;statement&gt;”)</p>
</dd>
</dl>
<p># 关闭连接</p>
</div></blockquote>
</section>
<section id="id9">
<h4>为多个绑定配置隔离级别<a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h4>
<p>对于 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 或 <code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 配置了多个 “binds” 的情况，可以重新完全指定 “binds” 参数，或者如果想仅替换单个 “binds”，则可以使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bind_mapper()</span></code> 或 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bind_table()</span></code> 方法：</p>
<blockquote>
<div><dl class="simple">
<dt>with Session() as session:</dt><dd><p>session.bind_mapper(User, autocommit_engine)</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="id10">
<h4>为单个事务设置隔离级别<a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h4>
<p>关于隔离级别的一个关键警告是，在已经开始事务的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 上安全修改该设置是不可能的。数据库不能更改正在进行事务的隔离级别，并且一些 DBAPI 及 SQLAlchemy 方言在这个问题上具有不一致的行为。</p>
<p>因此，最好使用始终与所需隔离级别一起绑定的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>。 但是，可以通过在事务开始之前使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.connection()</span></code> 方法影响每个连接上的每个事务的隔离级别：</p>
<blockquote>
<div><p>from sqlalchemy.orm import Session</p>
<p># 假定刚刚构造了会话
sess = Session(bind=engine)</p>
<p># 在其他任何操作之前，使用选项调用 connection()。
# 这将从绑定的 engine 中亲自摆脱新的连接并开始真实的数据库事务。
sess.connection(execution_options={“isolation_level”: “SERIALIZABLE”})</p>
<p># 在 SERIALIZABLE 隔离级别下操作会话 …</p>
<p># 提交事务。连接被释放，
# 然后重新设置为其之前的隔离级别。
sess.commit()</p>
<p># 在上面的提交（）之后，如果需要，可以开始新的事务，
# 除非再次设置了此隔离级别，否则将使用先前的默认隔离级别。</p>
</div></blockquote>
<p>以上，我们首先使用构造函数或 <code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code> 创建了 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>。 然后，我们通过在调用数据库级别事务之前调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.connection()</span></code> 来显式设置了数据库级别事务上的每个连接的隔离级别。使用此选择的事务会继续使用该选定隔离级别。 事务完成后，将重置隔离级别，以便将连接返回到连接池中之前。</p>
<p>可以使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin()</span></code> 方法启动 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 级别的事务；在调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.connection()</span></code> 之后，可以使用该方法来设置每个连接的事务隔离级别：</p>
<blockquote>
<div><p>sess = Session(bind=engine)</p>
<dl>
<dt>with sess.begin():</dt><dd><p># 在其他任何操作之前，使用 options 调用 connection()。
# 这将从绑定的 engine 中摆脱新的连接并开始真实的数据库事务。
sess.connection(execution_options={“isolation_level”: “SERIALIZABLE”})</p>
<p># 在 SERIALIZABLE 隔离级别下操作会话数据 …</p>
</dd>
</dl>
<p># 在块外，事务已提交。 连接被释放，
# 然后重新设置为其之前的隔离级别。</p>
</div></blockquote>
</section>
</section>
<section id="id11">
<h3>用事件跟踪事务状态<a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<p>有关会话事务状态更改可用的事件挂钩，请参见 <a class="reference internal" href="session_events.html#session-transaction-events"><span class="std std-ref">事务事件</span></a> 部分。</p>
</section>
</section>
<section id="session-external-transaction">
<span id="id12"></span><h2>将会话加入外部事务中（例如用于测试套件）<a class="headerlink" href="#session-external-transaction" title="Permalink to this heading">¶</a></h2>
<p>如果使用的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 已经处于事务状态（即已建立 <code class="xref py py-class docutils literal notranslate"><span class="pre">Transaction</span></code>），则可以通过将 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 绑定到该 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 上，使:class:<cite>.Session</cite> 参与该事务。 理解这种原理的通常逻辑是测试套件，允许 ORM 代码自由地使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>，包括调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code>，之后整个数据库交互被回滚。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0“加入外部事务”的配方再次得到优化（不需要事件处理程序来“重置”嵌套事务）。.</span></p>
</div>
<p>该配方通过建立处于事务状态（即具有 <code class="xref py py-class docutils literal notranslate"><span class="pre">Transaction</span></code>）的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code> 以及可能的 SAVEPOINT，然后将其作为 “bind” 传递给 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>，该参数为 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.join_transaction_mode</span></code> 传递了设置``”create_savepoint”<cite>，这意味着应创建新的 SAVEPOINT，以实现 :class:</cite>.Session` 中的 BEGIN/COMMIT/ROLLBACK，这将使外部事务保持与传递进来时相同的状态。</p>
<p>当测试代码撤销时，将回滚外部事务，以便将测试期间的所有数据更改全部恢复:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="c1"># 全局应用程序范围。创建 Session 类、engine</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://...&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SomeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 连接到数据库</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="c1"># 开始一个非 ORM 事务</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

        <span class="c1"># 将个别会话绑定到连接上，选择“create_savepoint”join_transaction_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span>
            <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">join_transaction_mode</span><span class="o">=</span><span class="s2">&quot;create_savepoint&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 使用会话进行测试。</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Foo</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_something_with_rollbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bar</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Foo</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># 回滚 - 将上面针对 Session 的所有内容（包括对 commit() 的调用）全部回滚。</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

        <span class="c1"># 将连接返回到 Engine。</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上述配方是 SQLAlchemy 自己使用的一部分，以确保其按预期工作。</p>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="cascades.html" title="previous chapter">级联</a>
        Next:
        <a href="persistence_techniques.html" title="next chapter">附加的持久化技术</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 9:31:19

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


