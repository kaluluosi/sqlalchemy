<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    集合自定义和API详细信息
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="关系配置" href="relationships.html" />
        <link rel="next" title="特殊关系的持久化模式" href="relationship_persistence.html" />
        <link rel="prev" title="操作大型集合" href="large_collections.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM映射类配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系配置</a></span><ul>
<li><span class="link-container"><a class="reference external" href="basic_relationships.html">基本关系模式</a></span></li>
<li><span class="link-container"><a class="reference external" href="self_referential.html">邻接列表关系</a></span></li>
<li><span class="link-container"><a class="reference external" href="join_conditions.html">配置关系联接</a></span></li>
<li><span class="link-container"><a class="reference external" href="large_collections.html">操作大型集合</a></span></li>
<li class="selected"><span class="link-container"><strong>集合自定义和API详细信息</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#custom-collections">定制集合访问</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-dictionary-collection">字典集合</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#key-collections-mutations">处理键值变化和记录反向关系字典</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm-custom-collection">自定义集合实现</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#dictionary-collections">自定义基于字典的集合</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id16">工具化和自定义类型</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#id17">集合 API</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.attribute_keyed_dict"><code class="docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.column_keyed_dict"><code class="docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.keyfunc_mapping"><code class="docutils literal notranslate"><span class="pre">keyfunc_mapping()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.attribute_mapped_collection"><code class="docutils literal notranslate"><span class="pre">attribute_mapped_collection</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.column_mapped_collection"><code class="docutils literal notranslate"><span class="pre">column_mapped_collection</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.mapped_collection"><code class="docutils literal notranslate"><span class="pre">mapped_collection</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.__init__"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.__init__()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.clear"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.clear()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.pop"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.pop()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.popitem"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.popitem()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.remove"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.remove()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.set"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.set()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.setdefault"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.setdefault()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.update"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.update()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.MappedCollection"><code class="docutils literal notranslate"><span class="pre">MappedCollection</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#id18">集合内部</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.bulk_replace"><code class="docutils literal notranslate"><span class="pre">bulk_replace()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">collection</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.adds"><code class="docutils literal notranslate"><span class="pre">collection.adds()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.appender"><code class="docutils literal notranslate"><span class="pre">collection.appender()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.converter"><code class="docutils literal notranslate"><span class="pre">collection.converter()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.internally_instrumented"><code class="docutils literal notranslate"><span class="pre">collection.internally_instrumented()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.iterator"><code class="docutils literal notranslate"><span class="pre">collection.iterator()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.remover"><code class="docutils literal notranslate"><span class="pre">collection.remover()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.removes"><code class="docutils literal notranslate"><span class="pre">collection.removes()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.removes_return"><code class="docutils literal notranslate"><span class="pre">collection.removes_return()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.replaces"><code class="docutils literal notranslate"><span class="pre">collection.replaces()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection_adapter"><code class="docutils literal notranslate"><span class="pre">collection_adapter</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.CollectionAdapter"><code class="docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.InstrumentedDict"><code class="docutils literal notranslate"><span class="pre">InstrumentedDict</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.InstrumentedList"><code class="docutils literal notranslate"><span class="pre">InstrumentedList</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.InstrumentedSet"><code class="docutils literal notranslate"><span class="pre">InstrumentedSet</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.prepare_instrumentation"><code class="docutils literal notranslate"><span class="pre">prepare_instrumentation()</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="relationship_persistence.html">特殊关系的持久化模式</a></span></li>
<li><span class="link-container"><a class="reference external" href="backref.html">使用传统的“backref”关系参数</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationship_api.html">关系API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM 查询指南</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">用 Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">事件和内部机制</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM 示例</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="large_collections.html" title="previous chapter">操作大型集合</a></li>
                <li><b>Next:</b>
                <a href="relationship_persistence.html" title="next chapter">特殊关系的持久化模式</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="relationships.html" title="关系配置">关系配置</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#api">集合自定义和API详细信息</a><ul>
<li><a class="reference internal" href="#custom-collections">定制集合访问</a><ul>
<li><a class="reference internal" href="#orm-dictionary-collection">字典集合</a><ul>
<li><a class="reference internal" href="#key-collections-mutations">处理键值变化和记录反向关系字典</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#orm-custom-collection">自定义集合实现</a><ul>
<li><a class="reference internal" href="#dictionary-collections">自定义基于字典的集合</a></li>
<li><a class="reference internal" href="#id16">工具化和自定义类型</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id17">集合 API</a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict"><code class="docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict"><code class="docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.keyfunc_mapping"><code class="docutils literal notranslate"><span class="pre">keyfunc_mapping()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.attribute_mapped_collection"><code class="docutils literal notranslate"><span class="pre">attribute_mapped_collection</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.column_mapped_collection"><code class="docutils literal notranslate"><span class="pre">column_mapped_collection</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.mapped_collection"><code class="docutils literal notranslate"><span class="pre">mapped_collection</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.__init__"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.__init__()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.clear"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.clear()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.pop"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.pop()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.popitem"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.popitem()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.remove"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.remove()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.set"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.set()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.setdefault"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.setdefault()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.update"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.update()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.orm.MappedCollection"><code class="docutils literal notranslate"><span class="pre">MappedCollection</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18">集合内部</a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.bulk_replace"><code class="docutils literal notranslate"><span class="pre">bulk_replace()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">collection</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.adds"><code class="docutils literal notranslate"><span class="pre">collection.adds()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.appender"><code class="docutils literal notranslate"><span class="pre">collection.appender()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.converter"><code class="docutils literal notranslate"><span class="pre">collection.converter()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.internally_instrumented"><code class="docutils literal notranslate"><span class="pre">collection.internally_instrumented()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.iterator"><code class="docutils literal notranslate"><span class="pre">collection.iterator()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.remover"><code class="docutils literal notranslate"><span class="pre">collection.remover()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes"><code class="docutils literal notranslate"><span class="pre">collection.removes()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes_return"><code class="docutils literal notranslate"><span class="pre">collection.removes_return()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.replaces"><code class="docutils literal notranslate"><span class="pre">collection.replaces()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection_adapter"><code class="docutils literal notranslate"><span class="pre">collection_adapter</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter"><code class="docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedDict"><code class="docutils literal notranslate"><span class="pre">InstrumentedDict</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedList"><code class="docutils literal notranslate"><span class="pre">InstrumentedList</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedSet"><code class="docutils literal notranslate"><span class="pre">InstrumentedSet</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.prepare_instrumentation"><code class="docutils literal notranslate"><span class="pre">prepare_instrumentation()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-collection_api" >
        
<section id="api">
<span id="custom-collections-toplevel"></span><h1>集合自定义和API详细信息<a class="headerlink" href="#api" title="Permalink to this heading">¶</a></h1>
<blockquote>
<div><p>:func:<a href="#id1"><span class="problematic" id="id2">`</span></a>_orm.relationship`函数定义了两个类之间的链接。当联系定义一个一对多或多对多的关系时，当对象被加载和操作时，它会被表示为Python集合。本节提供关于集合配置和技术的附加信息。</p>
</div></blockquote>
<section id="custom-collections">
<span id="id3"></span><h2>定制集合访问<a class="headerlink" href="#custom-collections" title="Permalink to this heading">¶</a></h2>
<p>将一个一对多或多对多的关系映射到一个父实例的属性上得到一个值的集合，可以通过这个属性进行访问。这两个基本的集合类型是列表和集合，在使用 <code class="docutils literal notranslate"><span class="pre">_orm.Mapped</span></code> 的   <a class="reference internal" href="declarative_styles.html"><span class="std std-ref">Declarative</span></a>  的映射方式中建立，如下面的 <code class="docutils literal notranslate"><span class="pre">Parent.children</span></code> 集合中将会使用 <code class="docutils literal notranslate"><span class="pre">list</span></code>：</p>
<blockquote>
<div><p>from sqlalchemy import ForeignKey</p>
<p>from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class Parent(Base):</dt><dd><p>__tablename__ = “parent”</p>
<p>parent_id: Mapped[int] = mapped_column(primary_key=True)</p>
<p># use a list
children: Mapped[List[“Child”]] = relationship()</p>
</dd>
<dt>class Child(Base):</dt><dd><p>__tablename__ = “child”</p>
<p>child_id: Mapped[int] = mapped_column(primary_key=True)
parent_id: Mapped[int] = mapped_column(ForeignKey(“parent.id”))</p>
</dd>
</dl>
</div></blockquote>
<p>或者在同一个 <code class="docutils literal notranslate"><span class="pre">Parent.children</span></code> 中使用集合：</p>
<blockquote>
<div><p>from typing import Set
from sqlalchemy import ForeignKey</p>
<p>from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class Parent(Base):</dt><dd><p>__tablename__ = “parent”</p>
<p>parent_id: Mapped[int] = mapped_column(primary_key=True)</p>
<p># use a set
children: Mapped[Set[“Child”]] = relationship()</p>
</dd>
<dt>class Child(Base):</dt><dd><p>__tablename__ = “child”</p>
<p>child_id: Mapped[int] = mapped_column(primary_key=True)
parent_id: Mapped[int] = mapped_column(ForeignKey(“parent.id”))</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果使用Python 3.7或3.8，则集合的注释需要使用“typing.List”或“typing.Set”，例如“Mapped[List[“Child”]]”或“Mapped[Set[“Child”]]”。这些Python版本的“list”和“set”Python内置程序尚不支持泛型注释。例如：</p>
<p>from typing import List</p>
<dl>
<dt>class Parent(Base):</dt><dd><p>__tablename__ = “parent”</p>
<p>parent_id: Mapped[int] = mapped_column(primary_key=True)</p>
<p># use a List, Python 3.8 and earlier
children: Mapped[List[“Child”]] = relationship()</p>
</dd>
</dl>
</div>
<p>在使用不带有   <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>  的映射方式时，比如在使用   <a class="reference internal" href="mapping_styles.html#orm-imperative-mapping"><span class="std std-ref">imperative mappings</span></a>  或未定义类型的 Python 代码中以及某些特殊情况下，可以通过  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.collection_class</span></code>  参数来直接指定   <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>  的集合类，如下例所示：</p>
<blockquote>
<div><p># non-annotated mapping</p>
<dl>
<dt>class Parent(Base):</dt><dd><p>__tablename__ = “parent”</p>
<p>parent_id = mapped_column(Integer, primary_key=True)</p>
<p>children = relationship(“Child”, collection_class=set)</p>
</dd>
<dt>class Child(Base):</dt><dd><p>__tablename__ = “child”</p>
<p>child_id = mapped_column(Integer, primary_key=True)
parent_id = mapped_column(ForeignKey(“parent.id”))</p>
</dd>
</dl>
</div></blockquote>
<p>在缺少  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.collection_class</span></code>  或   <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>  的情况下，缺省集合类型为 <code class="docutils literal notranslate"><span class="pre">list</span></code>。除了内建的 <code class="docutils literal notranslate"><span class="pre">list</span></code> 和 <code class="docutils literal notranslate"><span class="pre">set</span></code> 之外，还支持两个字典的变化，在   <a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a>  以下章节中有详细描述。任何任意可变序列类型都可以设置为目标集合，需要进行一些额外的配置操作，这将在   <a class="reference internal" href="#orm-custom-collection"><span class="std std-ref">自定义集合实现</span></a>  一节中进行描述。</p>
<section id="orm-dictionary-collection">
<span id="id4"></span><h3>字典集合<a class="headerlink" href="#orm-dictionary-collection" title="Permalink to this heading">¶</a></h3>
<p>使用字典作为集合需要一些额外的细节处理。这是因为对象总是作为列表从数据库中被加载，并且必须提供一种键生成策略，以便正确地填充字典。   <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a>  函数是实现简单字典集合的最常见方法。它会生成一个字典类，该类将某个映射类的特定属性作为键。下面我们映射了包含“Note”条目字典的“Item”类，这个字典键控制在“Note.keyword”属性中。当使用   <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a>  时，   <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>  可以使用   <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>  或普通的“dict”，如下面的示例所示。不过，在这种情况下，需要在配置时传入  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.collection_class</span></code>  参数，以便正确地指定   <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> ：</p>
<blockquote>
<div><p>from typing import Dict
from typing import Optional</p>
<p>from sqlalchemy import ForeignKey
from sqlalchemy.orm import attribute_keyed_dict
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class Item(Base):</dt><dd><p>__tablename__ = “item”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)</p>
<dl class="simple">
<dt>notes: Mapped[Dict[str, “Note”]] = relationship(</dt><dd><p>collection_class=attribute_keyed_dict(“keyword”),
cascade=”all, delete-orphan”,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>class Note(Base):</dt><dd><p>__tablename__ = “note”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)
item_id: Mapped[int] = mapped_column(ForeignKey(“item.id”))
keyword: Mapped[str]
text: Mapped[Optional[str]]</p>
<dl class="simple">
<dt>def __init__(self, keyword: str, text: str):</dt><dd><p>self.keyword = keyword
self.text = text</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Item.notes</span></code> 现在是一个字典：</p>
<blockquote>
<div><div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">item</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Note</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;atext&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">item</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="go">{&#39;a&#39;: &lt;__main__.Note object at 0x2eaaf0&gt;}</span></pre></div>
</div>
<p><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> <cite>Note`</cite> 的“keyword”属性都符合字典中的键。例如，当分配给 <code class="docutils literal notranslate"><span class="pre">Item.notes</span></code> 时，我们提供的字典键必须与实际``Note``对象的键匹配：</p>
<blockquote>
<div><p>item = Item()
item.notes = {</p>
<blockquote>
<div><p>“a”: Note(“a”, “atext”),
“b”: Note(“b”, “btext”),</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
</div></blockquote>
<p><em>attribute_keyed_dict</em> 使用的属性作为键不需要精确映射。使用一个常规的 Python <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> 就可以返回一个键，而不需要关系映射变量身负什么。例如下文，我们将属性映射为 tuple <code class="docutils literal notranslate"><span class="pre">Note.keyword</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Note.text</span></code> 字段的前十个字母，就是通过这个 tuple 值作为键：</p>
<blockquote>
<div><dl>
<dt>class Item(Base):</dt><dd><p>__tablename__ = “item”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)</p>
<dl class="simple">
<dt>notes: Mapped[Dict[str, “Note”]] = relationship(</dt><dd><p>collection_class=attribute_keyed_dict(“note_key”),
back_populates=”item”,
cascade=”all, delete-orphan”,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>class Note(Base):</dt><dd><p>__tablename__ = “note”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)
item_id: Mapped[int] = mapped_column(ForeignKey(“item.id”))
keyword: Mapped[str]
text: Mapped[str]</p>
<p>item: Mapped[“Item”] = relationship()</p>
<p>&#64;property
def note_key(self):</p>
<blockquote>
<div><p>return (self.keyword, self.text[0:10])</p>
</div></blockquote>
<dl class="simple">
<dt>def __init__(self, keyword: str, text: str):</dt><dd><p>self.keyword = keyword
self.text = text</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>以上添加了一个“Note.item”关系，具有双向性的  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.back_populates</span></code>  配置。在反向关系上进行分配，就将“Note”添加到“Item.notes”字典中，键将会自动生成：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;atext&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">item</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">item</span><span class="o">.</span><span class="n">notes</span>
<span class="go">{(&#39;a&#39;, &#39;atext&#39;): &lt;__main__.Note object at 0x2eaaf0&gt;}</span></pre></div>
</div>
<p>其它内建的字典类型包括   <a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a>  和   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_collection()</span></code> ，这是一种任意序列类型的扩展，在一些额外的配置步骤中可以设置为目标集合。这个在   <a class="reference internal" href="#orm-custom-collection"><span class="std std-ref">自定义集合实现</span></a>  中进行了说明。</p>
<section id="key-collections-mutations">
<span id="id5"></span><h4>处理键值变化和记录反向关系字典<a class="headerlink" href="#key-collections-mutations" title="Permalink to this heading">¶</a></h4>
<p>在使用   <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a>  时，字典的 “key” 是从目标对象的某个属性上提取的。<strong>不会跟踪更改此键的情况</strong>。这意味着，在第一次使用时必须分配键值，如果键值改变，集合将不会发生变化。一个常见的例子是在依赖于反向引用将属性映射集合中的值填充时。给定以下内容：</p>
<blockquote>
<div><dl>
<dt>class A(Base):</dt><dd><p>__tablename__ = “a”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)</p>
<dl class="simple">
<dt>bs: Mapped[Dict[str, “B”]] = relationship(</dt><dd><p>collection_class=attribute_keyed_dict(“data”),
back_populates=”a”,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>class B(Base):</dt><dd><p>__tablename__ = “b”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)
a_id: Mapped[int] = mapped_column(ForeignKey(“a.id”))
data: Mapped[str]</p>
<p>a: Mapped[“A”] = relationship(back_populates=”bs”)</p>
</dd>
</dl>
</div></blockquote>
<p>以上，如果我们创建了一个“B()”对象，它引用特定的“a()”，则反向引用将会将“B()”添加到“a.bs”集合中，但是如果“B.data”的值尚未设置，则键会为“None”：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>
<span class="go">{None: &lt;test3.B object at 0x7f7b1023ef70&gt;}</span></pre></div>
</div>
<p>在事后设置“b1.data”不会更新集合：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;the key&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>
<span class="go">{None: &lt;test3.B object at 0x7f7b1023ef70&gt;}</span></pre></div>
</div>
<p>如果在构造函数中也尝试设置“B()”，则会看到这一点。参数顺序的不同会导致不同的结果：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">B</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;the key&quot;</span><span class="p">)</span>
<span class="go">&lt;test3.B object at 0x7f7b10114280&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>
<span class="go">{None: &lt;test3.B object at 0x7f7b10114280&gt;}</span></pre></div>
</div>
<p>与</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">B</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;the key&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a1</span><span class="p">)</span>
<span class="go">&lt;test3.B object at 0x7f7b10114340&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>
<span class="go">{&#39;the key&#39;: &lt;test3.B object at 0x7f7b10114340&gt;}</span></pre></div>
</div>
<p>如果反向引用被用来这样填充属性, 确保使用带有“__init__”方法来正确地按照顺序填充属性。</p>
<p>例如下面的事件处理程序也可以用于跟踪集合的更改：</p>
<blockquote>
<div><p>from sqlalchemy import event
from sqlalchemy.orm import attributes</p>
<p>&#64;event.listens_for(B.data, “set”)
def set_item(obj, value, previous, initiator):</p>
<blockquote>
<div><dl class="simple">
<dt>if obj.a is not None:</dt><dd><p>previous = None if previous == attributes.NO_VALUE else previous
obj.a.bs[value] = obj
obj.a.bs.pop(previous)</p>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
</section>
</section>
</section>
<section id="orm-custom-collection">
<span id="id6"></span><h2>自定义集合实现<a class="headerlink" href="#orm-custom-collection" title="Permalink to this heading">¶</a></h2>
<p>您也可以使用自己的类型来进行集合的实现。对于简单情况来说，继承 <code class="docutils literal notranslate"><span class="pre">list</span></code> 或 <code class="docutils literal notranslate"><span class="pre">set</span></code>，添加定制行为即可。在其他情况下，则需要用特殊的装饰器告诉 SQLAlchemy 更多关于集合的操作方式。</p>
<aside class="topic">
<p class="topic-title">是否需要自定义集合实现？</p>
<p>在大多数情况下，不需要自定义集合实现。自定义集合的最常见用例是验证或转换传入的值，例如将字符串转换为类实例，或者表现出在某些方面内部的数据的不同形式，这些形式对外面呈现出了一个“视图”。</p>
<p>对于第一个用例，最简单的拦截所有情况的方法是使用   <a class="reference internal" href="mapped_attributes.html#id0" title="sqlalchemy.orm.validates"><code class="xref py py-func docutils literal notranslate"><span class="pre">validates()</span></code></a>  装饰器进行验证和简单转换。有关此内容的示例，请参阅   <a class="reference internal" href="mapped_attributes.html#simple-validators"><span class="std std-ref">简单的验证器</span></a> 。</p>
<p>对于第二个用例，   <span class="xref std std-ref">associationproxy_toplevel</span>  扩展是一种经过测试、广泛使用的系统，它提供了一个读/写的对一个集合的“视图”，包含一个目标对象的属性。因为目标对象属性可以是一个返回任何东西的 <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>，所以使用一些函数就可以构建集合的一系列“替代”视图。</p>
<p>这种方法使底层映射的集合不受影响，并避免了在需要逐个修改方法时仔细选择集合行为的需要。这些方法当然可以与以上两种方法相结合使用。</p>
</aside>
<p>集合在 SQLAlchemy 中是透明地进行了 <em>instrumentation*（工具化）。工具化意味着将集合的常规操作进行跟踪，操作正常情况下会在执行刷新时写入到数据库。此外，集合操作可能会触发 *事件</em>，这表明需要进行某些次要操作。这样的次要操作包括将子项保存在父   <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  中（例如，“save-update”级联），以及同步双向关系的状态（如   <code class="xref py py-func docutils literal notranslate"><span class="pre">backref()</span></code> ）。</p>
<p>集合包可以了解列表、集合和字典的基本接口，并自动应用到这些内置类型及其子类中。实现一个基本集合接口的对象派生类型通过 duck-typing 得到检测并进行工具化：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ListLike</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;foo&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">append</span></code>、<code class="docutils literal notranslate"><span class="pre">remove</span></code> 和 <code class="docutils literal notranslate"><span class="pre">extend</span></code> 是 <code class="docutils literal notranslate"><span class="pre">list</span></code> 的已知成员，并将被自动工具化。
<code class="docutils literal notranslate"><span class="pre">__iter__</span></code> 不是一个修改器方法，并且不会工具化。 <code class="docutils literal notranslate"><span class="pre">foo</span></code> 也不会被工具化。</p>
<p>自然推断（即猜测）并不是牢靠的，当您提供一个 <code class="docutils literal notranslate"><span class="pre">__emulates__</span></code> 类属性时，就可以为您实现的接口提供更明细的信息：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SetLike</span><span class="p">:</span>
    <span class="n">__emulates__</span> <span class="o">=</span> <span class="n">set</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>此类与 Python 的 <code class="docutils literal notranslate"><span class="pre">list</span></code> 类似（即 “list-like”），因为它有一个 <code class="docutils literal notranslate"><span class="pre">append</span></code> 方法，但是 <code class="docutils literal notranslate"><span class="pre">__emulates__</span></code> 属性强制将其视为 <code class="docutils literal notranslate"><span class="pre">set</span></code>。因为 <code class="docutils literal notranslate"><span class="pre">remove</span></code> 已知是 Set 接口的一部分，因此将自动工具化。 <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> 是默认方法，将用于移除和迭代。默认方法也可以更改：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">collection</span>


<span class="k">class</span> <span class="nc">MyList</span><span class="p">(</span><span class="n">list</span><span class="p">):</span>
    <span class="nd">@collection</span><span class="o">.</span><span class="n">remover</span>
    <span class="k">def</span> <span class="nf">zark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c1"># do something special...</span>
        <span class="o">...</span>

    <span class="nd">@collection</span><span class="o">.</span><span class="n">iterator</span>
    <span class="k">def</span> <span class="nf">hey_use_this_instead_for_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>并不需要完全类似于“列表”或“集合”，只要具有附加器、移除器和迭代器接口标记为 SQLAlchemy 使用即可。追加和移除方法将以映射实体作为唯一参数进行调用，而迭代方法将不带参数调用，并且必须返回一个迭代器。</p>
<section id="dictionary-collections">
<span id="id7"></span><h3>自定义基于字典的集合<a class="headerlink" href="#dictionary-collections" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><p><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>  类可以用作自定义类型的基类，也可以作为 mix-in，以便将 <code class="docutils literal notranslate"><span class="pre">dict</span></code> 集合支持快速添加到其他类中。它使用键函数来委托到 <code class="docutils literal notranslate"><span class="pre">__setitem__</span></code> 和 <code class="docutils literal notranslate"><span class="pre">__delitem__</span></code>：</p>
<blockquote>
<div><p>from sqlalchemy.orm.collections import KeyFuncDict</p>
<dl>
<dt>class MyNodeMap(KeyFuncDict):</dt><dd><p>“””Holds ‘Node’ objects, keyed by the ‘name’ attribute.”””</p>
<dl class="simple">
<dt>def __init__(self, <a href="#id8"><span class="problematic" id="id9">*</span></a>args, <a href="#id10"><span class="problematic" id="id11">**</span></a>kw):</dt><dd><p>super().__init__(keyfunc=lambda node: node.name)
dict.__init__(self, <a href="#id12"><span class="problematic" id="id13">*</span></a>args, <a href="#id14"><span class="problematic" id="id15">**</span></a>kw)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<p>当继承   <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>  时，需要使用装饰器  <a class="reference internal" href="#sqlalchemy.orm.collections.collection.internally_instrumented" title="sqlalchemy.orm.collections.collection.internally_instrumented"><code class="xref py py-meth docutils literal notranslate"><span class="pre">collection.internally_instrumented()</span></code></a>  标记用户定义的版本 of <code class="docutils literal notranslate"><span class="pre">__setitem__()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">__delitem__()</span></code>，<strong>如果</strong> 它们调用了这些已经在   <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>  上的方法。这是因为   <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>  上的方法已经被工具化了，如果在已经工具化的调用中再次调用它们可能会导致事件被重复触发或不适当地触发，导致在罕见情况下可能会发生内部状态损坏：</p>
<blockquote>
<div><p>from sqlalchemy.orm.collections import KeyFuncDict, collection</p>
<dl>
<dt>class MyKeyFuncDict(KeyFuncDict):</dt><dd><p>“””当你的方法从已经工具化的方法再次调用时，使用 &#64;internally_instrumented”””</p>
<p>&#64;collection.internally_instrumented
def __setitem__(self, key, value, _sa_initiator=None):</p>
<blockquote>
<div><p># do something with key, value
super(MyKeyFuncDict, self).__setitem__(key, value, _sa_initiator)</p>
</div></blockquote>
<p>&#64;collection.internally_instrumented
def __delitem__(self, key, _sa_initiator=None):</p>
<blockquote>
<div><p># do something with key
super(MyKeyFuncDict, self).__delitem__(key, _sa_initiator)</p>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<p>ORM 理解了 <code class="docutils literal notranslate"><span class="pre">dict</span></code> 接口时就像列表和集合一样，并且如果您选择继承 <code class="docutils literal notranslate"><span class="pre">dict</span></code> 或通过 duck-typed 类提供类似字典的集合行为，则会自动工具化所有”dict-like” 方法。但是必须装饰加入方法和删除方法。基本字典接口中没有兼容的方法供 SQLAlchemy 去使用。迭代将通过 <code class="docutils literal notranslate"><span class="pre">values()</span></code> 进行，除非另有装饰。</p>
</section>
<section id="id16">
<h3>工具化和自定义类型<a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h3>
<p>许多自定义类型和现有库类可以用作实体集合类型，因为它们已经有了基本集合接口。但是，重要的是要注意，工具化过程将修改类型，自动添加装饰器。这些装饰器是轻量级的，除了关系之外没有作用，但它们会在其他地方触发时增加不必要的开销。当使用库类作为集合时，使用“微不足道的子类”技巧是一个好习惯，将装饰器限制在关系的使用中。例如：</p>
<blockquote>
<div><dl class="simple">
<dt>class MyAwesomeList(some.great.library.AwesomeList):</dt><dd><p>pass</p>
</dd>
</dl>
<p># … relationship(…, collection_class=MyAwesomeList)</p>
</div></blockquote>
<p>ORM 使用这种方法来处理内置的集合，当直接使用 <code class="docutils literal notranslate"><span class="pre">list</span></code>、 <code class="docutils literal notranslate"><span class="pre">set</span></code> 或 <code class="docutils literal notranslate"><span class="pre">dict</span></code> 时，会悄替换为一个微不足道的子类。</p>
</section>
</section>
<section id="id17">
<h2>集合 API<a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h2>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict"><span class="sig-name descname">attribute_keyed_dict</span></a>(attr_name, *, [ignore_unpopulated_attribute])</p></td>
<td><p>A dictionary-based collection type with attribute-based keying.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.attribute_mapped_collection"><span class="sig-name descname">attribute_mapped_collection</span></a></p></td>
<td><p>A dictionary-based collection type with attribute-based keying.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict"><span class="sig-name descname">column_keyed_dict</span></a>(mapping_spec, *, [ignore_unpopulated_attribute])</p></td>
<td><p>A dictionary-based collection type with column-based keying.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.column_mapped_collection"><span class="sig-name descname">column_mapped_collection</span></a></p></td>
<td><p>A dictionary-based collection type with column-based keying.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.keyfunc_mapping"><span class="sig-name descname">keyfunc_mapping</span></a>(keyfunc, *, [ignore_unpopulated_attribute])</p></td>
<td><p>A dictionary-based collection type with arbitrary keying.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><span class="sig-name descname">KeyFuncDict</span></a></p></td>
<td><p>Base for ORM mapped dictionary classes.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.mapped_collection"><span class="sig-name descname">mapped_collection</span></a></p></td>
<td><p>A dictionary-based collection type with arbitrary keying.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.MappedCollection"><span class="sig-name descname">MappedCollection</span></a></p></td>
<td><p>Base for ORM mapped dictionary classes.</p></td>
</tr>
</tbody>
</table>
<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.attribute_keyed_dict">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">attribute_keyed_dict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">attr_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_unpopulated_attribute</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.mapped_collection.KeyFuncDict"><span class="pre">KeyFuncDict</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_KT</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.attribute_keyed_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with attribute-based keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.attribute_mapped_collection" title="sqlalchemy.orm.attribute_mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">attribute_mapped_collection</span></code></a> to
<a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory which will produce new
dictionary keys based on the value of a particular named attribute on
ORM mapped instances to be added to the dictionary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the value of the target attribute must be assigned with its
value at the time that the object is being added to the
dictionary collection.   Additionally, changes to the key attribute
are <strong>not tracked</strong>, which means the key in the dictionary is not
automatically synchronized with the key value on the target object
itself.  See <a class="reference internal" href="#key-collections-mutations"><span class="std std-ref">处理键值变化和记录反向关系字典</span></a> for further details.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.attribute_keyed_dict.params.attr_name"></span><strong>attr_name</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.attribute_keyed_dict.params.attr_name">¶</a> – string name of an ORM-mapped attribute
on the mapped class, the value of which on a particular instance
is to be used as the key for a new dictionary entry for that instance.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.attribute_keyed_dict.params.ignore_unpopulated_attribute"></span><strong>ignore_unpopulated_attribute</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.attribute_keyed_dict.params.ignore_unpopulated_attribute">¶</a> – <p>if True, and the target attribute
on an object is not populated at all, the operation will be silently
skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the attribute
being used for the dictionary key is determined that it was never
populated with any value.  The
<a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">attribute_keyed_dict.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped.
This is in contrast to the behavior of the 1.x series which would
erroneously populate the value in the dictionary with an arbitrary key
value of <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.column_keyed_dict">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">column_keyed_dict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mapping_spec</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_VT</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_unpopulated_attribute</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.mapped_collection.KeyFuncDict"><span class="pre">KeyFuncDict</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_KT</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.column_keyed_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with column-based keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.column_mapped_collection" title="sqlalchemy.orm.column_mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">column_mapped_collection</span></code></a> to
<code class="xref py py-class docutils literal notranslate"><span class="pre">column_keyed_dict</span></code>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory which will produce new
dictionary keys based on the value of a particular <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>-mapped
attribute on ORM mapped instances to be added to the dictionary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the value of the target attribute must be assigned with its
value at the time that the object is being added to the
dictionary collection.   Additionally, changes to the key attribute
are <strong>not tracked</strong>, which means the key in the dictionary is not
automatically synchronized with the key value on the target object
itself.  See <a class="reference internal" href="#key-collections-mutations"><span class="std std-ref">处理键值变化和记录反向关系字典</span></a> for further details.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.column_keyed_dict.params.mapping_spec"></span><strong>mapping_spec</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.column_keyed_dict.params.mapping_spec">¶</a> – a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object that is expected
to be mapped by the target mapper to a particular attribute on the
mapped class, the value of which on a particular instance is to be used
as the key for a new dictionary entry for that instance.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.column_keyed_dict.params.ignore_unpopulated_attribute"></span><strong>ignore_unpopulated_attribute</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.column_keyed_dict.params.ignore_unpopulated_attribute">¶</a> – <p>if True, and the mapped attribute
indicated by the given <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> target attribute
on an object is not populated at all, the operation will be silently
skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the attribute
being used for the dictionary key is determined that it was never
populated with any value.  The
<a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">column_keyed_dict.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped.
This is in contrast to the behavior of the 1.x series which would
erroneously populate the value in the dictionary with an arbitrary key
value of <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.keyfunc_mapping">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">keyfunc_mapping</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">keyfunc</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_F</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_unpopulated_attribute</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.mapped_collection.KeyFuncDict"><span class="pre">KeyFuncDict</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.keyfunc_mapping" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with arbitrary keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.mapped_collection" title="sqlalchemy.orm.mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">mapped_collection</span></code></a> to
<a class="reference internal" href="#sqlalchemy.orm.keyfunc_mapping" title="sqlalchemy.orm.keyfunc_mapping"><code class="xref py py-func docutils literal notranslate"><span class="pre">keyfunc_mapping()</span></code></a>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory with a keying function
generated from keyfunc, a callable that takes an entity and returns a
key value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the given keyfunc is called only once at the time that the
target object is being added to the collection.   Changes to the
effective value returned by the function are not tracked.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.keyfunc_mapping.params.keyfunc"></span><strong>keyfunc</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.keyfunc_mapping.params.keyfunc">¶</a> – a callable that will be passed the ORM-mapped instance
which should then generate a new key to use in the dictionary.
If the value returned is <a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a>, an error
is raised.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.keyfunc_mapping.params.ignore_unpopulated_attribute"></span><strong>ignore_unpopulated_attribute</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.keyfunc_mapping.params.ignore_unpopulated_attribute">¶</a> – <p>if True, and the callable returns
<a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a> for a particular instance, the
operation will be silently skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the callable
being used for the dictionary key returns
<a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a>, which in an ORM attribute
context indicates an attribute that was never populated with any value.
The <a class="reference internal" href="#sqlalchemy.orm.mapped_collection.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.mapped_collection"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_collection.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped. This is
in contrast to the behavior of the 1.x series which would erroneously
populate the value in the dictionary with an arbitrary key value of
<code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.attribute_mapped_collection">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">attribute_mapped_collection</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;function</span> <span class="pre">attribute_keyed_dict&gt;</span></em><a class="headerlink" href="#sqlalchemy.orm.attribute_mapped_collection" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with attribute-based keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.attribute_mapped_collection" title="sqlalchemy.orm.attribute_mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">attribute_mapped_collection</span></code></a> to
<a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory which will produce new
dictionary keys based on the value of a particular named attribute on
ORM mapped instances to be added to the dictionary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the value of the target attribute must be assigned with its
value at the time that the object is being added to the
dictionary collection.   Additionally, changes to the key attribute
are <strong>not tracked</strong>, which means the key in the dictionary is not
automatically synchronized with the key value on the target object
itself.  See <a class="reference internal" href="#key-collections-mutations"><span class="std std-ref">处理键值变化和记录反向关系字典</span></a> for further details.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>attr_name</strong> – string name of an ORM-mapped attribute
on the mapped class, the value of which on a particular instance
is to be used as the key for a new dictionary entry for that instance.</p></li>
<li><p><strong>ignore_unpopulated_attribute</strong> – <p>if True, and the target attribute
on an object is not populated at all, the operation will be silently
skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the attribute
being used for the dictionary key is determined that it was never
populated with any value.  The
<a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">attribute_keyed_dict.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped.
This is in contrast to the behavior of the 1.x series which would
erroneously populate the value in the dictionary with an arbitrary key
value of <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.column_mapped_collection">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">column_mapped_collection</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;function</span> <span class="pre">column_keyed_dict&gt;</span></em><a class="headerlink" href="#sqlalchemy.orm.column_mapped_collection" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with column-based keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.column_mapped_collection" title="sqlalchemy.orm.column_mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">column_mapped_collection</span></code></a> to
<code class="xref py py-class docutils literal notranslate"><span class="pre">column_keyed_dict</span></code>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory which will produce new
dictionary keys based on the value of a particular <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>-mapped
attribute on ORM mapped instances to be added to the dictionary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the value of the target attribute must be assigned with its
value at the time that the object is being added to the
dictionary collection.   Additionally, changes to the key attribute
are <strong>not tracked</strong>, which means the key in the dictionary is not
automatically synchronized with the key value on the target object
itself.  See <a class="reference internal" href="#key-collections-mutations"><span class="std std-ref">处理键值变化和记录反向关系字典</span></a> for further details.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mapping_spec</strong> – a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object that is expected
to be mapped by the target mapper to a particular attribute on the
mapped class, the value of which on a particular instance is to be used
as the key for a new dictionary entry for that instance.</p></li>
<li><p><strong>ignore_unpopulated_attribute</strong> – <p>if True, and the mapped attribute
indicated by the given <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> target attribute
on an object is not populated at all, the operation will be silently
skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the attribute
being used for the dictionary key is determined that it was never
populated with any value.  The
<a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">column_keyed_dict.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped.
This is in contrast to the behavior of the 1.x series which would
erroneously populate the value in the dictionary with an arbitrary key
value of <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.mapped_collection">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">mapped_collection</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;function</span> <span class="pre">keyfunc_mapping&gt;</span></em><a class="headerlink" href="#sqlalchemy.orm.mapped_collection" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with arbitrary keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.mapped_collection" title="sqlalchemy.orm.mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">mapped_collection</span></code></a> to
<a class="reference internal" href="#sqlalchemy.orm.keyfunc_mapping" title="sqlalchemy.orm.keyfunc_mapping"><code class="xref py py-func docutils literal notranslate"><span class="pre">keyfunc_mapping()</span></code></a>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory with a keying function
generated from keyfunc, a callable that takes an entity and returns a
key value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the given keyfunc is called only once at the time that the
target object is being added to the collection.   Changes to the
effective value returned by the function are not tracked.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>keyfunc</strong> – a callable that will be passed the ORM-mapped instance
which should then generate a new key to use in the dictionary.
If the value returned is <a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a>, an error
is raised.</p></li>
<li><p><strong>ignore_unpopulated_attribute</strong> – <p>if True, and the callable returns
<a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a> for a particular instance, the
operation will be silently skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the callable
being used for the dictionary key returns
<a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a>, which in an ORM attribute
context indicates an attribute that was never populated with any value.
The <a class="reference internal" href="#sqlalchemy.orm.mapped_collection.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.mapped_collection"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_collection.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped. This is
in contrast to the behavior of the 1.x series which would erroneously
populate the value in the dictionary with an arbitrary key value of
<code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">KeyFuncDict</span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict" title="Permalink to this definition">¶</a></dt>
<dd><p>Base for ORM mapped dictionary classes.</p>
<p>Extends the <code class="docutils literal notranslate"><span class="pre">dict</span></code> type with additional methods needed by SQLAlchemy ORM
collection classes. Use of <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> is most directly
by using the <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> or
<a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a> class factories.
<a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> may also serve as the base for user-defined
custom dictionary classes.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedCollection</span></code> to
<a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a></p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a></p>
<p><a class="reference internal" href="#orm-custom-collection"><span class="std std-ref">自定义集合实现</span></a></p>
</div>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.__init__"><span class="sig-name descname">__init__()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.clear"><span class="sig-name descname">clear()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.pop"><span class="sig-name descname">pop()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.popitem"><span class="sig-name descname">popitem()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.remove"><span class="sig-name descname">remove()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.set"><span class="sig-name descname">set()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.setdefault"><span class="sig-name descname">setdefault()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.update"><span class="sig-name descname">update()</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict</span></code></a> (<code class="docutils literal notranslate"><span class="pre">builtins.dict</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.__init__">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">keyfunc</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_F</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">dict_args</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_unpopulated_attribute</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a new collection with keying provided by keyfunc.</p>
<p>keyfunc may be any callable that takes an object and returns an object
for use as a dictionary key.</p>
<p>The keyfunc will be called every time the ORM needs to add a member by
value-only (such as when loading instances from the database) or
remove a member.  The usual cautions about dictionary keying apply-
<code class="docutils literal notranslate"><span class="pre">keyfunc(object)</span></code> should return the same output for the life of the
collection.  Keying based on mutable properties can result in
unreachable instances “lost” in the collection.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.clear">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">clear</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None.</span>&#160; <span class="pre">Remove</span> <span class="pre">all</span> <span class="pre">items</span> <span class="pre">from</span> <span class="pre">D.</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.clear" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.pop">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">pop</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">k</span></span></em><span class="optional">[</span>, <em class="sig-param"><span class="n"><span class="pre">d</span></span></em><span class="optional">]</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">v,</span> <span class="pre">remove</span> <span class="pre">specified</span> <span class="pre">key</span> <span class="pre">and</span> <span class="pre">return</span> <span class="pre">the</span> <span class="pre">corresponding</span> <span class="pre">value.</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.pop" title="Permalink to this definition">¶</a></dt>
<dd><p>If the key is not found, return the default if given; otherwise,
raise a KeyError.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.popitem">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">popitem</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.popitem" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove and return a (key, value) pair as a 2-tuple.</p>
<p>Pairs are returned in LIFO (last-in, first-out) order.
Raises KeyError if the dict is empty.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.remove">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_KT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_sa_initiator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.orm.AttributeEventToken" title="sqlalchemy.orm.AttributeEventToken"><span class="pre">AttributeEventToken</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Literal</span><span class="p"><span class="pre">[</span></span><span class="pre">None</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="k"><span class="pre">False</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.remove" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove an item by value, consulting the keyfunc for the key.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.set">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">set</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_KT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_sa_initiator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.orm.AttributeEventToken" title="sqlalchemy.orm.AttributeEventToken"><span class="pre">AttributeEventToken</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Literal</span><span class="p"><span class="pre">[</span></span><span class="pre">None</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="k"><span class="pre">False</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.set" title="Permalink to this definition">¶</a></dt>
<dd><p>Add an item by value, consulting the keyfunc for the key.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.setdefault">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">setdefault</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.setdefault" title="Permalink to this definition">¶</a></dt>
<dd><p>Insert key with a value of default if key is not in the dictionary.</p>
<p>Return the value for key if key is in the dictionary, else default.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.update">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">update</span></span><span class="sig-paren">(</span><span class="optional">[</span><em class="sig-param"><span class="n"><span class="pre">E</span></span></em>, <span class="optional">]</span><em class="sig-param"><span class="n"><span class="pre">**F</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None.</span>&#160; <span class="pre">Update</span> <span class="pre">D</span> <span class="pre">from</span> <span class="pre">dict/iterable</span> <span class="pre">E</span> <span class="pre">and</span> <span class="pre">F.</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.update" title="Permalink to this definition">¶</a></dt>
<dd><p>If E is present and has a .keys() method, then does:  for k in E: D[k] = E[k]
If E is present and lacks a .keys() method, then does:  for k, v in E: D[k] = v
In either case, this is followed by: for k in F:  D[k] = F[k]</p>
</dd></dl>

</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.MappedCollection">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">MappedCollection</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;class</span> <span class="pre">'sqlalchemy.orm.mapped_collection.KeyFuncDict'&gt;</span></em><a class="headerlink" href="#sqlalchemy.orm.MappedCollection" title="Permalink to this definition">¶</a></dt>
<dd><p>Base for ORM mapped dictionary classes.</p>
<p>Extends the <code class="docutils literal notranslate"><span class="pre">dict</span></code> type with additional methods needed by SQLAlchemy ORM
collection classes. Use of <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> is most directly
by using the <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> or
<a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a> class factories.
<a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> may also serve as the base for user-defined
custom dictionary classes.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedCollection</span></code> to
<a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a></p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合</span></a></p>
<p><a class="reference internal" href="#orm-custom-collection"><span class="std std-ref">自定义集合实现</span></a></p>
</div>
</dd></dl>

</section>
<section id="id18">
<h2>集合内部<a class="headerlink" href="#id18" title="Permalink to this heading">¶</a></h2>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.bulk_replace"><span class="sig-name descname">bulk_replace</span></a>(values, existing_adapter, new_adapter[, initiator])</p></td>
<td><p>Load a new collection, firing events based on prior like membership.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><span class="sig-name descname">collection</span></a></p></td>
<td><p>Decorators for entity collection classes.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.collection_adapter"><span class="sig-name descname">collection_adapter</span></a></p></td>
<td><p>attrgetter(attr, …) –&gt; attrgetter object</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter"><span class="sig-name descname">CollectionAdapter</span></a></p></td>
<td><p>Bridges between the ORM and arbitrary Python collections.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedDict"><span class="sig-name descname">InstrumentedDict</span></a></p></td>
<td><p>An instrumented version of the built-in dict.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedList"><span class="sig-name descname">InstrumentedList</span></a></p></td>
<td><p>An instrumented version of the built-in list.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedSet"><span class="sig-name descname">InstrumentedSet</span></a></p></td>
<td><p>An instrumented version of the built-in set.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.prepare_instrumentation"><span class="sig-name descname">prepare_instrumentation</span></a>(factory)</p></td>
<td><p>Prepare a callable for future use as a collection class factory.</p></td>
</tr>
</tbody>
</table>
<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.bulk_replace">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">bulk_replace</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">values</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">existing_adapter</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_adapter</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">initiator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.bulk_replace" title="Permalink to this definition">¶</a></dt>
<dd><p>Load a new collection, firing events based on prior like membership.</p>
<p>Appends instances in <code class="docutils literal notranslate"><span class="pre">values</span></code> onto the <code class="docutils literal notranslate"><span class="pre">new_adapter</span></code>. Events will be
fired for any instance not present in the <code class="docutils literal notranslate"><span class="pre">existing_adapter</span></code>.  Any
instances in <code class="docutils literal notranslate"><span class="pre">existing_adapter</span></code> not present in <code class="docutils literal notranslate"><span class="pre">values</span></code> will have
remove events fired upon them.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.collections.bulk_replace.params.values"></span><strong>values</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.collections.bulk_replace.params.values">¶</a> – An iterable of collection member instances</p></li>
<li><p><span class="target" id="sqlalchemy.orm.collections.bulk_replace.params.existing_adapter"></span><strong>existing_adapter</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.collections.bulk_replace.params.existing_adapter">¶</a> – A <a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter" title="sqlalchemy.orm.collections.CollectionAdapter"><code class="xref py py-class docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a> of
instances to be replaced</p></li>
<li><p><span class="target" id="sqlalchemy.orm.collections.bulk_replace.params.new_adapter"></span><strong>new_adapter</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.collections.bulk_replace.params.new_adapter">¶</a> – An empty <a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter" title="sqlalchemy.orm.collections.CollectionAdapter"><code class="xref py py-class docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a>
to load with <code class="docutils literal notranslate"><span class="pre">values</span></code></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">collection</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.collection" title="Permalink to this definition">¶</a></dt>
<dd><p>Decorators for entity collection classes.</p>
<p>The decorators fall into two groups: annotations and interception recipes.</p>
<p>The annotating decorators (appender, remover, iterator, converter,
internally_instrumented) indicate the method’s purpose and take no
arguments.  They are not written with parens:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">appender</span>
<span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>The recipe decorators all require parens, even those that take no
arguments:</p>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.orm.collections.collection.adds"><span class="sig-name descname">adds()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.appender"><span class="sig-name descname">appender()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.converter"><span class="sig-name descname">converter()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.internally_instrumented"><span class="sig-name descname">internally_instrumented()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.iterator"><span class="sig-name descname">iterator()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.remover"><span class="sig-name descname">remover()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes"><span class="sig-name descname">removes()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes_return"><span class="sig-name descname">removes_return()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.replaces"><span class="sig-name descname">replaces()</span></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">adds</span><span class="p">(</span><span class="s1">&#39;entity&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span> <span class="o">...</span>

<span class="nd">@collection</span><span class="o">.</span><span class="n">removes_return</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.adds">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">adds</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.adds" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark the method as adding an entity to the collection.</p>
<p>Adds “add to collection” handling to the method.  The decorator
argument indicates which method argument holds the SQLAlchemy-relevant
value.  Arguments can be specified positionally (i.e. integer) or by
name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">adds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="o">...</span>

<span class="nd">@collection</span><span class="o">.</span><span class="n">adds</span><span class="p">(</span><span class="s1">&#39;entity&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.appender">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">appender</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.appender" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as the collection appender.</p>
<p>The appender method is called with one positional argument: the value
to append. The method will be automatically decorated with ‘adds(1)’
if not already decorated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">appender</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span> <span class="o">...</span>

<span class="c1"># or, equivalently</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">appender</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">adds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span> <span class="o">...</span>

<span class="c1"># for mapping type, an &#39;append&#39; may kick out a previous value</span>
<span class="c1"># that occupies that slot.  consider d[&#39;a&#39;] = &#39;foo&#39;- any previous</span>
<span class="c1"># value in d[&#39;a&#39;] is discarded.</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">appender</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">replaces</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">some_key_func</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="n">previous</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
    <span class="k">return</span> <span class="n">previous</span></pre></div>
</div>
<p>If the value to append is not allowed in the collection, you may
raise an exception.  Something to remember is that the appender
will be called for each object mapped by a database query.  If the
database contains rows that violate your collection semantics, you
will need to get creative to fix the problem, as access via the
collection will not work.</p>
<p>If the appender method is internally instrumented, you must also
receive the keyword argument ‘_sa_initiator’ and ensure its
promulgation to collection events.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.converter">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">converter</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.converter" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as the collection converter.</p>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 1.3: </span>The <a class="reference internal" href="#sqlalchemy.orm.collections.collection.converter" title="sqlalchemy.orm.collections.collection.converter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">collection.converter()</span></code></a> handler is deprecated and will be removed in a future release.  Please refer to the <code class="xref py py-class docutils literal notranslate"><span class="pre">bulk_replace</span></code> listener interface in conjunction with the <a class="reference internal" href="../core/event.html#sqlalchemy.event.listen" title="sqlalchemy.event.listen"><code class="xref py py-func docutils literal notranslate"><span class="pre">listen()</span></code></a> function.</p>
</div>
<p>This optional method will be called when a collection is being
replaced entirely, as in:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myobj</span><span class="o">.</span><span class="n">acollection</span> <span class="o">=</span> <span class="p">[</span><span class="n">newvalue1</span><span class="p">,</span> <span class="n">newvalue2</span><span class="p">]</span></pre></div>
</div>
<p>The converter method will receive the object being assigned and should
return an iterable of values suitable for use by the <code class="docutils literal notranslate"><span class="pre">appender</span></code>
method.  A converter must not assign values or mutate the collection,
its sole job is to adapt the value the user provides into an iterable
of values for the ORM’s use.</p>
<p>The default converter implementation will use duck-typing to do the
conversion.  A dict-like collection will be convert into an iterable
of dictionary values, and other types will simply be iterated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">converter</span>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>If the duck-typing of the object does not match the type of this
collection, a TypeError is raised.</p>
<p>Supply an implementation of this method if you want to expand the
range of possible types that can be assigned in bulk or perform
validation on the values about to be assigned.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.internally_instrumented">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">internally_instrumented</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.internally_instrumented" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as instrumented.</p>
<p>This tag will prevent any decoration from being applied to the
method. Use this if you are orchestrating your own calls to
<code class="xref py py-func docutils literal notranslate"><span class="pre">collection_adapter()</span></code> in one of the basic SQLAlchemy
interface methods, or to prevent an automatic ABC method
decoration from wrapping your implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># normally an &#39;extend&#39; method on a list-like class would be</span>
<span class="c1"># automatically intercepted and re-implemented in terms of</span>
<span class="c1"># SQLAlchemy events and append().  your implementation will</span>
<span class="c1"># never be called, unless:</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">internally_instrumented</span>
<span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.iterator">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">iterator</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.iterator" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as the collection remover.</p>
<p>The iterator method is called with no arguments.  It is expected to
return an iterator over all collection members:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">iterator</span>
<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.remover">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">remover</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.remover" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as the collection remover.</p>
<p>The remover method is called with one positional argument: the value
to remove. The method will be automatically decorated with
<a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes_return" title="sqlalchemy.orm.collections.collection.removes_return"><code class="xref py py-meth docutils literal notranslate"><span class="pre">removes_return()</span></code></a> if not already decorated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">remover</span>
<span class="k">def</span> <span class="nf">zap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span> <span class="o">...</span>

<span class="c1"># or, equivalently</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">remover</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">removes_return</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">zap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>If the value to remove is not present in the collection, you may
raise an exception or return None to ignore the error.</p>
<p>If the remove method is internally instrumented, you must also
receive the keyword argument ‘_sa_initiator’ and ensure its
promulgation to collection events.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.removes">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">removes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.removes" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark the method as removing an entity in the collection.</p>
<p>Adds “remove from collection” handling to the method.  The decorator
argument indicates which method argument holds the SQLAlchemy-relevant
value to be removed. Arguments can be specified positionally (i.e.
integer) or by name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">removes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>For methods where the value to remove is not known at call-time, use
collection.removes_return.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.removes_return">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">removes_return</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.removes_return" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark the method as removing an entity in the collection.</p>
<p>Adds “remove from collection” handling to the method.  The return
value of the method, if any, is considered the value to remove.  The
method arguments are not inspected:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">removes_return</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>For methods where the value to remove is known at call-time, use
collection.remove.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.replaces">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">replaces</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.replaces" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark the method as replacing an entity in the collection.</p>
<p>Adds “add to collection” and “remove from collection” handling to
the method.  The decorator argument indicates which method argument
holds the SQLAlchemy-relevant value to be added, and return value, if
any will be considered the value to remove.</p>
<p>Arguments can be specified positionally (i.e. integer) or by name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">replaces</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection_adapter">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">collection_adapter</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">operator.attrgetter('_sa_adapter')</span></em><a class="headerlink" href="#sqlalchemy.orm.collections.collection_adapter" title="Permalink to this definition">¶</a></dt>
<dd><p>attrgetter(attr, …) –&gt; attrgetter object</p>
<p>Return a callable object that fetches the given attribute(s) from its operand.
After f = attrgetter(‘name’), the call f(r) returns r.name.
After g = attrgetter(‘name’, ‘date’), the call g(r) returns (r.name, r.date).
After h = attrgetter(‘name.first’, ‘name.last’), the call h(r) returns
(r.name.first, r.name.last).</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.CollectionAdapter">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">CollectionAdapter</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.CollectionAdapter" title="Permalink to this definition">¶</a></dt>
<dd><p>Bridges between the ORM and arbitrary Python collections.</p>
<p>Proxies base-level collection operations (append, remove, iterate)
to the underlying Python collection, and emits add/remove events for
entities entering or leaving the collection.</p>
<p>The ORM uses <a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter" title="sqlalchemy.orm.collections.CollectionAdapter"><code class="xref py py-class docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a> exclusively for interaction with
entity collections.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.InstrumentedDict">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">InstrumentedDict</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.InstrumentedDict" title="Permalink to this definition">¶</a></dt>
<dd><p>An instrumented version of the built-in dict.</p>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedDict" title="sqlalchemy.orm.collections.InstrumentedDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.InstrumentedDict</span></code></a> (<code class="docutils literal notranslate"><span class="pre">builtins.dict</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.InstrumentedList">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">InstrumentedList</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.InstrumentedList" title="Permalink to this definition">¶</a></dt>
<dd><p>An instrumented version of the built-in list.</p>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedList" title="sqlalchemy.orm.collections.InstrumentedList"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.InstrumentedList</span></code></a> (<code class="docutils literal notranslate"><span class="pre">builtins.list</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.InstrumentedSet">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">InstrumentedSet</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.InstrumentedSet" title="Permalink to this definition">¶</a></dt>
<dd><p>An instrumented version of the built-in set.</p>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedSet" title="sqlalchemy.orm.collections.InstrumentedSet"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.InstrumentedSet</span></code></a> (<code class="docutils literal notranslate"><span class="pre">builtins.set</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.prepare_instrumentation">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">prepare_instrumentation</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">factory</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><span class="pre">Collection</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_AdaptedCollectionProtocol</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_AdaptedCollectionProtocol</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.collections.prepare_instrumentation" title="Permalink to this definition">¶</a></dt>
<dd><p>Prepare a callable for future use as a collection class factory.</p>
<p>Given a collection class factory (either a type or no-arg callable),
return another factory that will produce compatible instances when
called.</p>
<p>This function is responsible for converting collection_class=list
into the run-time behavior of collection_class=InstrumentedList.</p>
</dd></dl>

</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="large_collections.html" title="previous chapter">操作大型集合</a>
        Next:
        <a href="relationship_persistence.html" title="next chapter">特殊关系的持久化模式</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 18:43:55

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


