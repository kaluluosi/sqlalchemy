<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    集合订制和API详细信息
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index.html" />
        <link rel="up" title="关系配置" href="relationships.html" />
        <link rel="next" title="特殊关系持久化模式" href="relationship_persistence.html" />
        <link rel="prev" title="处理大集合" href="large_collections.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM映射类配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系配置</a></span><ul>
<li><span class="link-container"><a class="reference external" href="basic_relationships.html">关系模式基础知识</a></span></li>
<li><span class="link-container"><a class="reference external" href="self_referential.html">邻接列表关系</a></span></li>
<li><span class="link-container"><a class="reference external" href="join_conditions.html">配置 Relationship Joins</a></span></li>
<li><span class="link-container"><a class="reference external" href="large_collections.html">处理大集合</a></span></li>
<li class="selected"><span class="link-container"><strong>集合订制和API详细信息</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#custom-collections">定制集合访问</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-dictionary-collection">字典集合订制</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id7">}</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#key-collections-mutations">解决键变异和针对字典集合的反向填充</a></span></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm-custom-collection">定制集合实现</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#dictionary-collections">自定义字典型集合</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#id25">集合API</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.attribute_keyed_dict"><code class="docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.column_keyed_dict"><code class="docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.keyfunc_mapping"><code class="docutils literal notranslate"><span class="pre">keyfunc_mapping()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.attribute_mapped_collection"><code class="docutils literal notranslate"><span class="pre">attribute_mapped_collection</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.column_mapped_collection"><code class="docutils literal notranslate"><span class="pre">column_mapped_collection</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.mapped_collection"><code class="docutils literal notranslate"><span class="pre">mapped_collection</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.__init__"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.__init__()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.clear"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.clear()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.pop"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.pop()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.popitem"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.popitem()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.remove"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.remove()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.set"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.set()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.setdefault"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.setdefault()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.KeyFuncDict.update"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.update()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.MappedCollection"><code class="docutils literal notranslate"><span class="pre">MappedCollection</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#id26">集合内部</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.bulk_replace"><code class="docutils literal notranslate"><span class="pre">bulk_replace()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">collection</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.adds"><code class="docutils literal notranslate"><span class="pre">collection.adds()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.appender"><code class="docutils literal notranslate"><span class="pre">collection.appender()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.converter"><code class="docutils literal notranslate"><span class="pre">collection.converter()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.internally_instrumented"><code class="docutils literal notranslate"><span class="pre">collection.internally_instrumented()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.iterator"><code class="docutils literal notranslate"><span class="pre">collection.iterator()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.remover"><code class="docutils literal notranslate"><span class="pre">collection.remover()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.removes"><code class="docutils literal notranslate"><span class="pre">collection.removes()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.removes_return"><code class="docutils literal notranslate"><span class="pre">collection.removes_return()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection.replaces"><code class="docutils literal notranslate"><span class="pre">collection.replaces()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.collection_adapter"><code class="docutils literal notranslate"><span class="pre">collection_adapter</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.CollectionAdapter"><code class="docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.InstrumentedDict"><code class="docutils literal notranslate"><span class="pre">InstrumentedDict</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.InstrumentedList"><code class="docutils literal notranslate"><span class="pre">InstrumentedList</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.InstrumentedSet"><code class="docutils literal notranslate"><span class="pre">InstrumentedSet</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.collections.prepare_instrumentation"><code class="docutils literal notranslate"><span class="pre">prepare_instrumentation()</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="relationship_persistence.html">特殊关系持久化模式</a></span></li>
<li><span class="link-container"><a class="reference external" href="backref.html">使用传统的“backref”关系参数</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationship_api.html">关系 API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM查询指南</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">使用Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">事件和内部实现</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM Examples</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="large_collections.html" title="previous chapter">处理大集合</a></li>
                <li><b>Next:</b>
                <a href="relationship_persistence.html" title="next chapter">特殊关系持久化模式</a></li>

            <li><b>Up:</b> <a href="../index.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="relationships.html" title="关系配置">关系配置</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#api">集合订制和API详细信息</a><ul>
<li><a class="reference internal" href="#custom-collections">定制集合访问</a><ul>
<li><a class="reference internal" href="#orm-dictionary-collection">字典集合订制</a><ul>
<li><a class="reference internal" href="#id7">}</a><ul>
<li><a class="reference internal" href="#key-collections-mutations">解决键变异和针对字典集合的反向填充</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#orm-custom-collection">定制集合实现</a><ul>
<li><a class="reference internal" href="#dictionary-collections">自定义字典型集合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25">集合API</a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict"><code class="docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict"><code class="docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.keyfunc_mapping"><code class="docutils literal notranslate"><span class="pre">keyfunc_mapping()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.attribute_mapped_collection"><code class="docutils literal notranslate"><span class="pre">attribute_mapped_collection</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.column_mapped_collection"><code class="docutils literal notranslate"><span class="pre">column_mapped_collection</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.mapped_collection"><code class="docutils literal notranslate"><span class="pre">mapped_collection</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.__init__"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.__init__()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.clear"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.clear()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.pop"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.pop()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.popitem"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.popitem()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.remove"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.remove()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.set"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.set()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.setdefault"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.setdefault()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.update"><code class="docutils literal notranslate"><span class="pre">KeyFuncDict.update()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.orm.MappedCollection"><code class="docutils literal notranslate"><span class="pre">MappedCollection</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id26">集合内部</a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.bulk_replace"><code class="docutils literal notranslate"><span class="pre">bulk_replace()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">collection</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.adds"><code class="docutils literal notranslate"><span class="pre">collection.adds()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.appender"><code class="docutils literal notranslate"><span class="pre">collection.appender()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.converter"><code class="docutils literal notranslate"><span class="pre">collection.converter()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.internally_instrumented"><code class="docutils literal notranslate"><span class="pre">collection.internally_instrumented()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.iterator"><code class="docutils literal notranslate"><span class="pre">collection.iterator()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.remover"><code class="docutils literal notranslate"><span class="pre">collection.remover()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes"><code class="docutils literal notranslate"><span class="pre">collection.removes()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes_return"><code class="docutils literal notranslate"><span class="pre">collection.removes_return()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection.replaces"><code class="docutils literal notranslate"><span class="pre">collection.replaces()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.collection_adapter"><code class="docutils literal notranslate"><span class="pre">collection_adapter</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter"><code class="docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedDict"><code class="docutils literal notranslate"><span class="pre">InstrumentedDict</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedList"><code class="docutils literal notranslate"><span class="pre">InstrumentedList</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedSet"><code class="docutils literal notranslate"><span class="pre">InstrumentedSet</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.collections.prepare_instrumentation"><code class="docutils literal notranslate"><span class="pre">prepare_instrumentation()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-collection_api" >
        
<section id="api">
<span id="custom-collections-toplevel"></span><h1>集合订制和API详细信息<a class="headerlink" href="#api" title="Permalink to this heading">¶</a></h1>
<p>:func:<a href="#id1"><span class="problematic" id="id2">`</span></a>_orm.relationship`函数定义了两个类之间的联系。当联系定义为一对多或多对多关系时,加载和操作对象时,它会被表示为Python集合。本部分介绍集合配置和技巧的额外信息。</p>
<section id="custom-collections">
<span id="id3"></span><h2>定制集合访问<a class="headerlink" href="#custom-collections" title="Permalink to this heading">¶</a></h2>
<p>在一个类映射成一对多或多对多关系之后，通过父实例上的属性访问一个值的集合。这两个常见的集合类型是 <code class="docutils literal notranslate"><span class="pre">list</span></code> 和 <code class="docutils literal notranslate"><span class="pre">set</span></code>，当使用 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>  的 <a class="reference internal" href="declarative_styles.html"><span class="std std-ref">声明性映射</span></a> 时，使用集合类型在 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 容器内部进行设置，如下所示 <code class="docutils literal notranslate"><span class="pre">Parent.children</span></code> 集合，其中使用的是 <code class="docutils literal notranslate"><span class="pre">list</span></code>：</p>
<blockquote>
<div><p>from sqlalchemy import ForeignKey</p>
<p>from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class Parent(Base):</dt><dd><p>__tablename__ = “parent”</p>
<p>parent_id: Mapped[int] = mapped_column(primary_key=True)</p>
<p># 使用列表
children: Mapped[List[“Child”]] = relationship()</p>
</dd>
<dt>class Child(Base):</dt><dd><p>__tablename__ = “child”</p>
<p>child_id: Mapped[int] = mapped_column(primary_key=True)
parent_id: Mapped[int] = mapped_column(ForeignKey(“parent.id”))</p>
</dd>
</dl>
</div></blockquote>
<p>或针对一个 <code class="docutils literal notranslate"><span class="pre">set</span></code>，在同样的“Parent.children”集合中演示：</p>
<blockquote>
<div><p>from typing import Set
from sqlalchemy import ForeignKey</p>
<p>from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class Parent(Base):</dt><dd><p>__tablename__ = “parent”</p>
<p>parent_id: Mapped[int] = mapped_column(primary_key=True)</p>
<p># 使用 set
children: Mapped[Set[“Child”]] = relationship()</p>
</dd>
<dt>class Child(Base):</dt><dd><p>__tablename__ = “child”</p>
<p>child_id: Mapped[int] = mapped_column(primary_key=True)
parent_id: Mapped[int] = mapped_column(ForeignKey(“parent.id”))</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果使用Python 3.7或3.8，集合的注释需要使用 <code class="docutils literal notranslate"><span class="pre">typing.List</span></code> 或 <code class="docutils literal notranslate"><span class="pre">typing.Set</span></code>，例如 <code class="docutils literal notranslate"><span class="pre">Mapped[List[&quot;Child&quot;]]</span></code> 或 <code class="docutils literal notranslate"><span class="pre">Mapped[Set[&quot;Child&quot;]]</span></code>；因为这些Python版本中的 <code class="docutils literal notranslate"><span class="pre">list</span></code> 和 <code class="docutils literal notranslate"><span class="pre">set</span></code> Python内置不支持通用注释。</p>
</div>
<p>当使用没有 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 注释的映射时，例如在 <a class="reference internal" href="mapping_styles.html#orm-imperative-mapping"><span class="std std-ref">命令式映射</span></a> 或未打了类型标签的 Python 代码中，以及一些特殊情况下，可以使用 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.collection_class</span></code> 参数直接指定 <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code> 的集合类：</p>
<blockquote>
<div><p># 非注释映射</p>
<dl>
<dt>class Parent(Base):</dt><dd><p>__tablename__ = “parent”</p>
<p>parent_id = mapped_column(Integer, primary_key=True)</p>
<p>children = relationship(“Child”, collection_class=set)</p>
</dd>
<dt>class Child(Base):</dt><dd><p>__tablename__ = “child”</p>
<p>child_id = mapped_column(Integer, primary_key=True)
parent_id = mapped_column(ForeignKey(“parent.id”))</p>
</dd>
</dl>
</div></blockquote>
<p>在缺乏 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.collection_class</span></code> 或 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 的情况下，默认集合类型是 <code class="docutils literal notranslate"><span class="pre">list</span></code>。
除了构建在内的 <code class="docutils literal notranslate"><span class="pre">list</span></code> 和 <code class="docutils literal notranslate"><span class="pre">set</span></code> 之外，还支持两种字典类型，下面的章节 <a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a> 中对此进行了描述。还可以将任何任意的可变序列类型设置为目标集合，但需要进行一些附加配置步骤；在章节 <a class="reference internal" href="#orm-custom-collection"><span class="std std-ref">定制集合实现</span></a> 中进行描述。</p>
<section id="orm-dictionary-collection">
<span id="id4"></span><h3>字典集合订制<a class="headerlink" href="#orm-dictionary-collection" title="Permalink to this heading">¶</a></h3>
<p>使用字典作为集合需要一些额外细节。因为对象总是以列表的形式从数据库中加载的，所以必须有一种键生成策略才能正确填充字典。 <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> 函数是实现简单字典集合的最常见方式。它生成一个字典类，该字典类将一个特定属性的映射类作为键。例如，下面映射了一个包含按“Note.keyword”属性标记的“Note”项的字典的“Item”类。当使用 <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> 时， <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 可以使用 <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> 或普通 <code class="docutils literal notranslate"><span class="pre">dict</span></code>，如下所示。但是，在此情况下需要 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.collection_class</span></code> 参数以便可以适当地构造 <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> 。：</p>
<blockquote>
<div><p>from typing import Dict
from typing import Optional</p>
<p>from sqlalchemy import ForeignKey
from sqlalchemy.orm import attribute_keyed_dict
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship</p>
<dl>
<dt>class Base(DeclarativeBase):</dt><dd><p>pass</p>
</dd>
<dt>class Item(Base):</dt><dd><p>__tablename__ = “item”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)</p>
<dl class="simple">
<dt>notes: Mapped[Dict[str, “Note”]] = relationship(</dt><dd><p>collection_class=attribute_keyed_dict(“keyword”),
cascade=”all, delete-orphan”,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>class Note(Base):</dt><dd><p>__tablename__ = “note”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)
item_id: Mapped[int] = mapped_column(ForeignKey(“item.id”))
keyword: Mapped[str]
text: Mapped[Optional[str]]</p>
<dl class="simple">
<dt>def __init__(self, keyword: str, text: str):</dt><dd><p>self.keyword = keyword
self.text = text</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>然后， <code class="docutils literal notranslate"><span class="pre">Item.notes</span></code> 是一个字典：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">item</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Note</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;atext&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">item</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="go">{&#39;a&#39;: &lt;__main__.Note object at 0x2eaaf0&gt;}</span></pre></div>
</div>
<p><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a>  将确保每个 <code class="docutils literal notranslate"><span class="pre">Note</span></code> 的 <code class="docutils literal notranslate"><span class="pre">.keyword</span></code> 属性符合字典中的键。例如，在“Item.notes”中指定键时，我们提供的字典键必须与实际 <code class="docutils literal notranslate"><span class="pre">Note</span></code> 对象的键匹配：</p>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a>`
item = Item()
item.notes = {</p>
<blockquote>
<div><p>“a”: Note(“a”, “atext”),
“b”: Note(“b”, “btext”),</p>
</div></blockquote>
<section id="id7">
<h4>}<a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">.attribute_keyed_dict</span></code> 使用的作为键的属性完全不需要被映射！  使用常规Python <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> 允许用于将对象的任何细节或组合用作键，正如在此之前所述的属性 <code class="docutils literal notranslate"><span class="pre">Note.keyword</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Note.text</span></code> 字段的前十个字母的元组中所建立的那样：</p>
<blockquote>
<div><dl>
<dt>class Item(Base):</dt><dd><p>__tablename__ = “item”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)</p>
<dl class="simple">
<dt>notes: Mapped[Dict[str, “Note”]] = relationship(</dt><dd><p>collection_class=attribute_keyed_dict(“note_key”),
back_populates=”item”,
cascade=”all, delete-orphan”,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>class Note(Base):</dt><dd><p>__tablename__ = “note”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)
item_id: Mapped[int] = mapped_column(ForeignKey(“item.id”))
keyword: Mapped[str]
text: Mapped[str]</p>
<p>item: Mapped[“Item”] = relationship()</p>
<p>&#64;property
def note_key(self):</p>
<blockquote>
<div><p>return (self.keyword, self.text[0:10])</p>
</div></blockquote>
<dl class="simple">
<dt>def __init__(self, keyword: str, text: str):</dt><dd><p>self.keyword = keyword
self.text = text</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>上面上述的代码添加了 <code class="docutils literal notranslate"><span class="pre">Note.item</span></code> 关系，具有双向的 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.back_populates</span></code> 配置。将一些反向关系添加到此，<code class="docutils literal notranslate"><span class="pre">Note</span></code> 将添加到 <code class="docutils literal notranslate"><span class="pre">Item.notes</span></code> 字典中，并自动为我们生成键：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;atext&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">item</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">item</span><span class="o">.</span><span class="n">notes</span>
<span class="go">{(&#39;a&#39;, &#39;atext&#39;): &lt;__main__.Note object at 0x2eaaf0&gt;}</span></pre></div>
</div>
<p>其他内置字典类型包括 <a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a>，它几乎与 <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> 相同，除了直接给出了 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象；以及 <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_collection()</span></code>，它传递任何可调用函数。请注意，通常建议结合使用 <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> 和 <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>，如前面提到的。</p>
<p>字典映射通常与“Association Proxy”扩展结合使用以产生流线型字典视图。请参阅 <span class="xref std std-ref">proxying_dictionaries</span> 和 <span class="xref std std-ref">composite_association_proxy</span> 以获取样例。</p>
<section id="key-collections-mutations">
<span id="id8"></span><h5>解决键变异和针对字典集合的反向填充<a class="headerlink" href="#key-collections-mutations" title="Permalink to this heading">¶</a></h5>
<p>当使用 <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> 时，字典的“键”取自目标对象上的一个属性。<strong>这些键的更改不会被跟踪</strong>。这意味着必须在首次使用它们时分配键，如果键更改，集合将不会发生变化。一个典型的例子是依靠反参考关系填充映射属性集合。以下是一个示例：</p>
<blockquote>
<div><dl>
<dt>class A(Base):</dt><dd><p>__tablename__ = “a”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)</p>
<dl class="simple">
<dt>bs: Mapped[Dict[str, “B”]] = relationship(</dt><dd><p>collection_class=attribute_keyed_dict(“data”),
back_populates=”a”,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>class B(Base):</dt><dd><p>__tablename__ = “b”</p>
<p>id: Mapped[int] = mapped_column(primary_key=True)
a_id: Mapped[int] = mapped_column(ForeignKey(“a.id”))
data: Mapped[str]</p>
<p>a: Mapped[“A”] = relationship(back_populates=”bs”)</p>
</dd>
</dl>
</div></blockquote>
<p>以上代码若使用 <code class="docutils literal notranslate"><span class="pre">B()</span></code> 指定特定的 <code class="docutils literal notranslate"><span class="pre">A()</span></code>，则反填将向 <code class="docutils literal notranslate"><span class="pre">A.bs</span></code> 集合中添加 <code class="docutils literal notranslate"><span class="pre">B()</span></code>，但如果 <code class="docutils literal notranslate"><span class="pre">B.data</span></code> 的值尚未设置，则键将为``None``：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a1</span><span class="p">)</span> <span class="c1"># 在此之后才为 &#39;data&#39; 赋值</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>
<span class="go">{None: &lt;test3.B object at 0x7f7b1023ef70&gt;}</span></pre></div>
</div>
<p>设置 <code class="docutils literal notranslate"><span class="pre">b1.data</span></code> 之后并不会更新集合：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;the key&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>
<span class="go">{None: &lt;test3.B object at 0x7f7b1023ef70&gt;}</span></pre></div>
</div>
<p>如果试图在构造函数中设置 <code class="docutils literal notranslate"><span class="pre">B()</span></code>，也会发现这一点。使用 <code class="docutils literal notranslate"><span class="pre">B.data</span></code> 的值在构造函数内部作为键会改变结果：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">B</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;the key&quot;</span><span class="p">)</span>
<span class="go">&lt;test3.B object at 0x7f7b10114280&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>
<span class="go">{None: &lt;test3.B object at 0x7f7b10114280&gt;}</span></pre></div>
</div>
<p>vs：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">B</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;the key&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a1</span><span class="p">)</span>
<span class="go">&lt;test3.B object at 0x7f7b10114340&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>
<span class="go">{&#39;the key&#39;: &lt;test3.B object at 0x7f7b10114340&gt;}</span></pre></div>
</div>
<p>如果使用反参考关系，确保通过 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> 方法按正确顺序填充属性。</p>
<p>类似下面的事件处理程序也可用于跟踪集合中的变化：</p>
<blockquote>
<div><p>from sqlalchemy import event
from sqlalchemy.orm import attributes</p>
<p>&#64;event.listens_for(B.data, “set”)
def set_item(obj, value, previous, initiator):</p>
<blockquote>
<div><dl class="simple">
<dt>if obj.a is not None:</dt><dd><p>previous = None if previous == attributes.NO_VALUE else previous
obj.a.bs[value] = obj
obj.a.bs.pop(previous)</p>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
</section>
</section>
</section>
</section>
<section id="orm-custom-collection">
<span id="id9"></span><h2>定制集合实现<a class="headerlink" href="#orm-custom-collection" title="Permalink to this heading">¶</a></h2>
<p>您也可以使用自己的类型作为集合。对于简单情况，继承自 <code class="docutils literal notranslate"><span class="pre">list</span></code> 或 <code class="docutils literal notranslate"><span class="pre">set</span></code>，并添加自定义行为就足够了。在其他情况下，需要特殊的装饰器以告诉SQLAlchemy更多关于集合运作的细节。</p>
<aside class="topic">
<p class="topic-title">我需要一个定制的集合实现吗？</p>
<p>在大多数情况下，不需要！使用“自验证”或者简单划转支持Struct的值的情况下，使用库内置的 <code class="docutils literal notranslate"><span class="pre">list</span></code> 或 <code class="docutils literal notranslate"><span class="pre">set</span></code> 并没有毛病。在这些基础上提供的装饰器能让您使用更多的订制选项。 有时，需要在外部建模的情况下，集合需要在访问或变异操作时具有特殊的行为，这时就需要进行个性化集合的处理。当然，可以将其与上述两种方法结合使用。</p>
</aside>
<p>QLAlchemy中的集合被透明地*仪器化*。仪器化意味着对集合的正常操作进行跟踪，并在刷新时将更改写入数据库。此外，集合操作可以触发*事件*，指示必须执行某些次要操作。二次操作的示例包括将子项保存在 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 的父级中（即 <code class="docutils literal notranslate"><span class="pre">save-update</span></code> 级联），以及同步双向关系的状态（即 <code class="xref py py-func docutils literal notranslate"><span class="pre">backref()</span></code>）。</p>
<p>“集合”模块了解列表，集合和字典的基本接口，并自动应用支持这些内置操作的修饰符。实现基本集合接口的对象派生类型通过鸭子类型进行检测和识别：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ListLike</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;foo&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">append</span></code>，<code class="docutils literal notranslate"><span class="pre">remove``和``extend``是已知的</span> <span class="pre">``list</span></code> 成员，并将自动附加修饰符。<a href="#id10"><span class="problematic" id="id11">``</span></a>__iter__``不是修改方法，不会被仪器化，并且``foo``也不会被修饰。</p>
<p>鸭子类型（即猜测）当然并不可靠，因此可以通过提供``__emulates__``类属性来显式说明您正在实施的接口：</p>
<blockquote>
<div><dl>
<dt>class SetLike:</dt><dd><p>__emulates__ = set</p>
<dl class="simple">
<dt>def __init__(self):</dt><dd><p>self.data = set()</p>
</dd>
<dt>def append(self, item):</dt><dd><p>self.data.add(item)</p>
</dd>
<dt>def remove(self, item):</dt><dd><p>self.data.remove(item)</p>
</dd>
<dt>def __iter__(self):</dt><dd><p>return iter(self.data)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>此类看起来与 Python 的 <code class="docutils literal notranslate"><span class="pre">list</span></code> （即 “list-like”）类似，因为它有公共的 <code class="docutils literal notranslate"><span class="pre">append</span></code> 方法，但``__emulates__``特性强制它被视为 <code class="docutils literal notranslate"><span class="pre">set</span></code>。已知 <code class="docutils literal notranslate"><span class="pre">set</span></code> 的部分接口包括 <code class="docutils literal notranslate"><span class="pre">remove</span></code>，因此将自动为该方法添加修饰符。</p>
<p>但是这个类还不能正常工作：需要一些黏合剂来将其适配到SQLAlchemy中使用。ORM需要知道哪些方法用于附加，删除和迭代集合的成员。使用类似一个 <code class="docutils literal notranslate"><span class="pre">list</span></code> 或 <code class="docutils literal notranslate"><span class="pre">set</span></code> 的类型时，适当的方法已经很清楚了，并且会被自动使用。但是，上面的类只大致类似于一个 <code class="docutils literal notranslate"><span class="pre">set</span></code>，并没有为SQLAlchemy提供可以默认使用的明确的适配方法。需要使用 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.collection_class</span></code> 参数在这种情况下使用其他方法。</p>
<p>使用修饰器 <code class="docutils literal notranslate"><span class="pre">&#64;collection.appender</span></code> 可以像这样将问题解决，因为它 in <code class="docutils literal notranslate"><span class="pre">SetLike</span></code> class 并没有提供``add`` 的方法:</p>
<blockquote>
<div><p>from sqlalchemy.orm.collections import collection</p>
<dl>
<dt>class SetLike:</dt><dd><p>__emulates__ = set</p>
<dl class="simple">
<dt>def __init__(self):</dt><dd><p>self.data = set()</p>
</dd>
</dl>
<p>&#64;collection.appender
def append(self, item):</p>
<blockquote>
<div><p>self.data.add(item)</p>
</div></blockquote>
<dl class="simple">
<dt>def remove(self, item):</dt><dd><p>self.data.remove(item)</p>
</dd>
<dt>def __iter__(self):</dt><dd><p>return iter(self.data)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>就像默认方法一样， <code class="docutils literal notranslate"><span class="pre">append</span></code> 和 <code class="docutils literal notranslate"><span class="pre">remove</span></code> 方法需传入一个映射实体作为单个参数，迭代器方法则直接调用而无需参数。</p>
<section id="dictionary-collections">
<span id="id12"></span><h3>自定义字典型集合<a class="headerlink" href="#dictionary-collections" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> 类可以作为自定义类型的基类或混入，以快速将“字典”集合支持添加到其他类中。它使用一个关键函数将委托到 <code class="docutils literal notranslate"><span class="pre">__setitem__</span></code>  和 <code class="docutils literal notranslate"><span class="pre">__delitem__</span></code>  进行设置：</p>
<blockquote>
<div><p>from sqlalchemy.orm.collections import KeyFuncDict</p>
<dl>
<dt>class MyNodeMap(KeyFuncDict):</dt><dd><p>“””Holds ‘Node’ objects, keyed by the ‘name’ attribute.”””</p>
<dl class="simple">
<dt>def __init__(self, <a href="#id13"><span class="problematic" id="id14">*</span></a>args, <a href="#id15"><span class="problematic" id="id16">**</span></a>kw):</dt><dd><p>super().__init__(keyfunc=lambda node: node.name)
dict.__init__(self, <a href="#id17"><span class="problematic" id="id18">*</span></a>args, <a href="#id19"><span class="problematic" id="id20">**</span></a>kw)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>在子类化 <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> 时，必须使用 <a class="reference internal" href="#sqlalchemy.orm.collections.collection.internally_instrumented" title="sqlalchemy.orm.collections.collection.internally_instrumented"><code class="xref py py-meth docutils literal notranslate"><span class="pre">collection.internally_instrumented()</span></code></a> 修饰符装饰自定义版本的 <code class="docutils literal notranslate"><span class="pre">__setitem__()</span></code>
或 <code class="docutils literal notranslate"><span class="pre">__delitem__()</span></code>，<a href="#id21"><span class="problematic" id="id22">**</span></a>如果**它们在该类的这些相同方法中调用了 <code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict`的这些方法。因为</span> <span class="pre">:class:</span></code>.KeyFuncDict` 方法已经被仪器化 - 从仪器化调用中调用它们可能会导致事件被重复触发或不恰当地触发，在罕见的情况下可能导致的内部状态破坏：</p>
<blockquote>
<div><p>from sqlalchemy.orm.collections import KeyFuncDict, collection</p>
<dl>
<dt>class MyKeyFuncDict(KeyFuncDict):</dt><dd><p>“””使用 &#64;internally_instrumented 当您的方法 调用到已仪器化的方法”””</p>
<p>&#64;collection.internally_instrumented
def __setitem__(self, key, value, _sa_initiator=None):</p>
<blockquote>
<div><p># do something with key, value
super(MyKeyFuncDict, self).__setitem__(key, value, _sa_initiator)</p>
</div></blockquote>
<p>&#64;collection.internally_instrumented
def __delitem__(self, key, _sa_initiator=None):</p>
<blockquote>
<div><p># do something with key
super(MyKeyFuncDict, self).__delitem__(key, _sa_initiator)</p>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<p>ORM了解所有列表，集合和字典的基本接口，并将自动应用装置，使这些内置类型和它们的子类在强类型框架内使用更加安全。实现基本集合接口的对象派生类型通过鸭子类型进行识别,详见上文。用于附加和删除的默认方法必须由 <code class="docutils literal notranslate"><span class="pre">appender</span></code> 和 <code class="docutils literal notranslate"><span class="pre">remover</span></code> 方法修饰，但是在基本字典介面中没有兼容的方法可供SQLAlchemy默认使用。除非另有装饰，否则迭代将通过 <code class="docutils literal notranslate"><span class="pre">values()``执行。如果您选择子类化</span> <span class="pre">``dict</span></code> 或通过另一种方式提供向字典一样的集合行为，ORM将了解“字典”接口，并在使用 <code class="docutils literal notranslate"><span class="pre">relationship（…）</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">collection_class</span></code> 参数进行适当仪器化。必须装修 <a href="#id23"><span class="problematic" id="id24">`</span></a>appender`和`remover`方法。</p>
</section>
</section>
<section id="id25">
<h2>集合API<a class="headerlink" href="#id25" title="Permalink to this heading">¶</a></h2>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict"><span class="sig-name descname">attribute_keyed_dict</span></a>(attr_name, *, [ignore_unpopulated_attribute])</p></td>
<td><p>A dictionary-based collection type with attribute-based keying.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.attribute_mapped_collection"><span class="sig-name descname">attribute_mapped_collection</span></a></p></td>
<td><p>A dictionary-based collection type with attribute-based keying.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict"><span class="sig-name descname">column_keyed_dict</span></a>(mapping_spec, *, [ignore_unpopulated_attribute])</p></td>
<td><p>A dictionary-based collection type with column-based keying.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.column_mapped_collection"><span class="sig-name descname">column_mapped_collection</span></a></p></td>
<td><p>A dictionary-based collection type with column-based keying.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.keyfunc_mapping"><span class="sig-name descname">keyfunc_mapping</span></a>(keyfunc, *, [ignore_unpopulated_attribute])</p></td>
<td><p>A dictionary-based collection type with arbitrary keying.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><span class="sig-name descname">KeyFuncDict</span></a></p></td>
<td><p>Base for ORM mapped dictionary classes.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.mapped_collection"><span class="sig-name descname">mapped_collection</span></a></p></td>
<td><p>A dictionary-based collection type with arbitrary keying.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.MappedCollection"><span class="sig-name descname">MappedCollection</span></a></p></td>
<td><p>Base for ORM mapped dictionary classes.</p></td>
</tr>
</tbody>
</table>
<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.attribute_keyed_dict">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">attribute_keyed_dict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">attr_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_unpopulated_attribute</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.mapped_collection.KeyFuncDict"><span class="pre">KeyFuncDict</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_KT</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.attribute_keyed_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with attribute-based keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.attribute_mapped_collection" title="sqlalchemy.orm.attribute_mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">attribute_mapped_collection</span></code></a> to
<a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory which will produce new
dictionary keys based on the value of a particular named attribute on
ORM mapped instances to be added to the dictionary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the value of the target attribute must be assigned with its
value at the time that the object is being added to the
dictionary collection.   Additionally, changes to the key attribute
are <strong>not tracked</strong>, which means the key in the dictionary is not
automatically synchronized with the key value on the target object
itself.  See <a class="reference internal" href="#key-collections-mutations"><span class="std std-ref">解决键变异和针对字典集合的反向填充</span></a> for further details.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.attribute_keyed_dict.params.attr_name"></span><strong>attr_name</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.attribute_keyed_dict.params.attr_name">¶</a> – string name of an ORM-mapped attribute
on the mapped class, the value of which on a particular instance
is to be used as the key for a new dictionary entry for that instance.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.attribute_keyed_dict.params.ignore_unpopulated_attribute"></span><strong>ignore_unpopulated_attribute</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.attribute_keyed_dict.params.ignore_unpopulated_attribute">¶</a> – <p>if True, and the target attribute
on an object is not populated at all, the operation will be silently
skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the attribute
being used for the dictionary key is determined that it was never
populated with any value.  The
<a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">attribute_keyed_dict.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped.
This is in contrast to the behavior of the 1.x series which would
erroneously populate the value in the dictionary with an arbitrary key
value of <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.column_keyed_dict">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">column_keyed_dict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mapping_spec</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_VT</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_unpopulated_attribute</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.mapped_collection.KeyFuncDict"><span class="pre">KeyFuncDict</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_KT</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.column_keyed_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with column-based keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.column_mapped_collection" title="sqlalchemy.orm.column_mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">column_mapped_collection</span></code></a> to
<code class="xref py py-class docutils literal notranslate"><span class="pre">column_keyed_dict</span></code>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory which will produce new
dictionary keys based on the value of a particular <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>-mapped
attribute on ORM mapped instances to be added to the dictionary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the value of the target attribute must be assigned with its
value at the time that the object is being added to the
dictionary collection.   Additionally, changes to the key attribute
are <strong>not tracked</strong>, which means the key in the dictionary is not
automatically synchronized with the key value on the target object
itself.  See <a class="reference internal" href="#key-collections-mutations"><span class="std std-ref">解决键变异和针对字典集合的反向填充</span></a> for further details.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.column_keyed_dict.params.mapping_spec"></span><strong>mapping_spec</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.column_keyed_dict.params.mapping_spec">¶</a> – a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object that is expected
to be mapped by the target mapper to a particular attribute on the
mapped class, the value of which on a particular instance is to be used
as the key for a new dictionary entry for that instance.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.column_keyed_dict.params.ignore_unpopulated_attribute"></span><strong>ignore_unpopulated_attribute</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.column_keyed_dict.params.ignore_unpopulated_attribute">¶</a> – <p>if True, and the mapped attribute
indicated by the given <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> target attribute
on an object is not populated at all, the operation will be silently
skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the attribute
being used for the dictionary key is determined that it was never
populated with any value.  The
<a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">column_keyed_dict.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped.
This is in contrast to the behavior of the 1.x series which would
erroneously populate the value in the dictionary with an arbitrary key
value of <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.keyfunc_mapping">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">keyfunc_mapping</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">keyfunc</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_F</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_unpopulated_attribute</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.mapped_collection.KeyFuncDict"><span class="pre">KeyFuncDict</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_KT</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.keyfunc_mapping" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with arbitrary keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.mapped_collection" title="sqlalchemy.orm.mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">mapped_collection</span></code></a> to
<a class="reference internal" href="#sqlalchemy.orm.keyfunc_mapping" title="sqlalchemy.orm.keyfunc_mapping"><code class="xref py py-func docutils literal notranslate"><span class="pre">keyfunc_mapping()</span></code></a>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory with a keying function
generated from keyfunc, a callable that takes an entity and returns a
key value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the given keyfunc is called only once at the time that the
target object is being added to the collection.   Changes to the
effective value returned by the function are not tracked.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.keyfunc_mapping.params.keyfunc"></span><strong>keyfunc</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.keyfunc_mapping.params.keyfunc">¶</a> – a callable that will be passed the ORM-mapped instance
which should then generate a new key to use in the dictionary.
If the value returned is <a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a>, an error
is raised.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.keyfunc_mapping.params.ignore_unpopulated_attribute"></span><strong>ignore_unpopulated_attribute</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.keyfunc_mapping.params.ignore_unpopulated_attribute">¶</a> – <p>if True, and the callable returns
<a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a> for a particular instance, the
operation will be silently skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the callable
being used for the dictionary key returns
<a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a>, which in an ORM attribute
context indicates an attribute that was never populated with any value.
The <a class="reference internal" href="#sqlalchemy.orm.mapped_collection.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.mapped_collection"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_collection.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped. This is
in contrast to the behavior of the 1.x series which would erroneously
populate the value in the dictionary with an arbitrary key value of
<code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.attribute_mapped_collection">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">attribute_mapped_collection</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;function</span> <span class="pre">attribute_keyed_dict&gt;</span></em><a class="headerlink" href="#sqlalchemy.orm.attribute_mapped_collection" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with attribute-based keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.attribute_mapped_collection" title="sqlalchemy.orm.attribute_mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">attribute_mapped_collection</span></code></a> to
<a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory which will produce new
dictionary keys based on the value of a particular named attribute on
ORM mapped instances to be added to the dictionary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the value of the target attribute must be assigned with its
value at the time that the object is being added to the
dictionary collection.   Additionally, changes to the key attribute
are <strong>not tracked</strong>, which means the key in the dictionary is not
automatically synchronized with the key value on the target object
itself.  See <a class="reference internal" href="#key-collections-mutations"><span class="std std-ref">解决键变异和针对字典集合的反向填充</span></a> for further details.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>attr_name</strong> – string name of an ORM-mapped attribute
on the mapped class, the value of which on a particular instance
is to be used as the key for a new dictionary entry for that instance.</p></li>
<li><p><strong>ignore_unpopulated_attribute</strong> – <p>if True, and the target attribute
on an object is not populated at all, the operation will be silently
skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the attribute
being used for the dictionary key is determined that it was never
populated with any value.  The
<a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">attribute_keyed_dict.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped.
This is in contrast to the behavior of the 1.x series which would
erroneously populate the value in the dictionary with an arbitrary key
value of <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.column_mapped_collection">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">column_mapped_collection</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;function</span> <span class="pre">column_keyed_dict&gt;</span></em><a class="headerlink" href="#sqlalchemy.orm.column_mapped_collection" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with column-based keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.column_mapped_collection" title="sqlalchemy.orm.column_mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">column_mapped_collection</span></code></a> to
<code class="xref py py-class docutils literal notranslate"><span class="pre">column_keyed_dict</span></code>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory which will produce new
dictionary keys based on the value of a particular <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>-mapped
attribute on ORM mapped instances to be added to the dictionary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the value of the target attribute must be assigned with its
value at the time that the object is being added to the
dictionary collection.   Additionally, changes to the key attribute
are <strong>not tracked</strong>, which means the key in the dictionary is not
automatically synchronized with the key value on the target object
itself.  See <a class="reference internal" href="#key-collections-mutations"><span class="std std-ref">解决键变异和针对字典集合的反向填充</span></a> for further details.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mapping_spec</strong> – a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object that is expected
to be mapped by the target mapper to a particular attribute on the
mapped class, the value of which on a particular instance is to be used
as the key for a new dictionary entry for that instance.</p></li>
<li><p><strong>ignore_unpopulated_attribute</strong> – <p>if True, and the mapped attribute
indicated by the given <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> target attribute
on an object is not populated at all, the operation will be silently
skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the attribute
being used for the dictionary key is determined that it was never
populated with any value.  The
<a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">column_keyed_dict.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped.
This is in contrast to the behavior of the 1.x series which would
erroneously populate the value in the dictionary with an arbitrary key
value of <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.mapped_collection">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">mapped_collection</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;function</span> <span class="pre">keyfunc_mapping&gt;</span></em><a class="headerlink" href="#sqlalchemy.orm.mapped_collection" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary-based collection type with arbitrary keying.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <a class="reference internal" href="#sqlalchemy.orm.mapped_collection" title="sqlalchemy.orm.mapped_collection"><code class="xref py py-data docutils literal notranslate"><span class="pre">mapped_collection</span></code></a> to
<a class="reference internal" href="#sqlalchemy.orm.keyfunc_mapping" title="sqlalchemy.orm.keyfunc_mapping"><code class="xref py py-func docutils literal notranslate"><span class="pre">keyfunc_mapping()</span></code></a>.</p>
</div>
<p>Returns a <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> factory with a keying function
generated from keyfunc, a callable that takes an entity and returns a
key value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the given keyfunc is called only once at the time that the
target object is being added to the collection.   Changes to the
effective value returned by the function are not tracked.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a> - background on use</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>keyfunc</strong> – a callable that will be passed the ORM-mapped instance
which should then generate a new key to use in the dictionary.
If the value returned is <a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a>, an error
is raised.</p></li>
<li><p><strong>ignore_unpopulated_attribute</strong> – <p>if True, and the callable returns
<a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a> for a particular instance, the
operation will be silently skipped.  By default, an error is raised.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0: </span>an error is raised by default if the callable
being used for the dictionary key returns
<a class="reference internal" href="internals.html#sqlalchemy.orm.LoaderCallableStatus.NO_VALUE" title="sqlalchemy.orm.LoaderCallableStatus.NO_VALUE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">LoaderCallableStatus.NO_VALUE</span></code></a>, which in an ORM attribute
context indicates an attribute that was never populated with any value.
The <a class="reference internal" href="#sqlalchemy.orm.mapped_collection.params.ignore_unpopulated_attribute" title="sqlalchemy.orm.mapped_collection"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_collection.ignore_unpopulated_attribute</span></code></a>
parameter may be set which will instead indicate that this condition
should be ignored, and the append operation silently skipped. This is
in contrast to the behavior of the 1.x series which would erroneously
populate the value in the dictionary with an arbitrary key value of
<code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">KeyFuncDict</span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict" title="Permalink to this definition">¶</a></dt>
<dd><p>Base for ORM mapped dictionary classes.</p>
<p>Extends the <code class="docutils literal notranslate"><span class="pre">dict</span></code> type with additional methods needed by SQLAlchemy ORM
collection classes. Use of <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> is most directly
by using the <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> or
<a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a> class factories.
<a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> may also serve as the base for user-defined
custom dictionary classes.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedCollection</span></code> to
<a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a></p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a></p>
<p><a class="reference internal" href="#orm-custom-collection"><span class="std std-ref">定制集合实现</span></a></p>
</div>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.__init__"><span class="sig-name descname">__init__()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.clear"><span class="sig-name descname">clear()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.pop"><span class="sig-name descname">pop()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.popitem"><span class="sig-name descname">popitem()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.remove"><span class="sig-name descname">remove()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.set"><span class="sig-name descname">set()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.setdefault"><span class="sig-name descname">setdefault()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict.update"><span class="sig-name descname">update()</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict</span></code></a> (<code class="docutils literal notranslate"><span class="pre">builtins.dict</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.__init__">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">keyfunc</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_F</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">dict_args</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_unpopulated_attribute</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a new collection with keying provided by keyfunc.</p>
<p>keyfunc may be any callable that takes an object and returns an object
for use as a dictionary key.</p>
<p>The keyfunc will be called every time the ORM needs to add a member by
value-only (such as when loading instances from the database) or
remove a member.  The usual cautions about dictionary keying apply-
<code class="docutils literal notranslate"><span class="pre">keyfunc(object)</span></code> should return the same output for the life of the
collection.  Keying based on mutable properties can result in
unreachable instances “lost” in the collection.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.clear">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">clear</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None.</span>&#160; <span class="pre">Remove</span> <span class="pre">all</span> <span class="pre">items</span> <span class="pre">from</span> <span class="pre">D.</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.clear" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.pop">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">pop</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">k</span></span></em><span class="optional">[</span>, <em class="sig-param"><span class="n"><span class="pre">d</span></span></em><span class="optional">]</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">v,</span> <span class="pre">remove</span> <span class="pre">specified</span> <span class="pre">key</span> <span class="pre">and</span> <span class="pre">return</span> <span class="pre">the</span> <span class="pre">corresponding</span> <span class="pre">value.</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.pop" title="Permalink to this definition">¶</a></dt>
<dd><p>If the key is not found, return the default if given; otherwise,
raise a KeyError.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.popitem">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">popitem</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.popitem" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove and return a (key, value) pair as a 2-tuple.</p>
<p>Pairs are returned in LIFO (last-in, first-out) order.
Raises KeyError if the dict is empty.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.remove">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_KT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_sa_initiator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.orm.AttributeEventToken" title="sqlalchemy.orm.AttributeEventToken"><span class="pre">AttributeEventToken</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Literal</span><span class="p"><span class="pre">[</span></span><span class="pre">None</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="k"><span class="pre">False</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.remove" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove an item by value, consulting the keyfunc for the key.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.set">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">set</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_KT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_sa_initiator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="internals.html#sqlalchemy.orm.AttributeEventToken" title="sqlalchemy.orm.AttributeEventToken"><span class="pre">AttributeEventToken</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Literal</span><span class="p"><span class="pre">[</span></span><span class="pre">None</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="k"><span class="pre">False</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.set" title="Permalink to this definition">¶</a></dt>
<dd><p>Add an item by value, consulting the keyfunc for the key.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.setdefault">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">setdefault</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.setdefault" title="Permalink to this definition">¶</a></dt>
<dd><p>Insert key with a value of default if key is not in the dictionary.</p>
<p>Return the value for key if key is in the dictionary, else default.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.KeyFuncDict.update">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.KeyFuncDict.</span></code></a><span class="sig-name descname"><span class="pre">update</span></span><span class="sig-paren">(</span><span class="optional">[</span><em class="sig-param"><span class="n"><span class="pre">E</span></span></em>, <span class="optional">]</span><em class="sig-param"><span class="n"><span class="pre">**F</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None.</span>&#160; <span class="pre">Update</span> <span class="pre">D</span> <span class="pre">from</span> <span class="pre">dict/iterable</span> <span class="pre">E</span> <span class="pre">and</span> <span class="pre">F.</span></span></span><a class="headerlink" href="#sqlalchemy.orm.KeyFuncDict.update" title="Permalink to this definition">¶</a></dt>
<dd><p>If E is present and has a .keys() method, then does:  for k in E: D[k] = E[k]
If E is present and lacks a .keys() method, then does:  for k, v in E: D[k] = v
In either case, this is followed by: for k in F:  D[k] = F[k]</p>
</dd></dl>

</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.MappedCollection">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">MappedCollection</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;class</span> <span class="pre">'sqlalchemy.orm.mapped_collection.KeyFuncDict'&gt;</span></em><a class="headerlink" href="#sqlalchemy.orm.MappedCollection" title="Permalink to this definition">¶</a></dt>
<dd><p>Base for ORM mapped dictionary classes.</p>
<p>Extends the <code class="docutils literal notranslate"><span class="pre">dict</span></code> type with additional methods needed by SQLAlchemy ORM
collection classes. Use of <a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> is most directly
by using the <a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a> or
<a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a> class factories.
<a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a> may also serve as the base for user-defined
custom dictionary classes.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>Renamed <code class="xref py py-class docutils literal notranslate"><span class="pre">MappedCollection</span></code> to
<a class="reference internal" href="#sqlalchemy.orm.KeyFuncDict" title="sqlalchemy.orm.KeyFuncDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyFuncDict</span></code></a>.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.orm.attribute_keyed_dict" title="sqlalchemy.orm.attribute_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">attribute_keyed_dict()</span></code></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.column_keyed_dict" title="sqlalchemy.orm.column_keyed_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_keyed_dict()</span></code></a></p>
<p><a class="reference internal" href="#orm-dictionary-collection"><span class="std std-ref">字典集合订制</span></a></p>
<p><a class="reference internal" href="#orm-custom-collection"><span class="std std-ref">定制集合实现</span></a></p>
</div>
</dd></dl>

</section>
<section id="id26">
<h2>集合内部<a class="headerlink" href="#id26" title="Permalink to this heading">¶</a></h2>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.bulk_replace"><span class="sig-name descname">bulk_replace</span></a>(values, existing_adapter, new_adapter[, initiator])</p></td>
<td><p>Load a new collection, firing events based on prior like membership.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><span class="sig-name descname">collection</span></a></p></td>
<td><p>Decorators for entity collection classes.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.collection_adapter"><span class="sig-name descname">collection_adapter</span></a></p></td>
<td><p>attrgetter(attr, …) –&gt; attrgetter object</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter"><span class="sig-name descname">CollectionAdapter</span></a></p></td>
<td><p>Bridges between the ORM and arbitrary Python collections.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedDict"><span class="sig-name descname">InstrumentedDict</span></a></p></td>
<td><p>An instrumented version of the built-in dict.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedList"><span class="sig-name descname">InstrumentedList</span></a></p></td>
<td><p>An instrumented version of the built-in list.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedSet"><span class="sig-name descname">InstrumentedSet</span></a></p></td>
<td><p>An instrumented version of the built-in set.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.collections.prepare_instrumentation"><span class="sig-name descname">prepare_instrumentation</span></a>(factory)</p></td>
<td><p>Prepare a callable for future use as a collection class factory.</p></td>
</tr>
</tbody>
</table>
<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.bulk_replace">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">bulk_replace</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">values</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">existing_adapter</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_adapter</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">initiator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.bulk_replace" title="Permalink to this definition">¶</a></dt>
<dd><p>Load a new collection, firing events based on prior like membership.</p>
<p>Appends instances in <code class="docutils literal notranslate"><span class="pre">values</span></code> onto the <code class="docutils literal notranslate"><span class="pre">new_adapter</span></code>. Events will be
fired for any instance not present in the <code class="docutils literal notranslate"><span class="pre">existing_adapter</span></code>.  Any
instances in <code class="docutils literal notranslate"><span class="pre">existing_adapter</span></code> not present in <code class="docutils literal notranslate"><span class="pre">values</span></code> will have
remove events fired upon them.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.collections.bulk_replace.params.values"></span><strong>values</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.collections.bulk_replace.params.values">¶</a> – An iterable of collection member instances</p></li>
<li><p><span class="target" id="sqlalchemy.orm.collections.bulk_replace.params.existing_adapter"></span><strong>existing_adapter</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.collections.bulk_replace.params.existing_adapter">¶</a> – A <a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter" title="sqlalchemy.orm.collections.CollectionAdapter"><code class="xref py py-class docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a> of
instances to be replaced</p></li>
<li><p><span class="target" id="sqlalchemy.orm.collections.bulk_replace.params.new_adapter"></span><strong>new_adapter</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.collections.bulk_replace.params.new_adapter">¶</a> – An empty <a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter" title="sqlalchemy.orm.collections.CollectionAdapter"><code class="xref py py-class docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a>
to load with <code class="docutils literal notranslate"><span class="pre">values</span></code></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">collection</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.collection" title="Permalink to this definition">¶</a></dt>
<dd><p>Decorators for entity collection classes.</p>
<p>The decorators fall into two groups: annotations and interception recipes.</p>
<p>The annotating decorators (appender, remover, iterator, converter,
internally_instrumented) indicate the method’s purpose and take no
arguments.  They are not written with parens:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">appender</span>
<span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>The recipe decorators all require parens, even those that take no
arguments:</p>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.orm.collections.collection.adds"><span class="sig-name descname">adds()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.appender"><span class="sig-name descname">appender()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.converter"><span class="sig-name descname">converter()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.internally_instrumented"><span class="sig-name descname">internally_instrumented()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.iterator"><span class="sig-name descname">iterator()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.remover"><span class="sig-name descname">remover()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes"><span class="sig-name descname">removes()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes_return"><span class="sig-name descname">removes_return()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.collections.collection.replaces"><span class="sig-name descname">replaces()</span></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">adds</span><span class="p">(</span><span class="s1">&#39;entity&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span> <span class="o">...</span>

<span class="nd">@collection</span><span class="o">.</span><span class="n">removes_return</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.adds">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">adds</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.adds" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark the method as adding an entity to the collection.</p>
<p>Adds “add to collection” handling to the method.  The decorator
argument indicates which method argument holds the SQLAlchemy-relevant
value.  Arguments can be specified positionally (i.e. integer) or by
name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">adds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="o">...</span>

<span class="nd">@collection</span><span class="o">.</span><span class="n">adds</span><span class="p">(</span><span class="s1">&#39;entity&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.appender">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">appender</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.appender" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as the collection appender.</p>
<p>The appender method is called with one positional argument: the value
to append. The method will be automatically decorated with ‘adds(1)’
if not already decorated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">appender</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span> <span class="o">...</span>

<span class="c1"># or, equivalently</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">appender</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">adds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span> <span class="o">...</span>

<span class="c1"># for mapping type, an &#39;append&#39; may kick out a previous value</span>
<span class="c1"># that occupies that slot.  consider d[&#39;a&#39;] = &#39;foo&#39;- any previous</span>
<span class="c1"># value in d[&#39;a&#39;] is discarded.</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">appender</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">replaces</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">some_key_func</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="n">previous</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
    <span class="k">return</span> <span class="n">previous</span></pre></div>
</div>
<p>If the value to append is not allowed in the collection, you may
raise an exception.  Something to remember is that the appender
will be called for each object mapped by a database query.  If the
database contains rows that violate your collection semantics, you
will need to get creative to fix the problem, as access via the
collection will not work.</p>
<p>If the appender method is internally instrumented, you must also
receive the keyword argument ‘_sa_initiator’ and ensure its
promulgation to collection events.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.converter">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">converter</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.converter" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as the collection converter.</p>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 1.3: </span>The <a class="reference internal" href="#sqlalchemy.orm.collections.collection.converter" title="sqlalchemy.orm.collections.collection.converter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">collection.converter()</span></code></a> handler is deprecated and will be removed in a future release.  Please refer to the <code class="xref py py-class docutils literal notranslate"><span class="pre">bulk_replace</span></code> listener interface in conjunction with the <a class="reference internal" href="../core/event.html#sqlalchemy.event.listen" title="sqlalchemy.event.listen"><code class="xref py py-func docutils literal notranslate"><span class="pre">listen()</span></code></a> function.</p>
</div>
<p>This optional method will be called when a collection is being
replaced entirely, as in:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myobj</span><span class="o">.</span><span class="n">acollection</span> <span class="o">=</span> <span class="p">[</span><span class="n">newvalue1</span><span class="p">,</span> <span class="n">newvalue2</span><span class="p">]</span></pre></div>
</div>
<p>The converter method will receive the object being assigned and should
return an iterable of values suitable for use by the <code class="docutils literal notranslate"><span class="pre">appender</span></code>
method.  A converter must not assign values or mutate the collection,
its sole job is to adapt the value the user provides into an iterable
of values for the ORM’s use.</p>
<p>The default converter implementation will use duck-typing to do the
conversion.  A dict-like collection will be convert into an iterable
of dictionary values, and other types will simply be iterated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">converter</span>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>If the duck-typing of the object does not match the type of this
collection, a TypeError is raised.</p>
<p>Supply an implementation of this method if you want to expand the
range of possible types that can be assigned in bulk or perform
validation on the values about to be assigned.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.internally_instrumented">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">internally_instrumented</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.internally_instrumented" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as instrumented.</p>
<p>This tag will prevent any decoration from being applied to the
method. Use this if you are orchestrating your own calls to
<code class="xref py py-func docutils literal notranslate"><span class="pre">collection_adapter()</span></code> in one of the basic SQLAlchemy
interface methods, or to prevent an automatic ABC method
decoration from wrapping your implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># normally an &#39;extend&#39; method on a list-like class would be</span>
<span class="c1"># automatically intercepted and re-implemented in terms of</span>
<span class="c1"># SQLAlchemy events and append().  your implementation will</span>
<span class="c1"># never be called, unless:</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">internally_instrumented</span>
<span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.iterator">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">iterator</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.iterator" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as the collection remover.</p>
<p>The iterator method is called with no arguments.  It is expected to
return an iterator over all collection members:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">iterator</span>
<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.remover">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">remover</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fn</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.remover" title="Permalink to this definition">¶</a></dt>
<dd><p>Tag the method as the collection remover.</p>
<p>The remover method is called with one positional argument: the value
to remove. The method will be automatically decorated with
<a class="reference internal" href="#sqlalchemy.orm.collections.collection.removes_return" title="sqlalchemy.orm.collections.collection.removes_return"><code class="xref py py-meth docutils literal notranslate"><span class="pre">removes_return()</span></code></a> if not already decorated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">remover</span>
<span class="k">def</span> <span class="nf">zap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span> <span class="o">...</span>

<span class="c1"># or, equivalently</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">remover</span>
<span class="nd">@collection</span><span class="o">.</span><span class="n">removes_return</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">zap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>If the value to remove is not present in the collection, you may
raise an exception or return None to ignore the error.</p>
<p>If the remove method is internally instrumented, you must also
receive the keyword argument ‘_sa_initiator’ and ensure its
promulgation to collection events.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.removes">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">removes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.removes" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark the method as removing an entity in the collection.</p>
<p>Adds “remove from collection” handling to the method.  The decorator
argument indicates which method argument holds the SQLAlchemy-relevant
value to be removed. Arguments can be specified positionally (i.e.
integer) or by name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">removes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>For methods where the value to remove is not known at call-time, use
collection.removes_return.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.removes_return">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">removes_return</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.removes_return" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark the method as removing an entity in the collection.</p>
<p>Adds “remove from collection” handling to the method.  The return
value of the method, if any, is considered the value to remove.  The
method arguments are not inspected:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">removes_return</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
<p>For methods where the value to remove is known at call-time, use
collection.remove.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection.replaces">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.collections.collection"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.collection.</span></code></a><em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">replaces</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arg</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.collections.collection.replaces" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark the method as replacing an entity in the collection.</p>
<p>Adds “add to collection” and “remove from collection” handling to
the method.  The decorator argument indicates which method argument
holds the SQLAlchemy-relevant value to be added, and return value, if
any will be considered the value to remove.</p>
<p>Arguments can be specified positionally (i.e. integer) or by name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@collection</span><span class="o">.</span><span class="n">replaces</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="o">...</span></pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.collection_adapter">
<span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">collection_adapter</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">operator.attrgetter('_sa_adapter')</span></em><a class="headerlink" href="#sqlalchemy.orm.collections.collection_adapter" title="Permalink to this definition">¶</a></dt>
<dd><p>attrgetter(attr, …) –&gt; attrgetter object</p>
<p>Return a callable object that fetches the given attribute(s) from its operand.
After f = attrgetter(‘name’), the call f(r) returns r.name.
After g = attrgetter(‘name’, ‘date’), the call g(r) returns (r.name, r.date).
After h = attrgetter(‘name.first’, ‘name.last’), the call h(r) returns
(r.name.first, r.name.last).</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.CollectionAdapter">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">CollectionAdapter</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.CollectionAdapter" title="Permalink to this definition">¶</a></dt>
<dd><p>Bridges between the ORM and arbitrary Python collections.</p>
<p>Proxies base-level collection operations (append, remove, iterate)
to the underlying Python collection, and emits add/remove events for
entities entering or leaving the collection.</p>
<p>The ORM uses <a class="reference internal" href="#sqlalchemy.orm.collections.CollectionAdapter" title="sqlalchemy.orm.collections.CollectionAdapter"><code class="xref py py-class docutils literal notranslate"><span class="pre">CollectionAdapter</span></code></a> exclusively for interaction with
entity collections.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.InstrumentedDict">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">InstrumentedDict</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.InstrumentedDict" title="Permalink to this definition">¶</a></dt>
<dd><p>An instrumented version of the built-in dict.</p>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedDict" title="sqlalchemy.orm.collections.InstrumentedDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.InstrumentedDict</span></code></a> (<code class="docutils literal notranslate"><span class="pre">builtins.dict</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.InstrumentedList">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">InstrumentedList</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.InstrumentedList" title="Permalink to this definition">¶</a></dt>
<dd><p>An instrumented version of the built-in list.</p>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedList" title="sqlalchemy.orm.collections.InstrumentedList"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.InstrumentedList</span></code></a> (<code class="docutils literal notranslate"><span class="pre">builtins.list</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.InstrumentedSet">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">InstrumentedSet</span></span><a class="headerlink" href="#sqlalchemy.orm.collections.InstrumentedSet" title="Permalink to this definition">¶</a></dt>
<dd><p>An instrumented version of the built-in set.</p>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.collections.InstrumentedSet" title="sqlalchemy.orm.collections.InstrumentedSet"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.collections.InstrumentedSet</span></code></a> (<code class="docutils literal notranslate"><span class="pre">builtins.set</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.collections.prepare_instrumentation">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.collections.</span></span><span class="sig-name descname"><span class="pre">prepare_instrumentation</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">factory</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><span class="pre">Collection</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_AdaptedCollectionProtocol</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_AdaptedCollectionProtocol</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.collections.prepare_instrumentation" title="Permalink to this definition">¶</a></dt>
<dd><p>Prepare a callable for future use as a collection class factory.</p>
<p>Given a collection class factory (either a type or no-arg callable),
return another factory that will produce compatible instances when
called.</p>
<p>This function is responsible for converting collection_class=list
into the run-time behavior of collection_class=InstrumentedList.</p>
</dd></dl>

</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="large_collections.html" title="previous chapter">处理大集合</a>
        Next:
        <a href="relationship_persistence.html" title="next chapter">特殊关系持久化模式</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 9:31:09

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


