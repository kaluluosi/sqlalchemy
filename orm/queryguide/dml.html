<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    支持 ORM 的 INSERT、UPDATE 和 DELETE 语句
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
        <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../../index.html" />
        <link rel="up" title="ORM查询指南" href="index.html" />
        <link rel="next" title="列载入选项" href="columns.html" />
        <link rel="prev" title="编写继承映射的SELECT语句" href="inheritance.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="../index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="../quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="../mapper_config.html">ORM映射类配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="../relationships.html">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="index.html">ORM查询指南</a></span><ul>
<li><span class="link-container"><a class="reference external" href="select.html">用ORM Mapper类编写SELECT语句</a></span></li>
<li><span class="link-container"><a class="reference external" href="inheritance.html">编写继承映射的SELECT语句</a></span></li>
<li class="selected"><span class="link-container"><strong>支持 ORM 的 INSERT、UPDATE 和 DELETE 语句</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-insert">ORM 批量 INSERT 语句</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#returning">使用 RETURNING 获取新对象</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-bulk-insert-returning-ordered">将返回记录与输入数据顺序相关联</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-insert-heterogeneous-params">使用异构参数字典</a></span></li>
<li><span class="link-container"><a class="reference external" href="#joined-table-inheritance-insert">Joined Table Inheritance 批量 INSERT</a></span></li>
<li><span class="link-container"><a class="reference external" href="#sql-orm">使用 SQL 表达式进行 ORM 批量插入</a></span></li>
<li><span class="link-container"><a class="reference external" href="#session">旧版 Session 批量插入方法</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-upsert">ORM “upsert” 语句</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm">ORM自定义更新和删除条件</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="columns.html">列载入选项</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系属性加载技术</a></span></li>
<li><span class="link-container"><a class="reference external" href="api.html">用于查询的ORM API特性</a></span></li>
<li><span class="link-container"><a class="reference external" href="query.html">旧版查询API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="../session.html">使用Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="../extending.html">事件和内部实现</a></span></li>
<li><span class="link-container"><a class="reference external" href="../extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="../examples.html">ORM Examples</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="inheritance.html" title="previous chapter">编写继承映射的SELECT语句</a></li>
                <li><b>Next:</b>
                <a href="columns.html" title="next chapter">列载入选项</a></li>

            <li><b>Up:</b> <a href="../../index.html">Home</a></li>
                    <ul><li><a href="../index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="index.html" title="ORM查询指南">ORM查询指南</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#orm-insertupdate-delete">支持 ORM 的 INSERT、UPDATE 和 DELETE 语句</a><ul>
<li><a class="reference internal" href="#orm-insert">ORM 批量 INSERT 语句</a><ul>
<li><a class="reference internal" href="#returning">使用 RETURNING 获取新对象</a><ul>
<li><a class="reference internal" href="#orm-queryguide-bulk-insert-returning-ordered">将返回记录与输入数据顺序相关联</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-queryguide-insert-heterogeneous-params">使用异构参数字典</a></li>
<li><a class="reference internal" href="#joined-table-inheritance-insert">Joined Table Inheritance 批量 INSERT</a></li>
<li><a class="reference internal" href="#sql-orm">使用 SQL 表达式进行 ORM 批量插入</a></li>
<li><a class="reference internal" href="#session">旧版 Session 批量插入方法</a></li>
<li><a class="reference internal" href="#orm-upsert">ORM “upsert” 语句</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm">ORM自定义更新和删除条件</a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-queryguide-dml" >
        
<section id="orm-insertupdate-delete">
<span id="orm-expression-update-delete"></span><h1>支持 ORM 的 INSERT、UPDATE 和 DELETE 语句<a class="headerlink" href="#orm-insertupdate-delete" title="Permalink to this heading">¶</a></h1>
<div class="admonition-about-this-document admonition">
<p class="admonition-title">About this Document （关于本文件）</p>
<p>本节使用 ORM 映射，可在 <a class="reference internal" href="../../tutorial/index.html#unified-tutorial"><span class="std std-ref">SQLAlchemy统一教程</span></a> 部分阐述的基础上处理 ORM-Enabled
<a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>, <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 和 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> 对象。
本节同时使用了继承映射在 <span class="xref std std-ref">inheritance_toplevel</span> 部分展示。</p>
<p>请查看本页相关的 <a class="reference internal" href="_dml_setup.html"><span class="doc">ORM 设置</span></a>。</p>
</div>
<p>在使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code> 方法处理 ORM-enabled <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> 对象的基础上，
该方法可以处理 ORM-enabled <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>, <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 和 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> 对象，从而以各种方式同时插入、更新或删除多个数据库行。
此外，对于 ORM-enabled “upserts”，即自动使用 UPDATE 为已存在的数据行插入的 INSERT 语句，不同的 SQL 方言提供了不同的支持。</p>
<p>下面的表总结了本文所讨论的各种调用形式：</p>
<section id="orm-insert">
<span id="orm-queryguide-bulk-insert"></span><h2>ORM 批量 INSERT 语句<a class="headerlink" href="#orm-insert" title="Permalink to this heading">¶</a></h2>
<p>可以通过 ORM 类以 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a> 构造，再将其传递给 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code> 方法来设置 ORM 批量 INSERT，通过在 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code> 参数中传递一个参数字典列表来触发。
除了 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 之外，还会优化此操作以尽可能的快速处理多行：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">insert</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">insert</span><span class="p">(</span><span class="n">User</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;spongebob&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sandy&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Sandy Cheeks&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;patrick&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Patrick Star&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;squidward&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Squidward Tentacles&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ehkrabs&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Eugene H. Krabs&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">{execsql}INSERT INTO user_account (name, fullname) VALUES (?, ?)</span>
<span class="go">[...] [(&#39;spongebob&#39;, &#39;Spongebob Squarepants&#39;), (&#39;sandy&#39;, &#39;Sandy Cheeks&#39;), (&#39;patrick&#39;, &#39;Patrick Star&#39;),</span>
<span class="go">(&#39;squidward&#39;, &#39;Squidward Tentacles&#39;), (&#39;ehkrabs&#39;, &#39;Eugene H. Krabs&#39;)]</span>
<span class="go">{stop}&lt;...&gt;</span></pre></div>
</div>
<p>参数字典包含键/值对，这些对应于与映射的 <a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 或 <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code> 声明相匹配的 ORM 映射属性，以及与 <a class="reference internal" href="../composites.html#mapper-composite"><span class="std std-ref">composite</span></a> 声明相一致的属性。如果这两个名称不同，
则键应与 ORM 映射属性名匹配。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>将 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造传递到 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code> 方法现在会调用“批量插入”功能，该功能使用的是与旧版 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings()</span></code> 方法相同的功能。这是与 1.x 系列相比的行为更改，1.x 系列会将 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 解释为基于 Core 的方式，使用列名称作为取值键；现在可以接受 ORM 属性键。可以为 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code> 的 <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execution_options</span></code> 参数传递执行选项 <cite>{“dml_strategy”: “raw”}</cite> 以提供 Core 级别的功能。</p>
</div>
<section id="returning">
<span id="orm-queryguide-bulk-insert-returning"></span><h3>使用 RETURNING 获取新对象<a class="headerlink" href="#returning" title="Permalink to this heading">¶</a></h3>
<p>对于支持 INSERT..RETURNING 语法的选定后端，ORM 批量插入功能支持还可对 SELECT 子句中返回的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code> 对象执行相同操作，并返回每个列以及完全构建的 ORM 对象。该操作要求所使用的后端支持 SQL RETURNING 语法以及带有 RETURNING 的 <a class="reference internal" href="../../glossary.html#term-executemany"><span class="xref std std-term">executemany</span></a> 支持；除了 MySQL（MariaDB 包括）之外的所有包括在内的 <a class="reference internal" href="../../dialects/index.html#included-dialects"><span class="std std-ref">SQLAlchemy-included</span></a> 后端都支持此功能。</p>
<p>例如，可以运行与之前相同的语句，使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a> 方法（将完整的“User”实体传递为返回值）：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">insert</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;spongebob&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sandy&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Sandy Cheeks&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;patrick&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Patrick Star&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;squidward&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Squidward Tentacles&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ehkrabs&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Eugene H. Krabs&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">{execsql}INSERT INTO user_account (name, fullname)</span>
<span class="go">VALUES (?, ?), (?, ?), (?, ?), (?, ?), (?, ?)</span>
<span class="go">RETURNING id, name, fullname, species</span>
<span class="go">[...] (&#39;spongebob&#39;, &#39;Spongebob Squarepants&#39;, &#39;sandy&#39;, &#39;Sandy Cheeks&#39;,</span>
<span class="go">&#39;patrick&#39;, &#39;Patrick Star&#39;, &#39;squidward&#39;, &#39;Squidward Tentacles&#39;,</span>
<span class="go">&#39;ehkrabs&#39;, &#39;Eugene H. Krabs&#39;)</span>
<span class="go">{stop}&gt;&gt;&gt; print(users.all())</span>
<span class="go">[User(name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),</span>
<span class="go"> User(name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;),</span>
<span class="go"> User(name=&#39;patrick&#39;, fullname=&#39;Patrick Star&#39;),</span>
<span class="go"> User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;),</span>
<span class="go"> User(name=&#39;ehkrabs&#39;, fullname=&#39;Eugene H. Krabs&#39;)]</span></pre></div>
</div>
<p>在上面的示例中，生成的 SQL 使用了 <span class="xref std std-ref">insertmanyvalues</span> 选项使用了将单个参数字典内嵌成单个 INSERT 语句的形式，以便可以使用 RETURNING。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.0: </span>ORM <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 现在在 ORM 上下文中解释 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>, <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 甚至 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> 构造中的 RETURNING 子句，在这些构造中可以混合列表达式和 ORM 映射实体，这些将通过 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a> 方法传递返回，并包括使用 ORM 结果传递时产生的 ORM mapView 映射的实体。此外还提供了对 ORM loader 选项（例如 <a class="reference internal" href="columns.html#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a> 和 <code class="xref py py-func docutils literal notranslate"><span class="pre">selectinload()</span></code>）的有限支持。</p>
</div>
<section id="orm-queryguide-bulk-insert-returning-ordered">
<span id="id1"></span><h4>将返回记录与输入数据顺序相关联<a class="headerlink" href="#orm-queryguide-bulk-insert-returning-ordered" title="Permalink to this heading">¶</a></h4>
<p>使用带有 RETURNING 的批量 INSERT 时，重要的是要注意，大多数数据库后端并没有正式保证按返回的顺序返回记录，包括没有保证其顺序与输入记录相对应的保证。对于需要确保 RETURNING 记录与输入数据相关的应用程序，可使用附加参数 :paramref:<a href="#id2"><span class="problematic" id="id3">`</span></a>_dml.Insert.returning.sort_by_parameter_order`（根据所使用的后端可能使用保持令牌的特殊 INSERT 表单（该令牌用于正确重新排序返回的行），或在某些情况下，例如在下面使用 SQLite 后端的示例中，操作将一次插入一行：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pearl&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Pearl Krabs&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;plankton&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Plankton&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;gary&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Gary&quot;</span><span class="p">},</span>
<span class="gp">... </span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_ids</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">insert</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sort_by_parameter_order</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">data</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">{execsql}INSERT INTO user_account (name, fullname) VALUES (?, ?) RETURNING id</span>
<span class="go">[... (insertmanyvalues) 1/3 (ordered; batch not supported)] (&#39;pearl&#39;, &#39;Pearl Krabs&#39;)</span>
<span class="go">INSERT INTO user_account (name, fullname) VALUES (?, ?) RETURNING id</span>
<span class="go">[insertmanyvalues 2/3 (ordered; batch not supported)] (&#39;plankton&#39;, &#39;Plankton&#39;)</span>
<span class="go">INSERT INTO user_account (name, fullname) VALUES (?, ?) RETURNING id</span>
<span class="go">[insertmanyvalues 3/3 (ordered; batch not supported)] (&#39;gary&#39;, &#39;Gary&#39;)</span>
<span class="go">{stop}&gt;&gt;&gt; for user_id, input_record in zip(user_ids, data):</span>
<span class="go">...     input_record[&quot;id&quot;] = user_id</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="go">[{&#39;name&#39;: &#39;pearl&#39;, &#39;fullname&#39;: &#39;Pearl Krabs&#39;, &#39;id&#39;: 6},</span>
<span class="go">{&#39;name&#39;: &#39;plankton&#39;, &#39;fullname&#39;: &#39;Plankton&#39;, &#39;id&#39;: 7},</span>
<span class="go">{&#39;name&#39;: &#39;gary&#39;, &#39;fullname&#39;: &#39;Gary&#39;, &#39;id&#39;: 8}]</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.10: </span>添加了 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning.params.sort_by_parameter_order" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.returning.sort_by_parameter_order</span></code></a>，该参数在 <a class="reference internal" href="../../glossary.html#term-insertmanyvalues"><span class="xref std std-term">insertmanyvalues</span></a> 架构中实现。</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues-returning-order"><span class="std std-ref">将返回行与参数集相关联</span></a> - 这里介绍了在不显著降低性能的情况下保证输入数据与结果行对应的方法的背景知识</p>
</div>
</section>
</section>
<section id="orm-queryguide-insert-heterogeneous-params">
<span id="id4"></span><h3>使用异构参数字典<a class="headerlink" href="#orm-queryguide-insert-heterogeneous-params" title="Permalink to this heading">¶</a></h3>
<p>ORM 批量插入功能支持异构的参数字典列表，”异构” 基本上意味着”每个字典中的键可能不同”。当检测到此条件时，
ORM 将会根据每组键将这些参数字典分为一组并进行批处理：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">insert</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span>
<span class="gp">... </span>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;spongebob&quot;</span><span class="p">,</span>
<span class="gp">... </span>            <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Spongebob Squarepants&quot;</span><span class="p">,</span>
<span class="gp">... </span>            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;Sea Sponge&quot;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sandy&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Sandy Cheeks&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;Squirrel&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;patrick&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;Starfish&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span>
<span class="gp">... </span>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;squidward&quot;</span><span class="p">,</span>
<span class="gp">... </span>            <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Squidward Tentacles&quot;</span><span class="p">,</span>
<span class="gp">... </span>            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;Squid&quot;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ehkrabs&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Eugene H. Krabs&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;Crab&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">{execsql}INSERT INTO user_account (name, fullname, species)</span>
<span class="go">VALUES (?, ?, ?), (?, ?, ?) RETURNING id, name, fullname, species</span>
<span class="go">[... (insertmanyvalues) 1/1 (unordered)] (&#39;spongebob&#39;, &#39;Spongebob Squarepants&#39;, &#39;Sea Sponge&#39;,</span>
<span class="go">&#39;sandy&#39;, &#39;Sandy Cheeks&#39;, &#39;Squirrel&#39;)</span>
<span class="go">INSERT INTO user_account (name, species)</span>
<span class="go">VALUES (?, ?) RETURNING id, name, fullname, species</span>
<span class="go">[...] (&#39;patrick&#39;, &#39;Starfish&#39;)</span>
<span class="go">INSERT INTO user_account (name, fullname, species)</span>
<span class="go">VALUES (?, ?, ?), (?, ?, ?) RETURNING id, name, fullname, species</span>
<span class="go">[... (insertmanyvalues) 1/1 (unordered)] (&#39;squidward&#39;, &#39;Squidward Tentacles&#39;,</span>
<span class="go">&#39;Squid&#39;, &#39;ehkrabs&#39;, &#39;Eugene H. Krabs&#39;, &#39;Crab&#39;)</span></pre></div>
</div>
<p>在上面的示例中，传递的五个参数字典分别对应着三个 INSERT 语句，因为每个字典都有特定的键集，因此可以分组，单独处理。</p>
</section>
<section id="joined-table-inheritance-insert">
<span id="orm-queryguide-insert-joined-table-inheritance"></span><h3>Joined Table Inheritance 批量 INSERT<a class="headerlink" href="#joined-table-inheritance-insert" title="Permalink to this heading">¶</a></h3>
<p>ORM 批量插入是在内部单元工作系统中加以实现的。该系统用于生成 INSERT 语句，因此对于多个映射到多个表格的 ORM 实体（通常是使用 <a class="reference internal" href="../inheritance.html#joined-inheritance"><span class="std std-ref">joined table inheritance</span></a> 进行映射的实体），批量 INSERT 操作将为由映射表示的每个表格发出一个 INSERT 语句，并将服务器生成的主键值正确传输到依赖于它们的表格行中。在这里还支持 RETURNING，即 ORM 将接收每条 INSERT 语句执行的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code> 对象，然后“水平拼合”它们，以便返回的行包括所有插入的值：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">managers</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">insert</span><span class="p">(</span><span class="n">Manager</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">Manager</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">[</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sandy&quot;</span><span class="p">,</span> <span class="s2">&quot;manager_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sandy Cheeks&quot;</span><span class="p">},</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ehkrabs&quot;</span><span class="p">,</span> <span class="s2">&quot;manager_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Eugene H. Krabs&quot;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">{execsql}INSERT INTO employee (name, type) VALUES (?, ?) RETURNING id, name, type</span>
<span class="go">[... (insertmanyvalues) 1/2 (ordered; batch not supported)] (&#39;sandy&#39;, &#39;manager&#39;)</span>
<span class="go">INSERT INTO employee (name, type) VALUES (?, ?) RETURNING id, name, type</span>
<span class="go">[insertmanyvalues 2/2 (ordered; batch not supported)] (&#39;ehkrabs&#39;, &#39;manager&#39;)</span>
<span class="go">INSERT INTO manager (id, manager_name) VALUES (?, ?), (?, ?) RETURNING id, manager_name, id AS id__1</span>
<span class="go">[... (insertmanyvalues) 1/1 (ordered)] (1, &#39;Sandy Cheeks&#39;, 2, &#39;Eugene H. Krabs&#39;)</span></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>批量插入：加入继承映射需要 ORM 在内部使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning.params.sort_by_parameter_order" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.returning.sort_by_parameter_order</span></code></a> 来解析它们，以便可以将来自 RETURNING 的主键值对应到用于插入到“子”表中的参数集中，这就是为什么上面使用 SQLite 后端透明地降级为使用非批处理语句的原因。</p>
</div>
</section>
<section id="sql-orm">
<span id="orm-queryguide-bulk-insert-w-sql"></span><h3>使用 SQL 表达式进行 ORM 批量插入<a class="headerlink" href="#sql-orm" title="Permalink to this heading">¶</a></h3>
<p>ORM 批量插入支持添加一组固定的参数，该组参数可能包括用于每个目标行的 SQL 表达式。为此，请将 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 方法与通常的批量调用形式组合使用，通过在 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code> 中包括一个具有单独行参数字典的参数字典列表来传递。</p>
<p>例如，假设 ORM 映射包括“timestamp”列：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>


<span class="k">class</span> <span class="nc">LogRecord</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;log_record&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">code</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>如果我们想要插入一系列带有唯一“message”字段的“LogRecord”元素，但是我们希望在所有行中都应用 SQL 函数 “now()”，我们可以通过将 “timestamp” 存储在 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 中来实现，然后使用“批量”模式传递额外的记录。:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_record_result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(LogRecord).values(code=&quot;SQLA&quot;, timestamp=func.now()).returning(LogRecord),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #1&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #2&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #3&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #4&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">log_record</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span>
<span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">unordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;log message #1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #2&#39;</span><span class="p">,</span>
<span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #4&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">log_record_result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[LogRecord(&#39;log message #1&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go"> LogRecord(&#39;log message #2&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go"> LogRecord(&#39;log message #3&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go"> LogRecord(&#39;log message #4&#39;, &#39;SQLA&#39;, datetime.datetime(...))]</span></pre></div>
</div>
<p>由于使用了 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a>，所以不会使用批量 ORM 插入模式。</p>
<p>以下特征将不可用：</p>
<ul class="simple">
<li><p>不支持 <a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">Joined table inheritance</span></a> 或其他多表映射，因为这需要多个 INSERT 语句。</p></li>
<li><p>不支持 <a class="reference internal" href="#orm-queryguide-insert-heterogeneous-params"><span class="std std-ref">Heterogenous parameter sets</span></a>。每个 VALUES 集元素必须具有相同的列。</p></li>
<li><p>不可用 Core 级别的规模优化，例如 <span class="xref std std-ref">insertmanyvalues</span> 的批处理; 语句需要确保参数总数不超过备份数据库强制规定的限制。</p></li>
</ul>
<p>出于这些原因，通常不建议在 ORM INSERT 语句中使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 的多个参数集，除非存在明确理由，即正在使用“upsert”或需要在每个参数集中嵌入每行的 SQL 表达式。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-upsert"><span class="std std-ref">ORM “upsert” 语句</span></a></p>
</div>
</section>
<section id="session">
<span id="orm-queryguide-legacy-bulk-insert"></span><h3>旧版 Session 批量插入方法<a class="headerlink" href="#session" title="Permalink to this heading">¶</a></h3>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> 包括处理“批量” INSERT 和 UPDATE 语句的旧版方法。这些方法使用与描述在 <a class="reference internal" href="#orm-queryguide-bulk-insert"><span class="std std-ref">ORM 批量 INSERT 语句</span></a> 和 <span class="xref std std-ref">orm_queryguide_bulk_update</span> 中的 SQLAlchemy 2.0 版本具有相同实现，但不支持很多功能，即没有与回收支持，也不支持使用 RETURNING。</p>
<p>例如，使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings()</span></code> 的代码可以移植如下：</p>
<blockquote>
<div><p>session.bulk_insert_mappings(User, [{“name”: “u1”}, {“name”: “u2”}, {“name”: “u3”}])</p>
</div></blockquote>
<p>上述代码可以用新 API 如下语句表示：</p>
<blockquote>
<div><p>from sqlalchemy import insert</p>
<p>session.execute(insert(User), [{“name”: “u1”}, {“name”: “u2”}, {“name”: “u3”}])</p>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="xref std std-ref">orm_queryguide_legacy_bulk_update</span></p>
</div>
</section>
<section id="orm-upsert">
<span id="orm-queryguide-upsert"></span><h3>ORM “upsert” 语句<a class="headerlink" href="#orm-upsert" title="Permalink to this heading">¶</a></h3>
<p>使用 SQLAlchemy 的标准 SQL 方言，可能包括有特殊支持 upsert的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造，它还具有将现有的参数集的行转换为近似 UPDATE 语句的能力。由“现有行”指的是行，这些行具有相同的主键值，或者是在行中被认为是唯一的索引列；这取决于所使用的后端的能力。</p>
<p>包括具有特定于 SQL 的“upsert” API 功能的 SQLAlchemy 随附方言是：</p>
<ul class="simple">
<li><p>SQLite - 使用 <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.Insert" title="sqlalchemy.dialects.sqlite.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>，在 <a class="reference internal" href="../../dialects/sqlite.html#sqlite-on-conflict-insert"><span class="std std-ref">INSERT…ON CONFLICT (Upsert)</span></a> 中记录</p></li>
<li><p>PostgreSQL - 使用 <a class="reference internal" href="../../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Insert" title="sqlalchemy.dialects.postgresql.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>，在 <a class="reference internal" href="../../dialects/postgresql.html#postgresql-insert-on-conflict"><span class="std std-ref">INSERT…ON CONFLICT (Upsert)</span></a> 中记录</p></li>
<li><p>MySQL/MariaDB - 使用 <a class="reference internal" href="../../dialects/mysql.html#sqlalchemy.dialects.mysql.Insert" title="sqlalchemy.dialects.mysql.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>，在 <a class="reference internal" href="../../dialects/mysql.html#mysql-insert-on-duplicate-key-update"><span class="std std-ref">INSERT…ON DUPLICATE KEY UPDATE (Upsert)</span></a> 中记录</p></li>
</ul>
<p>用户应查看上述各章节了解适当构建这些对象的背景知识；特别是“upsert”方法通常需要参考原始语句，因此通常需要分两个步骤构造声明。</p>
<p>第三方后端（例如位于 <a class="reference internal" href="../../dialects/index.html"><span class="std std-ref">外部方言</span></a> 中提到的后端）可能也提供类似的构造方法。</p>
<p>虽然 SQLAlchemy 还没有通用的 upsert 构造，但上述的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 变体在 ORM 兼容方面仍然可用，因为它们可以用与 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造本身相同的方式使用，如在 <span class="xref std std-ref">orm_queryguide_insert_values</span> 中所述，即通过将期望插入的行嵌入到 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 方法中的方式。在下面的示例中，使用 SQLite 的 <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.insert" title="sqlalchemy.dialects.sqlite.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a> 函数生成一个 <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.Insert" title="sqlalchemy.dialects.sqlite.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造，其中包括 “ON CONFLICT DO UPDATE” 选项。然后将语句传递给 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code>，其中还附带了在 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 中嵌入的所需行参数字典；这些将被解释为 ORM 映射属性键，而不是列名称：</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-upsert"><span class="std std-ref">ORM “upsert” 语句</span></a>.. _orm_queryguide_update_delete_where:</p>
</div>
</section>
</section>
<section id="orm">
<h2>ORM自定义更新和删除条件<a class="headerlink" href="#orm" title="Permalink to this heading">¶</a></h2>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code>，要更新的值应该使用:meth:<a href="#id5"><span class="problematic" id="id6">`</span></a>_dml.Update.values`传递。</p>
<p>这种使用方式不同于在 <span class="xref std std-ref">orm_queryguide_bulk_update</span> 中描述的特性，后者使用自动为每个记录生成主键的确切WHERE条件执行UPDATE或DELETE语句，并使用:term:<a href="#id7"><span class="problematic" id="id8">`</span></a>executemany`对每个参数集运行。</p>
<p>例如，下面的更新语句会影响“fullname”字段的多个行：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s2">&quot;squidward&quot;</span><span class="p">,</span> <span class="s2">&quot;sandy&quot;</span><span class="p">]))</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">fullname</span><span class="o">=</span><span class="s2">&quot;Name starts with S&quot;</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="go">{execsql}UPDATE user_account SET fullname=? WHERE user_account.name IN (?, ?)</span>
<span class="go">[...] (&#39;Name starts with S&#39;, &#39;squidward&#39;, &#39;sandy&#39;)</span>
<span class="go">{stop}&lt;...&gt;</span></pre></div>
</div>
<p>对于DELETE，以下是基于条件删除行的示例：</p>
<p>在ORM启用的UPDATE和DELETE WHERE标准中，与返回的支持完全兼容，支持完全。可以指定完整ORM对象和/或列来进行返回：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;squidward&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">fullname</span><span class="o">=</span><span class="s2">&quot;Squidward Tentacles&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="go">{execsql}UPDATE user_account SET fullname=? WHERE user_account.name = ?</span>
<span class="go">RETURNING id, name, fullname, species</span>
<span class="go">[...] (&#39;Squidward Tentacles&#39;, &#39;squidward&#39;)</span>
<span class="go">{stop}&gt;&gt;&gt; print(result.all())</span>
<span class="go">[User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;)]</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a></p>
<p><a class="reference internal" href="query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a></p>
</div>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="inheritance.html" title="previous chapter">编写继承映射的SELECT语句</a>
        Next:
        <a href="columns.html" title="next chapter">列载入选项</a>

    <div id="docs-copyright">
        &copy; <a href="../../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 9:31:16

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../../_static/init.js"></script>


    </body>
</html>


