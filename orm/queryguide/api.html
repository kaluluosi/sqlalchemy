<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    查询时使用的ORM API功能
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
        <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../../index.html" />
        <link rel="up" title="ORM 查询指南" href="index.html" />
        <link rel="next" title="Legacy查询API" href="query.html" />
        <link rel="prev" title="关系加载技术" href="relationships.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="../index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="../quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="../mapper_config.html">ORM映射类配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="../relationships.html">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="index.html">ORM 查询指南</a></span><ul>
<li><span class="link-container"><a class="reference external" href="select.html">使用ORM映射类编写SELECT语句</a></span></li>
<li><span class="link-container"><a class="reference external" href="inheritance.html">继承映射中编写SELECT语句</a></span></li>
<li><span class="link-container"><a class="reference external" href="dml.html">ORM-启用的INSERT、UPDATE和DELETE语句</a></span></li>
<li><span class="link-container"><a class="reference external" href="columns.html">列加载选项</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系加载技术</a></span></li>
<li class="selected"><span class="link-container"><strong>查询时使用的ORM API功能</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm">ORM加载器选项</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-execution-options">ORM执行选项</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-populate-existing">填充现有的实例</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-autoflush">自动刷新</a></span></li>
<li><span class="link-container"><a class="reference external" href="#queryguide-identity-token">标识符令牌</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-select-dml">检查从启用 ORM 的 SELECT 和 DML 语句中获取的实体和列</a></span></li>
<li><span class="link-container"><a class="reference external" href="#queryguide-additional">其他 ORM API 构件</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.aliased"><code class="docutils literal notranslate"><span class="pre">aliased()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.util.AliasedClass"><code class="docutils literal notranslate"><span class="pre">AliasedClass</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.util.AliasedInsp"><code class="docutils literal notranslate"><span class="pre">AliasedInsp</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">Bundle</span></code></a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.__init__"><code class="docutils literal notranslate"><span class="pre">Bundle.__init__()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.c"><code class="docutils literal notranslate"><span class="pre">Bundle.c</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.columns"><code class="docutils literal notranslate"><span class="pre">Bundle.columns</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.create_row_processor"><code class="docutils literal notranslate"><span class="pre">Bundle.create_row_processor()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.is_aliased_class"><code class="docutils literal notranslate"><span class="pre">Bundle.is_aliased_class</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.is_bundle"><code class="docutils literal notranslate"><span class="pre">Bundle.is_bundle</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.is_clause_element"><code class="docutils literal notranslate"><span class="pre">Bundle.is_clause_element</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.is_mapper"><code class="docutils literal notranslate"><span class="pre">Bundle.is_mapper</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.label"><code class="docutils literal notranslate"><span class="pre">Bundle.label()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.Bundle.single_entity"><code class="docutils literal notranslate"><span class="pre">Bundle.single_entity</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.with_loader_criteria"><code class="docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.join"><code class="docutils literal notranslate"><span class="pre">join()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.outerjoin"><code class="docutils literal notranslate"><span class="pre">outerjoin()</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="query.html">Legacy查询API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="../session.html">用 Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="../extending.html">事件和内部机制</a></span></li>
<li><span class="link-container"><a class="reference external" href="../extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="../examples.html">ORM 示例</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="relationships.html" title="previous chapter">关系加载技术</a></li>
                <li><b>Next:</b>
                <a href="query.html" title="next chapter">Legacy查询API</a></li>

            <li><b>Up:</b> <a href="../../index.html">Home</a></li>
                    <ul><li><a href="../index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="index.html" title="ORM 查询指南">ORM 查询指南</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#orm-api">查询时使用的ORM API功能</a><ul>
<li><a class="reference internal" href="#orm">ORM加载器选项</a></li>
<li><a class="reference internal" href="#orm-queryguide-execution-options">ORM执行选项</a><ul>
<li><a class="reference internal" href="#orm-queryguide-populate-existing">填充现有的实例</a></li>
<li><a class="reference internal" href="#orm-queryguide-autoflush">自动刷新</a></li>
<li><a class="reference internal" href="#queryguide-identity-token">标识符令牌</a><ul>
<li><a class="reference internal" href="#orm-select-dml">检查从启用 ORM 的 SELECT 和 DML 语句中获取的实体和列</a></li>
<li><a class="reference internal" href="#queryguide-additional">其他 ORM API 构件</a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.aliased"><code class="docutils literal notranslate"><span class="pre">aliased()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass"><code class="docutils literal notranslate"><span class="pre">AliasedClass</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.util.AliasedInsp"><code class="docutils literal notranslate"><span class="pre">AliasedInsp</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">Bundle</span></code></a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.__init__"><code class="docutils literal notranslate"><span class="pre">Bundle.__init__()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.c"><code class="docutils literal notranslate"><span class="pre">Bundle.c</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.columns"><code class="docutils literal notranslate"><span class="pre">Bundle.columns</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.create_row_processor"><code class="docutils literal notranslate"><span class="pre">Bundle.create_row_processor()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.is_aliased_class"><code class="docutils literal notranslate"><span class="pre">Bundle.is_aliased_class</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.is_bundle"><code class="docutils literal notranslate"><span class="pre">Bundle.is_bundle</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.is_clause_element"><code class="docutils literal notranslate"><span class="pre">Bundle.is_clause_element</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.is_mapper"><code class="docutils literal notranslate"><span class="pre">Bundle.is_mapper</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.label"><code class="docutils literal notranslate"><span class="pre">Bundle.label()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.Bundle.single_entity"><code class="docutils literal notranslate"><span class="pre">Bundle.single_entity</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria"><code class="docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.join"><code class="docutils literal notranslate"><span class="pre">join()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.outerjoin"><code class="docutils literal notranslate"><span class="pre">outerjoin()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-queryguide-api" >
        
<aside class="topic">
<p class="topic-title">ORM 查询指南</p>
<p>本页面是  <a class="reference internal" href="index.html"><span class="doc">ORM 查询指南</span></a>  的一部分。</p>
<p>上一页: <a class="reference internal" href="relationships.html"><span class="doc">关系加载技术</span></a>   |   下一页: <a class="reference internal" href="query.html"><span class="doc">Legacy查询API</span></a></p>
</aside>
<section id="orm-api">
<h1>查询时使用的ORM API功能<a class="headerlink" href="#orm-api" title="Permalink to this heading">¶</a></h1>
<section id="orm">
<h2>ORM加载器选项<a class="headerlink" href="#orm" title="Permalink to this heading">¶</a></h2>
<p>加载器选项是当在  <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.options" title="sqlalchemy.sql.expression.Select.options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.options()</span></code></a>  方法中传递给 :class:` .Select`对象或类似的SQL构造时，影响列和关系导向属性的加载的对象。
大部分加载器选项从 <a class="reference internal" href="relationships.html#sqlalchemy.orm.Load" title="sqlalchemy.orm.Load"><code class="xref py py-class docutils literal notranslate"><span class="pre">Load</span></code></a> 继承层次结构中派生。
有关使用加载器选项的完整概述，请参见下面的链接部分。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<ul class="simple">
<li><p><a class="reference internal" href="columns.html#loading-columns"><span class="std std-ref">列加载选项</span></a>  - 关于如何加载列和SQL表达式映射属性的</p></li>
</ul>
<blockquote>
<div><p>映射器和加载选项的详细信息。</p>
</div></blockquote>
<ul class="simple">
<li><p><span class="xref std std-ref">loading_toplevel</span>  - 关于如何加载   :func:` _orm.relationship`</p></li>
</ul>
<blockquote>
<div><p>映射属性的关系和加载选项的详细信息。</p>
</div></blockquote>
</div>
</section>
<section id="orm-queryguide-execution-options">
<span id="id1"></span><h2>ORM执行选项<a class="headerlink" href="#orm-queryguide-execution-options" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt>ORM级别的执行选项是可以与语句执行关联的关键字选项，可以使用</dt><dd><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code>   和  :meth:` _orm.Session.scalars`  ，也可以直接将其与要调用的语句相关联，使用  <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Executable.execution_options" title="sqlalchemy.sql.expression.Executable.execution_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Executable.execution_options()</span></code></a>  方法，该方法接受它们作为任意关键字参数。</p>
</dd>
<dt>ORM级别的选项与在</dt><dd><p><a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection.execution_options" title="sqlalchemy.engine.Connection.execution_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execution_options()</span></code></a>   中记录的核心级别执行选项不同。</p>
</dd>
<dt>重要的是要注意，以下ORM选项与核心级别方法</dt><dd><p><a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection.execution_options" title="sqlalchemy.engine.Connection.execution_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execution_options()</span></code></a>   或  :meth:` _engine.Engine.execution_options`  <strong>不</strong> 兼容；</p>
</dd>
</dl>
<p>即使关联了使用的  <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  的  :class:` .Engine`  或   <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> ，这些选项在该级别上也会被忽略。</p>
<p>在本节中，将使用  <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Executable.execution_options" title="sqlalchemy.sql.expression.Executable.execution_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Executable.execution_options()</span></code></a>   方法样式来说明示例。</p>
<section id="orm-queryguide-populate-existing">
<span id="id2"></span><h3>填充现有的实例<a class="headerlink" href="#orm-queryguide-populate-existing" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">populate_existing</span></code> 执行选项确保对于所有加载的行，  <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  中对应的实例都将被完全刷新-擦除对象中任何现有数据（包括待定更改）并替换为从结果加载的数据。</p>
<p>示例用法如下:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">populate_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span>
<span class="p">...</span>
</div></pre></div>
</div>
<p>通常，ORM对象只被加载一次，并且如果它们与后续结果行中的主键匹配，该行不会应用于对象。
这既是为了保留对象上待处理的未刷新更改，也是为了避免刷新已经存在的数据的开销和复杂性。</p>
<blockquote>
<div><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  假定高度隔离的事务的默认工作模型，在事务内部预期的数据随着本地更改之外的程度发生更改，应该使用诸如此方法的显式步骤来处理这些用例。</p>
</div></blockquote>
<p>使用 <code class="docutils literal notranslate"><span class="pre">populate_existing</span></code>，可以刷新匹配查询的任何对象集，并且它还允许控制关系加载器选项。
例如。在刷新实例的同时刷新相关对象集：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
    <span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">populate_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">selectinload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span>
<span class="p">)</span>
<span class="c1"># 将刷新所有匹配的用户对象以及相关的Address对象</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">populate_existing</span></code> 的另一个用例是支持各种特性属性加载，这些属性加载可以更改以每个查询为基础如何加载属性的方式。对此适用的选项包括：</p>
<ul class="simple">
<li><p><a class="reference internal" href="columns.html#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  选项。</p></li>
<li><p><a class="reference internal" href="../internals.html#sqlalchemy.orm.PropComparator.and_" title="sqlalchemy.orm.PropComparator.and_"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PropComparator.and_()</span></code></a>  方法，可以修改加载器策略加载的内容</p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code>  选项</p></li>
<li><p><a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a>  选项</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">populate_existing</span></code> 执行选项相当于 <span class="xref std std-term">1.x style</span> ORM 查询中的  :meth:` _orm.Query.populate_existing`  方法。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<blockquote>
<div><p><a class="reference internal" href="../../faq/sessions.html#faq-session-identity"><span class="std std-ref">我正在使用会话重新加载数据，但是没有看到在其他地方提交的更改</span></a>  - 在  :doc:` /faq/index`  中</p>
<p><a class="reference internal" href="../session_state_management.html#session-expire"><span class="std std-ref">刷新/到期</span></a>  - 在ORM   :class:` _orm.Session`</p>
</div></blockquote>
<p>文档中</p>
</div>
</section>
<section id="orm-queryguide-autoflush">
<span id="id3"></span><h3>自动刷新<a class="headerlink" href="#orm-queryguide-autoflush" title="Permalink to this heading">¶</a></h3>
<p>当以 <code class="docutils literal notranslate"><span class="pre">False</span></code> 作为参数传递时，此选项将导致  <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  不调用 “自动刷新” 步骤，
相当于使用  <code class="xref py py-attr docutils literal notranslate"><span class="pre">Session.no_autoflush</span></code>  上下文管理器禁用自动刷新:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span>
<span class="p">...</span>
</div></pre></div>
</div>
<p>此选项也适用于支持ORM的   <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a>  和   :class:` _sql.Delete`  查询。</p>
<p><code class="docutils literal notranslate"><span class="pre">autoflush</span></code> 执行选项相当于 <span class="xref std std-term">1.x style</span> ORM 查询中的  :meth:` _orm.Query.autoflush`  方法。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../session_basics.html#session-flushing"><span class="std std-ref">刷新</span></a></p>
</div>
<p id="orm-queryguide-yield-per">使用Yield Per获取大结果集``yield_per`` 执行选项是一个整数值，它将会在数据提供给客户端之前，仅将一定数量的行和/或 ORM 对象缓冲在内存中。</p>
<p>通常，ORM 会立即获取**所有**行，为每个行构造 ORM 对象并将这些对象组装到一个单一的缓冲区中，再将此缓冲区作为行的源传递到   <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a>  对象供返回。这种行为的基本原理是，允许正确地使用特性，如连接贪婪加载，结果惟一化和依赖于标识映射在提取结果集中的每个对象维护一致状态的常规结果处理逻辑。</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 的目的是改变这种行为，以使 ORM 结果集针对遍历非常大的结果集（例如，&gt; 10K 行）进行优化，其中用户已确定上述模式不适用。当使用 <code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 时，ORM 将 ORM 结果批处理成子集，并在迭代   <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a>  对象时逐个产生每个子集中的行，因此 Python 解释器无需声明非常大的内存区域，这既耗时又会导致过度的内存使用。该选项影响数据库游标的使用方式以及 ORM 构建行和对象以供传递到   :class:` _engine.Result`  的方式。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>由上可知，  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a>  必须以可迭代的方式被消耗，即使用迭代（例如，` <cite>for row in result`</cite>）或使用部分行方法，例如  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result.fetchmany" title="sqlalchemy.engine.Result.fetchmany"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.fetchmany()</span></code></a>  或  :meth:` _engine.Result.partitions` 。调用  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result.all" title="sqlalchemy.engine.Result.all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.all()</span></code></a>  将会破坏使用 ` <cite>yield_per`</cite> 的目的。</p>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 相当于同时使用  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection.execution_options.params.stream_results" title="sqlalchemy.engine.Connection.execution_options"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Connection.execution_options.stream_results</span></code></a>  执行选项（如果得到支持，选择让后端使用服务器端游标）和返回的   :class:` _engine.Result`  对象上的  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result.yield_per" title="sqlalchemy.engine.Result.yield_per"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.yield_per()</span></code></a>  方法，它建立了被批次获取行的固定大小和同时构造 ORM 对象的相应限制。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 现在还可以作为 Core 执行选项使用，详细信息请参见   <span class="xref std std-ref">engine_stream_results</span> 。本节详细介绍了在 ORM   :class:` _orm.Session`  上使用 <code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 作为执行选项。该选项在两种情况下的行为尽可能相似。</p>
</div>
<p>当与 ORM 一起使用时，<code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 必须是通过给定语句上的  <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Executable.execution_options" title="sqlalchemy.sql.expression.Executable.execution_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Executable.execution_options()</span></code></a>  方法或通过将其传递给  :meth:` _orm.Session.execute`  或其他类似的   <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  方法（例如  :meth:` _orm.Session.scalars` ）的  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.execution_options</span></code>  参数来建立的。获取 ORM 对象的典型用法如下所示：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">yield_per</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user_obj</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
<span class="go">{execsql}SELECT user_account.id, user_account.name, user_account.fullname</span>
<span class="go">FROM user_account</span>
<span class="go">[...] ()</span>
<span class="go">{stop}User(id=1, name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;)</span>
<span class="go">User(id=2, name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;)</span>
<span class="go">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># ... rows continue ...</span></pre></div>
</div>
<p>上面的代码等同于下面的示例，该示例使用  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection.execution_options.params.stream_results" title="sqlalchemy.engine.Connection.execution_options"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Connection.execution_options.stream_results</span></code></a>  和  :paramref:` _engine.Connection.execution_options.max_row_buffer`  Core 级执行选项，以及   <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a>  的  :meth:` _engine.Result.yield_per`  方法：</p>
<blockquote>
<div><p># equivalent code
&gt;&gt;&gt; stmt = select(User).execution_options(stream_results=True, max_row_buffer=10)
&gt;&gt;&gt; for user_obj in session.scalars(stmt).yield_per(10):
…     print(user_obj)
{execsql}SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
[…] ()
{stop}User(id=1, name=’spongebob’, fullname=’Spongebob Squarepants’)
User(id=2, name=’sandy’, fullname=’Sandy Cheeks’)
…
&gt;&gt;&gt; # … rows continue …</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 还经常与  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result.partitions" title="sqlalchemy.engine.Result.partitions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.partitions()</span></code></a>  方法一起使用，该方法将按分组分区迭代行。每个分区的大小默认为传递给 ` <cite>yield_per`</cite> 的整数值，如下例所示：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">yield_per</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">partition</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">partitions</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">user_obj</span> <span class="ow">in</span> <span class="n">partition</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">print</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
<span class="go">{execsql}SELECT user_account.id, user_account.name, user_account.fullname</span>
<span class="go">FROM user_account</span>
<span class="go">[...] ()</span>
<span class="go">{stop}User(id=1, name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;)</span>
<span class="go">User(id=2, name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;)</span>
<span class="go">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># ... rows continue ...</span></pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 执行选项与使用集合时的   <a class="reference internal" href="relationships.html#subquery-eager-loading"><span class="std std-ref">“子查询” eager loading</span></a>  或   :ref:` “连接” lazy loading &lt;joined_eager_loading&gt;`  <strong>不兼容</strong>。如果数据库驱动程序支持多个独立的游标，则   <a class="reference internal" href="relationships.html#selectin-eager-loading"><span class="std std-ref">“select in” eager loading</span></a>  可能兼容，并且每个游标能够处理特定数量的结果。</p>
<p>此外，<code class="docutils literal notranslate"><span class="pre">yield_per</span></code> 执行选项与  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result.unique" title="sqlalchemy.engine.Result.unique"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.unique()</span></code></a>  方法不兼容；由于该方法依赖于存储所有行的完整标识符集，这将必然破坏使用 ` <cite>yield_per`</cite> 处理任意大量的结果集的目的。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.4.6: </span>从一个   <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a>  对象中获取 ORM 行时，如果与同时使用 ` <cite>yield_per`</cite> 执行选项，则会触发异常  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result.unique" title="sqlalchemy.engine.Result.unique"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.unique()</span></code></a>  过滤器。</p>
</div>
<p>使用旧版   <a class="reference internal" href="query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>  对象，配合  :term:` 1.x style`  的 ORM 使用时，  <a class="reference internal" href="query.html#sqlalchemy.orm.Query.yield_per" title="sqlalchemy.orm.Query.yield_per"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.yield_per()</span></code></a>   方法的结果与 ` <cite>yield_per`</cite> 执行选项相同。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="xref std std-ref">engine_stream_results</span></p>
</div>
</section>
<section id="queryguide-identity-token">
<span id="id4"></span><h3>标识符令牌<a class="headerlink" href="#queryguide-identity-token" title="Permalink to this heading">¶</a></h3>
<div class="admonition deepalchemy">
<p class="admonition-title">Deep Alchemy</p>
<p>该选项是高级选项，大多数情况下用于与   <span class="xref std std-ref">horizontal_sharding_toplevel</span>  扩展一同使用。
对于从不同的“片”或分区中加载具有相同主键的对象的典型情况，请首先考虑分别使用每个   <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  对象。</p>
</div>
<p>“标识符令牌”是一个任意值，它可以关联到新加载对象的  <span class="xref std std-term">identity key</span>  中。 首先和主要是为了支持每行“分片”的扩展，其中对象可以从一个表的任意副本中加载，这些副本与重叠的主键值。 “标识符令牌”的主要用户是   :ref:` horizontal_sharding_toplevel`  扩展，它提供了一个通用框架，用于在特定数据库表的多个“片”之间持久化对象。</p>
<p><code class="docutils literal notranslate"><span class="pre">identity_token</span></code> 执行选项可以在每个查询的基础上使用以直接影响此令牌。 使用它可以直接在   <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  中添加具有相同主键和来源表的多个对象，但具有不同的“标识符”。</p>
<p>一个例子是使用   <a class="reference internal" href="../../core/connections.html#schema-translating"><span class="std std-ref">翻译模式名称</span></a>  功能从不同模式的同名表中填充   :class:` _orm.Session` 。 给定以下映射：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MyTable</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;my_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上面类的默认“schema”名称为``None``，表示 SQL 语句不会写入模式资格认证。 然而，如果使用  <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection.execution_options.params.schema_translate_map" title="sqlalchemy.engine.Connection.execution_options"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Connection.execution_options.schema_translate_map</span></code></a> ，将` <cite>None``映射到替代模式，我们可以将 ``MyTable`</cite> 的实例放入两个不同的模式中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="s2">&quot;postgresql+psycopg://scott:tiger@localhost/test&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">with</span> <span class="n">Session</span><span class="p">(</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">schema_translate_map</span><span class="o">=</span><span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;test_schema&quot;</span><span class="p">})</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyTable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;this is schema one&quot;</span><span class="p">))</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="k">with</span> <span class="n">Session</span><span class="p">(</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">schema_translate_map</span><span class="o">=</span><span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;test_schema_2&quot;</span><span class="p">})</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyTable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;this is schema two&quot;</span><span class="p">))</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<p>上述两个块每次都会创建一个链接到不同的模式翻译映射的   <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  对象，并将 ` <cite>MyTable`</cite> 的实例持续保留在 <code class="docutils literal notranslate"><span class="pre">test_schema.my_table</span></code> 和 <code class="docutils literal notranslate"><span class="pre">test_schema_2.my_table</span></code> 中。</p>
<p>上面的   <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>  对象时相互独立的。 如果我们想在一个事务中同时保存这两个对象，则需要使用   :ref:` horizontal_sharding_toplevel`  扩展来完成此操作。</p>
<p>但是，我们可以通过以下方法说明在一个会话中查询这些对象：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">obj1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
        <span class="n">select</span><span class="p">(</span><span class="n">MyTable</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MyTable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">execution_options</span><span class="p">(</span>
            <span class="n">schema_translate_map</span><span class="o">=</span><span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;test_schema&quot;</span><span class="p">},</span>
            <span class="n">identity_token</span><span class="o">=</span><span class="s2">&quot;test_schema&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">obj2</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
        <span class="n">select</span><span class="p">(</span><span class="n">MyTable</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MyTable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">execution_options</span><span class="p">(</span>
            <span class="n">schema_translate_map</span><span class="o">=</span><span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;test_schema_2&quot;</span><span class="p">},</span>
            <span class="n">identity_token</span><span class="o">=</span><span class="s2">&quot;test_schema_2&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span></pre></div>
</div>
<p>两者的 <code class="docutils literal notranslate"><span class="pre">obj1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">obj2</span></code> 是不同的。 然而，它们都是 <code class="docutils literal notranslate"><span class="pre">MyTable</span></code> 类的主键 id 1，但却是不同的。 这就是“identity_token”发挥作用的方式，我们可以在检查每个对象时查看  <code class="xref py py-attr docutils literal notranslate"><span class="pre">InstanceState.key</span></code> ，以查看两个不同的标识符令牌：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">inspect</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj1</span><span class="p">)</span><span class="o">.</span><span class="n">key</span>
<span class="go">(&lt;class &#39;__main__.MyTable&#39;&gt;, (1,), &#39;test_schema&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj2</span><span class="p">)</span><span class="o">.</span><span class="n">key</span>
<span class="go">(&lt;class &#39;__main__.MyTable&#39;&gt;, (1,), &#39;test_schema_2&#39;)</span></pre></div>
</div>
<p>当使用   <span class="xref std std-ref">horizontal_sharding_toplevel</span>  扩展时，上述逻辑会自动执行。.. versionadded::2.0.0rc1 - 添加` <cite>identity_token`</cite> ORM 级别执行选项。</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../examples.html#examples-sharding"><span class="std std-ref">水平分片</span></a>  - 见于   :ref:` examples_toplevel`  部分。查看脚本``separate_schema_translates.py``了解如何使用完整的分片 API 的演示案例。</p>
</div>
<section id="orm-select-dml">
<span id="queryguide-inspection"></span><h4>检查从启用 ORM 的 SELECT 和 DML 语句中获取的实体和列<a class="headerlink" href="#orm-select-dml" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p><a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-class docutils literal notranslate"><span class="pre">select</span></code></a>  构造，以及   :func:` _sql.insert` ，  <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> ，和   :func:` _sql.delete`  构件（对于后者的 DML 构件，从 SQLAlchemy 1.4.33 开始），都支持检查这些语句所涉及的实体以及组成结果集的列和数据类型。</p>
</div></blockquote>
<p>对于   <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>  对象，可以从  :attr:` .Select.column_descriptions`  属性中获取这些信息。这个属性的操作方式与传统的  <a class="reference internal" href="query.html#sqlalchemy.orm.Query.column_descriptions" title="sqlalchemy.orm.Query.column_descriptions"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Query.column_descriptions</span></code></a>  属性相同。返回的格式为字典列表:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;user2&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_alias</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">column_descriptions</span><span class="p">)</span>
<span class="go">[{&#39;aliased&#39;: False,</span>
<span class="go">  &#39;entity&#39;: &lt;class &#39;User&#39;&gt;,</span>
<span class="go">  &#39;expr&#39;: &lt;class &#39;User&#39;&gt;,</span>
<span class="go">  &#39;name&#39;: &#39;User&#39;,</span>
<span class="go">  &#39;type&#39;: &lt;class &#39;User&#39;&gt;},</span>
<span class="go"> {&#39;aliased&#39;: False,</span>
<span class="go">  &#39;entity&#39;: &lt;class &#39;User&#39;&gt;,</span>
<span class="go">  &#39;expr&#39;: &lt;....InstrumentedAttribute object at ...&gt;,</span>
<span class="go">  &#39;name&#39;: &#39;id&#39;,</span>
<span class="go">  &#39;type&#39;: Integer()},</span>
<span class="go"> {&#39;aliased&#39;: True,</span>
<span class="go">  &#39;entity&#39;: &lt;AliasedClass ...; User&gt;,</span>
<span class="go">  &#39;expr&#39;: &lt;AliasedClass ...; User&gt;,</span>
<span class="go">  &#39;name&#39;: &#39;user2&#39;,</span>
<span class="go">  &#39;type&#39;: &lt;class &#39;User&#39;&gt;}]</span></pre></div>
</div>
<p>当使用  <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.column_descriptions" title="sqlalchemy.sql.expression.Select.column_descriptions"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Select.column_descriptions</span></code></a>  与非 ORM 对象配合使用，例如普通的   :class:` .Table`  或   <a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  对象时，所有情况下返回的条目将包含关于各个列的基本信息:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">,</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">column_descriptions</span><span class="p">)</span>
<span class="go">[{&#39;expr&#39;: Column(&#39;id&#39;, Integer(), table=&lt;user_account&gt;, primary_key=True, nullable=False),</span>
<span class="go">  &#39;name&#39;: &#39;id&#39;,</span>
<span class="go">  &#39;type&#39;: Integer()},</span>
<span class="go"> {&#39;expr&#39;: Column(&#39;name&#39;, String(), table=&lt;user_account&gt;, nullable=False),</span>
<span class="go">  &#39;name&#39;: &#39;name&#39;,</span>
<span class="go">  &#39;type&#39;: String()},</span>
<span class="go"> {&#39;expr&#39;: Column(&#39;fullname&#39;, String(), table=&lt;user_account&gt;),</span>
<span class="go">  &#39;name&#39;: &#39;fullname&#39;,</span>
<span class="go">  &#39;type&#39;: String()},</span>
<span class="go"> {&#39;expr&#39;: Column(&#39;id&#39;, Integer(), table=&lt;address&gt;, primary_key=True, nullable=False),</span>
<span class="go">  &#39;name&#39;: &#39;id_1&#39;,</span>
<span class="go">  &#39;type&#39;: Integer()}]</span></pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.4.33: </span>当应用于无 ORM 的   <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>  时，  :attr:` .Select.column_descriptions`   属性现在会返回一个值。之前，这将会引发 <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> 异常。</p>
</div>
<p>对于   <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a> ，  :func:` .update`  和   <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a>  构件，存在两个单独的属性。 其中一个是  :attr:` .UpdateBase.entity_description` ，返回的是与 DML 构件相关的主 ORM 实体和数据库表的信息:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;somename&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">entity_description</span><span class="p">)</span>
<span class="go">{&#39;entity&#39;: &lt;class &#39;User&#39;&gt;,</span>
<span class="go"> &#39;expr&#39;: &lt;class &#39;User&#39;&gt;,</span>
<span class="go"> &#39;name&#39;: &#39;User&#39;,</span>
<span class="go"> &#39;table&#39;: Table(&#39;user_account&#39;, ...),</span>
<span class="go"> &#39;type&#39;: &lt;class &#39;User&#39;&gt;}</span></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.entity_description" title="sqlalchemy.sql.expression.UpdateBase.entity_description"><code class="xref py py-attr docutils literal notranslate"><span class="pre">UpdateBase.entity_description</span></code></a>  包括一个项 ` <cite>“table”`</cite>，实际上是语句将要插入、更新或删除的表格，而这通常并不与映射到该类的 SQL “selectable” 相同。例如，在继承加入表行中，<code class="docutils literal notranslate"><span class="pre">&quot;table&quot;</span></code> 将引用给定实体的本地表格。</p>
</div>
<p>另一个是  <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning_column_descriptions" title="sqlalchemy.sql.expression.UpdateBase.returning_column_descriptions"><code class="xref py py-attr docutils literal notranslate"><span class="pre">UpdateBase.returning_column_descriptions</span></code></a> ，以与  :attr:` .Select.column_descriptions`  类似的方式提供关于返回集合中存在的列的信息:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">returning_column_descriptions</span><span class="p">)</span>
<span class="go">[{&#39;aliased&#39;: False,</span>
<span class="go">  &#39;entity&#39;: &lt;class &#39;User&#39;&gt;,</span>
<span class="go">  &#39;expr&#39;: &lt;sqlalchemy.orm.attributes.InstrumentedAttribute ...&gt;,</span>
<span class="go">  &#39;name&#39;: &#39;id&#39;,</span>
<span class="go">  &#39;type&#39;: Integer()}]</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.33: </span>添加了  <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.entity_description" title="sqlalchemy.sql.expression.UpdateBase.entity_description"><code class="xref py py-attr docutils literal notranslate"><span class="pre">UpdateBase.entity_description</span></code></a>  和  :attr:` .UpdateBase.returning_column_descriptions`  属性。</p>
</div>
</section>
<section id="queryguide-additional">
<span id="id5"></span><h4>其他 ORM API 构件<a class="headerlink" href="#queryguide-additional" title="Permalink to this heading">¶</a></h4>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.aliased"><span class="sig-name descname">aliased</span></a>(element[, alias, name, flat, ...])</p></td>
<td><p>Produce an alias of the given element, usually an <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>
instance.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass"><span class="sig-name descname">AliasedClass</span></a></p></td>
<td><p>Represents an “aliased” form of a mapped class for usage with Query.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.util.AliasedInsp"><span class="sig-name descname">AliasedInsp</span></a></p></td>
<td><p>Provide an inspection interface for an
<a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> object.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.Bundle"><span class="sig-name descname">Bundle</span></a></p></td>
<td><p>A grouping of SQL expressions that are returned by a <a class="reference internal" href="query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>
under one namespace.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.join"><span class="sig-name descname">join</span></a>(left, right[, onclause, isouter, ...])</p></td>
<td><p>Produce an inner join between left and right clauses.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.outerjoin"><span class="sig-name descname">outerjoin</span></a>(left, right[, onclause, full])</p></td>
<td><p>Produce a left outer join between left and right clauses.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria"><span class="sig-name descname">with_loader_criteria</span></a>(entity_or_base, where_criteria[, loader_only, include_aliases, ...])</p></td>
<td><p>Add additional WHERE criteria to the load for all occurrences of
a particular entity.</p></td>
</tr>
</tbody>
</table>
<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.aliased">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">aliased</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">element</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_EntityType</span><span class="p"><span class="pre">[</span></span><span class="pre">_O</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><span class="pre">FromClause</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">alias</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><span class="pre">FromClause</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flat</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">adapt_on_names</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><span class="pre">AliasedClass</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_O</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><span class="pre">FromClause</span></a><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">AliasedType</span><span class="p"><span class="pre">[</span></span><span class="pre">_O</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.aliased" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce an alias of the given element, usually an <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>
instance.</p>
<p>E.g.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">my_alias = aliased(MyClass)</span>

<span class="go">stmt = select(MyClass, my_alias).filter(MyClass.id &gt; my_alias.id)</span>
<span class="go">result = session.execute(stmt)</span></pre></div>
</div>
<p>The <a class="reference internal" href="#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> function is used to create an ad-hoc mapping of a
mapped class to a new selectable.  By default, a selectable is generated
from the normally mapped selectable (typically a <a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
) using the
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.FromClause.alias" title="sqlalchemy.sql.expression.FromClause.alias"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FromClause.alias()</span></code></a> method. However, <a class="reference internal" href="#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a>
can also be
used to link the class to a new <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> statement.
Also, the <a class="reference internal" href="inheritance.html#sqlalchemy.orm.with_polymorphic" title="sqlalchemy.orm.with_polymorphic"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_polymorphic()</span></code></a> function is a variant of
<a class="reference internal" href="#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> that is intended to specify a so-called “polymorphic
selectable”, that corresponds to the union of several joined-inheritance
subclasses at once.</p>
<p>For convenience, the <a class="reference internal" href="#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> function also accepts plain
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> constructs, such as a
<a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> or
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct.   In those cases, the
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.FromClause.alias" title="sqlalchemy.sql.expression.FromClause.alias"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FromClause.alias()</span></code></a>
method is called on the object and the new
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> object returned.  The returned
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> is not
ORM-mapped in this case.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../../tutorial/data_select.html#tutorial-orm-entity-aliases"><span class="std std-ref">ORM实体别名</span></a> - in the <a class="reference internal" href="../../tutorial/index.html#unified-tutorial"><span class="std std-ref">SQLAlchemy统一教程</span></a></p>
<p><a class="reference internal" href="select.html#orm-queryguide-orm-aliases"><span class="std std-ref">选择 ORM 别名</span></a> - in the <a class="reference internal" href="index.html"><span class="std std-ref">ORM 查询指南</span></a></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.aliased.params.element"></span><strong>element</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.aliased.params.element">¶</a> – element to be aliased.  Is normally a mapped class,
but for convenience can also be a <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a>
element.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.aliased.params.alias"></span><strong>alias</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.aliased.params.alias">¶</a> – Optional selectable unit to map the element to.  This is
usually used to link the object to a subquery, and should be an aliased
select construct as one would produce from the
<a class="reference internal" href="query.html#sqlalchemy.orm.Query.subquery" title="sqlalchemy.orm.Query.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.subquery()</span></code></a> method or
the <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.subquery" title="sqlalchemy.sql.expression.Select.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.subquery()</span></code></a> or
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.alias" title="sqlalchemy.sql.expression.Select.alias"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.alias()</span></code></a> methods of the <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>
construct.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.aliased.params.name"></span><strong>name</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.aliased.params.name">¶</a> – optional string name to use for the alias, if not specified
by the <code class="docutils literal notranslate"><span class="pre">alias</span></code> parameter.  The name, among other things, forms the
attribute name that will be accessible via tuples returned by a
<a class="reference internal" href="query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object.  Not supported when creating aliases
of <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Join" title="sqlalchemy.sql.expression.Join"><code class="xref py py-class docutils literal notranslate"><span class="pre">Join</span></code></a> objects.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.aliased.params.flat"></span><strong>flat</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.aliased.params.flat">¶</a> – Boolean, will be passed through to the
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.FromClause.alias" title="sqlalchemy.sql.expression.FromClause.alias"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FromClause.alias()</span></code></a> call so that aliases of
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Join" title="sqlalchemy.sql.expression.Join"><code class="xref py py-class docutils literal notranslate"><span class="pre">Join</span></code></a> objects will alias the individual tables
inside the join, rather than creating a subquery.  This is generally
supported by all modern databases with regards to right-nested joins
and generally produces more efficient queries.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.aliased.params.adapt_on_names"></span><strong>adapt_on_names</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.aliased.params.adapt_on_names">¶</a> – <p>if True, more liberal “matching” will be used when
mapping the mapped columns of the ORM entity to those of the
given selectable - a name-based match will be performed if the
given selectable doesn’t otherwise have a column that corresponds
to one on the entity.  The use case for this is when associating
an entity with some derived selectable such as one that uses
aggregate functions:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">class UnitPrice(Base):</span>
<span class="go">    __tablename__ = &#39;unit_price&#39;</span>
<span class="go">    ...</span>
<span class="go">    unit_id = Column(Integer)</span>
<span class="go">    price = Column(Numeric)</span>

<span class="go">aggregated_unit_price = Session.query(</span>
<span class="go">                            func.sum(UnitPrice.price).label(&#39;price&#39;)</span>
<span class="go">                        ).group_by(UnitPrice.unit_id).subquery()</span>

<span class="go">aggregated_unit_price = aliased(UnitPrice,</span>
<span class="go">            alias=aggregated_unit_price, adapt_on_names=True)</span></pre></div>
</div>
<p>Above, functions on <code class="docutils literal notranslate"><span class="pre">aggregated_unit_price</span></code> which refer to
<code class="docutils literal notranslate"><span class="pre">.price</span></code> will return the
<code class="docutils literal notranslate"><span class="pre">func.sum(UnitPrice.price).label('price')</span></code> column, as it is
matched on the name “price”.  Ordinarily, the “price” function
wouldn’t have any “column correspondence” to the actual
<code class="docutils literal notranslate"><span class="pre">UnitPrice.price</span></code> column as it is not a proxy of the original.</p>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.util.AliasedClass">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.util.</span></span><span class="sig-name descname"><span class="pre">AliasedClass</span></span><a class="headerlink" href="#sqlalchemy.orm.util.AliasedClass" title="Permalink to this definition">¶</a></dt>
<dd><p>Represents an “aliased” form of a mapped class for usage with Query.</p>
<p>The ORM equivalent of a <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.alias" title="sqlalchemy.sql.expression.alias"><code class="xref py py-func docutils literal notranslate"><span class="pre">alias()</span></code></a>
construct, this object mimics the mapped class using a
<code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> scheme and maintains a reference to a
real <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> object.</p>
<p>A primary purpose of <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> is to serve as an alternate
within a SQL statement generated by the ORM, such that an existing
mapped entity can be used in multiple contexts.   A simple example:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go"># find all pairs of users with the same name</span>
<span class="go">user_alias = aliased(User)</span>
<span class="go">session.query(User, user_alias).\</span>
<span class="go">                join((user_alias, User.id &gt; user_alias.id)).\</span>
<span class="go">                filter(User.name == user_alias.name)</span></pre></div>
</div>
<p><a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> is also capable of mapping an existing mapped
class to an entirely new selectable, provided this selectable is column-
compatible with the existing mapped selectable, and it can also be
configured in a mapping as the target of a <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>.
See the links below for examples.</p>
<p>The <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> object is constructed typically using the
<a class="reference internal" href="#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> function.   It also is produced with additional
configuration when using the <a class="reference internal" href="inheritance.html#sqlalchemy.orm.with_polymorphic" title="sqlalchemy.orm.with_polymorphic"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_polymorphic()</span></code></a> function.</p>
<p>The resulting object is an instance of <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>.
This object implements an attribute scheme which produces the
same attribute and method interface as the original mapped
class, allowing <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> to be compatible
with any attribute technique which works on the original class,
including hybrid attributes (see <span class="xref std std-ref">hybrids_toplevel</span>).</p>
<p>The <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> can be inspected for its underlying
<code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>, aliased selectable, and other information
using <a class="reference internal" href="../../core/inspection.html#sqlalchemy.inspect" title="sqlalchemy.inspect"><code class="xref py py-func docutils literal notranslate"><span class="pre">inspect()</span></code></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy import inspect</span>
<span class="go">my_alias = aliased(MyClass)</span>
<span class="go">insp = inspect(my_alias)</span></pre></div>
</div>
<p>The resulting inspection object is an instance of <a class="reference internal" href="#sqlalchemy.orm.util.AliasedInsp" title="sqlalchemy.orm.util.AliasedInsp"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedInsp</span></code></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a></p>
<p><a class="reference internal" href="inheritance.html#sqlalchemy.orm.with_polymorphic" title="sqlalchemy.orm.with_polymorphic"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_polymorphic()</span></code></a></p>
<p><a class="reference internal" href="../join_conditions.html#relationship-aliased-class"><span class="std std-ref">与别名类的关系</span></a></p>
<p><a class="reference internal" href="../join_conditions.html#relationship-to-window-function"><span class="std std-ref">使用窗口函数的行限制关系</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.AliasedClass</span></code> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.inspection.Inspectable</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.ORMColumnsClauseRole</span></code>)</p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.util.AliasedInsp">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.util.</span></span><span class="sig-name descname"><span class="pre">AliasedInsp</span></span><a class="headerlink" href="#sqlalchemy.orm.util.AliasedInsp" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide an inspection interface for an
<a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> object.</p>
<p>The <a class="reference internal" href="#sqlalchemy.orm.util.AliasedInsp" title="sqlalchemy.orm.util.AliasedInsp"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedInsp</span></code></a> object is returned
given an <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> using the
<a class="reference internal" href="../../core/inspection.html#sqlalchemy.inspect" title="sqlalchemy.inspect"><code class="xref py py-func docutils literal notranslate"><span class="pre">inspect()</span></code></a> function:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy import inspect</span>
<span class="go">from sqlalchemy.orm import aliased</span>

<span class="go">my_alias = aliased(MyMappedClass)</span>
<span class="go">insp = inspect(my_alias)</span></pre></div>
</div>
<p>Attributes on <a class="reference internal" href="#sqlalchemy.orm.util.AliasedInsp" title="sqlalchemy.orm.util.AliasedInsp"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedInsp</span></code></a>
include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">entity</span></code> - the <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> represented.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mapper</span></code> - the <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code> mapping the underlying class.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">selectable</span></code> - the <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a>
construct which ultimately
represents an aliased <a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> or
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>
construct.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> - the name of the alias.  Also is used as the attribute
name when returned in a result tuple from <a class="reference internal" href="query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">with_polymorphic_mappers</span></code> - collection of <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>
objects
indicating all those mappers expressed in the select construct
for the <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">polymorphic_on</span></code> - an alternate column or SQL expression which
will be used as the “discriminator” for a polymorphic load.</p></li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="xref std std-ref">inspection_toplevel</span></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.AliasedInsp</span></code> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.ORMEntityColumnsClauseRole</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.ORMFromClauseRole</span></code>, <a class="reference internal" href="../../core/foundation.html#sqlalchemy.sql.traversals.HasCacheKey" title="sqlalchemy.sql.cache_key.HasCacheKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.sql.cache_key.HasCacheKey</span></code></a>, <a class="reference internal" href="../internals.html#sqlalchemy.orm.InspectionAttr" title="sqlalchemy.orm.base.InspectionAttr"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.base.InspectionAttr</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.util.langhelpers.MemoizedSlots</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.inspection.Inspectable</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">typing.Generic</span></code>)</p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">Bundle</span></span><a class="headerlink" href="#sqlalchemy.orm.Bundle" title="Permalink to this definition">¶</a></dt>
<dd><p>A grouping of SQL expressions that are returned by a <a class="reference internal" href="query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>
under one namespace.</p>
<p>The <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a> essentially allows nesting of the tuple-based
results returned by a column-oriented <a class="reference internal" href="query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object.
It also
is extensible via simple subclassing, where the primary capability
to override is that of how the set of expressions should be returned,
allowing post-processing as well as custom return types, without
involving ORM identity-mapped classes.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="select.html#bundles"><span class="std std-ref">使用 Bundles 分组选择的属性</span></a></p>
</div>
<div class="class-members docutils container">
<p><strong>Members</strong></p>
<p><a class="reference internal" href="#sqlalchemy.orm.Bundle.__init__"><span class="sig-name descname">__init__()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.c"><span class="sig-name descname">c</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.columns"><span class="sig-name descname">columns</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.create_row_processor"><span class="sig-name descname">create_row_processor()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.is_aliased_class"><span class="sig-name descname">is_aliased_class</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.is_bundle"><span class="sig-name descname">is_bundle</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.is_clause_element"><span class="sig-name descname">is_clause_element</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.is_mapper"><span class="sig-name descname">is_mapper</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.label"><span class="sig-name descname">label()</span></a>, <a class="reference internal" href="#sqlalchemy.orm.Bundle.single_entity"><span class="sig-name descname">single_entity</span></a></p>
</div>
<div class="class-bases docutils container">
<p><strong>Class signature</strong></p>
<p>class <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle</span></code></a> (<code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.ORMColumnsClauseRole</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.sql.annotation.SupportsCloneAnnotations</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.sql.cache_key.MemoizedHasCacheKey</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.inspection.Inspectable</span></code>, <a class="reference internal" href="../internals.html#sqlalchemy.orm.InspectionAttr" title="sqlalchemy.orm.base.InspectionAttr"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.base.InspectionAttr</span></code></a>)</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.__init__">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">exprs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_ColumnExpressionArgument</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kw</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.Bundle.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Construct a new <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a>.</p>
<p>e.g.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">bn = Bundle(&quot;mybundle&quot;, MyClass.x, MyClass.y)</span>

<span class="go">for row in session.query(bn).filter(</span>
<span class="go">        bn.c.x == 5).filter(bn.c.y == 4):</span>
<span class="go">    print(row.mybundle.x, row.mybundle.y)</span></pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.Bundle.params.name"></span><strong>name</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.Bundle.params.name">¶</a> – name of the bundle.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.Bundle.params.*exprs"></span><strong>*exprs</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.Bundle.params.*exprs">¶</a> – columns or SQL expressions comprising the bundle.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.Bundle.params.single_entity"></span><strong>single_entity=False</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.Bundle.params.single_entity">¶</a> – if True, rows for this <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a>
can be returned as a “single entity” outside of any enclosing tuple
in the same manner as a mapped entity.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.c">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">c</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">ReadOnlyColumnCollection</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">KeyedColumnElement</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></em><a class="headerlink" href="#sqlalchemy.orm.Bundle.c" title="Permalink to this definition">¶</a></dt>
<dd><p>An alias for <a class="reference internal" href="#sqlalchemy.orm.Bundle.columns" title="sqlalchemy.orm.Bundle.columns"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Bundle.columns</span></code></a>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.columns">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">columns</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">ReadOnlyColumnCollection</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">KeyedColumnElement</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></em><a class="headerlink" href="#sqlalchemy.orm.Bundle.columns" title="Permalink to this definition">¶</a></dt>
<dd><p>A namespace of SQL expressions referred to by this <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a>.</p>
<blockquote>
<div><p>e.g.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">bn = Bundle(&quot;mybundle&quot;, MyClass.x, MyClass.y)</span>

<span class="go">q = sess.query(bn).filter(bn.c.x == 5)</span></pre></div>
</div>
<p>Nesting of bundles is also supported:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">b1 = Bundle(&quot;b1&quot;,</span>
<span class="go">        Bundle(&#39;b2&#39;, MyClass.a, MyClass.b),</span>
<span class="go">        Bundle(&#39;b3&#39;, MyClass.x, MyClass.y)</span>
<span class="go">    )</span>

<span class="go">q = sess.query(b1).filter(</span>
<span class="go">    b1.c.b2.c.a == 5).filter(b1.c.b3.c.y == 9)</span></pre></div>
</div>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.orm.Bundle.c" title="sqlalchemy.orm.Bundle.c"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Bundle.c</span></code></a></p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.create_row_processor">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">create_row_processor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">query</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><span class="pre">Select</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">procs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="../../core/defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><span class="pre">Sequence</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><span class="pre">Row</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">labels</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="../../core/defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><span class="pre">Sequence</span></a><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><span class="pre">Row</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.Bundle.create_row_processor" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce the “row processing” function for this <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a>.</p>
<p>May be overridden by subclasses to provide custom behaviors when
results are fetched. The method is passed the statement object and a
set of “row processor” functions at query execution time; these
processor functions when given a result row will return the individual
attribute value, which can then be adapted into any kind of return data
structure.</p>
<p>The example below illustrates replacing the usual <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a>
return structure with a straight Python dictionary:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy.orm import Bundle</span>

<span class="go">class DictBundle(Bundle):</span>
<span class="go">    def create_row_processor(self, query, procs, labels):</span>
<span class="go">        &#39;Override create_row_processor to return values as</span>
<span class="go">        dictionaries&#39;</span>

<span class="go">        def proc(row):</span>
<span class="go">            return dict(</span>
<span class="go">                zip(labels, (proc(row) for proc in procs))</span>
<span class="go">            )</span>
<span class="go">        return proc</span></pre></div>
</div>
<p>A result from the above <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a> will return dictionary
values:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">bn = DictBundle(&#39;mybundle&#39;, MyClass.data1, MyClass.data2)</span>
<span class="go">for row in session.execute(select(bn)).where(bn.c.data1 == &#39;d1&#39;):</span>
<span class="go">    print(row.mybundle[&#39;data1&#39;], row.mybundle[&#39;data2&#39;])</span></pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.is_aliased_class">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">is_aliased_class</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">False</span></em><a class="headerlink" href="#sqlalchemy.orm.Bundle.is_aliased_class" title="Permalink to this definition">¶</a></dt>
<dd><p>True if this object is an instance of <a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.is_bundle">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">is_bundle</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">True</span></em><a class="headerlink" href="#sqlalchemy.orm.Bundle.is_bundle" title="Permalink to this definition">¶</a></dt>
<dd><p>True if this object is an instance of <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.is_clause_element">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">is_clause_element</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">False</span></em><a class="headerlink" href="#sqlalchemy.orm.Bundle.is_clause_element" title="Permalink to this definition">¶</a></dt>
<dd><p>True if this object is an instance of
<a class="reference internal" href="../../core/foundation.html#sqlalchemy.sql.expression.ClauseElement" title="sqlalchemy.sql.expression.ClauseElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClauseElement</span></code></a>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.is_mapper">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">is_mapper</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">False</span></em><a class="headerlink" href="#sqlalchemy.orm.Bundle.is_mapper" title="Permalink to this definition">¶</a></dt>
<dd><p>True if this object is an instance of <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.label">
<em class="property"><span class="pre">method</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">label</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.orm.Bundle.label" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide a copy of this <a class="reference internal" href="#sqlalchemy.orm.Bundle" title="sqlalchemy.orm.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a> passing a new label.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="sqlalchemy.orm.Bundle.single_entity">
<em class="property"><span class="pre">attribute</span> </em><a class="reference internal" href="#sqlalchemy.orm.Bundle"><code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm.Bundle.</span></code></a><span class="sig-name descname"><span class="pre">single_entity</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">False</span></em><a class="headerlink" href="#sqlalchemy.orm.Bundle.single_entity" title="Permalink to this definition">¶</a></dt>
<dd><p>If True, queries for a single Bundle will be returned as a single
entity, rather than an element within a keyed tuple.</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.with_loader_criteria">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">with_loader_criteria</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">entity_or_base</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_EntityType</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">where_criteria</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_ColumnExpressionArgument</span><span class="p"><span class="pre">[</span></span><span class="pre">bool</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">loader_only</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">include_aliases</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">propagate_to_loaders</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">track_closure_variables</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">LoaderCriteriaOption</span></span></span><a class="headerlink" href="#sqlalchemy.orm.with_loader_criteria" title="Permalink to this definition">¶</a></dt>
<dd><p>Add additional WHERE criteria to the load for all occurrences of
a particular entity.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.</span></p>
</div>
<p>The <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> option is intended to add
limiting criteria to a particular kind of entity in a query,
<strong>globally</strong>, meaning it will apply to the entity as it appears
in the SELECT query as well as within any subqueries, join
conditions, and relationship loads, including both eager and lazy
loaders, without the need for it to be specified in any particular
part of the query.    The rendering logic uses the same system used by
single table inheritance to ensure a certain discriminator is applied
to a table.</p>
<p>E.g., using <span class="xref std std-term">2.0-style</span> queries, we can limit the way the
<code class="docutils literal notranslate"><span class="pre">User.addresses</span></code> collection is loaded, regardless of the kind
of loading used:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy.orm import with_loader_criteria</span>

<span class="go">stmt = select(User).options(</span>
<span class="go">    selectinload(User.addresses),</span>
<span class="go">    with_loader_criteria(Address, Address.email_address != &#39;foo&#39;))</span>
<span class="go">)</span></pre></div>
</div>
<p>Above, the “selectinload” for <code class="docutils literal notranslate"><span class="pre">User.addresses</span></code> will apply the
given filtering criteria to the WHERE clause.</p>
<p>Another example, where the filtering will be applied to the
ON clause of the join, in this example using <span class="xref std std-term">1.x style</span>
queries:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">q = session.query(User).outerjoin(User.addresses).options(</span>
<span class="go">    with_loader_criteria(Address, Address.email_address != &#39;foo&#39;))</span>
<span class="go">)</span></pre></div>
</div>
<p>The primary purpose of <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> is to use
it in the <a class="reference internal" href="../events.html#sqlalchemy.orm.SessionEvents.do_orm_execute" title="sqlalchemy.orm.SessionEvents.do_orm_execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.do_orm_execute()</span></code></a> event handler
to ensure that all occurrences of a particular entity are filtered
in a certain way, such as filtering for access control roles.    It
also can be used to apply criteria to relationship loads.  In the
example below, we can apply a certain set of rules to all queries
emitted by a particular <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session = Session(bind=engine)</span>

<span class="go">@event.listens_for(&quot;do_orm_execute&quot;, session)</span>
<span class="go">def _add_filtering_criteria(execute_state):</span>

<span class="go">    if (</span>
<span class="go">        execute_state.is_select</span>
<span class="go">        and not execute_state.is_column_load</span>
<span class="go">        and not execute_state.is_relationship_load</span>
<span class="go">    ):</span>
<span class="go">        execute_state.statement = execute_state.statement.options(</span>
<span class="go">            with_loader_criteria(</span>
<span class="go">                SecurityRole,</span>
<span class="go">                lambda cls: cls.role.in_([&#39;some_role&#39;]),</span>
<span class="go">                include_aliases=True</span>
<span class="go">            )</span>
<span class="go">        )</span></pre></div>
</div>
<p>In the above example, the <a class="reference internal" href="../events.html#sqlalchemy.orm.SessionEvents.do_orm_execute" title="sqlalchemy.orm.SessionEvents.do_orm_execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.do_orm_execute()</span></code></a>
event will intercept all queries emitted using the
<code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code>. For those queries which are SELECT statements
and are not attribute or relationship loads a custom
<a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> option is added to the query.    The
<a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> option will be used in the given
statement and will also be automatically propagated to all relationship
loads that descend from this query.</p>
<p>The criteria argument given is a <code class="docutils literal notranslate"><span class="pre">lambda</span></code> that accepts a <code class="docutils literal notranslate"><span class="pre">cls</span></code>
argument.  The given class will expand to include all mapped subclass
and need not itself be a mapped class.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When using <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> option in
conjunction with the <code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code> loader option,
it’s important to note that <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> only
affects the part of the query that determines what SQL is rendered
in terms of the WHERE and FROM clauses. The
<code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code> option does not affect the rendering of
the SELECT statement outside of the columns clause, so does not have
any interaction with the <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> option.
However, the way things “work” is that <code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code>
is meant to be used with a query that is already selecting from the
additional entities in some way, where
<a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> can apply it’s additional
criteria.</p>
<p>In the example below, assuming a mapping relationship as
<code class="docutils literal notranslate"><span class="pre">A</span> <span class="pre">-&gt;</span> <span class="pre">A.bs</span> <span class="pre">-&gt;</span> <span class="pre">B</span></code>, the given <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a>
option will affect the way in which the JOIN is rendered:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">stmt = select(A).join(A.bs).options(</span>
<span class="go">    contains_eager(A.bs),</span>
<span class="go">    with_loader_criteria(B, B.flag == 1)</span>
<span class="go">)</span></pre></div>
</div>
<p>Above, the given <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> option will
affect the ON clause of the JOIN that is specified by
<code class="docutils literal notranslate"><span class="pre">.join(A.bs)</span></code>, so is applied as expected. The
<code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code> option has the effect that columns from
<code class="docutils literal notranslate"><span class="pre">B</span></code> are added to the columns clause:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">SELECT</span>
<span class="go">    b.id, b.a_id, b.data, b.flag,</span>
<span class="go">    a.id AS id_1,</span>
<span class="go">    a.data AS data_1</span>
<span class="go">FROM a JOIN b ON a.id = b.a_id AND b.flag = :flag_1</span></pre></div>
</div>
<p>The use of the <code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code> option within the above
statement has no effect on the behavior of the
<a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> option. If the
<code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code> option were omitted, the SQL would be
the same as regards the FROM and WHERE clauses, where
<a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> continues to add its criteria to
the ON clause of the JOIN. The addition of
<code class="xref py py-func docutils literal notranslate"><span class="pre">contains_eager()</span></code> only affects the columns clause, in that
additional columns against <code class="docutils literal notranslate"><span class="pre">b</span></code> are added which are then consumed
by the ORM to produce <code class="docutils literal notranslate"><span class="pre">B</span></code> instances.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The use of a lambda inside of the call to
<a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> is only invoked <strong>once per unique
class</strong>. Custom functions should not be invoked within this lambda.
See <a class="reference internal" href="../../core/connections.html#engine-lambda-caching"><span class="std std-ref">使用Lambda在语句生成中添加显着的速度增益</span></a> for an overview of the “lambda SQL”
feature, which is for advanced use only.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.with_loader_criteria.params.entity_or_base"></span><strong>entity_or_base</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.with_loader_criteria.params.entity_or_base">¶</a> – a mapped class, or a class that is a super
class of a particular set of mapped classes, to which the rule
will apply.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.with_loader_criteria.params.where_criteria"></span><strong>where_criteria</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.with_loader_criteria.params.where_criteria">¶</a> – <p>a Core SQL expression that applies limiting
criteria.   This may also be a “lambda:” or Python function that
accepts a target class as an argument, when the given class is
a base with many different mapped subclasses.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To support pickling, use a module-level Python function to
produce the SQL expression instead of a lambda or a fixed SQL
expression, which tend to not be picklable.</p>
</div>
</p></li>
<li><p><span class="target" id="sqlalchemy.orm.with_loader_criteria.params.include_aliases"></span><strong>include_aliases</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.with_loader_criteria.params.include_aliases">¶</a> – if True, apply the rule to <a class="reference internal" href="#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a>
constructs as well.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.with_loader_criteria.params.propagate_to_loaders"></span><strong>propagate_to_loaders</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.with_loader_criteria.params.propagate_to_loaders">¶</a> – <p>defaults to True, apply to relationship
loaders such as lazy loaders.   This indicates that the
option object itself including SQL expression is carried along with
each loaded instance.  Set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to prevent the object from
being assigned to individual instances.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../examples.html#examples-session-orm-events"><span class="std std-ref">ORM 查询事件</span></a> - includes examples of using
<a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a>.</p>
<p><a class="reference internal" href="../session_events.html#do-orm-execute-global-criteria"><span class="std std-ref">添加全局WHERE/ON条件</span></a> - basic example on how to
combine <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> with the
<a class="reference internal" href="../events.html#sqlalchemy.orm.SessionEvents.do_orm_execute" title="sqlalchemy.orm.SessionEvents.do_orm_execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.do_orm_execute()</span></code></a> event.</p>
</div>
</p></li>
<li><p><span class="target" id="sqlalchemy.orm.with_loader_criteria.params.track_closure_variables"></span><strong>track_closure_variables</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.with_loader_criteria.params.track_closure_variables">¶</a> – <p>when False, closure variables inside
of a lambda expression will not be used as part of
any cache key.    This allows more complex expressions to be used
inside of a lambda expression but requires that the lambda ensures
it returns the identical SQL every time given a particular class.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.0b2.</span></p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.join">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">join</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">left</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_FromClauseArgument</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">right</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_FromClauseArgument</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">onclause</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_OnClauseArgument</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">isouter</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">full</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_ORMJoin</span></span></span><a class="headerlink" href="#sqlalchemy.orm.join" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce an inner join between left and right clauses.</p>
<p><a class="reference internal" href="#sqlalchemy.orm.join" title="sqlalchemy.orm.join"><code class="xref py py-func docutils literal notranslate"><span class="pre">join()</span></code></a> is an extension to the core join interface
provided by <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.join" title="sqlalchemy.sql.expression.join"><code class="xref py py-func docutils literal notranslate"><span class="pre">join()</span></code></a>, where the
left and right selectable may be not only core selectable
objects such as <a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>, but also mapped classes or
<a class="reference internal" href="#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> instances.   The “on” clause can
be a SQL expression or an ORM mapped attribute
referencing a configured <code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code>.</p>
<p><a class="reference internal" href="#sqlalchemy.orm.join" title="sqlalchemy.orm.join"><code class="xref py py-func docutils literal notranslate"><span class="pre">join()</span></code></a> is not commonly needed in modern usage,
as its functionality is encapsulated within that of the
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a> and <a class="reference internal" href="query.html#sqlalchemy.orm.Query.join" title="sqlalchemy.orm.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a>
methods. which feature a
significant amount of automation beyond <a class="reference internal" href="#sqlalchemy.orm.join" title="sqlalchemy.orm.join"><code class="xref py py-func docutils literal notranslate"><span class="pre">join()</span></code></a>
by itself.  Explicit use of <a class="reference internal" href="#sqlalchemy.orm.join" title="sqlalchemy.orm.join"><code class="xref py py-func docutils literal notranslate"><span class="pre">join()</span></code></a>
with ORM-enabled SELECT statements involves use of the
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.select_from" title="sqlalchemy.sql.expression.Select.select_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.select_from()</span></code></a> method, as in:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy.orm import join</span>
<span class="go">stmt = select(User).\</span>
<span class="go">    select_from(join(User, Address, User.addresses)).\</span>
<span class="go">    filter(Address.email_address==&#39;foo@bar.com&#39;)</span></pre></div>
</div>
<p>In modern SQLAlchemy the above join can be written more
succinctly as:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">stmt = select(User).\</span>
<span class="go">        join(User.addresses).\</span>
<span class="go">        filter(Address.email_address==&#39;foo@bar.com&#39;)</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>using <a class="reference internal" href="#sqlalchemy.orm.join" title="sqlalchemy.orm.join"><code class="xref py py-func docutils literal notranslate"><span class="pre">join()</span></code></a> directly may not work properly
with modern ORM options such as <a class="reference internal" href="#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a>.
It is strongly recommended to use the idiomatic join patterns
provided by methods such as <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a> and
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.join_from" title="sqlalchemy.sql.expression.Select.join_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join_from()</span></code></a> when creating ORM joins.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="select.html#orm-queryguide-joins"><span class="std std-ref">连接</span></a> - in the <a class="reference internal" href="index.html"><span class="std std-ref">ORM 查询指南</span></a> for
background on idiomatic ORM join patterns</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.outerjoin">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">outerjoin</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">left</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_FromClauseArgument</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">right</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_FromClauseArgument</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">onclause</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_OnClauseArgument</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">full</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_ORMJoin</span></span></span><a class="headerlink" href="#sqlalchemy.orm.outerjoin" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce a left outer join between left and right clauses.</p>
<p>This is the “outer join” version of the <a class="reference internal" href="#sqlalchemy.orm.join" title="sqlalchemy.orm.join"><code class="xref py py-func docutils literal notranslate"><span class="pre">join()</span></code></a> function,
featuring the same behavior except that an OUTER JOIN is generated.
See that function’s documentation for other usage details.</p>
</dd></dl>

</section>
</section>
</section>
</section>
<aside class="topic">
<p class="topic-title">ORM 查询指南</p>
<p>下一个查询指南章节: <a class="reference internal" href="query.html"><span class="doc">Legacy查询API</span></a></p>
</aside>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="relationships.html" title="previous chapter">关系加载技术</a>
        Next:
        <a href="query.html" title="next chapter">Legacy查询API</a>

    <div id="docs-copyright">
        &copy; <a href="../../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 18:59:02

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../../_static/init.js"></script>


    </body>
</html>


