<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>
            
    
    列加载选项
 &mdash;
    SQLAlchemy 2.0 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
        <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../../index.html" />
        <link rel="up" title="ORM 查询指南" href="index.html" />
        <link rel="next" title="关系加载技术" href="relationships.html" />
        <link rel="prev" title="ORM-启用的INSERT、UPDATE和DELETE语句" href="dml.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.19</span>


        | Release Date: July 15, 2023

    </div>

    <h1><a href="../../index.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">



        <div id="docs-sidebar-popout">
            <h3><a href="../../index.html">SQLAlchemy 2.0 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../../index.html">Home</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="../index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="../quickstart.html">ORM快速入门</a></span></li>
<li><span class="link-container"><a class="reference external" href="../mapper_config.html">ORM映射类配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="../relationships.html">关系配置</a></span></li>
<li><span class="link-container"><a class="reference external" href="index.html">ORM 查询指南</a></span><ul>
<li><span class="link-container"><a class="reference external" href="select.html">使用ORM映射类编写SELECT语句</a></span></li>
<li><span class="link-container"><a class="reference external" href="inheritance.html">继承映射中编写SELECT语句</a></span></li>
<li><span class="link-container"><a class="reference external" href="dml.html">ORM-启用的INSERT、UPDATE和DELETE语句</a></span></li>
<li class="selected"><span class="link-container"><strong>列加载选项</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-column-deferral">使用列延迟选择要加载的列</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#load-only">使用“load_only()”减少加载列</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#id17">与多个实体一起使用“load_only()”</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-load-only-related">在相关对象和集合上使用 <code class="docutils literal notranslate"><span class="pre">load_only()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#defer">使用 <code class="docutils literal notranslate"><span class="pre">defer()</span></code> 省略特定列</a></span></li>
<li><span class="link-container"><a class="reference external" href="#raiseload">使用raiseload防止延迟列加载</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-deferred-declarative">配置映射的列缓期</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#deferred-sql">使用 <code class="docutils literal notranslate"><span class="pre">deferred()</span></code> 用于命令式映射，映射 SQL 表达式</a></span></li>
<li><span class="link-container"><a class="reference external" href="#undefer">使用 <code class="docutils literal notranslate"><span class="pre">undefer()</span></code> 来“急切”加载延迟列</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-queryguide-deferred-group">按组加载待决列</a></span></li>
<li><span class="link-container"><a class="reference external" href="#id29">使用通配符undefer</a></span></li>
<li><span class="link-container"><a class="reference external" href="#mapper-level-raiseload">配置默认的 mapper-level “raiseload” 行为</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#sql">将任意SQL表达式加载到对象上</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#union-with-expression">在 UNION 和其他子查询中使用 <code class="docutils literal notranslate"><span class="pre">with_expression()</span></code></a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#api">列加载 API</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.defer"><code class="docutils literal notranslate"><span class="pre">defer()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.deferred"><code class="docutils literal notranslate"><span class="pre">deferred()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.query_expression"><code class="docutils literal notranslate"><span class="pre">query_expression()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.load_only"><code class="docutils literal notranslate"><span class="pre">load_only()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.undefer"><code class="docutils literal notranslate"><span class="pre">undefer()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.undefer_group"><code class="docutils literal notranslate"><span class="pre">undefer_group()</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlalchemy.orm.with_expression"><code class="docutils literal notranslate"><span class="pre">with_expression()</span></code></a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="relationships.html">关系加载技术</a></span></li>
<li><span class="link-container"><a class="reference external" href="api.html">查询时使用的ORM API功能</a></span></li>
<li><span class="link-container"><a class="reference external" href="query.html">Legacy查询API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="../session.html">用 Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="../extending.html">事件和内部机制</a></span></li>
<li><span class="link-container"><a class="reference external" href="../extensions/index.html">ORM扩展</a></span></li>
<li><span class="link-container"><a class="reference external" href="../examples.html">ORM 示例</a></span></li>
</ul>



        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="../../search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12" />
            </label>
            <input type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>

        <p>
        <a href="../../index.html">Home</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="dml.html" title="previous chapter">ORM-启用的INSERT、UPDATE和DELETE语句</a></li>
                <li><b>Next:</b>
                <a href="relationships.html" title="next chapter">关系加载技术</a></li>

            <li><b>Up:</b> <a href="../../index.html">Home</a></li>
                    <ul><li><a href="../index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="index.html" title="ORM 查询指南">ORM 查询指南</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#loading-columns">列加载选项</a><ul>
<li><a class="reference internal" href="#orm-queryguide-column-deferral">使用列延迟选择要加载的列</a><ul>
<li><a class="reference internal" href="#load-only">使用“load_only()”减少加载列</a><ul>
<li><a class="reference internal" href="#id17">与多个实体一起使用“load_only()”</a></li>
<li><a class="reference internal" href="#orm-queryguide-load-only-related">在相关对象和集合上使用 <code class="docutils literal notranslate"><span class="pre">load_only()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#defer">使用 <code class="docutils literal notranslate"><span class="pre">defer()</span></code> 省略特定列</a></li>
<li><a class="reference internal" href="#raiseload">使用raiseload防止延迟列加载</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-queryguide-deferred-declarative">配置映射的列缓期</a><ul>
<li><a class="reference internal" href="#deferred-sql">使用 <code class="docutils literal notranslate"><span class="pre">deferred()</span></code> 用于命令式映射，映射 SQL 表达式</a></li>
<li><a class="reference internal" href="#undefer">使用 <code class="docutils literal notranslate"><span class="pre">undefer()</span></code> 来“急切”加载延迟列</a></li>
<li><a class="reference internal" href="#orm-queryguide-deferred-group">按组加载待决列</a></li>
<li><a class="reference internal" href="#id29">使用通配符undefer</a></li>
<li><a class="reference internal" href="#mapper-level-raiseload">配置默认的 mapper-level “raiseload” 行为</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sql">将任意SQL表达式加载到对象上</a><ul>
<li><a class="reference internal" href="#union-with-expression">在 UNION 和其他子查询中使用 <code class="docutils literal notranslate"><span class="pre">with_expression()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#api">列加载 API</a><ul>
<li><a class="reference internal" href="#sqlalchemy.orm.defer"><code class="docutils literal notranslate"><span class="pre">defer()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.deferred"><code class="docutils literal notranslate"><span class="pre">deferred()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.query_expression"><code class="docutils literal notranslate"><span class="pre">query_expression()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.load_only"><code class="docutils literal notranslate"><span class="pre">load_only()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.undefer"><code class="docutils literal notranslate"><span class="pre">undefer()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.undefer_group"><code class="docutils literal notranslate"><span class="pre">undefer_group()</span></code></a></li>
<li><a class="reference internal" href="#sqlalchemy.orm.with_expression"><code class="docutils literal notranslate"><span class="pre">with_expression()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class="withsidebar orm-queryguide-columns" >
        
<aside class="topic">
<p class="topic-title">ORM 查询指南</p>
<p>本页面是  <a class="reference internal" href="index.html"><span class="doc">ORM 查询指南</span></a>  的一部分。</p>
<p>上一页: <a class="reference internal" href="dml.html"><span class="doc">ORM-启用的INSERT、UPDATE和DELETE语句</span></a>   |   下一页: <a class="reference internal" href="relationships.html"><span class="doc">关系加载技术</span></a></p>
</aside>
<section id="loading-columns">
<span id="id1"></span><h1>列加载选项<a class="headerlink" href="#loading-columns" title="Permalink to this heading">¶</a></h1>
<div class="admonition- admonition">
<p class="admonition-title">关于该文档</p>
<p>本节提供与列加载相关的其他选项。采用的映射包括列存储
大字符串值，我们可能希望在加载这些值时进行限制。</p>
<blockquote>
<div><p><a class="reference internal" href="_deferred_setup.html"><span class="doc">查看此页面的ORM设置</span></a> 。一些</p>
</div></blockquote>
<p>下面的示例将重新定义“Book”映射器以修改
一些列定义。</p>
</div>
<section id="orm-queryguide-column-deferral">
<span id="id2"></span><h2>使用列延迟选择要加载的列<a class="headerlink" href="#orm-queryguide-column-deferral" title="Permalink to this heading">¶</a></h2>
<p><a href="#id3"><span class="problematic" id="id4">**</span></a>列延迟**是指在查询该类型的对象时省略了ORM映射的列。
SELECT语句。 一般的理由是性能，在表具有很少使用的列的情况下，
具有潜在大数据值的情况下，完全加载这些列的每个查询可能是
时间和/或内存密集型。 SQLAlchemy ORM提供了各种方法来
控制加载实体时列的方式。</p>
<p>本节中的大多数示例都说明**ORM加载器选项**。这些
是传递给  <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select.options" title="sqlalchemy.sql.expression.Select.options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.options()</span></code></a>  方法的小构造</p>
<blockquote>
<div><p>:class:<a href="#id5"><span class="problematic" id="id6">`</span></a>_sql.Select`对象，它们然后由ORM消耗</p>
</div></blockquote>
<p>当对象编译为SQL字符串时。</p>
<section id="load-only">
<span id="orm-queryguide-load-only"></span><h3>使用“load_only()”减少加载列<a class="headerlink" href="#load-only" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><p>:func:<a href="#id7"><span class="problematic" id="id8">`</span></a>_orm.load_only`加载器选项是载入对象时使用的最快的选项</p>
</div></blockquote>
<p>已知仅访问少量列。此选项接受可变数量的类绑定属性
对象，指示应加载哪些映射为列的属性，其中
所有主键之外的其他列映射的属性都不会成为
检索出的列。在下面的示例中，“Book”类包含
列“。title”，“.summary”和“。cover_photo”。使用</p>
<blockquote>
<div><p><a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a> ，我们可以指示ORM仅加载</p>
</div></blockquote>
<p>“。title”和“。summary”列:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">load_only</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">load_only</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">summary</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">books</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">SELECT book.id, book.title, book.summary</span>
<span class="go">FROM book</span>
<span class="go">[...] ()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span><span class="p">:</span>
<span class="go">...     print(f&quot;{book.title}  {book.summary}&quot;)</span>
<span class="go">100 Years of Krabby Patties  some long summary</span>
<span class="go">Sea Catch 22  another long summary</span>
<span class="go">The Sea Grapes of Wrath  yet another summary</span>
<span class="go">A Nut Like No Other  some long summary</span>
<span class="go">Geodesic Domes: A Retrospective  another long summary</span>
<span class="go">Rocketry for Squirrels  yet another summary</span></pre></div>
</div>
<p>上面，SELECT语句省略了“.cover_photo”列，
仅包括“。title”和“。summary”，以及主键列。
“.id”；ORM通常会始终获取主键列，因为这些列是必需的，
用于建立行的标识。</p>
<p>一旦加载，对象通常具有  <span class="xref std std-term">lazy loading</span>  行为
应用于其余的未加载属性，这意味着在首次访问任何属性时，
将在当前事务中发出SQL语句以加载值。下面，访问“.cover_photo”会发出SELECT
语句来加载其值:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">img_data</span> <span class="o">=</span> <span class="n">books</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cover_photo</span>
<span class="go">SELECT book.cover_photo AS book_cover_photo</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.id = ?</span>
<span class="go">[...] (1,)</span></pre></div>
</div>
<p>无论其附加状态如何，惰性负载始终使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">Session`发出来完成</span>
<span class="pre">对象处于</span>&#160; <span class="pre">:term:`persistent</span></code>  状态。如果对象是  <span class="xref std std-term">detached</span>
从任何 :class:<a href="#id9"><span class="problematic" id="id10">`</span></a>_orm.Session`中，该操作将失败，引发异常。</p>
<p>作为访问时的懒惰加载的替代方法，还可以配置延迟处理的列在访问时引发
一个信息丰富的异常，无论其附加状态如何。当使用：func:<a href="#id11"><span class="problematic" id="id12">`</span></a>_orm.load_only`时
可以使用：paramref:<a href="#id13"><span class="problematic" id="id14">`</span></a>_orm.load_only.raiseload`参数进行指示。
有关背景和示例，请参见第：ref:<a href="#id15"><span class="problematic" id="id16">`</span></a>orm_queryguide_deferred_raiseload`节。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>如其他地方所述，使用时无法使用懒加载
<a class="reference internal" href="../extensions/asyncio.html"><span class="std std-ref">异步 I/O (asyncio)</span></a> 。</p>
</div>
<section id="id17">
<h4>与多个实体一起使用“load_only()”<a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>:func:<a href="#id18"><span class="problematic" id="id19">`</span></a>_orm.load_only`仅限于其属性列表中引用的单个实体</p>
</div></blockquote>
<dl class="simple">
<dt>（当前不允许传递跨越多个实体的属性列表）。在下面的示例中，选择的内容</dt><dd><p>:func:<a href="#id20"><span class="problematic" id="id21">`</span></a>_orm.load_only`选项仅适用于“Book”实体。另一方面，“User”</p>
</dd>
</dl>
<p>选择的实体不受影响；在生成的SELECT中，所有for“user_account”的列都存在，
而只有“book.id”和“book.title”存在于“book”表中:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">load_only</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>    <span class="o">&gt;&gt;&gt;</span> <span class="n">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span><span class="p">,</span>
<span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id_1</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">title</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span>
</div></pre></div>
</div>
<p>如果我们想要对 <code class="docutils literal notranslate"><span class="pre">User</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Book</span></code> 都应用   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a> ，我们需要使用两个单独的选项：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Book</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Book</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">load_only</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">load_only</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="go">{printsql}SELECT user_account.id, user_account.name, book.id AS id_1, book.title</span>
<span class="go">FROM user_account JOIN book ON user_account.id = book.owner_id</span></pre></div>
</div>
</section>
<section id="orm-queryguide-load-only-related">
<span id="id22"></span><h4>在相关对象和集合上使用 <code class="docutils literal notranslate"><span class="pre">load_only()</span></code><a class="headerlink" href="#orm-queryguide-load-only-related" title="Permalink to this heading">¶</a></h4>
<p>当使用   <span class="xref std std-ref">relationship loaders</span>  在控制相关对象的加载时，任何关系载入器的  <a class="reference internal" href="relationships.html#sqlalchemy.orm.Load.load_only" title="sqlalchemy.orm.Load.load_only"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Load.load_only()</span></code></a>  方法都可以用于在子实体上应用   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  规则。在下面的示例中，我们使用了   <code class="xref py py-func docutils literal notranslate"><span class="pre">selectinload()</span></code>  来加载每个 <code class="docutils literal notranslate"><span class="pre">User</span></code> 对象上的相关 <code class="docutils literal notranslate"><span class="pre">books</span></code> 集合。通过在生成的选项对象上应用  <a class="reference internal" href="relationships.html#sqlalchemy.orm.Load.load_only" title="sqlalchemy.orm.Load.load_only"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Load.load_only()</span></code></a> ，当为关系加载对象时，生成的 SELECT 将仅参考 <code class="docutils literal notranslate"><span class="pre">title</span></code> 列，除了主键列：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">selectinload</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">selectinload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">books</span><span class="p">)</span><span class="o">.</span><span class="n">load_only</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">title</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">books</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">{execsql}SELECT user_account.id, user_account.name, user_account.fullname</span>
<span class="go">FROM user_account</span>
<span class="go">[...] ()</span>
<span class="go">SELECT book.owner_id AS book_owner_id, book.id AS book_id, book.title AS book_title</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.owner_id IN (?, ?)</span>
<span class="go">[...] (1, 2)</span>
<span class="go">{stop}Spongebob Squarepants   [&#39;100 Years of Krabby Patties&#39;, &#39;Sea Catch 22&#39;, &#39;The Sea Grapes of Wrath&#39;]</span>
<span class="go">Sandy Cheeks   [&#39;A Nut Like No Other&#39;, &#39;Geodesic Domes: A Retrospective&#39;, &#39;Rocketry for Squirrels&#39;]</span></pre></div>
</div>
<p>可以同时应用   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  到子实体上，而不需要为关系本身指定加载样式。如果我们不想改变 <code class="docutils literal notranslate"><span class="pre">User.books</span></code> 的默认加载方式，但仍要对 <code class="docutils literal notranslate"><span class="pre">Book</span></code> 应用 load only 规则，我们将使用   <code class="xref py py-func docutils literal notranslate"><span class="pre">defaultload()</span></code>  选项进行链接，在这种情况下，将保留关系的默认加载样式 “lazy”，并将自定义的   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  规则应用于为每个 <code class="docutils literal notranslate"><span class="pre">User.books</span></code> 集合发出的 SELECT 语句：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">defaultload</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">defaultload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">books</span><span class="p">)</span><span class="o">.</span><span class="n">load_only</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">title</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">books</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">{execsql}SELECT user_account.id, user_account.name, user_account.fullname</span>
<span class="go">FROM user_account</span>
<span class="go">[...] ()</span>
<span class="go">SELECT book.id AS book_id, book.title AS book_title</span>
<span class="go">FROM book</span>
<span class="go">WHERE ? = book.owner_id</span>
<span class="go">[...] (1,)</span>
<span class="go">{stop}Spongebob Squarepants   [&#39;100 Years of Krabby Patties&#39;, &#39;Sea Catch 22&#39;, &#39;The Sea Grapes of Wrath&#39;]</span>
<span class="go">{execsql}SELECT book.id AS book_id, book.title AS book_title</span>
<span class="go">FROM book</span>
<span class="go">WHERE ? = book.owner_id</span>
<span class="go">[...] (2,)</span>
<span class="go">{stop}Sandy Cheeks   [&#39;A Nut Like No Other&#39;, &#39;Geodesic Domes: A Retrospective&#39;, &#39;Rocketry for Squirrels&#39;]</span></pre></div>
</div>
</section>
</section>
<section id="defer">
<span id="orm-queryguide-defer"></span><h3>使用 <code class="docutils literal notranslate"><span class="pre">defer()</span></code> 省略特定列<a class="headerlink" href="#defer" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><p><a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  载入选项是   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  的更细粒度的替代方法，它允许将单个特定的列标记为 “不加载”。在下面的示例中，   <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  直接应用于 <code class="docutils literal notranslate"><span class="pre">.cover_photo</span></code> 列，留下了所有其他列的行为不变：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">defer</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">defer</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">cover_photo</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">books</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">{execsql}SELECT book.id, book.owner_id, book.title, book.summary</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.owner_id = ?</span>
<span class="go">[...] (2,)</span>
<span class="go">{stop}&gt;&gt;&gt; for book in books:</span>
<span class="go">...     print(f&quot;{book.title}: {book.summary}&quot;)</span>
<span class="go">A Nut Like No Other: some long summary</span>
<span class="go">Geodesic Domes: A Retrospective: another long summary</span>
<span class="go">Rocketry for Squirrels: yet another summary</span></pre></div>
</div>
</div></blockquote>
<p>与   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  一样，默认情况下未加载的列将在使用  <span class="xref std std-term">lazy loading</span>  时加载自己：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">img_data</span> <span class="o">=</span> <span class="n">books</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cover_photo</span>
<span class="go">{execsql}SELECT book.cover_photo AS book_cover_photo</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.id = ?</span>
<span class="go">[...] (4,)</span></pre></div>
</div>
<p>可以在一个语句中使用多个   <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  选项，以便将多个列标记为延迟加载。</p>
<p>与   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  一样，  <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  选项会延迟加载的列还可以使用“raiseload”属性在访问时引发异常，而不是惰性加载。在下面的章节“:ref：<cite>orm_queryguide_deferred_raiseload</cite>”中给出了示例。</p>
<blockquote>
<div></div></blockquote>
</section>
<section id="raiseload">
<span id="orm-queryguide-deferred-raiseload"></span><h3>使用raiseload防止延迟列加载<a class="headerlink" href="#raiseload" title="Permalink to this heading">¶</a></h3>
<p>在使用   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  或   <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  加载选项时，将对象上标记为deferred的属性具有默认行为何时首次访问，当前事务内将发出SELECT语句以加载它们的值。通常需要防止这种负载发生，而是在访问属性时引发异常，表示不期望为此列查询数据库。一个典型的场景是加载全部已知所需的列的对象以使操作继续进行，然后将它们传递到视图层中。在视图层内发出的任何其他SQL操作都应该被捕获，以便可以调整启动时的加载操作以适应该附加数据，而不是产生额外的惰性加载。</p>
<p>对于此用例，   <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  和   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  选项包括一个 boolean 参数  <a href="#id23"><span class="problematic" id="id24">:parg:`~_orm.defer.raiseload`</span></a>  ，当设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> 时，将导致受影响的属性在访问时引发异常。在下面的示例中，将取消该:deferred列`.cover_photo`上的属性访问权限:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
<span class="go">...     select(Book).options(defer(Book.cover_photo, raiseload=True)).where(Book.id == 4)</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">summary</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">book</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span><span class="o">.</span><span class="n">cover_photo</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="go">...</span>
<span class="go">sqlalchemy.exc.InvalidRequestError: &#39;Book.cover_photo&#39; is not available due to raiseload=True</span></pre></div>
</div>
<p>当使用   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  指定一组特定的未延迟的列时， <code class="docutils literal notranslate"><span class="pre">raiseload</span></code> 行为可能适用于剩余列，使用  <a class="reference internal" href="#sqlalchemy.orm.load_only.params.raiseload" title="sqlalchemy.orm.load_only"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">load_only.raiseload</span></code></a>  参数，该参数将应用于所有  <span class="xref std std-term">deferred attribute</span></p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">expunge_all</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
<span class="go">...     select(Book).options(load_only(Book.title, raiseload=True)).where(Book.id == 5)</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">title</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">book</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">,)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span><span class="o">.</span><span class="n">summary</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="go">...</span>
<span class="go">sqlalchemy.exc.InvalidRequestError: &#39;Book.summary&#39; is not available due to raiseload=True</span></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>目前尚不能在一个语句中混合   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  和   <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  选项，这些选项引用相同的实体以更改某些属性的 <code class="docutils literal notranslate"><span class="pre">raiseload</span></code> 行为；当前，这样做会产生属性的未定义加载行为。</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.orm.defer.params.raiseload" title="sqlalchemy.orm.defer"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">defer.raiseload</span></code></a>  一节。</p>
</div>
</section>
</section>
<section id="orm-queryguide-deferred-declarative">
<span id="id25"></span><h2>配置映射的列缓期<a class="headerlink" href="#orm-queryguide-deferred-declarative" title="Permalink to this heading">¶</a></h2>
<p>对于默认情况下不应在每个查询中无条件加载的列，可以将   <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  功能作为映射列的默认行为。为了配置，使用   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>  的  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred</span></code>  参数。下面的示例说明了适用于 <code class="docutils literal notranslate"><span class="pre">Book</span></code> 的映射，将默认列延迟应用于 <code class="docutils literal notranslate"><span class="pre">summary</span></code> 和 <code class="docutils literal notranslate"><span class="pre">cover_photo</span></code> 列：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;book&quot;</span>
<span class="gp">... </span>    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">owner_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">title</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">summary</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">cover_photo</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">LargeBinary</span><span class="p">,</span> <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Book(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">!r}</span><span class="s2">, title=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">!r}</span><span class="s2">)&quot;</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>使用上述映射，针对 <code class="docutils literal notranslate"><span class="pre">Book</span></code> 的查询将自动不包括 <code class="docutils literal notranslate"><span class="pre">summary</span></code> 和 <code class="docutils literal notranslate"><span class="pre">cover_photo</span></code> 列：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
<span class="go">{execsql}SELECT book.id, book.owner_id, book.title</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.id = ?</span>
<span class="go">[...] (2,)</span></pre></div>
</div>
<p>在所有缓期中都是这样，当首次访问加载对象上的deferred属性时，它们将  <span class="xref std std-term">lazy load</span>  他们的值。</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">img_data</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">cover_photo</span>
<span class="go">{execsql}SELECT book.cover_photo AS book_cover_photo</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.id = ?</span>
<span class="go">[...] (2,)</span></pre></div>
</div>
<p>与   <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a>  和   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  加载器选项一样，映射器级别的延迟也包括一个 <code class="docutils literal notranslate"><span class="pre">raiseload</span></code> 选项。当没有其他选项时，由于行为发生，而不是延迟加载。这允许映射在某些列默认情况下不加载，而且不会在语句中使用显式指令的情况下懒惰地加载。请参阅   <a class="reference internal" href="#orm-queryguide-mapper-deferred-raiseload"><span class="std std-ref">配置默认的 mapper-level “raiseload” 行为</span></a>  部分，了解如何配置和使用此行为。</p>
<section id="deferred-sql">
<span id="orm-queryguide-deferred-imperative"></span><h3>使用 <code class="docutils literal notranslate"><span class="pre">deferred()</span></code> 用于命令式映射，映射 SQL 表达式<a class="headerlink" href="#deferred-sql" title="Permalink to this heading">¶</a></h3>
<p>在引入   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>  构造之前，   <a class="reference internal" href="#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a>  函数是早期的、更通用的“延迟列”映射指令。</p>
<p>当配置 ORM 映射器时，可以使用   <a class="reference internal" href="#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a>  ，并接受任意 SQL 表达式或   <a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>  对象作为参数。因此，当使用非声明性   <a class="reference internal" href="../mapping_styles.html#orm-imperative-mapping"><span class="std std-ref">imperative mappings</span></a>  时，它适用于传递到  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">map_imperatively.properties</span></code>  字典中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Blob</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>

<span class="n">book_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;book&quot;</span><span class="p">,</span>
    <span class="n">mapper_registry</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;cover_image&quot;</span><span class="p">,</span> <span class="n">Blob</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">Book</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span>
    <span class="n">Book</span><span class="p">,</span>
    <span class="n">book_table</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">deferred</span><span class="p">(</span><span class="n">book_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">summary</span><span class="p">),</span>
        <span class="s2">&quot;cover_image&quot;</span><span class="p">:</span> <span class="n">deferred</span><span class="p">(</span><span class="n">book_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cover_image</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>当映射的 SQL 表达式应该延迟加载时，   <a class="reference internal" href="#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a>  也可以用于替代   <code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code>  ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">deferred</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">firstname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">lastname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">deferred</span><span class="p">(</span><span class="n">firstname</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">lastname</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../mapped_sql_expr.html#mapper-column-property-sql-expressions"><span class="std std-ref">使用column_property</span></a> - 参见   <a class="reference internal" href="../mapped_sql_expr.html#mapper-sql-expressions"><span class="std std-ref">将SQL表达式映射为属性</span></a>  部分</p>
<p><span class="xref std std-ref">orm_imperative_table_column_options</span> - 参见   <a class="reference internal" href="../declarative_tables.html"><span class="std std-ref">使用Declarative配置Table</span></a>  部分</p>
</div>
</section>
<section id="undefer">
<h3>使用 <code class="docutils literal notranslate"><span class="pre">undefer()</span></code> 来“急切”加载延迟列<a class="headerlink" href="#undefer" title="Permalink to this heading">¶</a></h3>
<p>默认情况下，如果某些列的映射已经被延迟，   <a class="reference internal" href="#sqlalchemy.orm.undefer" title="sqlalchemy.orm.undefer"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer()</span></code></a>  选项将会导致任何一列被快速地加载，即与映射的所有其他列一起提前加载。例如，我们可以将   <a class="reference internal" href="#sqlalchemy.orm.undefer" title="sqlalchemy.orm.undefer"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer()</span></code></a>  应用于以前映射中标记为延迟的 <code class="docutils literal notranslate"><span class="pre">Book.summary</span></code> 列：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">undefer</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">undefer</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">summary</span><span class="p">)))</span>
<span class="go">{execsql}SELECT book.id, book.owner_id, book.title, book.summary</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.id = ?</span>
<span class="go">[...] (2,)</span></pre></div>
</div>
<p>现在 “Book.summary” 行被急切地加载，可以在不发出额外 SQL 的情况下访问：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">book</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
<span class="go">another long summary</span></pre></div>
</div>
</section>
<section id="orm-queryguide-deferred-group">
<span id="id26"></span><h3>按组加载待决列<a class="headerlink" href="#orm-queryguide-deferred-group" title="Permalink to this heading">¶</a></h3>
<p>通常情况下，当映射了延迟属性时，在访问一个对象上的属性时，将仅加载该列，而不加载其他列，即使映射中具有其他标记为延迟的列。通常情况下，“延迟”属性是与一组属性共同加载的。在公共情况下，  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred_group</span></code>  参数可以使用，它接受一个任意的字符串，用于定义一组共同的要不加载的列 ：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;book&quot;</span>
<span class="gp">... </span>    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">owner_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">title</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">summary</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">Text</span><span class="p">,</span> <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deferred_group</span><span class="o">=</span><span class="s2">&quot;book_attrs&quot;</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span>    <span class="n">cover_photo</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">LargeBinary</span><span class="p">,</span> <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deferred_group</span><span class="o">=</span><span class="s2">&quot;book_attrs&quot;</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Book(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">!r}</span><span class="s2">, title=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">!r}</span><span class="s2">)&quot;</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>使用上述映射，访问 <code class="docutils literal notranslate"><span class="pre">summary</span></code> 或 <code class="docutils literal notranslate"><span class="pre">cover_photo</span></code> 时将一次性加载这两个列，只需使用一条 SQL 语句：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
<span class="go">{execsql}SELECT book.id, book.owner_id, book.title</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.id = ?</span>
<span class="go">[...] (2,)</span>
<span class="go">{stop}&gt;&gt;&gt; img_data, summary = book.cover_photo, book.summary</span>
<span class="go">{execsql}SELECT book.summary AS book_summary, book.cover_photo AS book_cover_photo</span>
<span class="go">FROM book</span>
<span class="go">WHERE book.id = ?</span>
<span class="go">[...] (2,)</span></pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">undefer_group()</span></code> 按组取消加载延迟列
=============================================如果在之前的章节中使用了  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred_group</span></code>  对延迟加载的列进行了配置，可以使用 :func:<a href="#id27"><span class="problematic" id="id28">`</span></a>_orm.undefer_group`选项一次指定整个组加载方式为立即加载，需要传递组的字符串名称:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">undefer_group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
<span class="go">...     select(Book).where(Book.id == 2).options(undefer_group(&quot;book_attrs&quot;))</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">summary</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">cover_photo</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">book</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
</div></pre></div>
</div>
<p>这时，不需要进行其他操作就可以访问到所有延迟加载的列内容:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">img_data</span><span class="p">,</span> <span class="n">summary</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">cover_photo</span><span class="p">,</span> <span class="n">book</span><span class="o">.</span><span class="n">summary</span></pre></div>
</div>
</section>
<section id="id29">
<h3>使用通配符undefer<a class="headerlink" href="#id29" title="Permalink to this heading">¶</a></h3>
<p>ORM加载器的大多数选项都接受通配符表达式，用 “*” 表示，它表示将选项应用于所有相关属性。如果映射具有一系列延迟加载的列，则可以通过使用通配符一次性未定义所有这些列来引用它们，而无需使用组名:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">undefer</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)))</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">summary</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">cover_photo</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">book</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
</div></pre></div>
</div>
</section>
<section id="mapper-level-raiseload">
<span id="orm-queryguide-mapper-deferred-raiseload"></span><h3>配置默认的 mapper-level “raiseload” 行为<a class="headerlink" href="#mapper-level-raiseload" title="Permalink to this heading">¶</a></h3>
<p>首先介绍的   <a class="reference internal" href="#orm-queryguide-deferred-raiseload"><span class="std std-ref">使用raiseload防止延迟列加载</span></a>  “raiseload” 行为也可以使用   <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>  的  <code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred_raiseload</span></code>  参数作为默认的映射级别实现。
使用此参数时，受影响的列将始终在访问时抛出异常，除非在查询时专门使用   <a class="reference internal" href="#sqlalchemy.orm.undefer" title="sqlalchemy.orm.undefer"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer()</span></code></a>  或   <a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a>  取消延迟加载:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="go">...     __tablename__ = &quot;book&quot;</span>
<span class="go">...     id: Mapped[int] = mapped_column(primary_key=True)</span>
<span class="go">...     owner_id: Mapped[int] = mapped_column(ForeignKey(&quot;user_account.id&quot;))</span>
<span class="go">...     title: Mapped[str]</span>
<span class="go">...     summary: Mapped[str] = mapped_column(Text, deferred=True, deferred_raiseload=True)</span>
<span class="go">...     cover_photo: Mapped[bytes] = mapped_column(</span>
<span class="go">...         LargeBinary, deferred=True, deferred_raiseload=True</span>
<span class="go">...     )</span>
<span class="go">...</span>
<span class="go">...     def __repr__(self) -&gt; str:</span>
<span class="go">...         return f&quot;Book(id={self.id!r}, title={self.title!r})&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>使用上述映射时，默认情况下不会加载 <code class="docutils literal notranslate"><span class="pre">.summary</span></code> 和 <code class="docutils literal notranslate"><span class="pre">.cover_photo</span></code> 列:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">title</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">book</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span><span class="o">.</span><span class="n">summary</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="go">...</span>
<span class="go">sqlalchemy.exc.InvalidRequestError: &#39;Book.summary&#39; is not available due to raiseload=True</span></pre></div>
</div>
<p>只有通过在查询时重写其行为，通常使用   <a class="reference internal" href="#sqlalchemy.orm.undefer" title="sqlalchemy.orm.undefer"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer()</span></code></a>  或   <a class="reference internal" href="#sqlalchemy.orm.undefer_group" title="sqlalchemy.orm.undefer_group"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer_group()</span></code></a> ，
或者不常规使用   <a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a> ，才能加载这些属性。
下面的示例将 <code class="docutils literal notranslate"><span class="pre">undefer('*')</span></code> 应用于取消延迟加载所有属性，并使用   <a class="reference internal" href="api.html#orm-queryguide-populate-existing"><span class="std std-ref">填充现有的实例</span></a>  刷新已加载的对象的加载选项:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
<span class="go">...     select(Book)</span>
<span class="go">...     .where(Book.id == 2)</span>
<span class="go">...     .options(undefer(&quot;*&quot;))</span>
<span class="go">...     .execution_options(populate_existing=True)</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">summary</span><span class="p">,</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">cover_photo</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">book</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">book</span><span class="o">.</span><span class="n">summary</span>
<span class="go">&#39;another long summary&#39;</span></pre></div>
</div>
</section>
</section>
<section id="sql">
<span id="orm-queryguide-with-expression"></span><h2>将任意SQL表达式加载到对象上<a class="headerlink" href="#sql" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt>如   <a class="reference internal" href="select.html#orm-queryguide-select-columns"><span class="std std-ref">选择ORM实体和属性</span></a>  和其他地方所述，</dt><dd><p><a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>  构造可以用于在结果集中加载任意的 SQL 表达式。例如，如果我们想要发出一个查询来加载 <cite>User</cite> 对象，同时也包括每个 <cite>User</cite> 拥有的书籍数量的计数，我们可以使用 <cite>func.count(Book.id)</cite> 向一个包含 Join 到 <cite>Book</cite> 的查询中添加一个”count”列，以及一个根据拥有者 id 分组的 GROUP BY。这将产生   <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a>  对象，每个对象包含两个条目，一个是 <cite>User</cite>，另一个是 <cite>func.count(Book.id)</cite>。</p>
</dd>
</dl>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">book_count</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="go">...     print(f&quot;Username: {user.name}  Number of books: {book_count}&quot;)</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">()</span>
</div><span class="go">Username: spongebob  Number of books: 3</span>
<span class="go">Username: sandy  Number of books: 3</span></pre></div>
</div>
<p>在上面的例子中，<cite>User</cite> 实体和”book count” SQL 表达式是分别返回的。但是，一个流行的用例是生成一个查询，它将仅返回 <cite>User</cite> 对象，这些对象可以被迭代，例如使用  <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.scalars()</span></code> ，其中 <cite>func.count(Book.id)</cite> SQL 表达式将被 <a href="#id30"><span class="problematic" id="id31">*</span></a>动态*地应用到每个 <cite>User</cite> 实体上。最终结果将类似于将任意的 SQL 表达式映射到类中，但 SQL 表达式可以在查询时被修改。对于这种用例，SQLAlchemy 提供了   <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  加载选项，当与映射器级别的   <a class="reference internal" href="#sqlalchemy.orm.query_expression" title="sqlalchemy.orm.query_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">query_expression()</span></code></a>  指令结合使用时，可以产生这个结果。</p>
<p>要应用   <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  到查询，映射类必须预先使用   <a class="reference internal" href="#sqlalchemy.orm.query_expression" title="sqlalchemy.orm.query_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">query_expression()</span></code></a>  指令配置一个 ORM 映射属性；该指令将产生一个适合接收查询时 SQL 表达式的映射类属性。下面我们在 <cite>User</cite> 中添加一个新属性 <cite>User.book_count</cite>。这个 ORM 映射属性是只读的，没有默认值；在已经加载的实例上访问它通常会产生 <cite>None</cite>。</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">query_expression</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="go">...     __tablename__ = &quot;user_account&quot;</span>
<span class="go">...     id: Mapped[int] = mapped_column(primary_key=True)</span>
<span class="go">...     name: Mapped[str]</span>
<span class="go">...     fullname: Mapped[Optional[str]]</span>
<span class="go">...     book_count: Mapped[int] = query_expression()</span>
<span class="go">...</span>
<span class="go">...     def __repr__(self) -&gt; str:</span>
<span class="go">...         return f&quot;User(id={self.id!r}, name={self.name!r}, fullname={self.fullname!r})&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">User.book_count</span></code> 属性配置我们的映射后，我们可以使用   <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  加载器选项将自定义 SQL 表达式应用于每个加载的 <cite>User</cite> 对象中:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">with_expression</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     select(User)</span>
<span class="go">...     .join_from(User, Book)</span>
<span class="go">...     .group_by(Book.owner_id)</span>
<span class="go">...     .options(with_expression(User.book_count, func.count(Book.id)))</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="go">...     print(f&quot;Username: {user.name}  Number of books: {user.book_count}&quot;)</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_1</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">()</span>
</div><span class="go">Username: spongebob  Number of books: 3</span>
<span class="go">Username: sandy  Number of books: 3</span></pre></div>
</div>
<p>上面，我们将我们的 <cite>func.count(Book.id)</cite> 表达式从   <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>  构造的 columns 参数中移到   <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  加载器选项中。ORM 然后将其视为一个特殊的列加载选项，它在运行时动态应用到语句中。</p>
<p>注意：</p>
<ul>
<li><p>对于没有使用   <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  来填充这个属性的对象，对象实例上的属性值将为 <cite>None</cite>，除非映射中  <a class="reference internal" href="#sqlalchemy.orm.query_expression.params.default_expr" title="sqlalchemy.orm.query_expression"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">query_expression.default_expr</span></code></a>  参数被设置为默认的 SQL 表达式。*   <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  的值 <strong>不会填充已经加载的对象</strong>，除非使用   <a class="reference internal" href="api.html#orm-queryguide-populate-existing"><span class="std std-ref">填充现有的实例</span></a> 。下面的示例不起作用，因为 <code class="docutils literal notranslate"><span class="pre">A</span></code> 对象已经加载：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 加载第一个 A</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c1"># 加载相同带选项的 A；不会应用已经加载的对象上的表达式</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">with_expression</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">some_expr</span><span class="p">)))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
</div>
<p>为确保重新加载现有对象上的属性，请使用   <a class="reference internal" href="api.html#orm-queryguide-populate-existing"><span class="std std-ref">填充现有的实例</span></a>  执行选项以确保重新填充所有列：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">with_expression</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">some_expr</span><span class="p">))</span>
    <span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">populate_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
</div>
</li>
<li><p>当对象过期时，无法保存此 SQL 表达式，无论是通过  <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expire()</span></code>  还是通过  <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code>  的 expire_on_commit 行为。一旦对象过期，SQL 表达式及其值将不再与属性关联，随后的访问将返回 <code class="docutils literal notranslate"><span class="pre">None</span></code>。</p></li>
<li><p><a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  作为对象加载选项，仅在查询的 <strong>最外层部分</strong> 作用，并且仅针对针对完整实体的查询，而不是针对任意列选择、子查询或复合语句（如 UNION） 的查询。参见下一节   <a class="reference internal" href="#orm-queryguide-with-expression-unions"><span class="std std-ref">在 UNION 和其他子查询中使用 with_expression()</span></a> ，了解示例。</p></li>
<li><p>映射属性无法应用于查询的其他部分，例如 WHERE 子句、ORDER BY 子句，并利用临时表达式；也就是说，以下代码不起作用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 无法在查询的其他地方引用 A.expr 表达式</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">with_expression</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">expr</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>上述 WHERE 子句和 ORDER BY 子句中的 <code class="docutils literal notranslate"><span class="pre">A.expr</span></code> 表达式将解析为 NULL。要在整个查询中使用表达式，请先将其分配给变量，然后使用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 预先指定期望的表达式，然后在查询中引用</span>
<span class="n">a_expr</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">y</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">with_expression</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">a_expr</span><span class="p">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">a_expr</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">a_expr</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
</li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  选项是一种特殊选项，用于在查询时动态应用 SQL 表达式到映射类。对于在映射器上配置的普通固定 SQL 表达式，请参见   <a class="reference internal" href="../mapped_sql_expr.html#mapper-sql-expressions"><span class="std std-ref">将SQL表达式映射为属性</span></a>  部分。</p>
</div>
<section id="union-with-expression">
<span id="orm-queryguide-with-expression-unions"></span><h3>在 UNION 和其他子查询中使用 <code class="docutils literal notranslate"><span class="pre">with_expression()</span></code><a class="headerlink" href="#union-with-expression" title="Permalink to this heading">¶</a></h3>
<p>为了在子查询中使用任意 SQL 表达式，应使用添加表达式的常规 Core 样式方法。要将子查询派生的表达式组合到 ORM 实体的   <a class="reference internal" href="#sqlalchemy.orm.query_expression" title="sqlalchemy.orm.query_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">query_expression()</span></code></a>  属性上，需要在 ORM 对象加载的顶层使用   <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a> ，引用子查询中的 SQL 表达式。</p>
<p>在下面的示例中，使用两个带有附加 SQL 表达式标记为“expr”的   <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>  构造针对 ORM 实体 <code class="docutils literal notranslate"><span class="pre">A</span></code> 进行操作，并使用   <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.union_all" title="sqlalchemy.sql.expression.union_all"><code class="xref py py-func docutils literal notranslate"><span class="pre">union_all()</span></code></a>  进行组合。然后，在最高层次上，使用   <a class="reference internal" href="select.html#orm-queryguide-unions"><span class="std std-ref">从UNIONs和其他集合操作中选择实体</span></a>  中描述的查询方法从此 UNION 中 SELECT 了 <code class="docutils literal notranslate"><span class="pre">A</span></code> 实体。在新加载的 <code class="docutils literal notranslate"><span class="pre">A</span></code> 实例上添加选项来使用   <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>  提取此 SQL 表达式:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">union_all</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     select(User, func.count(Book.id).label(&quot;book_count&quot;))</span>
<span class="go">...     .join_from(User, Book)</span>
<span class="go">...     .where(User.name == &quot;spongebob&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     select(User, func.count(Book.id).label(&quot;book_count&quot;))</span>
<span class="go">...     .join_from(User, Book)</span>
<span class="go">...     .where(User.name == &quot;sandy&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">union_stmt</span> <span class="o">=</span> <span class="n">union_all</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">orm_stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     select(User)</span>
<span class="go">...     .from_statement(union_stmt)</span>
<span class="go">...     .options(with_expression(User.book_count, union_stmt.selected_columns.book_count))</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">orm_stmt</span><span class="p">):</span>
<span class="go">...     print(f&quot;Username: {user.name}  Number of books: {user.book_count}&quot;)</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">book</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">book_count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="n">owner_id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="err">联合所有</span>
</div></pre></div>
</div>
<hr class="docutils" />
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">UNION ALL</span>
<span class="go">SELECT user_account.id, user_account.name, user_account.fullname, count(book.id) AS book_count</span>
<span class="go">FROM user_account JOIN book ON user_account.id = book.owner_id</span>
<span class="go">WHERE user_account.name = ?</span>
<span class="go">[...] (&#39;spongebob&#39;, &#39;sandy&#39;){stop}</span>
<span class="go">用户名: spongebob  书籍数量: 3</span>
<span class="go">用户名: sandy  书籍数量: 3</span></pre></div>
</div>
</section>
</section>
<section id="api">
<h2>列加载 API<a class="headerlink" href="#api" title="Permalink to this heading">¶</a></h2>
<table class="longtable docutils align-default">
<thead>
<tr class="row-odd"><th class="head">Object Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.defer"><span class="sig-name descname">defer</span></a>(key, *addl_attrs, [raiseload])</p></td>
<td><p>Indicate that the given column-oriented attribute should be
deferred, e.g. not loaded until accessed.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.deferred"><span class="sig-name descname">deferred</span></a>(column, *additional_columns, [group, raiseload, comparator_factory, init, repr, default, default_factory, compare, kw_only, active_history, expire_on_flush, info, doc])</p></td>
<td><p>Indicate a column-based mapped attribute that by default will
not load unless accessed.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.load_only"><span class="sig-name descname">load_only</span></a>(*attrs, [raiseload])</p></td>
<td><p>Indicate that for a particular entity, only the given list
of column-based attribute names should be loaded; all others will be
deferred.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.query_expression"><span class="sig-name descname">query_expression</span></a>([default_expr], *, [repr, compare, expire_on_flush, info, doc])</p></td>
<td><p>Indicate an attribute that populates from a query-time SQL expression.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.undefer"><span class="sig-name descname">undefer</span></a>(key, *addl_attrs)</p></td>
<td><p>Indicate that the given column-oriented attribute should be
undeferred, e.g. specified within the SELECT statement of the entity
as a whole.</p></td>
</tr>
<tr class="row-odd"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.undefer_group"><span class="sig-name descname">undefer_group</span></a>(name)</p></td>
<td><p>Indicate that columns within the given deferred group name should be
undeferred.</p></td>
</tr>
<tr class="row-even"><td class="autosummary-name"><p><a class="reference internal" href="#sqlalchemy.orm.with_expression"><span class="sig-name descname">with_expression</span></a>(key, expression)</p></td>
<td><p>Apply an ad-hoc SQL expression to a “deferred expression”
attribute.</p></td>
</tr>
</tbody>
</table>
<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.defer">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">defer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="../internals.html#sqlalchemy.orm.QueryableAttribute" title="sqlalchemy.orm.attributes.QueryableAttribute"><span class="pre">QueryableAttribute</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">addl_attrs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="../internals.html#sqlalchemy.orm.QueryableAttribute" title="sqlalchemy.orm.attributes.QueryableAttribute"><span class="pre">QueryableAttribute</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">raiseload</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_AbstractLoad</span></span></span><a class="headerlink" href="#sqlalchemy.orm.defer" title="Permalink to this definition">¶</a></dt>
<dd><p>Indicate that the given column-oriented attribute should be
deferred, e.g. not loaded until accessed.</p>
<p>This function is part of the <a class="reference internal" href="relationships.html#sqlalchemy.orm.Load" title="sqlalchemy.orm.Load"><code class="xref py py-class docutils literal notranslate"><span class="pre">Load</span></code></a> interface and supports
both method-chained and standalone operation.</p>
<p>e.g.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy.orm import defer</span>

<span class="go">session.query(MyClass).options(</span>
<span class="go">    defer(MyClass.attribute_one),</span>
<span class="go">    defer(MyClass.attribute_two)</span>
<span class="go">)</span></pre></div>
</div>
<p>To specify a deferred load of an attribute on a related class,
the path can be specified one token at a time, specifying the loading
style for each link along the chain.  To leave the loading style
for a link unchanged, use <code class="xref py py-func docutils literal notranslate"><span class="pre">defaultload()</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.query(MyClass).options(</span>
<span class="go">    defaultload(MyClass.someattr).defer(RelatedClass.some_column)</span>
<span class="go">)</span></pre></div>
</div>
<p>Multiple deferral options related to a relationship can be bundled
at once using <a class="reference internal" href="relationships.html#sqlalchemy.orm.Load.options" title="sqlalchemy.orm.Load.options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Load.options()</span></code></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.query(MyClass).options(</span>
<span class="go">    defaultload(MyClass.someattr).options(</span>
<span class="go">        defer(RelatedClass.some_column),</span>
<span class="go">        defer(RelatedClass.some_other_column),</span>
<span class="go">        defer(RelatedClass.another_column)</span>
<span class="go">    )</span>
<span class="go">)</span></pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.defer.params.key"></span><strong>key</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.defer.params.key">¶</a> – Attribute to be deferred.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.defer.params.raiseload"></span><strong>raiseload</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.defer.params.raiseload">¶</a> – raise <a class="reference internal" href="../../core/exceptions.html#sqlalchemy.exc.InvalidRequestError" title="sqlalchemy.exc.InvalidRequestError"><code class="xref py py-class docutils literal notranslate"><span class="pre">InvalidRequestError</span></code></a> rather than
lazy loading a value when the deferred attribute is accessed. Used
to prevent unwanted SQL from being emitted.</p></li>
</ul>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.</span></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-column-deferral"><span class="std std-ref">使用列延迟选择要加载的列</span></a> - in the
<a class="reference internal" href="index.html"><span class="std std-ref">ORM 查询指南</span></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.undefer" title="sqlalchemy.orm.undefer"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer()</span></code></a></p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.deferred">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">deferred</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">column</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_ORMColumnExprArgument</span><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">additional_columns</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_ORMColumnExprArgument</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">group</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">raiseload</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">comparator_factory</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="../internals.html#sqlalchemy.orm.PropComparator" title="sqlalchemy.orm.PropComparator"><span class="pre">PropComparator</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">init</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_NoArg</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">_NoArg.NO_ARG</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">repr</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_NoArg</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">_NoArg.NO_ARG</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Any</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">_NoArg.NO_ARG</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default_factory</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_NoArg</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">_NoArg.NO_ARG</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compare</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_NoArg</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">_NoArg.NO_ARG</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kw_only</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_NoArg</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">_NoArg.NO_ARG</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">active_history</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expire_on_flush</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">info</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_InfoType</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">doc</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="../internals.html#sqlalchemy.orm.MappedSQLExpression" title="sqlalchemy.orm.MappedSQLExpression"><span class="pre">MappedSQLExpression</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.deferred" title="Permalink to this definition">¶</a></dt>
<dd><p>Indicate a column-based mapped attribute that by default will
not load unless accessed.</p>
<p>When using <code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code>, the same functionality as
that of <a class="reference internal" href="#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> construct is provided by using the
<code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred</span></code> parameter.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.deferred.params.*columns"></span><strong>*columns</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.deferred.params.*columns">¶</a> – columns to be mapped.  This is typically a single
<a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object,
however a collection is supported in order
to support multiple columns mapped under the same attribute.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.deferred.params.raiseload"></span><strong>raiseload</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.deferred.params.raiseload">¶</a> – <p>boolean, if True, indicates an exception should be raised
if the load operation is to take place.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.4.</span></p>
</div>
</p></li>
</ul>
</dd>
</dl>
<p>Additional arguments are the same as that of <code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-deferred-imperative"><span class="std std-ref">使用 deferred() 用于命令式映射，映射 SQL 表达式</span></a></p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.query_expression">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">query_expression</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">default_expr:</span> <span class="pre">_ORMColumnExprArgument[_T]</span> <span class="pre">=</span> <span class="pre">&lt;sqlalchemy.sql.elements.Null</span> <span class="pre">object&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">repr:</span> <span class="pre">Union[_NoArg</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bool]</span> <span class="pre">=</span> <span class="pre">_NoArg.NO_ARG</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">compare:</span> <span class="pre">Union[_NoArg</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bool]</span> <span class="pre">=</span> <span class="pre">_NoArg.NO_ARG</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expire_on_flush:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">info:</span> <span class="pre">Optional[_InfoType]</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">doc:</span> <span class="pre">Optional[str]</span> <span class="pre">=</span> <span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="../internals.html#sqlalchemy.orm.MappedSQLExpression" title="sqlalchemy.orm.MappedSQLExpression"><span class="pre">MappedSQLExpression</span></a><span class="p"><span class="pre">[</span></span><span class="pre">_T</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#sqlalchemy.orm.query_expression" title="Permalink to this definition">¶</a></dt>
<dd><p>Indicate an attribute that populates from a query-time SQL expression.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="target" id="sqlalchemy.orm.query_expression.params.default_expr"></span><strong>default_expr</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.query_expression.params.default_expr">¶</a> – Optional SQL expression object that will be used in
all cases if not assigned later with <a class="reference internal" href="#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>.</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.2.</span></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-with-expression"><span class="std std-ref">将任意SQL表达式加载到对象上</span></a> - background and usage examples</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.load_only">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">load_only</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">attrs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="../internals.html#sqlalchemy.orm.QueryableAttribute" title="sqlalchemy.orm.attributes.QueryableAttribute"><span class="pre">QueryableAttribute</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">raiseload</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_AbstractLoad</span></span></span><a class="headerlink" href="#sqlalchemy.orm.load_only" title="Permalink to this definition">¶</a></dt>
<dd><p>Indicate that for a particular entity, only the given list
of column-based attribute names should be loaded; all others will be
deferred.</p>
<p>This function is part of the <a class="reference internal" href="relationships.html#sqlalchemy.orm.Load" title="sqlalchemy.orm.Load"><code class="xref py py-class docutils literal notranslate"><span class="pre">Load</span></code></a> interface and supports
both method-chained and standalone operation.</p>
<p>Example - given a class <code class="docutils literal notranslate"><span class="pre">User</span></code>, load only the <code class="docutils literal notranslate"><span class="pre">name</span></code> and
<code class="docutils literal notranslate"><span class="pre">fullname</span></code> attributes:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.query(User).options(load_only(User.name, User.fullname))</span></pre></div>
</div>
<p>Example - given a relationship <code class="docutils literal notranslate"><span class="pre">User.addresses</span> <span class="pre">-&gt;</span> <span class="pre">Address</span></code>, specify
subquery loading for the <code class="docutils literal notranslate"><span class="pre">User.addresses</span></code> collection, but on each
<code class="docutils literal notranslate"><span class="pre">Address</span></code> object load only the <code class="docutils literal notranslate"><span class="pre">email_address</span></code> attribute:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.query(User).options(</span>
<span class="go">    subqueryload(User.addresses).load_only(Address.email_address)</span>
<span class="go">)</span></pre></div>
</div>
<p>For a statement that has multiple entities,
the lead entity can be
specifically referred to using the <a class="reference internal" href="relationships.html#sqlalchemy.orm.Load" title="sqlalchemy.orm.Load"><code class="xref py py-class docutils literal notranslate"><span class="pre">Load</span></code></a> constructor:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">stmt = select(User, Address).join(User.addresses).options(</span>
<span class="go">            Load(User).load_only(User.name, User.fullname),</span>
<span class="go">            Load(Address).load_only(Address.email_address)</span>
<span class="go">        )</span></pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.load_only.params.*attrs"></span><strong>*attrs</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.load_only.params.*attrs">¶</a> – Attributes to be loaded, all others will be deferred.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.load_only.params.raiseload"></span><strong>raiseload</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.load_only.params.raiseload">¶</a> – <p>raise <a class="reference internal" href="../../core/exceptions.html#sqlalchemy.exc.InvalidRequestError" title="sqlalchemy.exc.InvalidRequestError"><code class="xref py py-class docutils literal notranslate"><span class="pre">InvalidRequestError</span></code></a> rather than
lazy loading a value when a deferred attribute is accessed. Used
to prevent unwanted SQL from being emitted.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.</span></p>
</div>
</p></li>
</ul>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-column-deferral"><span class="std std-ref">使用列延迟选择要加载的列</span></a> - in the
<a class="reference internal" href="index.html"><span class="std std-ref">ORM 查询指南</span></a></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.load_only.params.*attrs"></span><strong>*attrs</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.load_only.params.*attrs">¶</a> – Attributes to be loaded, all others will be deferred.</p></li>
<li><p><span class="target" id="sqlalchemy.orm.load_only.params.raiseload"></span><strong>raiseload</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.load_only.params.raiseload">¶</a> – <p>raise <a class="reference internal" href="../../core/exceptions.html#sqlalchemy.exc.InvalidRequestError" title="sqlalchemy.exc.InvalidRequestError"><code class="xref py py-class docutils literal notranslate"><span class="pre">InvalidRequestError</span></code></a> rather than
lazy loading a value when a deferred attribute is accessed. Used
to prevent unwanted SQL from being emitted.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.0.</span></p>
</div>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.undefer">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">undefer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="../internals.html#sqlalchemy.orm.QueryableAttribute" title="sqlalchemy.orm.attributes.QueryableAttribute"><span class="pre">QueryableAttribute</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">addl_attrs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference internal" href="../internals.html#sqlalchemy.orm.QueryableAttribute" title="sqlalchemy.orm.attributes.QueryableAttribute"><span class="pre">QueryableAttribute</span></a><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_AbstractLoad</span></span></span><a class="headerlink" href="#sqlalchemy.orm.undefer" title="Permalink to this definition">¶</a></dt>
<dd><p>Indicate that the given column-oriented attribute should be
undeferred, e.g. specified within the SELECT statement of the entity
as a whole.</p>
<p>The column being undeferred is typically set up on the mapping as a
<a class="reference internal" href="#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> attribute.</p>
<p>This function is part of the <a class="reference internal" href="relationships.html#sqlalchemy.orm.Load" title="sqlalchemy.orm.Load"><code class="xref py py-class docutils literal notranslate"><span class="pre">Load</span></code></a> interface and supports
both method-chained and standalone operation.</p>
<p>Examples:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go"># undefer two columns</span>
<span class="go">session.query(MyClass).options(</span>
<span class="go">    undefer(MyClass.col1), undefer(MyClass.col2)</span>
<span class="go">)</span>

<span class="go"># undefer all columns specific to a single class using Load + *</span>
<span class="go">session.query(MyClass, MyOtherClass).options(</span>
<span class="go">    Load(MyClass).undefer(&quot;*&quot;))</span>

<span class="go"># undefer a column on a related object</span>
<span class="go">session.query(MyClass).options(</span>
<span class="go">    defaultload(MyClass.items).undefer(MyClass.text))</span></pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="target" id="sqlalchemy.orm.undefer.params.key"></span><strong>key</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.undefer.params.key">¶</a> – Attribute to be undeferred.</p>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-column-deferral"><span class="std std-ref">使用列延迟选择要加载的列</span></a> - in the
<a class="reference internal" href="index.html"><span class="std std-ref">ORM 查询指南</span></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.undefer_group" title="sqlalchemy.orm.undefer_group"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer_group()</span></code></a></p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.undefer_group">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">undefer_group</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_AbstractLoad</span></span></span><a class="headerlink" href="#sqlalchemy.orm.undefer_group" title="Permalink to this definition">¶</a></dt>
<dd><p>Indicate that columns within the given deferred group name should be
undeferred.</p>
<p>The columns being undeferred are set up on the mapping as
<a class="reference internal" href="#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> attributes and include a “group” name.</p>
<p>E.g:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.query(MyClass).options(undefer_group(&quot;large_attrs&quot;))</span></pre></div>
</div>
<p>To undefer a group of attributes on a related entity, the path can be
spelled out using relationship loader options, such as
<code class="xref py py-func docutils literal notranslate"><span class="pre">defaultload()</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.query(MyClass).options(</span>
<span class="go">    defaultload(&quot;someattr&quot;).undefer_group(&quot;large_attrs&quot;))</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-column-deferral"><span class="std std-ref">使用列延迟选择要加载的列</span></a> - in the
<a class="reference internal" href="index.html"><span class="std std-ref">ORM 查询指南</span></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.defer" title="sqlalchemy.orm.defer"><code class="xref py py-func docutils literal notranslate"><span class="pre">defer()</span></code></a></p>
<p><a class="reference internal" href="#sqlalchemy.orm.undefer" title="sqlalchemy.orm.undefer"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer()</span></code></a></p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sqlalchemy.orm.with_expression">
<em class="property"><span class="pre">function</span> </em><span class="sig-prename descclassname"><span class="pre">sqlalchemy.orm.</span></span><span class="sig-name descname"><span class="pre">with_expression</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_AttrType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expression</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">_ColumnExpressionArgument</span><span class="p"><span class="pre">[</span></span><span class="pre">Any</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">_AbstractLoad</span></span></span><a class="headerlink" href="#sqlalchemy.orm.with_expression" title="Permalink to this definition">¶</a></dt>
<dd><p>Apply an ad-hoc SQL expression to a “deferred expression”
attribute.</p>
<p>This option is used in conjunction with the
<a class="reference internal" href="#sqlalchemy.orm.query_expression" title="sqlalchemy.orm.query_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">query_expression()</span></code></a> mapper-level construct that indicates an
attribute which should be the target of an ad-hoc SQL expression.</p>
<p>E.g.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">stmt = select(SomeClass).options(</span>
<span class="go">    with_expression(SomeClass.x_y_expr, SomeClass.x + SomeClass.y)</span>
<span class="go">)</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.2.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><span class="target" id="sqlalchemy.orm.with_expression.params.key"></span><strong>key</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.with_expression.params.key">¶</a> – Attribute to be populated</p></li>
<li><p><span class="target" id="sqlalchemy.orm.with_expression.params.expr"></span><strong>expr</strong><a class="paramlink headerlink reference internal" href="#sqlalchemy.orm.with_expression.params.expr">¶</a> – SQL expression to be applied to the attribute.</p></li>
</ul>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#orm-queryguide-with-expression"><span class="std std-ref">将任意SQL表达式加载到对象上</span></a> - background and usage
examples</p>
</div>
</dd></dl>

</section>
</section>
<aside class="topic">
<p class="topic-title">ORM 查询指南</p>
<p>下一个查询指南章节: <a class="reference internal" href="relationships.html"><span class="doc">关系加载技术</span></a></p>
</aside>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="dml.html" title="previous chapter">ORM-启用的INSERT、UPDATE和DELETE语句</a>
        Next:
        <a href="relationships.html" title="next chapter">关系加载技术</a>

    <div id="docs-copyright">
        &copy; <a href="../../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: 2023/8/18 18:44:01

    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../../',
          VERSION:     '2.0.19',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../../_static/init.js"></script>


    </body>
</html>


